$z.defModule("access/index",{initialize:function(){$j("#password_help").data("originalURL",$j("#password_help").attr("href"));this.addEmailToPasswordHelpLink();$j("#user_email").change(function(){$z("access/index").addEmailToPasswordHelpLink()})},addEmailToPasswordHelpLink:function(){var passwordHelpLink=$j("#password_help");var email=$j("#user_email").val();var originalURL=$j("#password_help").data("originalURL");if($j.trim(email)===""){passwordHelpLink.attr("href",originalURL)}else{email=encodeURIComponent(email);passwordHelpLink.attr("href",originalURL+"?email="+email)}}});$z.defModule("account/business_hours_definitions/show",{initialize:function(){if($j("form#business_hours_form").attr("data-has-business-hours")==="false"){$j("#business_hours_definition_is_active_false").click();$j("form#business_hours_form :input").prop("disabled",true);$j("#sub_setting_is_active").show()}}});$z.defModule("account/dropboxes/edit",{initialize:function(){var $form=$j("#dropbox_form"),$upgradeField=$form.find(".upgrade_field"),$upgradeLink=$form.find("a.upgrade"),$currentVersion=$form.find(".current_version");$upgradeLink.click(function(){if(!confirm("Upgrade this Feedback Tab?")){return false}$j.ajax({url:$upgradeLink.attr("href"),type:"POST",dataType:"JSON",data:{_method:"PUT"}}).done(function(json){showFlash("Upgraded","notice");$currentVersion.html(json.version);$upgradeField.removeClass("upgradeable").addClass("not_upgradeable")}).fail(function(response){var json=JSON.parse(response.responseText);json.error&&showFlash(json.error,"error")});return false})}});$z.defModule("account/dropboxes/version1",{initialize:function(){this._hostName=$j("#zenboxForm").attr("data-zd-host-name");if(!this._hostName){console.warn("No host name found. Is there a #zenboxForm[data-zd-host-name] element?")}$j("#zenboxForm input").change(this.update.bind(this));Zenbox.init(this._settings());this.update({init:true})},update:function(options){var settings=this._settings();this._applySettingsToDropbox(settings);this._writeTemplate(settings,options)},_settings:function(){return{url:this._hostName,tab_id:this._tabID(),tab_color:$j.trim($j("#zenbox_color").val()),title:$j.trim($j("#zenbox_title").val()).replace(/"/g,"'"),text:this._applyHTMLLineBreaks(($j("#zenbox_text").val())).replace(/"/g,"'"),tag:$j("#zenbox_tag").val()}},_applySettingsToDropbox:function(settings){var tab=$j("#zenbox_tab");tab.css("backgroundColor",settings.tab_color);tab.css("borderColor",settings.tab_color);$j("#overlay_zenbox_title").html(settings.title);$j("#overlay_zenbox_text").html(settings.text);$j("#zenbox_tab").css("backgroundImage","url(http://assets.zendesk.com/external/zenbox/images/tab_"+settings.tab_id+".png)")},_writeTemplate:function(settings,options){var output=$j("#zenbox_output");output.val($j.mustache(this._template,settings));if(options&&!options.init){output.effect&&output.effect("highlight",{},2000)}},_template:'<script type="text/javascript" src="//assets.zendesk.com/external/zenbox/overlay.js"><\/script>\n<style type="text/css" media="screen, projection">\n  @import url(//assets.zendesk.com/external/zenbox/overlay.css);\n</style>\n<script type="text/javascript">\n  if (typeof(Zenbox) !== "undefined") {\n    Zenbox.init({\n      url:       "{{ url }}",\n      tab_id:    "{{ tab_id }}",\n      tab_color: "{{ tab_color }}",\n      title:     "{{ title }}",\n      text:      "{{ text }}",\n      tag:       "{{ tag }}"\n    });\n  }\n<\/script>\n',_applyHTMLLineBreaks:function(t){return $j.trim(t).replace(/\r\n|\n/g,"<br/>")},_tabID:function(){return $j('input:checked[type="radio"][name="zenbox_tab_id"]').val()}});$z.defModule("account/monitored_twitter_handles/index",{initialize:function(){var addMonitorLink=$j("p.add_monitor_handle a#add-twitter");if(arguments[0]==true){addMonitorLink.click(function(){$j("div.help-bubble").slideDown("200")})}else{addMonitorLink.click(this.addTwitterMonitorHandle())}MTH.initialize()},addTwitterMonitorHandle:function(){$j.colorbox({href:"/account/monitored_twitter_handles/new"})}});var MTH={initialize:function(){$j("input.handle_master").each(function(index,checkbox){$j(checkbox).click(MTH.setPrimary)})},setPrimary:function(event){var checkbox=$j(event.target);var id=checkbox.attr("id").split("_").last();var checked=checkbox.attr("checked");if(checked){MTH.uncheckSiblings(checkbox)}MTH.togglePrimaryFlag(id,checked);MTH.requestUpdate(id,checked)},showSpinner:function(id){$j("#spinner-"+id).show()},hideSpinner:function(id){$j("#spinner-"+id).hide()},uncheckSiblings:function(checkbox){$j("input.handle_master").prop("checked",false);checkbox.attr("checked",true)},togglePrimaryFlag:function(id,checked){$j(".primary-selector").hide();if(checked){$j("#primary-selector-"+id).show()}},requestUpdate:function(id,checked){MTH.showSpinner(id);$j.ajax({type:"PUT",url:"/account/channels/"+id,data:{handle:{master:checked}},success:function(){MTH.hideSpinner(id)}})}};$z.defModule("archived_tickets/index",{initialize:function(){this.updateUI();$j("select#filter_by").change(this.updateUI)},updateUI:function(){["requester","organization"].each(function(item){if(item==$j("select#filter_by").val()){$j("#"+item).show()}else{$j("#"+item).hide()}})}});$z.defModule("categories/form",{initialize:function(){$j("#category_name").focus()}});$z.defModule("categories/show",{initialize:function(){$z("forums/index").initialize()}});$j(document).ready(function(){$j("#chat_availability").click(function(event){event.preventDefault();window.open("/chat","chatWindow","toolbar=0, menubar=0, width=620, height=594, location=0, status=0, directories=0")})});$z.defModule("settings/chat/show",{initialize:function(params){this.appendNewLabel(I18n.t("txt.admin.views.account.chat_settings.zopim_chat_settings.new"));if(currentAccount.hasFeature("chatDisableWarning")){this.bindFormSubmissonCheck()}this.setupInnerTabs();this.bindNavigation()},bindNavigation:function(){$j(".zopim-settings .buy-zopim").addClass("orange-btn").click(this.goToZopimPlanSelection.bind(this));$j(".zopim-settings .buy-zendesk").addClass("orange-btn").click(this.goToZendeskPlanSelection.bind(this));$j(".zopim-settings .adjust-plan").addClass("orange-btn").click(this.goToBillingPage.bind(this));$j(".zopim-settings .dashboard").click(this.goToDashboard.bind(this));$j(".zopim-settings .app-settings").click(this.goToAppSettings.bind(this));$j(".zopim-settings .help-center").click(this.goToHelpCenter.bind(this));$j(".zopim-marketing .cta").click(this.createZopimTrial.bind(this));$j(".zopim-marketing .zopim-customer").click(this.goToAppDetails.bind(this));$j(".zopim-marketing .explorezop-phaseI").click(this.goToAppDetails.bind(this));$j(".widget-link").click(this.goToWidgetCode.bind(this))},bindFormSubmissonCheck:function(){$j("#chat_settings_form").submit(this.showConfirmationDialog.bind(this))},createZopimTrial:function(){var button=$j(".cta");button.removeClass("active");button.text(I18n.t("txt.admin.views.account.chat_settings._zopim.creating_account"));var self=this;$j.ajax({type:"POST",url:"/api/v2/account/zopim_subscription.json?include=zopim_integration,app_market_integration"}).done(function(data){var message=JSON.stringify({target:"setUpZopimApp",data:data.app_market_integration.app_path});window.parent.postMessage(message,window.location.origin)}).fail(function(data){button.addClass("active");button.text(I18n.t("txt.admin.views.account.chat_settings._zopim.get_started"));window.top.require("lib/growl").error(I18n.t("txt.admin.public.javascripts.views.admin.settings.zopim_create_unknown_error"))})},goToAppDetails:function(e){e.preventDefault();this.goToHash("admin.apps.details","zopim_chat")},goToAppSettings:function(){this.goToHash("/admin/apps/manage")},goToWidgetCode:function(){this.goToHash("/admin/widget/setup_zopim")},goToDashboard:function(e){var path=$j(e.currentTarget).data("zopim-path");this.goToHash("/apps/"+path)},goToZopimApp:function(zopim_app_path){this.goToHash("/apps/"+zopim_app_path)},goToHelpCenter:function(){window.open("/hc/admin/general_settings")},zopimChatMessage:function(type){var message=JSON.stringify({target:"zopimChat",type:type});return message},goToZopimPlanSelection:function(){var message=this.zopimChatMessage("zopim-plan-selection");window.parent.postMessage(message,window.location.origin)},goToZendeskPlanSelection:function(){var message=this.zopimChatMessage();window.parent.postMessage(message,window.location.origin)},goToBillingPage:function(){var message=this.zopimChatMessage("billing");window.parent.postMessage(message,window.location.origin)},goToHash:function(){var router=window.parent.Zd.router;router.transitionTo.apply(router,arguments)},appendNewLabel:function(str){$j("a[href='#chat_settings_zopim']").append('<span class="zopim-chat-new-label">'+str+"</span>")},showConfirmationDialog:function(){var chatSetting=$j('input[name="account[settings][chat]"]:checked');if(chatSetting.val()==0){return confirm(I18n.t("txt.admin.views.account.chat_settings._general.disable_chat_message"))}},setupInnerTabs:function(){var tab=$j(".inner-tabs a.current").attr("href");$j(tab).show();$j(".inner-tabs a").click(function(event){event.preventDefault();var tab=$j(this);tab.closest(".tab-menu").find("a").removeClass("current");tab.addClass("current");var id=tab.attr("href");$j(".tab-content").not(id).hide();$j(id).show()})}});Zendesk.NS("CMS");Zendesk.CMS.Bootstrap=function(){if((typeof(currentAccount)=="undefined")||!currentAccount.hasFeature("ahab")){return}$j("[data-placeholder-id]").each(function(idx,element){var element=$j(element);if(!element.data("ahab")){var inputField=(element.find("textarea")||element.find("input[type=text]"));var target=element.find(".placeholder-info")||$j("<div></div>").insertAfter(inputField);var ahabWidget=target.ahab(inputField);element.data("ahab",ahabWidget)}})};Zendesk.CMS.Ahab=function(linkElement,targetInput){this.targetInput=targetInput;this.linkElement=linkElement;this.list=null};Zendesk.CMS.Ahab.prototype={show:function(){if((typeof(this.list)=="undefined")||(this.list==null)){this._prepare()}var self=this;$j(this.list).iosMenu({title:"Insert Placeholder",slideDuration:50,click:function(iosMenu,listItem){var placeholderData=listItem.data("value");if(placeholderData){$j(self.targetInput).insertAtCaret("{{"+placeholderData+"}}");iosMenu.toggle()}},backTextFunction:function(submenu){return $j(submenu).parent().find("> a").html()}});return this},_prepare:function(){var list=this._render(Zendesk.CMS.texts);var container=$j(this.linkElement).html(list);this.list=container.find("ul.root")},_render:function(root){var listRoot=$j('<ul class="menu root" style="display: none;">');var rendered=_.reduce(this._renderLevel(root),function(m,n){return m.append(n)},listRoot);return rendered},_renderLevel:function(listItems){var self=this;var subItemNames=_.without(_.keys(listItems),"id","title");var sortedSubItems=_.sortBy(subItemNames,function(e){return e});var items=_.map(sortedSubItems,function(subItemName){return self._renderItem(subItemName,listItems[subItemName])});return items},_renderItem:function(name,element){var subItem=$j("<li></li>");subItem.append(name);var subLevelItems=this._renderLevel(element);if(_.any(subLevelItems)){subLevel=_.reduce(subLevelItems,function(m,n){return m.append(n)},$j('<ul class="sd"></ul>'));subItem.append(subLevel).addClass("sub")}else{subItem.addClass("link")}subItem.data("full-title",element.title);subItem.data("value",element.id);return subItem},_calculateTitles:_.memoize(function(){return _.map($j("li.ui-menu-item.link"),function(e){return $j(e).data("full-title")})}),_searchResultRenderer:function(result){var query=$j("input.ios-menu-search-field").val();var parts=result.toLowerCase().split(query.toLowerCase());var annotatedResult=_.reduce(parts,function(memo,substr){return memo+"<strong>"+query+"</strong>"+substr});return"<li><a>"+annotatedResult+"</a></li>"}};jQuery.fn.extend({ahab:function(inputField){return new Zendesk.CMS.Ahab(this,inputField).show()}});$j("#cms_variant_is_fallback").change(function(){if($j("#cms_variant_is_fallback").attr("checked")=="checked"){$j("#cms_variant_active_true").attr("checked",true);$j("#cms_variant_active_false").attr("disabled",true)}else{$j("#cms_variant_active_false").attr("disabled",false)}});$j("#get_more_macros").click(function(){$j("#get_more_macros").hide();$j(".macros_reference").fadeIn()});$j("#get_more_triggers").click(function(){$j("#get_more_triggers").hide();$j(".triggers_reference").fadeIn()});$j("#get_more_automations").click(function(){$j("#get_more_automations").hide();$j(".automations_reference").fadeIn()});$j(document).ready(function(){$j("#cms_texts_filter_form").change(function(){$j(this).closest("form").submit()});new InputSuggest($j(".cms_content"))});(function(){if(!this.require){var modules={},cache={};var require=function(name,root){var path=expand(root,name),indexPath=expand(path,"./index"),module,fn;module=cache[path]||cache[indexPath];if(module){return module}else{if(fn=modules[path]||modules[path=indexPath]){module={id:path,exports:{}};cache[path]=module.exports;fn(module.exports,function(name){return require(name,dirname(path))},module);return cache[path]=module.exports}else{throw"module "+name+" not found"}}};var expand=function(root,name){var results=[],parts,part;if(/^\.\.?(\/|$)/.test(name)){parts=[root,name].join("/").split("/")}else{parts=name.split("/")}for(var i=0,length=parts.length;i<length;i++){part=parts[i];if(part==".."){results.pop()}else{if(part!="."&&part!=""){results.push(part)}}}return results.join("/")};var dirname=function(path){return path.split("/").slice(0,-1).join("/")};this.require=function(name){return require(name,"")};this.require.define=function(bundle){for(var key in bundle){modules[key]=bundle[key]}};this.require.modules=modules;this.require.cache=cache}return this.require}).call(this);this.require.define({"views/color_preview/color_calc":function(exports,require,module){var ColorCalc={validHexRegEx:/^#?[0-9a-f]{3,6}$/i,calculateColors:function(primaryColor){var hex=this.sanitize(primaryColor);if(!hex){return false}var rgb=YAHOO.util.Color.hex2rgb(hex),hsv=YAHOO.util.Color.rgb2hsv(rgb[0],rgb[1],rgb[2]),tabBgColor=this.getTabBgHexFrom(hsv);return{tabBgColor:tabBgColor,tabHoverColor:this.getTabHoverHexFrom(hsv),textColor:this.getTextHexFrom(hsv),borderColor:this.getBorderColor(tabBgColor),bgColor:hex,bodyClass:this.getBodyClass(hsv)}},isValid:function(hex){return this.validHexRegEx.test(hex)},sanitize:function(hex){if(this.isValid(hex)){hex=this.removeHashFrom(hex);hex=this.sixDigit(hex);return hex}else{return false}},removeHashFrom:function(hex){return hex.replace(/#/gi,"")},sixDigit:function(hex){return hex.length===6?hex:hex[0]+hex[0]+hex[1]+hex[1]+hex[2]+hex[2]},themeIsLight:function(hsv){return hsv[2]>0.85},getBodyClass:function(hsv){return this.themeIsLight(hsv)?"custom-branding-light":"custom-branding-dark"},getTabHoverHexFrom:function(hsv){var h=hsv[0],s=hsv[1]*0.62,v=hsv[2]*1.02>1?1:hsv[2]*1.02,hsvNew=this.hsvToHex([h,s,v]);return hsvNew==="FFFFFF"?"E8E8E8":hsvNew},hsvToHex:function(hsv){var rgb=YAHOO.util.Color.hsv2rgb(hsv[0],hsv[1],hsv[2]);return YAHOO.util.Color.rgb2hex(rgb[0],rgb[1],rgb[2])},getTextHexFrom:function(hsv){return this.themeIsLight(hsv)?"2A2A2A":"FFFFFF"},getTabBgHexFrom:function(hsv){var h=hsv[0]*1.03>1?1:hsv[0]*1.03,s=hsv[1]*0.87,v=hsv[2]*0.83;return this.hsvToHex([h,s,v])},getBorderColor:function(hex){var rgb=YAHOO.util.Color.hex2rgb(hex),hsv=YAHOO.util.Color.rgb2hsv(rgb[0],rgb[1],rgb[2]);if(hsv[2]<0.5){hsv[2]*=1.2}else{hsv[2]*=0.8}rgb=YAHOO.util.Color.hsv2rgb(hsv[0],hsv[1],hsv[2]);return YAHOO.util.Color.rgb2hex(rgb[0],rgb[1],rgb[2])}};module.exports=ColorCalc}});this.require.define({"views/color_preview/global_events":function(exports,require,module){var GlobalEvents=(function(){var queues={};return{trigger:function(eventName,data){if(!queues.hasOwnProperty(eventName)){return}for(var i=0;i<queues[eventName].length;i++){queues[eventName][i](data)}},on:function(eventName,listener){if(!queues.hasOwnProperty(eventName)){queues[eventName]=[]}queues[eventName].push(listener)},off:function(eventName,listener){if(!eventName){queues={}}if(!queues.hasOwnProperty(eventName)){return}if(!listener&&eventName){queues[eventName]=[]}if(listener&&eventName){var index=queues[eventName].indexOf(listener);if(index===-1){return}queues[eventName].splice(index,1)}}}}());module.exports=Object.freeze(GlobalEvents)}});this.require.define({"views/color_preview/preview_client":function(exports,require,module){var PreviewClient=(function(){var originalBrandingHtml,colorCalc=require("views/color_preview/color_calc"),previewStateCallback=function(data){if(data.memo.previewing){$j("#inner_branding_styles")[0].outerHTML=data.memo.classic_styles}},previewEndedCallback=function(){$j("#inner_branding_styles")[0].outerHTML=(originalBrandingHtml)};return{init:function(){this.xFrameInit();this.checkPreviewState();return this},xFrameInit:function(){var globalEvents=require("views/color_preview/global_events");originalBrandingHtml=$j("#inner_branding_styles")[0].outerHTML;require("views/color_preview/x_frame_com").setup();globalEvents.on("@action:reset_branding",previewEndedCallback.bind(this));globalEvents.on("@action:preview_state_response",previewStateCallback.bind(this))},checkPreviewState:function(){var xFrameClient=require("views/color_preview/x_frame_client");xFrameClient({target:"check_preview_state",source:"branding_check_preview"})},setBranding:function(color){this.startLotusPreview(color,"save_branding")},startLotusPreview:function(color,target){var xFrameClient=require("views/color_preview/x_frame_client");var colors=colorCalc.calculateColors(color);$j.ajax({url:"/settings/account/preview_branding",type:"POST",data:colors}).done(function(data){$j("#inner_branding_styles")[0].outerHTML=(data.classic_styles);xFrameClient({target:target,source:"branding_preview",memo:{styles:data,currentClassic:originalBrandingHtml,borderColor:colors.bgColor,bodyClass:colors.bodyClass}})})},endLotusPreview:function(){var xFrameClient=require("views/color_preview/x_frame_client");xFrameClient({target:"preview_manager_stop",source:"branding_end_preview"})}}}());module.exports=PreviewClient}});this.require.define({"views/color_preview/x_frame_client":function(exports,require,module){module.exports=function(msg){if(msg!=null&&typeof msg==="object"){msg=JSON.stringify(msg)}var loc=window.location;var origin=loc.protocol+"//"+loc.host;window.top.postMessage(msg,origin)}}});this.require.define({"views/color_preview/x_frame_com":function(exports,require,module){var GlobalEvents=require("views/color_preview/global_events");var isValidOrigin=function(origin){var loc=this.location;var expectedOrigin=loc.protocol+"//"+loc.host;return origin===expectedOrigin};var xFrameMessageHandler=function(event){if(!isValidOrigin(event.origin)){return}var data;try{data=event.data&&JSON.parse(event.data)||{}}catch(e){return}if(!data.target){return}GlobalEvents.trigger("@action:"+data.target,data)};module.exports=Object.freeze({setup:function(){window.top.addEventListener("message",xFrameMessageHandler,false)}})}});Zendesk.NS("CRM");Zendesk.CRM.Application=function(renderer){this.renderer=renderer;this.initialDelay=5000;this.backoff=0};Zendesk.CRM.Application.prototype={renderData:function(records,status){if(status){this.renderer.render(records,status)}else{this.renderer.render(records,"ok")}},fetchAndRenderData:function(url){this.url=url;this._setupPoller();this.renderer.renderWaiting();this.poller.start()},_setupPoller:function(){var self=this;this.poller=new Zendesk.CRM.Poller(function(poller){self._pollerCallback(self,poller)},{initialDelay:this.initialDelay,backoff:this.backoff})},_pollerCallback:function(self,poller){$j.ajax({type:"get",url:this.url,success:function(response){if(response.status==="ok"){self.poller.stop();self.renderData(response.records)}else{if(response.status=="errored"){self.poller.stop();self.renderData(response.records,response.status)}else{self.poller.resume()}}},error:function(){self.poller.stop();self.renderData([],"errored")}})}};Zendesk.NS("CRM");Zendesk.CRM.Poller=function(callback,options){this.initialDelay=options.initialDelay||10000;this.backoff=options.backoff||5000;this.waitForCallback=options.waitForCallback||false;this.callback=callback;this.state="stopped";this.currentDelay=this.initialDelay;this.waitDelay=options.waitDelay||2000;this.debug=!!options.debug;this.trace=""};Zendesk.CRM.Poller.prototype={start:function(){this.state="polling";this._schedulePoll(this.initialDelay);this._trace("[started]")},stop:function(){this.state="stopped"},reset:function(){this.state="resetting"},pause:function(){this.state="paused";this._trace("[paused]")},resume:function(){if(this.state=="paused"){this._trace("[resuming]");this.state="resuming"}},_schedulePoll:function(after){var self=this;setTimeout(function(){self._pollerCallback()},after)},_pollerCallback:function(){if(this.state=="polling"){this.currentDelay=this.currentDelay+this.backoff;var delay=this.currentDelay;if(this.waitForCallback){this._trace("[pausing]");this.pause();delay=this.waitDelay}this._trace("[callback]");this.callback(this);this._schedulePoll(delay)}else{if(this.state=="resetting"){this.state="polling";this.currentDelay=this.initialDelay;this._schedulePoll(this.initialDelay)}else{if(this.state=="paused"){this._trace(".");this._schedulePoll(this.waitDelay)}else{if(this.state=="resuming"){this._trace("[resumed]");this.state="polling";this._schedulePoll(this.currentDelay)}}}}},_trace:function(msg){if(this.debug){this.trace=this.trace+msg}}};Zendesk.NS("CRM");Zendesk.CRM.ProfileRenderer=function(){this.element=$j("#crm_user_data");this.success_template=$j("#crm_template").html();this.error_template=$j("#crm_error_template").html();this.loading=$j("#crm_loading")};Zendesk.CRM.ProfileRenderer.prototype={renderWaiting:function(){this.loading.show()},render:function(records,status){if(status=="ok"){this._renderSuccess(records)}else{if(status=="pending"){this.renderWaiting()}else{this._renderError()}}},_renderSuccess:function(records){var self=this;_(records).each(function(record){record.fields=self._splitFields(record.fields)});var html=$j.mustache(this.success_template,{records:records});this.element.html(html);this.loading.hide()},_renderError:function(){this.element.html(this.error_template);this.loading.hide()},_splitFields:function(fields){var arr=[];var record1,record2;for(var i=0;i<fields.length;i++){record1=fields[i];if(fields[i+1]){record2=fields[i+1];i=i+1}else{record2={label:"&nbsp;",value:"&nbsp;",empty:true}}arr.push({record1:record1,record2:record2})}return arr}};Zendesk.NS("CRM");Zendesk.CRM.SidebarRenderer=function(profile_url){this.element=$j("#crm_user_data");this.success_template=$j("#crm_template").html();this.error_template=$j("#crm_error_template").html();this.loading=$j("#crm_loading");this.profile_url=profile_url;this.fieldsToShow=10};Zendesk.CRM.SidebarRenderer.prototype={renderWaiting:function(){this.loading.show()},render:function(records,status){if(status=="ok"){this._renderSuccess(records)}else{if(status=="pending"){this.renderWaiting()}else{this._renderError()}}},_renderSuccess:function(records){if(records.length>0){var mainRecord=this._addMoreLink(records[0]);var self=this;var subRecords=_(records.slice(1)).map(function(record){return self._addMoreLink(record)});var showMore=subRecords.length}else{var mainRecord=null;var subRecords=null;var showMore=null}var html=$j.mustache(this.success_template,{mainRecord:mainRecord,subRecords:subRecords,showMore:showMore});this.element.html(html);this.loading.hide();var self=this;$j(".crm-records-toggle",self.element).click(function(event){$j("#crm-sub-records",self.element).slideToggle(function(){$j(".crm-records-toggle",self.element).toggle()});event.stopPropagation();event.preventDefault()})},_addMoreLink:function(record){if(record.fields&&record.fields.length>this.fieldsToShow){record.fields=record.fields.slice(0,this.fieldsToShow);record.moreLink=this.profile_url}return record},_renderError:function(){this.element.html(this.error_template);this.loading.hide()}};$z.defModule("entries/_forums2_show",{initialize:function(params){var self=this;self.zd_label_answered=$j("div.frame > div.entry span.zd_label.answered");$j("div#history.frame > div.item").each(function(index,element){var post_id=$j(element).attr("data-post_id");if(params["is_moderator?"]===true){$j(element).find("div.user_formatted span.label_theanswer").click(self.set_the_answer_toggle_option(post_id))}});$j("a[property='is_locked']").click(function(event){$j("div.commenting-controls div.control").toggle()})},set_the_answer_toggle_option:function(post_id){var self=this;return(function(event){var answer_span=$j(this);answer_span.toggleClass("answered").addClass("ajax");var set_answer_label=self.set_answered_label(answer_span.hasClass("answered"));$j.post(answer_span.attr("data-update_answer_path"),{is_answer:answer_span.hasClass("answered")},function(){$j.ajax({url:answer_span.attr("data-is_answered_path"),dataType:"json",type:"GET",success:set_answer_label,complete:function(){answer_span.removeClass("ajax")}})})})},set_answered_label:function(is_answered){var self=this;if(is_answered===true){self.zd_label_answered.addClass("selected")}else{return function(msg){self.zd_label_answered.toggleClass("selected",msg)}}this.zd_label_answered.toggleClass("selected",is_answered)},set_moderator_toggle_option_for:function(property,on){$(property+"_option").children[0].className=(on?"selected":"deselected");$(property+"_option").children[0].className=(on?"deselected":"selected")},set_moderator_idea_label:function(flag){$("flag_option").children[0].className=(flag==1?"selected":"deselected");$("flag_option").children[1].className=(flag==200?"selected":"deselected");$("flag_option").children[2].className=(flag==201?"selected":"deselected")}});$z.defModule("entries/_sidebar_moderator",{initialize:function(params){var self=this;self.moderatorBox=$j("#moderator_box");self.actionDiv=$j("#contentcolumn > div.content > div.action");self.adminLabels=$j("#moderator_box > p.labels");self.zdLabels=$j("div.entry");self.setModeratorToggleOptionFor();self.renderModeratorIdeaLabelFor()},setModeratorToggleOptionFor:function(){var self=this;self.moderatorBox.find("ul.actions > li > a.mod_option").click(self.selectToggle())},renderModeratorIdeaLabelFor:function(){var self=this;self.moderatorBox.find("p.labels > a").click(self.selectToggle())},selectToggle:function(){var self=this;var ajaxOptions={url:$j(this).attr("data-deselected_entry_path"),data:{authenticity_token:Zendesk.currentUser.authenticityToken},dataType:"json",type:"put"};var successFunc=function(state,property){return function(){self.updatePage(state,property)}};return function(event){if($j(this).hasClass("selected")){$j(this).removeClass("selected");ajaxOptions.success=successFunc("deselected",$j(this).attr("property"));ajaxOptions.url=$j(this).attr("data-deselected_entry_path")}else{$j(this).addClass("selected");ajaxOptions.success=successFunc("selected",$j(this).attr("property"));ajaxOptions.url=$j(this).attr("data-selected_entry_path")}$j.ajax(ajaxOptions)}},updatePage:function(state,property){var self=this;switch(property){case"planned":if(state==="selected"){self.adminLabels.find("a.topic_label_done").removeClass("selected");self.adminLabels.find("a.topic_label_not_planned").removeClass("selected");self.zdLabels.find("span.done").removeClass("selected");self.zdLabels.find("span.not_planned").removeClass("selected");self.zdLabels.find("span.planned").addClass("selected")}else{self.adminLabels.find("a.topic_label_planned").removeClass("selected");self.zdLabels.find("span.planned").removeClass("selected");self.zdLabels.find("span.planned").removeClass("selected")}break;case"done":if(state==="selected"){self.adminLabels.find("a.topic_label_planned").removeClass("selected");self.adminLabels.find("a.topic_label_not_planned").removeClass("selected");self.zdLabels.find("span.planned").removeClass("selected");self.zdLabels.find("span.not_planned").removeClass("selected");self.zdLabels.find("span.done").addClass("selected")}else{self.adminLabels.find("a.topic_label_done").removeClass("selected");self.adminLabels.find("span.done").removeClass("done");self.zdLabels.find("span.done").removeClass("selected")}break;case"not_planned":if(state==="selected"){self.adminLabels.find("a.topic_label_planned").removeClass("selected");self.adminLabels.find("a.topic_label_done").removeClass("selected");self.zdLabels.find("span.planned").removeClass("selected");self.zdLabels.find("span.done").removeClass("selected");self.zdLabels.find("span.not_planned").addClass("selected")}else{self.adminLabels.find("a.topic_label_not_planned").removeClass("selected");self.adminLabels.find("span.not_planned").removeClass("done");self.zdLabels.find("span.not_planned").removeClass("selected")}break;case"answered":if(state==="selected"){self.zdLabels.find("span.answered").addClass("selected")}else{self.zdLabels.find("span.answered").removeClass("selected")}break}}});$z.defModule("entries/edit",{initialize:function(params){$("entry_title").focus();$j("form#entryform").submit(function(){if(typeof(entryTagField)!="undefined"){entryTagField.beforeFormSubmit()}if(typeof(entryPhrasesField)!="undefined"){entryPhrasesField.beforeFormSubmit()}})},applyTagsToField:function(field,id,tags,allow_spaces,undefined){var self=this;if(self.fields===undefined){self.fields={}}if(self.fields[field]!==undefined){}else{self.fields[field]=null}$j(function(){function valueTest(value,event){if(allow_spaces==true){return event.keyCode==188||event.keyCode==13}else{return true}}self.fields[field]=new Autocompleter.MultiValue(id,Autocompleter.cachedLookupTag,tags,{frequency:0.3,minChars:2,acceptNewValues:true,newValueChecker:valueTest})})}});$z.defModule("entries",{});$z.defModule("entries/index",{initialize:function(){}});$z.defModule("entries/show",{initialize:function(params){if(typeof(currentUser)!=="undefined"){$j("input[name='authenticity_token']").each(function(){$j(this).attr("value",currentUser.authenticityToken)})}$z("forums/index").initialize()},showFormFor:function(postId){$j("#view-post-"+postId).hide();$j("#edit-post-"+postId).show();tinyMCE.execCommand("mceAddControl",false,"post-edit-field-"+postId);InputTracking.fixSubmit($("post-edit-form-"+postId),"onsubmit");$j("#edit-link-for-"+postId).removeAttr("onclick");$j("#edit-link-for-"+postId).click(function(){$j("#view-post-"+postId).hide();$j("#edit-post-"+postId).show();return false})},hideFormFor:function(postId){$j("#edit-post-"+postId).hide();$j("#view-post-"+postId).show();InputTracking.trackedElements=[]}});$z.defModule("feeds/index",{initialize:function(){},renderLatestComment:function(nice_id){$j.ajax({url:"/tickets/"+nice_id+"/events?for=feed&filter=latest",dataType:"html",context:$j("#"+nice_id+"-reply"),success:function(transport){$j("#"+nice_id+"-ticket-form").hide();$j("#ticket-form").appendTo($j("#ticket-form-home"));this.replaceWith(transport)}})},renderRemainingComments:function(nice_id){this.remoteCall("/tickets/"+nice_id+"/events?for=feed&filter=remaining","li#"+nice_id+"-all")},renderCommentBody:function(comment_id){this.remoteCall("/events/"+comment_id+"?for=feed","span#"+comment_id+"-comment-body")},remoteCall:function(url,context){$j.ajax({url:url,dataType:"html",context:$j(context),success:function(transport){this.replaceWith(transport)}})},renderTicketForm:function(nice_id,status_id,priority_id,group_id,assignee_id){$j(".fake-text-area").show();$j("#show-ticket-properties").show();$j("#ticket-properties").hide();$j("#ticket-status-new").prop("disabled",status_id!="0");$j("#"+nice_id+"-fake-reply").hide();$j("#ticket-form").appendTo($j("#"+nice_id+"-ticket-form"));$j("#ticket_status_id").val(status_id);$j("#ticket_priority_id").val(priority_id);$j("#ticket_group_id").val(group_id);$j("#ticket_assignee_id").val("");$j("#comment_value").val("");$j("#comment_is_public").prop("checked",false);updateProperties(assignee_id);$j("#"+nice_id+"-ticket-form").show();$j("#ticket-form").show();$j("#comment_value").focus()}});(function($){function showBounds(bounds){var div=$("<div/>").css({position:"absolute",left:bounds.left+"px",top:bounds.top+"px",width:(bounds.right-bounds.left)+"px",height:(bounds.bottom-bounds.top)+"px",outline:"red 1px solid"});$("body").append(div);window.setTimeout(function(){div.remove()},1000)}$.fn.bounds=function(withPadding,withMargin){withPadding=withPadding||withMargin;var bounds={left:Number.POSITIVE_INFINITY,top:Number.POSITIVE_INFINITY,right:Number.NEGATIVE_INFINITY,bottom:Number.NEGATIVE_INFINITY,width:function(){return this.right-this.left},height:function(){return this.bottom-this.top},show:function(){showBounds(this);return this},toString:function(){return JSON.stringify(this)}};this.each(function(i,el){var elQ=$(el),off=elQ.offset();if(withPadding){off.right=off.left+$(elQ).outerWidth(withMargin);off.bottom=off.top+$(elQ).outerHeight(withMargin)}else{off.right=off.left+$(elQ).width();off.bottom=off.top+$(elQ).height()}if(off.left<bounds.left){bounds.left=off.left}if(off.top<bounds.top){bounds.top=off.top}if(off.right>bounds.right){bounds.right=off.right}if(off.bottom>bounds.bottom){bounds.bottom=off.bottom}});return bounds}})($j);(function($){$.fn.filterOrFind=function(selector){var $this=$(this);return $this.find(selector).add($this.filter(selector))}})($j);(function(){var forumsSearch=Zendesk.NS("Forums.Search");$z.defModule("forums/_search",{initialize:function(params){params=params||{};params.forumsSearch=true;forumsSearch.Instant.setup(params);forumsSearch.Autocomplete.setup(params)}})})();$z.defModule("forums/form",{initialize:function(params){$j("input#forum_visibility_restriction_id_1, input#forum_visibility_restriction_id_2").click(function(){$j("#forum_is_locked_false").prop("disabled",false);$j(".forum-language-selector").show("slow")});$j("input#forum_visibility_restriction_id_3").click(function(){$j("#forum_is_locked_false").prop("disabled",true);$j("#forum_is_locked_true").prop("checked",true);$j(".forum-language-selector").hide();$j("#forum_translation_locale_id").val("")});$j("form.edit_forum").submit(function(){if(typeof(forumTagField)!="undefined"){forumTagField.beforeFormSubmit()}})}});(function(){function setNav(active){if(active!="stats"){$j(".sparkline").removeClass("active")}$j(".forum-nav a.active").removeClass("active");if(active){$j("#forum_nav_"+active).addClass("active")}else{$j(".forum-nav a:first").addClass("active")}}function setUpCategoryHeaders(){if($j(".category-header").attr("id")){$j(".category-header").map(function(x,el){categoryTopRightEdit($j(el).attr("id"));makeCategorizedForumsDraggable($j(el).parent().find(".category").attr("id"))});$j(".buttons-right .reorder").show();addCategoryReordering();categoryDescription();$j(".category-header").show()}else{return false}}function fetchContent(section){$j(".buttons-right .reorder").hide();$j("#detailed_stats_graph_container").hide();$j("#content_entries .frame:first").html('<div id="topic_search_loading" class="loading"></div>');$j.ajax({url:$j("#forum_nav_"+section).attr("url"),data:{xhr:true}}).done(function(body){$j("#content_entries").html(body);$j("#search-result").paginateResults();$j(".forum_tabs").trigger("events-loaded.entries.zendesk");if(section=="overview"){setUpCategoryHeaders()}});setNav(section)}function showCommentSection(){$j("#comments_section").show();setNav("comments")}var forum_module={initialize:function(params){params=params||{};params.scopeSammyTo=params.scopeSammyTo||".forum_tabs";$j(".category li span").truncateViaFade();this.sammy_app=$j.sammy(params.scopeSammyTo,function(){this.get("#stats/:statName",function(){$j(".buttons-right .reorder").hide();$j("#comments_section").hide();var statName=this.params.statName;Zendesk.Stats.ForumUI.showDetailGraph(".sparkline#"+statName);setNav("stats")});this.get("#stats",function(){$j(".buttons-right .reorder").hide();$j("#comments_section").hide();Zendesk.Stats.ForumUI.showDetailGraph(".sparkline:first");setNav("stats")});this.get("#overview",function(){fetchContent("overview")});this.get("#recent",function(){fetchContent("recent")});this.get("#popular",function(){fetchContent("popular")});this.get("#unanswered",function(){fetchContent("unanswered")});this.get("#answered",function(){fetchContent("answered")});this.get("#planned",function(){fetchContent("planned")});this.get("#not_planned",function(){fetchContent("not_planned")});this.get("#done",function(){fetchContent("done")});this.get("#comments",function(){showCommentSection()});this.get("",function(){$j("#detailed_stats_graph_container").hide();var firstTab=$j(".forum-nav a:first").attr("href");if(firstTab){if(firstTab=="#comments"){showCommentSection();return false}setNav(firstTab.replace("#",""));setUpCategoryHeaders();$j(".forum_tabs").trigger("events-loaded.entries.zendesk")}})});Zendesk.Stats.ForumUI.setup(this.sammy_app);this.sammy_app.disable_push_state=true;this.sammy_app.run()}};$z.defModule("forums/index",forum_module);$z.defModule("forums/show",forum_module);$z.defModule("forums/forums1_index",forum_module);$z.defModule("forums/forums2_index",forum_module)}());var HeaderRenderer={};HeaderRenderer.hasRenderedTopRight=false;HeaderRenderer.renderTopRight=function(){var topRight=$j("#top-right");if(!topRight||HeaderRenderer.hasRenderedTopRight){return}HeaderRenderer.hasRenderedTopRight=true;var menuItems=[];if(currentUser){if(!currentUser.isAnonymous){var name=currentUser.first_name;if(currentAccount.isSandbox){name=name+" (SANDBOX)"}if(currentUser.isAgent||currentAccount.showUserProfile){menuItems.push($j("<a />",{id:"top-right-name",href:"/users/"+currentUser.id,html:name}))}else{menuItems.push($j("<span/>",{id:"top-right-name",html:name}));if(currentAccount.showChangePassword){menuItems.push($j("<a/>",{href:"/password",text:I18n.t("txt.layout.change_pwd")}))}}if(currentUser.localeIsDifferent){menuItems.push($j("<a />",{href:"?locale="+currentUser.locale_id,text:currentUser.localeIsDifferent}))}}if(currentUser.isAdmin||(currentUser.isAgent&&(currentAccount.isLotusVisibleToAgents||currentAccount.doAgentsPreferLotus))){var linkText=(currentAccount.doAgentsPreferLotus)?I18n.t("txt.views.shared.header.back_to_agent"):I18n.t("txt.views.shared.header.try_the_new_zendesk"),linkUrl="https://"+currentAccount.subdomain+"."+currentAccount.domain+"/agent/";if(window.ticket_id){linkUrl+="#/tickets/"+window.ticket_id}menuItems.push('<a href="/?return_to='+escape(linkUrl)+'">'+linkText+"</a>")}if(currentUser.isAgent&&currentAccount.lastTrialDay){menuItems.push(I18n.t("txt.admin.public.javascript.header_renderer.days_left_in_trial_label_with_params",{count:currentAccount.daysLeftInTrial}));jQuery("#expires_badge .count").text(currentAccount.daysLeftInTrial)}if(currentUser.isAdmin){menuItems.push('<a href="http://support.zendesk.com">'+I18n.t("txt.admin.public.javascript.header_renderer.help")+"</a>")}if(currentUser.assumed){menuItems.push('<a href="/users/revert">'+I18n.t("txt.javascript.views.agent_console.revert_identity")+"</a>")}if(currentUser.isAnonymous){var return_to=document.location.href.replace(/\/home\/?$/,"/");menuItems.push($j("<a/>",{href:"/login?return_to="+escape(return_to),text:I18n.t("txt.layout.login")}));if(currentAccount&&currentAccount.isOpen&&!currentAccount.hasRemoteAuthentication){menuItems.push($j("<a/>",{href:"/registration",text:I18n.t("txt.layout.signup")}))}}else{menuItems.push($j("<a/>",{href:"/access/logout",text:I18n.t("txt.layout.logout")}))}}if(Zendesk.viewedOnMobileDevice&&currentAccount.hasFeature("mobile")){var returnToUrl=document.location.href;menuItems.push('<a href="/mobile/switch?return_to='+escape(returnToUrl)+'">'+I18n.t("txt.views.shared.header.go_to_mobile_site")+"</a>")}if(menuItems.length>0){topRight.append(menuItems.shift());menuItems.each(function(item){topRight.append(" | ");topRight.append(item)})}};function buildOrganizationLink(organization,klass){var path=currentAccount.urlPrefix+"/organizations/"+organization.id+"/requests";var attributes={href:path,text:organization.name.truncate(35)};if(klass){attributes["class"]=klass}return $j("<a>",attributes)[0]}HeaderRenderer.hasUpdatedTabs=false;HeaderRenderer.updateTabs=function(){var topMenu=$j("#top-menu > ul#green").first();if(!topMenu||HeaderRenderer.hasUpdatedTabs){return}HeaderRenderer.hasUpdatedTabs=true;if(currentUser){if(currentUser.isAnonymous){if(!currentAccount.isOpen){topMenu.find("> li:not(.right, .tab_home)").remove()}else{if(!currentAccount.hasRemoteAuthentication&&!currentUser.hasEmail){topMenu.find("> li.tab_new a").attr("href","/anonymous_requests/new")}}}if(currentUser.accessibleForums){var forumsTab=$j('<li class="main tab_forums"/>');forumsTab.append($j("<a/>",{"class":"tab",href:"/forums",text:currentAccount.forumsTitle}));topMenu.find("> li.tab_home").after(forumsTab)}if(currentUser.isEndUser){var previousTab=topMenu.find("> li:not(.right)").last();var organizationTab=$j('<li class="main tab_organization"/>');if(currentUser.canViewMultipleOrganizations){organizationTab.append($j("<a/>",{"class":"tab",href:"#",text:I18n.t("txt.layout.organization_requests")}));var temp=$j('<ul class="menu-drop">');currentUser.sharedOrganizations.each(function(org,index){var organizationListItem=$j("<li>").append(buildOrganizationLink(org))[0];temp.append(organizationListItem)});organizationTab.append(temp)}else{if(currentUser.canViewOrganization){organizationTab.append(buildOrganizationLink(currentUser.organization,"tab"))}else{if(currentUser.sharedOrganizations.length){organizationTab.append(buildOrganizationLink(currentUser.sharedOrganizations[0],"tab"))}}}previousTab.after(organizationTab)}}topMenu.find("> li.first").removeClass("first");topMenu.find("> li.active").removeClass("active");topMenu.find("> li").first().addClass("first");topMenu.find("> li").addClass("main");var activeTab=topMenu.find("> li.tab_"+Zendesk.tab);activeTab.removeClass("main").addClass("active");activeTab.next().addClass("first")};if(typeof(currentUser)!=="undefined"){HeaderRenderer.renderTopRight();HeaderRenderer.updateTabs()}(function(){var forumsSearch=Zendesk.NS("Forums.Search");$z.defModule("home/_home_page_search_box",{initialize:function(params){params=params||{};params.homePageSearch=true;forumsSearch.Autocomplete.setup(params)}})})();$z.defModule("home/index",{initialize:function(){if(currentUser.isAgent){$j("#dashboard").ready(function(){$j("#dashboard").show();$j.get("/home/dashboard",function(data){$j("#dashboard").html(data).show()})})}if(currentUser.isAdmin){new IntroductoryTextForm()}if(currentUser.managePinnedOrder){$z("home/reorder_pinned_entries").initialize()}$z("forums/index").initialize()}});(function(window,$){var IntroductoryTextForm=window.IntroductoryTextForm=function(){this.form=$("#introductory_text .introductory_text_form");this.display=$("#introductory_text .introductory_display_texts");this.editLink=this.display.find(".edit_this");this.cancelLink=this.form.find(".cancel_link");this.setup()};IntroductoryTextForm.prototype={setup:function(){var scope=this;this.form.hide();this.editLink.click(function(){scope.display.hide();scope.form.show()});this.cancelLink.click(function(){scope.form.hide();scope.display.show()})}}}(window,$j));(function($,_){var pinnedEntriesReorderingTemplate,$showLink,$thingsToHideWhileReordering,$widgetContainer,$pinnedEntriesReorderer,$spinner;function onSaveSuccess(){document.location.href="/home"}function onSaveError(){alert("Sorry, there was an error saving your changes.")}function saveOrder(){var $this=$(this);var idsAsQuery=$pinnedEntriesReorderer.find("ol").sortable("serialize",{key:"ids[]"});if(idsAsQuery=="ids[]="){idsAsQuery=""}else{idsAsQuery=idsAsQuery+"&"}$.ajax({url:$this.attr("action"),type:$this.attr("method"),data:idsAsQuery+$this.serialize(),success:onSaveSuccess,error:onSaveError});return false}function hidePinnedEntriesReorderer(){$widgetContainer.hide();$thingsToHideWhileReordering.show();$pinnedEntriesReorderer.remove();$pinnedEntriesReorderer=null}function addReorderingBehavior(){$pinnedEntriesReorderer.find("a.cancel").click(function(){hidePinnedEntriesReorderer();return false}).end().find("form").submit(saveOrder);var lists=$pinnedEntriesReorderer.find("ul,ol");lists.each(function(){$(this).sortableWithEmptyTarget({emptyTargetText:I18n.t("txt.admin.views.home._reorder_pinned_entries.drag_topics_here_label"),emptyTargetClass:"item sortable",axis:"y",placeholder:"sortable item target",connectWith:lists.not(this)})})}function hasPinnedIndex(entry){return !!entry.pinned_index}function renderPinnedEntriesReorderer(){if($pinnedEntriesReorderer){return}$.getJSON($showLink.attr("href"),null,function(pinnedEntries){pinnedEntries=_(pinnedEntries);$pinnedEntriesReorderer=$($.mustache(pinnedEntriesReorderingTemplate,{orderedEntries:pinnedEntries.select(hasPinnedIndex),unorderedEntries:pinnedEntries.reject(hasPinnedIndex)})).appendTo($widgetContainer);$spinner.hide();addReorderingBehavior()})}function showPinnedEntriesReorderer(){$thingsToHideWhileReordering.hide();$widgetContainer.show();renderPinnedEntriesReorderer()}function initialize(){pinnedEntriesReorderingTemplate=$("#reorder_pinned_entries_template").html();$widgetContainer=$('<div class="frame"></div>').hide().insertAfter($("#pinned_topics_title"));$spinner=$('<div class="loading">&nbsp;</div>').appendTo($widgetContainer);$showLink=$("#show_pinned_entries_reordering").click(function(){showPinnedEntriesReorderer();return false});$thingsToHideWhileReordering=$("#pinned-entries-frame, #entries_pagination").add($showLink)}$z.defModule("home/reorder_pinned_entries",{initialize:initialize})}(this.jQuery,this._));jQuery(function($){var $searchForm=$(".home #suggest_form");if($searchForm.length===0){return}var $searchResultsContainer=$("#topic_search"),$searchOutput=$("#topic_search_result"),$searchLoader=$("#topic_search_loading"),$moreResults=$("#show_more_results");function onSearchResults(content){$searchLoader.removeClass("loading");$searchResultsContainer.show();$searchOutput.html(content);var nextPage=Zendesk.ResultsPaginator.parseNextPageFrom($searchOutput);if(nextPage==null){$moreResults.hide();if($searchOutput.is(":empty")){$searchOutput.html('<h2 class="empty_suggestion_set">'+I18n.t("txt.entries.list.empty")+"</h2>")}}else{$searchOutput.paginateResults()}}function onSearch(event){$searchResultsContainer.hide();$searchLoader.addClass("loading");$searchOutput.html("");$.get("/categories/search_for_home_page_box?"+$searchForm.serialize(),{format:"html",for_search:1,page:1}).done(onSearchResults);return false}$searchForm.submit(onSearch)});if(!this.Zendesk){this.Zendesk={}}(function($,console,Zendesk,_){Zendesk.Banner={containerSelector:"#banners",container:function(){var self=Zendesk.Banner;var container=$(self.containerSelector);if(container.length<=0){console.error("Could not find a banner container. Do you have an "+self.containerSelector+" element?")}else{return self._bindIgnoreEventListenerIfNeeded(container)}},templateSelector:"#banner-item-template",template:function(){var self=Zendesk.Banner;if(!self._template){var templateContainer=$(self.templateSelector).first();if(templateContainer.length<=0){console.error("Could not find a Banner template. Do you have an "+self.templateSelector+" element?")}else{self._template=templateContainer.html()}}return self._template},_ignoreEventListenerBound:false,_bindIgnoreEventListenerIfNeeded:function(container){var self=Zendesk.Banner;if(!self._ignoreEventListenerBound){container.bind("ignore.zd.banner",function(event,banner){banner.disappear();return true});container.bind("reload.zd.banner",function(event,banner){window.location.reload(true);return true});self._ignoreEventListenerBound=true}return container},create:function(options){var self=Zendesk.Banner;var banner=$.extend({},self._buildLI(options||{}),self._enhancements);$(banner).find(".ignore").click(function(){$(banner).trigger("ignore.zd.banner",[banner])});$(banner).find(".reload a").click(function(){$(banner).trigger("reload.zd.banner",[banner]);return false});return banner.appendTo(self.container())},_buildLI:function(options){var li=$($.mustache(Zendesk.Banner.template(),{text:(options.text||"")}));if(!(options.visible)){li.hide()}["icon","ignore","reload"].each(function(property){if(options[property]===false){li.find("."+property).hide()}});return li},_enhancements:{toString:function(){return"<banner text="+this.content().text()+">"},setContent:function(content){this.content().html(content);return this},appear:function(callback){var self=this;self.slideDown(null,function(){self.trigger("appear.zd.banner",[self]);callback&&callback()});return self},disappear:function(callback){var self=this;self.slideUp(null,function(){self.trigger("disappear.zd.banner",[self]);callback&&callback()});return self},visible:function(){return this.filter(":visible").length>0},hidden:function(){return this.filter(":hidden").length>0}}};_(["icon","content","ignore","reload"]).each(function(component){Zendesk.Banner._enhancements[component]=function(){return $(this).find("."+component)}})})(this.jQuery,this.console,this.Zendesk,this._);$z.defModule("people/bulk_delete/index",{initialize:function(){this.form=$j("#bulk_form");this.check=$j("#bulk_check_all");this.submitBtn=$j("#bulk_submit");this.checkboxes=$j("#bulk_form .bulk_check_one");this.toggleBulkSubmit();this.check.change($j.proxy(this.manageBulkUpdate,this));this.checkboxes.change($j.proxy(this.toggleBulkSubmit,this));this.submitBtn.click($j.proxy(this.submitBulkForm,this))},manageBulkUpdate:function(e){var bulkCheckSelected=this.check.prop("checked");this.checkboxes.prop("checked",bulkCheckSelected);this.toggleBulkSubmit()},submitBulkForm:function(e){if(e){e.stopPropagation();e.preventDefault()}if(!this.anyChecked()){return}$j("#bulk_spinner").show();$j.ajax({type:this.form.attr("method"),url:this.form.attr("action"),data:this.form.serialize(),success:function(response){clearFlash();$j.colorbox({html:response});$j("#bulk_spinner").hide()},error:function(response){showFlash("Error:"+response,"error");$j("#bulk_spinner").hide()}})},toggleBulkSubmit:function(e){var checked=this.anyChecked();this.submitBtn.prop("disabled",!checked);this.submitBtn.toggleClass("button_disabled",checked)},anyChecked:function(){return $j("#bulk_form .bulk_check_one:checked").length>0}});Zendesk.NS("Groups");Zendesk.Groups.DeletionVerifier=function(containerSelector){this.form=$j(containerSelector)};Zendesk.Groups.DeletionVerifier.prototype={init:function(){this.attachHandlers()},attachHandlers:function(){var self=this;this.form.find("#delete-group").click(function(e){self.showModal()})},showModal:function(){var self=this;$j.colorbox({href:"./confirm_delete",inline:false,onComplete:function(){self.attachModalHandlers()}})},attachModalHandlers:function(){$j("#group-delete-confirm #cancel-delete").click(this.closeModal)},closeModal:function(){$j.colorbox.close()}};$z.defModule("people/groups/edit",{initialize:function(){this.verifier=new Zendesk.Groups.DeletionVerifier("#account-settings");this.verifier.init()}});$z.defModule("people/groups/show",{initialize:function(){$z("people/search/index").initialize()}});$z.defModule("people/organizations/edit",{initialize:function(organizationId){$j("form#account-settings").submit(function(){if(typeof(organizationTagField)!="undefined"){organizationTagField.beforeFormSubmit()}})}});$z.defModule("people/organizations/show",{initialize:function(){$z("people/search/index").initialize()}});Zendesk.NS("People.Passwords",function($j){var sentSequenceNumber=0;var recvSequenceNumber=0;var showPasswordValidations=function(data){var incomingSequenceNumber=data.sequence;if(incomingSequenceNumber<recvSequenceNumber){return}recvSequenceNumber=incomingSequenceNumber;var errors=_(data.errors);var passwordRequirements=$j("#password_requirements ul li");_(passwordRequirements).each(function(e){var element=$j(e);var errorText=$j.trim(element.text());if(errors.contains(errorText)){element.addClass("invalid").removeClass("valid")}else{element.addClass("valid").removeClass("invalid")}})};$j(document).ready(function(){$j(".validate_password").keyup(function(event){var url=currentAccount.secureUrlPrefix+"/password/validate_password";$j.ajax({type:"POST",url:url,data:{password:$j(this).val(),user_security_policy_id:$j("#user_security_policy_id").val(),sequence:sentSequenceNumber+=1},success:showPasswordValidations})})})},jQuery);Zendesk.NS("People.Roles",function($j){var ticketAccess=$j("#permission_set_permissions_ticket_access");var forumAccess=$j("#permission_set_permissions_forum_access");var peopleAccess=$j("#permission_set_permissions_end_user_profile");var peopleListAccess=$j("#permission_set_permissions_available_user_lists");var form=$j("#permission_set_form");var isLightAgent=form.data("light-agent");function setupAssignedTicketsOnlyDependencies(ticketAccess){var ticketAccessMessage=$j("#ticket_access_message");var assignToAnyGroup=$j("#assign_to_any_group");var ticketEditing=$j("#permission_set_permissions_ticket_editing");var ticketEditingLabel=$j("label[for='permission_set_permissions_ticket_editing']");var disableDependency=function(){var tooltip="To deselect this option, you must change ticket access selection";ticketEditing.prop("checked",true).prop("disabled",true).prop("title",tooltip).change();ticketEditingLabel.prop("title",tooltip)};var enableDependency=function(){ticketEditing.prop("disabled",isLightAgent).removeAttr("title");ticketEditingLabel.removeAttr("title")};var showGroupMessage=function(){ticketAccessMessage.html(I18n.t("txt.admin.javascrips.views.people.roles.user_belongs_group")).show()};var showAssignToAnyGroup=function(){assignToAnyGroup.show()};var showOrganizationMessage=function(){ticketAccessMessage.html(I18n.t("txt.admin.javascrips.views.people.roles.user_belongs_organization")).show()};var hideMessage=function(){ticketAccessMessage.hide()};var hideAssignToAnyGroup=function(){assignToAnyGroup.hide()};var interactions={"assigned-only":[hideMessage,hideAssignToAnyGroup,disableDependency],"within-groups":[showGroupMessage,showAssignToAnyGroup,enableDependency],"within-organization":[showOrganizationMessage,hideAssignToAnyGroup,enableDependency],all:[hideMessage,hideAssignToAnyGroup,enableDependency]};if(ticketEditing.exists()){ticketAccess.selectInteraction(interactions)}}function setupForumFullAccessDependencies(forumAccess){var forumRestrictedContent=$j("#permission_set_permissions_forum_access_restricted_content");var forumRestrictedContentLabel=$j("label[for='permission_set_permissions_forum_access_restricted_content']");var manageHelpCenter=$j("#permission_set_manage_help_center");var lockFullAccess=function(){var tooltip="To deselect this option, you must change forums editing permission";forumRestrictedContent.prop("checked",true).prop("disabled",true).prop("title",tooltip);forumRestrictedContentLabel.prop("title",tooltip)};var unlockFullAccess=function(){forumRestrictedContent.prop("disabled",false).removeAttr("title");forumRestrictedContentLabel.removeAttr("title")};var interactions={full:lockFullAccess,"default-interaction":unlockFullAccess};if(forumRestrictedContent.exists()){forumAccess.selectInteraction(interactions)}if(manageHelpCenter.exists()){manageHelpCenter.prop("disabled",isLightAgent)}}function setupPeopleListDependencies(peopleListAccess){var customerListAccess=$j("#user_view_access");var showDependency=function(){customerListAccess.slideDown()};var hideDependency=function(){customerListAccess.slideUp()};var interactions={none:hideDependency,all:showDependency,"default-interaction":hideDependency};$j(peopleListAccess).selectInteraction(interactions)}function setupPeopleDependencies(peopleAccess){var peopleDependencies=$j("#people_editing_options");var groupOrgRestriction=$j("#permission_set_permissions_edit_organizations");var showDependency=function(){peopleDependencies.slideDown();groupOrgRestriction.prop("disabled",false)};var hideDependency=function(){peopleDependencies.slideUp();groupOrgRestriction.prop("disabled",true)};var interactions={edit:showDependency,full:showDependency,"default-interaction":hideDependency};$j(peopleAccess).selectInteraction(interactions)}function setupPermissionDependencies(){if(ticketAccess.exists()){setupAssignedTicketsOnlyDependencies(ticketAccess)}if(forumAccess.exists()){setupForumFullAccessDependencies(forumAccess)}if(peopleAccess.exists()){setupPeopleDependencies(peopleAccess)}if(peopleListAccess.exists()){setupPeopleListDependencies(peopleListAccess)}}function setupLightAgentForm(){var assignToAnyGroupField=$j("[name='permission_set[permissions][assign_tickets_to_any_group]']"),reportAccessField=$j("[name='permission_set[permissions][report_access]']"),viewSatisfactionPrediction=$j("[name='permission_set[permissions][view_ticket_satisfaction_prediction]']");reportAccessField.find("option[value='full']").remove();form.find(":input").not(":submit, [name='_method'], [name='authenticity_token']").not(ticketAccess).not(assignToAnyGroupField).not(reportAccessField).not(viewSatisfactionPrediction).prop("disabled",true)}$j(document).ready(function(){setupPermissionDependencies();if(isLightAgent){setupLightAgentForm()}})},this.jQuery);function UserMergeWizard(redirectToWinner){this.redirectToWinner=redirectToWinner;this.registerEvents()}UserMergeWizard.prototype={redirectToWinner:false,lookupUser:function(loser,searchTerm,callback){new Ajax.Request("/users/"+loser+"/merge/autocomplete",{method:"GET",parameters:{name:searchTerm,rand:(new Date()).getTime()},onSuccess:function(response){callback(response.responseJSON)}})},registerEvents:function(){var self=this;$j("#merge_link").live("click",function(){$j.colorbox({href:$j(this).attr("href"),onComplete:function(){var loser=self.winnerForm().attr("data-loser");var cache=new Autocompleter.Cache(self.lookupUser.curry(loser));new Autocompleter.Json("winner","winner_auto_complete",cache.lookup.bind(cache),{frequency:0.1,minChars:3});$j("input[placeholder]").placeholder()}});return false});self.winnerLinks().live("click",function(){$j.colorbox({href:$j(this).attr("href")});return false});self.winnerForm().live("submit",function(){$j.ajax({type:$j(this).attr("method"),data:$j(this).serialize(),url:$j(this).attr("action"),success:function(response){$j.colorbox({html:response})},error:function(request,textStatus,errorThrown){$j.colorbox({html:request.responseText})}});return false});self.confirmForm().live("submit",function(){var button=self.confirmButton();button.val(I18n.t("txt.user.merge.merging_users"));button.prop("disabled",true);var form=self.confirmForm();var accountId=form.data("account-id");var winnerId=form.data("winner-id");var loserId=form.data("loser-id");var radarKeyName="user_merge/"+accountId+"/"+winnerId+"/"+loserId;RadarClient.initialize(function(){RadarClient.alloc("user_merge",function(){RadarClient.status(radarKeyName).on(function(msg){var newForm;if(msg.value===true){newForm=jQuery("<form>",{action:"/users/"+winnerId+"/merge_complete",method:"post","accept-charset":"UTF-8"}).append(jQuery("<input>",{name:"merge_status",value:1,type:"hidden"})).append(jQuery("<input>",{name:"utf8",value:"✓",type:"hidden"})).append(jQuery("<input>",{name:"loser",value:form.data("loser-name"),type:"hidden"})).append(jQuery("<input>",{name:"authenticity_token",value:$j('meta[name="csrf-token"]').attr("content"),type:"hidden"}))}else{newForm=jQuery("<form>",{action:"/users/"+loserId+"/merge_complete",method:"post","accept-charset":"UTF-8"}).append(jQuery("<input>",{name:"merge_status",value:0,type:"hidden"})).append(jQuery("<input>",{name:"utf8",value:"✓",type:"hidden"})).append(jQuery("<input>",{name:"authenticity_token",value:$j('meta[name="csrf-token"]').attr("content"),type:"hidden"}))}newForm.appendTo("body").submit()}).subscribe(function(){$j.ajax({data:form.serialize(),type:"POST",url:form.attr("action")+"?format=js",error:function(request,textStatus,errorThrown){$j.colorbox({html:request.responseText});button.val(I18n.t("txt.user.merge.confirm_and_merge"));button.prop("disabled",false)}})})})});return false})},winnerForm:function(){return $j("#winner_form")},winnerField:function(){return this.winnerForm().find("input[type='text']")},continueButton:function(){return this.winnerForm().find("input[type='submit']")},winnerLinks:function(){return $j(".winner_selector")},confirmForm:function(){return $j("#confirm_merge_form")},confirmButton:function(){return this.confirmForm().find("input[type='submit']")}};$z.defModule("people/users/edit",{initialize:function(userId){var self=this;this.confirmationMessages={leavingLegacy:I18n.t("txt.admin.public.javascripts.views.people.users_edit.assigning_new_role"),downgradingRole:I18n.t("txt.admin.public.javascripts.views.people.users_edit.downgrading_role")};var $userVoiceNumber=$j("#user_voice_number"),$callButton=$j("#test_call_button");if($userVoiceNumber.exists()){if($j.trim($userVoiceNumber.val())!==""){$callButton.removeAttr("disabled")}$userVoiceNumber.live("keyup",function(event){if($j.trim($j(event.currentTarget).val())===""){$callButton.attr("disabled","disabled")}else{$callButton.removeAttr("disabled")}})}if($j("#original_roles").exists()){this.setupNonEnterpriseRoles(userId);$j("#user_default_group_id").live("change",function(){var selectedGroupId=$j(this).val();$j("#user_groups_"+selectedGroupId).prop("checked",true)})}else{$j("#user_default_group_id").change(function(){self.enableGroup($j("#group_"+$j(this).val()))});self.enableGroup($j("#group_"+$j("#user_default_group_id").val()))}var roleGroupsForm=$j("#role_and_groups_form");this.formElm=roleGroupsForm.exists()?roleGroupsForm:$j("#user-form");if($j(".role_groups").exists()){$j(".user_type, #user_role_or_permission_set").change($j.proxy(this.manageRoleDisplay,this));this.manageRoleDisplay();$j("#group_tiles .tile").click(function(evt){var clickedGroupElm=$j(evt.target).hasClass("tile")?$j(evt.target):$j(evt.target).parents(".tile");self.selectGroup(clickedGroupElm)});this.formElm.submit($j.proxy(this.confirmSaveForEnterprise,this))}else{this.formElm.submit({userId:userId},$j.proxy(this.confirmSave,this))}$j("form#user-form [type=submit]").bind("click",function(e){if(typeof(userTagField)!="undefined"){userTagField.beforeFormSubmit()}});if($j("#identities").exists()){$j(".email.unverified_email .add_identity, .twitter .add_identity, .google .add_identity, .facebook .add_identity").colorbox({onComplete:function(){$j("#focus").focus()}});this.identitiesManager=new Zendesk.IdentitiesManager(userId,$j.proxy(this.setupPrimary,this));this.renderIdentities(userId)}$j("#status_spinner").addClass("spinner small").hide();$j("#test_call_button").click(function(event){event.preventDefault();$j("#test_call_status").removeClass("test_call_error");if($j("#test_call_button").val()===I18n.t("txt.admin.views.people.users.basic_info.test_call")){var number=$j("#user_voice_number").val();$j("#test_call_button").val(I18n.t("txt.admin.assets.javascripts.views.people.users.users-edit.calling")+"...");$j("#test_call_status").html(I18n.t("txt.admin.assets.javascripts.views.people.users.users-edit.dialing",{number:number}));var data=self.prepCallData(number,$j("#user_voice_extension").val());$j("#status_spinner").fadeIn("slow");var call_sid=$j.post("/api/v2/channels/voice/agent_verification/call",data,function(sid){return sid});function checkStatus(){var status=$j.get("/api/v2/channels/voice/agent_verification/status",{call_sid:call_sid.responseText},function(current_status){return current_status});status.always(function(){var state=status.responseText;if(state==="queued"||state==="ringing"||state==="retry"){setTimeout(checkStatus,500)}else{if(state==="in-progress"){$j("#test_call_status").html(I18n.t("txt.admin.assets.javascripts.views.people.users.users-edit.forward_success",{number:number}));setTimeout(checkStatus,500)}else{if(state==="completed"){$j("#test_call_status").html(I18n.t("txt.admin.assets.javascripts.views.people.users.users-edit.test_success"));$j("#test_call_button").val(I18n.t("txt.admin.views.people.users.basic_info.test_call"));$j("#status_spinner").fadeOut("slow")}else{$j("#test_call_status").html(I18n.t("txt.admin.assets.javascripts.views.people.users.users-edit.test_error",{number:number}));$j("#test_call_status").addClass("test_call_error");$j("#test_call_button").val(I18n.t("txt.admin.views.people.users.basic_info.test_call"));$j("#status_spinner").fadeOut("slow")}}}})}}call_sid.always(function(){setTimeout(checkStatus,1500)})})},prepCallData:function(number,extension){var data={number:number},pattern=/^\s*(w*\d+#?)\s*$/,match=pattern.exec(extension);if(match){data.ext=match[1]}return data},setupNonEnterpriseRoles:function(userId){if($j("#user_roles_4").is(":checked")){$j("#agent_groups").html($j("#group-block").html())}if($j("#user_roles_2").is(":checked")){$j("#admin_groups").html($j("#group-block").html())}$j("#user-radio").click(function(){$j("#agent_groups, #admin_groups").empty();$j("#end_user_block").show();$j("#agent_block, #admin_groups").hide();$j("#user_restriction_id_4").click();$j("#display_name").hide()});$j("#user_roles_4").click(function(){$j("#agent_groups").html($j("#group-block").html());$j("#admin_groups").empty();$j("#agent_block").show();$j("#admin_groups, #end_user_block").hide();$j("#user_restriction_id_0").click();$j("#display_name").show()});$j("#user_roles_2").click(function(){$j("#admin_groups").html($j("#group-block").html());$j("#agent_groups").empty();$j("#agent_block, #end_user_block").hide();$j("#admin_groups").show();$j("#display_name").show()})},manageRoleDisplay:function(e){this.roleData=this.roleData||$j.parseJSON($j("#role_data").html());var agentRoleRadioElm=$j("#roles_agent"),agentRoleDetailsElm=$j("#agent_details"),agentRoleDescriptionElm=agentRoleDetailsElm.find(".description"),agentRoleHeadcountElm=agentRoleDetailsElm.find(".headcount"),enduserRoleDetailsElm=$j("#enduser_details"),endUserRestrictionElms=$j('#enduser_details input[name="user[restriction_id]"]'),endUserSelected=$j("#roles_enduser").prop("checked"),selectedPermissionSetElm=$j("#user_role_or_permission_set"),selectedPermissionSet=_(this.roleData).find(function(permission_set){return permission_set.id==selectedPermissionSetElm.val()});selectedPermissionSetElm.prop("disabled",endUserSelected);enduserRoleDetailsElm.toggle(endUserSelected);agentRoleDetailsElm.toggle(!endUserSelected);if(!endUserSelected){endUserRestrictionElms.prop("disabled",true);agentRoleRadioElm.val(selectedPermissionSet.id=="admin"?2:4);agentRoleDescriptionElm.html(selectedPermissionSet.description);agentRoleHeadcountElm.html(selectedPermissionSet.headcount)}else{endUserRestrictionElms.prop("disabled",false)}this.displayGroups(endUserSelected)},displayGroups:function(endUserSelected){$j("#groups_unavailable").toggle(endUserSelected);$j("#groups_available").toggle(!endUserSelected);if(endUserSelected){$j("#group_tiles input").prop("disabled",true)}else{$j("#group_tiles input.empty").prop("disabled",false);_($j("#group_tiles .tile")).each(function(tileElm){tileElm=$j(tileElm);if(tileElm.hasClass("selected")){$j(tileElm.find("input")).prop("disabled",false)}})}},selectGroup:function(selectedGroupElm){if(selectedGroupElm.hasClass("selected")){this.disableGroup(selectedGroupElm)}else{this.enableGroup(selectedGroupElm)}},enableGroup:function(selectedGroupElm){selectedGroupElm.addClass("selected");$j("input",selectedGroupElm).prop("disabled",false)},disableGroup:function(selectedGroupElm){selectedGroupElm.removeClass("selected");$j("input",selectedGroupElm).prop("disabled",true)},confirmSaveForEnterprise:function(e){if(e){e.stopPropagation();e.preventDefault()}var isLegacyAgent=$j("#user_role_or_permission_set option:first-child").val()==="";var legacyAgentNotSelected=$j("#user_role_or_permission_set").val()!=="";var agentRoleSelected=$j("#roles_agent").prop("checked");if(isLegacyAgent&&agentRoleSelected&&legacyAgentNotSelected){if(!confirm(this.confirmationMessages.leavingLegacy)){return false}}else{if(!this.confirmDemotion($j("#roles_enduser").prop("checked"))){return false}}this.formElm.unbind("submit");this.formElm.submit()},confirmSave:function(e){if(e){e.stopPropagation();e.preventDefault()}if(!this.confirmDemotion($j("#user-radio").prop("checked"))){return false}var userType=$j("#user_roles_4").is(":checked")?"Agent":($j("#user_roles_2").is(":checked")?"Admin":"End-User");Zendesk.Instrumentation.track(userType,"User - Save");$j("#submit-button").val(e.data.userId?I18n.t("txt.users.edit.updating"):I18n.t("txt.users.edit.creating")).prop("disabled",true);this.formElm.unbind("submit");this.formElm.submit()},confirmDemotion:function(toEndUser){var was_agent=this.formElm.data("is-agent");if(was_agent&&toEndUser){return confirm(this.confirmationMessages.downgradingRole)}else{return true}},renderIdentities:function(userId){var removeLink,identityNameElm,primaryLabelElm,unverifiedLabelElm,primaryIdentity,primaryIdentityElm;var hasPrimaryIdentity=this.identitiesManager.allPrimaryCandidates().length!==0;$j(this.identitiesManager.identities).each($j.proxy(function(i,identity){removeLink=$j("<a>",{href:"javascript: void(0);",html:I18n.t("txt.users.edit.delete_identity")}).click($j.proxy(this.deleteIdentity,this)).data("elmId",identity.elmId).addClass("remove_link");identityNameElm=$j("<span>",{html:identity.name}).addClass("identity_name");primaryLabelElm=$j("<span>",{html:"("+I18n.t("txt.users.edit.primary")+")",style:"display: none"}).addClass("primary_label");unverifiedLabelElm=$j("<span>",{html:"("+I18n.t("txt.users.edit.email_not_verified")+")"}).addClass("status unverified");$j("<li>",{id:identity.elmId}).append(identityNameElm).append(identity.isUnverified()?unverifiedLabelElm:"").append((identity.isPrimaryCandidate()&&!identity.isUnverified())?primaryLabelElm:"").append(removeLink).appendTo($j(identity.listElmId));if(this.identitiesManager.limitToSingleIdentity(identity)){$j("."+identity.identity_type+" .add_identity").hide()}if(!hasPrimaryIdentity&&identity.isExternalIdentity){$j("#"+identity.elmId).find(".remove_link").hide()}},this));primaryIdentity=this.identitiesManager.primary();if(typeof primaryIdentity!=="undefined"){primaryIdentityElm=$j("#"+primaryIdentity.elmId);primaryIdentityElm.find(".primary_label").show();primaryIdentityElm.find(".remove_link").hide()}this.setupPrimary()},setupPrimary:function(){var candidates=this.identitiesManager.allPrimaryCandidates();if(candidates.length>1||(candidates.length==1&&!candidates[0].isPrimary)){$j("#primary_section").show()}else{$j("#primary_section").hide();return}var selectElm=$j("#primary_identity");this.renderPrimary(this.identitiesManager.primary());selectElm.unbind("change",$j.proxy(this.updatePrimary,this));selectElm.bind("change",$j.proxy(this.updatePrimary,this))},renderPrimary:function(primaryIdentity){var selectElm=$j("#primary_identity");selectElm.html("");if(primaryIdentity==undefined){selectElm.append($j("<option>",{html:"&mdash;"}))}else{selectElm.append($j("<option>",{value:primaryIdentity.elmId,html:primaryIdentity.name+" ("+I18n.t("txt.users.edit.primary")+")"}))}_(this.identitiesManager.allPrimaryCandidates()).each(function(identity){if(identity!=primaryIdentity){selectElm.append($j("<option>",{value:identity.elmId,html:identity.name}))}})},updatePrimary:function(e){if(e){e.stopPropagation();e.preventDefault()}var candidates=this.identitiesManager.allPrimaryCandidates();if(candidates.length<1||(candidates.length==1&&candidates[0].isPrimary)){$j("#primary_section").hide();return}var selectElm=$j("#primary_identity");var selectedIdentity=this.identitiesManager.find(selectElm.val());var spinner=$j("<div>").addClass("spinner small").insertAfter(selectElm);this.identitiesManager.makePrimary(selectedIdentity).done(function(){spinner.remove()}).fail(function(){spinner.remove()}).done($j.proxy(function(){this.renderPrimary(selectedIdentity);$j(".remove_link").show();$j("#"+selectedIdentity.elmId).find(".remove_link").hide();$j(".primary_label").hide();$j("#"+selectedIdentity.elmId).find(".primary_label").show();clearFlash()},this)).fail($j.proxy(function(response){this.setupPrimary();showFlash(response,"error")},this))},deleteIdentity:function(e){if(e){e.stopPropagation();e.preventDefault()}var targetElm=$j(e.target);var identity=this.identitiesManager.find(targetElm.data("elmId"));if(!confirm(I18n.t("txt.users.edit.remove_account_confirmation",{identityName:identity.name}))){return false}var spinner=$j("<div>").addClass("spinner small").insertAfter(targetElm);targetElm.hide();this.identitiesManager.remove(identity).done(function(){spinner.remove()}).fail(function(){spinner.remove()}).done(function(){$j("."+identity.identityType+" .add_identity").show();$j("#"+identity.elmId).remove();clearFlash()}).fail(function(response){var json=JSON.parse(response.responseText);json.error&&showFlash(json.error[0],"error")})}});$z.defModule("people/search/index",{initialize:function(){if($j("#bulk_update").exists()){this.setupBulkUpdate()}if($j("#seat-type-filter").exists()){this.setupSeatTypeFilter()}},setupSeatTypeFilter:function(){$j("#seat-type-filter select").change(function(){window.location.href=window.location.search+"&seat_type="+$j(this).val()})},setupBulkUpdate:function(){var allCheckboxContent=$j(".individual_bulk_checkbox");this.activeCheckboxes=$j(_(allCheckboxContent.find(".checkbox")).select(function(checkbox){return !$j(checkbox).prop("disabled")}));if(this.activeCheckboxes.length<1){$j("#bulk_update").hide();allCheckboxContent.hide()}else{this.bulkSubmitElm=$j("#bulk_submit");this.toggleBulkSubmit();$j("#bulk_check").change($j.proxy(this.manageBulkUpdate,this));this.activeCheckboxes.change($j.proxy(this.toggleBulkSubmit,this));$j("#bulk_submit").click($j.proxy(this.submitBulkForm,this))}},manageBulkUpdate:function(e){var bulkCheckSelected=$j("#bulk_check").prop("checked");this.activeCheckboxes.not(".disabled").prop("checked",bulkCheckSelected);this.toggleBulkSubmit()},submitBulkForm:function(e){if(e){e.stopPropagation();e.preventDefault()}if(!this.anyChecked()){return}$j("#bulk_check").hide();$j("#bulk_spinner").show();$j.ajax({type:"POST",url:"/users/select_bulk_action",data:($j("#bulk_form").serialize()),success:function(response){clearFlash();$j.colorbox({html:response});$j("#bulk_spinner").hide();$j("#bulk_check").show()},error:function(response){showFlash("Error:"+response,"error");$j("#bulk_spinner").hide();$j("#bulk_check").show()}})},toggleBulkSubmit:function(e){if(this.anyChecked()){this.bulkSubmitElm.prop("disabled",false);this.bulkSubmitElm.removeClass("button_disabled");this.bulkSubmitElm.addClass("button")}else{this.bulkSubmitElm.prop("disabled",true);this.bulkSubmitElm.removeClass("button");this.bulkSubmitElm.addClass("button_disabled")}},anyChecked:function(){return _(this.activeCheckboxes).any(function(checkbox){return $j(checkbox).prop("checked")})}});$z.defModule("people/users/merge",{initialize:function(){},switch_to_password_form:function(){$j("#user_merge_email_form").hide();$j("#user_merge_password_form").show();$j.colorbox.resize();$j("#user_merge_email_for_password_form").val($j("#user_merge_email").val());$j("#user_merge_password_email_display").html($j("#user_merge_email").val())},on_email_submit:function(){if(this.email_validate($j("#user_merge_email").val())){this.toggle_form("email");return false}else{alert(I18n.t("txt.user.merge.enter_valid_email"));return true}},on_password_submit:function(){if($j("#user_merge_password").val()!==""){this.toggle_form("password");return false}else{alert(I18n.t("txt.user.merge.enter_valid_password"));return true}},email_validate:function(address){var reg=/^([A-Za-z0-9_\+\-\.])+(\+[0-9]+)?\@([A-Za-z0-9_\-\.])+\.([A-Za-z]{2,4})$/;return reg.test(address)},password_does_not_match:function(text){this.toggle_form("password");alert(text)},toggle_form:function(type){$j("#user_merge_waiting_for_"+type).toggle();$j("#user_merge_submit_"+type).toggle()}});$z.defModule("people/users/new",{initialize:function(userId){$z("people/users/edit").initialize(userId)}});$z.defModule("people/users/show",{initialize:function(userId){this.userId=userId;var suspendUserElm=$j("#suspend_access");this.userSuspended=(suspendUserElm.attr("data-user-suspended")!=="false");if(this.userSuspended){$j("#suspended").show()}$j("a.toggle-twitter-data").click(function(){$j(this).closest("p.user-twitter").next(".twitter-properties").slideToggle(50)});$j(".visibility-controls").click(function(){$j("a.toggle-twitter-data",this).toggle()});$j("#make_direct_number_link").click(function(e){$j.colorbox({inline:true,href:"#make_direct_number_layer"});if(e){e.preventDefault()}});$j("#edit_number_link").click(function(e){$j.colorbox({inline:true,href:"#edit_number_layer"});if(e){e.preventDefault()}});new UserMergeWizard(true);this.setSuspensionActionText();suspendUserElm.click($j.proxy(this.setSuspensionStatus,this))},setSuspensionStatus:function(e){e.preventDefault();if(this.settingStatus===true){return}this.settingSuspensionStatus=true;var suspendAccessUrl="/users/"+this.userId;$j.ajax({url:suspendAccessUrl,type:"PUT",dataType:"json",dataFilter:function(data){trimmed_data=$j.trim(data);if(trimmed_data==""){return"{}"}else{return data}},data:{authenticity_token:currentUser.authenticityToken,user:{suspended:!this.userSuspended}},success:$j.proxy(function(){this.userSuspended=!this.userSuspended;this.setSuspensionActionText();$j("#suspended").toggle(this.userSuspended);showFlash((this.userSuspended?I18n.t("txt.admin.javascrips.users_show.user_suspended_label"):I18n.t("txt.admin.javascrips.users_show.user_unsuspended_label")),"notice");this.settingSuspensionStatus=false},this),error:function(response){var action=this.userSuspended?"suspend":"unsuspend";if(action=="suspend"){message=I18n.t("txt.admin.javascrips.users_show.suspend_user_label")}else{message=I18n.t("txt.admin.javascrips.users_show.unsuspend_user_label")}showFlash(message,"error");this.settingSuspensionStatus=false}})},setSuspensionActionText:function(){$j("#suspend_access").html(this.userSuspended?I18n.t("txt.admin.javascrips.users_show.unsusped_access_label"):I18n.t("txt.admin.javascrips.users_show.suspend_access_label"))}});$z.defModule("recaptcha/index",{initialize:function(){window.Recaptcha={reload:function(){$j.getJSON("/recaptcha/fetch",function(response){$j("#recaptcha_challenge_field").val(response.recaptcha_challenge_field);$j("#recaptcha_challenge_image").attr("src",response.google_recaptcha_api_image_url+response.recaptcha_challenge_field)})}};$j("#recaptcha_image").append('<img id="recaptcha_challenge_image"><input id="recaptcha_challenge_field" name="recaptcha_challenge_field" type="hidden">');window.Recaptcha.reload()}});$z.defModule("reports/edit",{initialize:function(params){$j("fieldset.conditions span select").autocompleteFromSelectIfLarge()}});Zendesk.NS("Reports");Zendesk.Reports.Exports=function(options){options=options||{};this.container=options.container;this.sammyApp=this._extendSammyApp(options.app);this.sammyApp.post("/csv_exports",function(){return true});this.sammyApp.put("/settings/export_configuration/update_whitelisted_domain",function(){return true})};Zendesk.Reports.Exports.prototype={$:function(selector){return $j(selector,this.container)},_extendSammyApp:function(app){var self=this;return app.bind("tab.changed_and_loaded",function(e,data){if(data.tabID!=="export"){return}self._initUI()})},_createDatepickers:function(){var self=this;this.$(".date_picker").each(function(){self.$(this).datepicker({maxDate:"+0D"});self._setDate(this)})},_setDate:function(elem){var date=new Date(),dataFieldName=this.$(elem).data("field"),dataField=this.$("#"+dataFieldName);if(dataFieldName&&dataField){date.setTime(this.$(dataField).val()*1000);this.$(elem).datepicker("setDate",date)}},_createExportTimeBind:function(){var self=this,voyagerSubmitBtn=this.$("#voyager_csv_export");if(voyagerSubmitBtn){this.$("#voyager_csv_export").click(function(){var start_date=self.$("#start_date_cal").datepicker("getDate");var end_date=self.$("#end_date_cal").datepicker("getDate");start_date.setHours(0,0,0);end_date.setHours(23,59,59);var start_date_utc=self._utcDate(start_date);var end_date_utc=self._utcDate(end_date);if(end_date_utc.getTime()>Date.now()){end_date_utc.setTime(Date.now())}self.$("#start").val(start_date_utc.getTime()/1000);self.$("#end").val(end_date_utc.getTime()/1000)})}},_utcDate:function(date){return new Date(Date.UTC(date.getFullYear(),date.getMonth(),date.getDate(),date.getHours(),date.getMinutes(),date.getSeconds()))},_initUI:function(){this._createDatepickers();this._createExportTimeBind()}};Zendesk.NS("Reports");Zendesk.Reports.ForumAnalytics=function(options){options=options||{};this.container=options.container;this.sammyApp=this._extendSammyApp(options.app);this.routes={TAB:"#forum_analytics",STATS:"#forum_analytics/stats/:statName"}};Zendesk.Reports.ForumAnalytics.prototype={$:function(selector){return $j(selector,this.container)},_extendSammyApp:function(app){var self=this;return app.bind("tab.changed_and_loaded",function(e,data){if(data.tabID!=="forum_analytics"){return}if(!self.$("#stats_summary_container").length){return}self._initUI();self._loadDefaultState();var params;if(this.matchPath(data.path,self.routes.TAB)){self._getRouteTab()}else{if(params=this.matchPath(data.path,self.routes.STATS)){self._getRouteStats(params)}}})},_getRouteStats:function(params){var sparkline=this.$(".sparkline#"+params.statName);if(sparkline.hasClass("active")){return}Zendesk.Stats.ForumUI.showDetailGraph(sparkline,{container:this.container})},_getRouteTab:function(){this._getRouteStats({statName:this.$(".sparkline:first").attr("id")})},_loadDefaultState:function(){if(!this.$(".sparkline > div:not(:empty)").length){Zendesk.Stats.ForumUI._drawSparklines({container:this.container})}},_initUI:function(){if(this._initialized){return}this._initialized=true;Zendesk.Stats.ForumUI._bindSparklineHandlers(this.sammyApp,{statsURL:"#forum_analytics/stats",container:this.container})}};Zendesk.NS("Reports");Zendesk.Reports.Overview=function(options){options=options||{};this.container=options.container;this.sammyApp=this._extendSammyApp(options.app)};Zendesk.Reports.Overview.prototype={$:function(selector){return $j(selector,this.container)},_bindSparklineHandlers:function(){var self=this,sparklines;sparklines=[{context:".ticket_stats .search_sparkline",path:"#reports"},{context:"#forum_views",path:"#forum_analytics/stats/entry_view"},{context:"#forum_topics",path:"#forum_analytics"},{context:"#search_total_searches",path:"#search_analytics"},{context:"#search_tickets_created",path:"#search_analytics/stats/tickets"}];$j(sparklines).each(function(index,el){$j(el.context).bind("click",function(){if(el.context==".ticket_stats .search_sparkline"&&Zendesk.embeddedInLotusAdmin&&Zendesk.embeddedInLotusAdmin()){window.parent.Zd.router.transitionTo("reporting.index")}else{self.sammyApp.setLocation(el.path)}})})},_drawAllSparklines:function(){var self=this,sparklineGraphs;sparklineGraphs=[{div:"#tickets_created_sparkline",statName:"created_count",draw:this._drawTicketSparklines},{div:"#tickets_solved_sparkline",statName:"solve_count",draw:this._drawTicketSparklines},{div:"#tickets_first_response_time_sparkline",statName:"first_response_time",draw:this._drawTicketSparklines},{div:"#tickets_satisfaction_sparkline",statName:"csr",draw:this._drawTicketSparklines},{div:"#forum_views_sparkline",statName:"entry_view",draw:this._drawForumSparklines},{div:"#forum_topics_sparkline",statName:"entry_create",draw:this._drawForumSparklines},{div:"#search_total_searches_sparkline",statName:"searches",draw:this._drawSearchSparklines},{div:"#search_tickets_created_sparkline",statName:"tickets",draw:this._drawSearchSparklines}];$j(sparklineGraphs).each(function(index,graph){if($j(graph.div).length){graph.draw.call(self,graph)}})},_drawForumSparklines:function(graph){var graphDiv=this.$(graph.div),sparkline,statsInfo=Zendesk.Stats.ForumUI._statsInfo(this.$("#stats_object"));sparkline=new Zendesk.Stats.Graph(graphDiv,{graphType:"sparkline",resource:"forum",objectType:statsInfo.objectType,objectId:statsInfo.objectId,statName:graph.statName,start:statsInfo.windowStart,totalCountDiv:graphDiv.closest(".sparkline_container").find(".stat_total")});sparkline.draw()},_drawSearchSparklines:function(graph){var graphDiv=this.$(graph.div),sparkline;sparkline=new Zendesk.Stats.Graph(graphDiv,{graphType:"sparkline",searchStatURL:"/account/search_account_stats",statName:graph.statName,totalCountDiv:graphDiv.closest(".sparkline_container").find(".stat_total")});sparkline.draw()},_drawTicketSparklines:function(graph){var graphDiv=this.$(graph.div),sparkline;sparkline=new Zendesk.Stats.Graph(graphDiv,{graphType:"sparkline",searchStatURL:"/account/0/ticket_stats_by_account",statName:graph.statName,totalCountDiv:graphDiv.closest(".sparkline_container").find(".stat_total")});$j.getJSON(sparkline.statsURL,{start:sparkline.startTime,interval:86400}).done($j.proxy(this._drawSparkline,sparkline,sparkline.statsURL,this._calculateTotal))},_extendSammyApp:function(app){var self=this;return app.bind("tab.changed_and_loaded",function(e,data){if(data.tabID!=="overview"){return}if(!self.$(".stats_summary_container").length){return}self._initUI();var sparklines=self.$(".search_sparkline > div:not(:empty)");if(sparklines.length){return}self._drawAllSparklines()})},_drawSparkline:function(url,calculateTotal,data){this.data=data.data;this.draw();var format="0,0",total=calculateTotal(data.data,data.counts);if(this.statName==="csr"){format="0,0%";total*=100}if(this.statName==="first_response_time"){total=total/3600}$j(this.totalCountDiv).append(Zendesk.Stats.formatNumber(format,total))},_calculateTotal:function(data,counts){var points=0,total=0;if(counts&&counts.length===data.length){for(var i=0;i<data.length;i++){if(counts[i]===undefined){continue}total+=data[i][1]*counts[i];points+=counts[i]}total/=points}else{for(var j=0;j<data.length;j++){total+=data[j][1]}}return total},_initUI:function(){if(this._initialized){return}this._initialized=true;this._bindSparklineHandlers()}};Zendesk.NS("Reports.Page");Zendesk.Reports.Page.init=function(){var tabbedContainer=new Zendesk.TabbedContainer.SammyApp();new Zendesk.Reports.Overview({app:tabbedContainer.app,container:"#overview"});new Zendesk.Reports.ForumAnalytics({app:tabbedContainer.app,container:"#forum_analytics"});new Zendesk.Reports.SearchAnalytics({app:tabbedContainer.app,container:"#search_analytics"});new Zendesk.Reports.Exports({app:tabbedContainer.app,container:"#export"});tabbedContainer.app.bind("tab.change",function(e,data){var tab=$j("#"+data.tabID);var trigger=function(){tabbedContainer.app.trigger("tab.changed_and_loaded",data)};if(tab.data("loaded")){trigger()}else{tab.data("loaded",true);tab.responsiveLoad("/reports?tab="+data.tabID,trigger)}});tabbedContainer.init()};Zendesk.NS("Reports");Zendesk.Reports.SearchAnalytics=function(options){options=options||{};this.container=options.container;this.sammyApp=this._extendSammyApp(options.app);this.routes={STATS:"#search_analytics/stats/:statName",TAB:"#search_analytics",TABLE:"#search_analytics/table/:orderField/:sortDirection/page/:page"}};Zendesk.Reports.SearchAnalytics.prototype={$:function(selector){return $j(selector,this.container)},_extendSammyApp:function(app){var self=this;return app.bind("tab.changed_and_loaded",function(e,data){self.searchStatsTable=self._initializeTable();if(data.tabID!=="search_analytics"){return}if(!self.$(".stats_summary_container").length){return}self._initUI();self._loadDefaultState();var params;if(this.matchPath(data.path,self.routes.TAB)){self._getRouteTab()}else{if(params=this.matchPath(data.path,self.routes.TABLE)){self._getRouteTable(params)}else{if(params=this.matchPath(data.path,self.routes.STATS)){self._getRouteStats(params)}}}})},_getRouteStats:function(params){var statName=params.statName,sparkline=this.$(".search_sparkline#"+statName);if(sparkline.hasClass("active")){return}this._drawDetailGraph(sparkline);this._setTableDescription(statName);this._fetchTableForSparkline(statName);this.$("#percentage_stats_graph").hide();this.$("#detailed_stats_graph").show();if(statName!=="searches"){this._addPercentageSelectMenu(statName)}else{this.$("#stats_graph_select_menu").empty()}},_getRouteTab:function(){this._getRouteStats({statName:this.$(".search_sparkline:first").attr("id")})},_getRouteTable:function(params){this._loadDefaultGraph();var orderField=params.orderField,page=parseInt(params.page,10),sortDirection=params.sortDirection;this.$("#search_string_stats table th img").hide();this._sortTopStats(this.$("#search_string_stats table th."+orderField),sortDirection,page)},_initializeTable:function(){if(!this.$(".stats_summary_container").length){return undefined}var options={divTable:"#search_string_stats",statsType:"all",orderField:"searches",searchStatsTemplate:"#search_stats_template",divPaginationTotal:"#pagination_total",container:this.container};this.$("#search_string_feedback_checkbox").hide();this.$(options.divTable+" #show_more").hide();var searchStatsTable=new Zendesk.Stats.SearchStatsTable(options);this._displayFeedbackCheckbox(searchStatsTable);return searchStatsTable},_loadDefaultGraph:function(){if(this.$("#detailed_stats_graph").is(":empty")){this._drawDetailGraph(this.$(".search_sparkline:first"))}},_loadDefaultState:function(){if(!this.$(".search_sparkline > div:not(:empty)").length){this._drawSparklines()}},_setFeedbackCheckbox:function(isFeedbackData){if(isFeedbackData===true){this.$("#search_string_feedback_checkbox").show()}},_displayFeedbackCheckbox:function(table){table.isFeedbackData(this,this._setFeedbackCheckbox);var checkbox=this.$("#search_string_stats #feedback_tag");checkbox.prop("checked",false);checkbox.click(function(){var statsType=($j(this).is(":checked")?"feedback_tab":"all");table.modifyDisplayed({statsType:statsType})})},_bindSparklineHandlers:function(){var self=this;this.$(".search_sparkline").bind("click",function(){if(($j(this).hasClass("active"))){return false}else{self.sammyApp.setLocation("#search_analytics/stats/"+$j(this).attr("id"))}})},_sortByColumn:function(){var self=this;var sortableHeaders=this.$("table.tickets th").slice(0,-1);sortableHeaders.css({cursor:"pointer"});sortableHeaders.click(function(){var orderField=$j(this).attr("class"),page=self.searchStatsTable.statOptions.page,sortDirection=self.searchStatsTable.getNextSortDirection(orderField);self.sammyApp.setLocation("#search_analytics/table/"+orderField+"/"+sortDirection+"/page/"+page);return false})},_bindTableHandlers:function(){this._sortByColumn();var self=this;this.$("#search_string_stats #show_more a").click(function(){self.$("table.tickets tr:hidden").show();var table=self.searchStatsTable,orderField=table.statOptions.orderField,page=table.nextPage(),sortDirection=table.getCurrentSortDirection(orderField);self.sammyApp.setLocation("#search_analytics/table/"+orderField+"/"+sortDirection+"/page/"+page);return false})},_bindSelectMenuHandler:function(){var self=this;this.$("#stats_graph_select_menu select").live("change",function(){var selected=$j(this).find("option:selected").val();if(selected==="percentage"){self._showPercentageGraph()}else{self._showOriginal()}})},_showOriginal:function(){this.$("#percentage_stats_graph").hide();this.$("#detailed_stats_graph").show()},_showPercentageGraph:function(){var total=this.$("#searches_sparkline").data("graph_data").data;var current=this.$(".active").find("div").data("graph_data").data;var average=[];for(var i=0;i<total.length;i++){var percentage=parseInt((parseInt(current[i][1],10)*100)/parseInt(total[i][1],10),10);average.push([total[i][0],(isNaN(percentage)?0:percentage)])}this.$("#detailed_stats_graph").hide();this.$("#percentage_stats_graph").show();var graph=new Zendesk.Stats.Graph(this.$("#percentage_stats_graph"),{graphType:"percentage",data:average});graph.draw()},_drawSparklines:function(){var sparklineGraphs=[{div:"#searches_sparkline",statName:"searches"},{div:"#no_results_sparkline",statName:"no_results"},{div:"#no_clicks_sparkline",statName:"no_clicks"},{div:"#tickets_sparkline",statName:"tickets"}];for(var i=0;i<sparklineGraphs.length;i++){var sparkline=new Zendesk.Stats.Graph(this.$(sparklineGraphs[i].div),{graphType:"sparkline",searchStatURL:"/account/search_account_stats",statName:sparklineGraphs[i].statName,totalCountDiv:this.$(sparklineGraphs[i].div).parent().parent().find(".stat_total")});sparkline.draw()}},_drawDetailGraph:function(sparkline){this.$(".search_sparkline.active").removeClass("active");this.$(sparkline).addClass("active");var statName=this.$(sparkline).prop("id");var graph=new Zendesk.Stats.Graph(this.$("#detailed_stats_graph"),{graphType:"area",searchStatURL:"/account/search_account_stats",statName:statName});graph.draw();$j(window).resize(function(){graph.draw()})},_setTableDescription:function(stat){var tableDescription={searches:{title:I18n.t("txt.admin.public.javascript.views.reports.top_500_searches"),description:""},no_results:{title:I18n.t("txt.admin.public.javascript.views.reports.search.top_500_searches_no_results_label"),description:I18n.t("txt.admin.public.javascript.views.reports.search.search.top_500_searches_no_results_description")},no_clicks:{title:I18n.t("txt.admin.public.javascript.views.reports.search.top_500_searches_no_clicks_label"),description:I18n.t("txt.admin.public.javascript.views.reports.search.top_500_searches_no_clicks_description")},tickets:{title:I18n.t("txt.admin.public.javascript.views.reports.search.top_500_searches_tickets_created_label"),description:I18n.t("txt.admin.public.javascript.views.reports.search.top_500_searches_tickets_created_description")}}[stat];this.$(".stats_summary_description").empty();this.$(".stats_summary_description").append(tableDescription.title);this.$(".stats_summary_extra_description").empty();this.$(".stats_summary_extra_description").append(tableDescription.description)},_fetchTableForSparkline:function(stat){var statData={searches:["searches","desc"],no_results:["avg_results","asc"],no_clicks:["ctr","asc"],tickets:["tickets","desc"]}[stat];if(stat!=="searches"){this.$("#search_string_feedback_checkbox input[type=checkbox]").prop("checked",false);this.searchStatsTable.statOptions.statsType="all"}this._sortTopStats(this.$("th."+statData[0]),statData[1],1,this._filterCallback)},_addPercentageSelectMenu:function(stat){var selectMenuDiv=this.$("#stats_graph_select_menu");var statTitle=this.$("#"+stat).parent().find(".stat_title").html().toLowerCase();var selectMenu=[];var originalTitle=this._getPercentageSelectMenuTranslation(statTitle);selectMenu.push("<select>");selectMenu.push('<option value="original">'+originalTitle+"</option>");selectMenu.push('<option value="percentage">'+I18n.t("txt.admin.public.javascript.views.reports.search.percent_of_total_searches_option")+"</option>");selectMenu.push("</select>");selectMenuDiv.empty();selectMenuDiv.append(selectMenu.join())},_getPercentageSelectMenuTranslation:function(statTitle){if(statTitle==I18n.t("txt.admin.views.reports.tabs.search.with_no_results_label").toLowerCase()){return I18n.t("txt.admin.views.reports.tabs.search.number_with_no_results_label")}else{if(statTitle==I18n.t("txt.admin.views.reports.tabs.search.with_no_clicks_label").toLowerCase()){return I18n.t("txt.admin.views.reports.tabs.search.number_with_no_clicks_label")}else{if(statTitle==I18n.t("txt.admin.views.reports.tabs.search.tickets_created_label").toLowerCase()){return I18n.t("txt.admin.views.reports.tabs.search.number_tickets_created_label")}else{return"Number "+statTitle}}}},_filterCallback:function(stat){this.$("table.tickets td."+stat).each(function(){if(stat=="ctr"||stat=="avg_results"){if(parseFloat($j(this).html())>0.05){$j(this).parent().hide()}}if(stat=="tickets"){if(parseFloat($j(this).html())<1){$j(this).parent().hide()}}});if(this.$(".active").attr("id")!=="searches"){var sorted=this.$("table.tickets tbody tr:visible").sort(function(a,b){return parseInt($j(b).find(".searches").html(),10)-parseInt($j(a).find(".searches").html(),10)});this.$("table.tickets tbody").empty();this.$("table.tickets tbody").append(sorted);this.$("#show_more").hide();this.$(".view_sort").remove();this.$("th.searches").children("div.title").append('<img alt="Table-arrow" class="view_sort" src="/images/table-arrow.png"/>');this.$("table.tickets th").css({cursor:"default"});this.$("table.tickets th").unbind("click");if(this.$("#search_string_feedback_checkbox").is(":visible")){this.$("#search_string_feedback_checkbox").hide();this.$("#search_string_feedback_checkbox").data("show_again",true)}}else{if(this.$("#search_string_feedback_checkbox").data("show_again")){this.$("#search_string_feedback_checkbox").show();this.$("#search_string_feedback_checkbox").data("show_again",false)}this._sortByColumn()}},_setSortImage:function(column,sortDirection){this.$(".view_sort").remove();var sortImage=(sortDirection==="desc"?"/images/table-arrow.png":"/images/table-arrow1.png");column.children("div.title").append('<img alt="Table-arrow" class="view_sort" src="'+sortImage+'"/>')},_sortTopStats:function(column,sortDirection,page,callback){var orderField=column.prop("class"),table=this.searchStatsTable,pageSize=(this.$(".active").attr("id")==="searches")?15:100;table.setSort(orderField,sortDirection);table.modifyDisplayed({page:page,pageSize:pageSize},this,callback);this._setSortImage(column,sortDirection)},_initUI:function(){if(this._initialized){return}this._initialized=true;this._bindSparklineHandlers();this._bindTableHandlers();this._bindSelectMenuHandler()}};(function($){function onOrganizationSelected(e){$("#ticket_organization_id").val($(this).val())}$(function init(){$("#request_organization_id").change(onOrganizationSelected)})}(jQuery));(function($){var $ticketFormData;var ticketFormMarkup={};function getForm(formId){var form=_.find($ticketFormData,function(form){return form.id===formId});if(form==null){throw new Error("No such form: "+formId)}return form}function visibleFieldsForForm(formId){var form=getForm(formId);return form.ticket_fields}function hideTicketSection(){$("#ticketfields").hide();$("#attachment-friends").hide()}function showTicketSection(){$("#ticketfields").show();$("#attachment-friends").show();$("#ticket-field-friends div").not("#date-flash").show()}function showTicketFormFields(formID){var fieldsToShow=visibleFieldsForForm(formID);var friends=$("#ticket-field-friends");friends.empty();_.each(fieldsToShow,function(field,index){var fieldMarkup=ticketFormMarkup[field.id];friends.append(fieldMarkup)});if($(".new_date_picker")){rebuildDatepickers()}showTicketSection();setVisibility("#ticket_date",($j("#ticket_ticket_type_id").val()==="4"));setupNestedDropdowns();$("#suggestions_for_new_topic").hide();if(Zendesk&&Zendesk.bindRelatedTopics){Zendesk.bindRelatedTopics()}}function rebuildDatepickers(){var datepickers=$(".new_date_picker");datepickers.removeClass("hasDatepicker");$(".ui-datepicker-trigger").remove();datepickers.datepicker({showOn:"both",buttonImage:"/images/calendar_date_select/calendar.gif",buttonImageOnly:true,showAnim:"slideDown",defaultDate:+7,onSelect:function(){var dateObject=$(this).datepicker("getDate");var dataField=this.getAttribute("data-field");$("#"+dataField).val(getDateString(dateObject))}})}function getDateString(dateObject){return dateObject.getFullYear()+"-"+("0"+(dateObject.getMonth()+1)).slice(-2)+"-"+("0"+dateObject.getDate()).slice(-2)}function setupNestedDropdowns(){$("ul.drop-list").each(function(i,elem){new Zendesk.UI.NestedMenu(elem).initialize()});$(".field-tagger").ticketTagger()}function onTicketFormSelected(e){var formID=parseInt($(e.target).val(),10);if(formID===-1){hideTicketSection();return}showTicketFormFields(formID)}function renderDefaultForm(){var formID=$ticketFormData[0].id;showTicketFormFields(formID)}$(function init(){var $el=$("#ticket_forms_data");if($el.length===0){return}$ticketFormData=JSON.parse($el.html());if($ticketFormData.length===0){return}$("#ticket-field-friends div[data-field-id]").each(function(index,markup){var id=$(markup).data("field-id");ticketFormMarkup[id]=markup});if($ticketFormData.length===1){renderDefaultForm();return}hideTicketSection();$("#ticket_ticket_form_id").change(onTicketFormSelected).change()})}(jQuery));$z.defModule("rules/_bulk_update",{initialize:function(){var bulkForm=$j("#ticket-chat");bulkForm.submit(function(e){$j.ajax({url:bulkForm.attr("action"),type:"POST",data:bulkForm.serialize()+"&background=true",dataType:"json",success:function(job){var jobStatus=new Zendesk.JobStatus(job.status_url,{title:I18n.t("txt.public.javascripts.views.rules._bulk_update.processing_tickets"),renderResult:function(jobStatus){var output={title:I18n.t("txt.public.javascripts.views.rules._bulk_update.tickets_processed",{count:jobStatus.results.length}),body:$j("<ul/>")};if(jobStatus.status==="completed"){document.location="/tickets/bulk_result?background="+jobStatus.job.id+"&return_to="+escape(document.location)}return output}})}});$j("#bulk-update").hide();$j("table.tickets th.checkbox input").remove();$j("table.tickets input.tickets_to_bulk_update").remove();return false})}});$j(document).ready(function(){$j("a.nube1").click(function(){var tempForm=jQuery("<form>",{action:$j(this).attr("href"),method:"post","accept-charset":"UTF-8"}).append(jQuery("<input>",{name:"utf8",value:"✓",type:"hidden"})).append(jQuery("<input>",{name:"authenticity_token",value:$j('meta[name="csrf-token"]').attr("content"),type:"hidden"}));if($j(this).data("key")!==undefined){tempForm.append(jQuery("<input>",{name:"key",value:$j(this).data("key"),type:"hidden"}))}$j("body").append(tempForm);tempForm.submit();return false})});$j(document).ready(function(){$j("select#analysis-filter").change(function(event){var tempForm=jQuery("<form>",{action:$j(location).attr("pathname"),method:"post","accept-charset":"UTF-8"}).append(jQuery("<input>",{name:"utf8",value:"✓",type:"hidden"})).append(jQuery("<input>",{name:"filter",value:$j("select#analysis-filter option:selected").val(),type:"hidden"})).append(jQuery("<input>",{name:"authenticity_token",value:$j('meta[name="csrf-token"]').attr("content"),type:"hidden"}));if($j(this).data("select")!==undefined){tempForm.append(jQuery("<input>",{name:"select",value:$j(this).data("select"),type:"hidden"}))}if($j(this).data("key")!==undefined){tempForm.append(jQuery("<input>",{name:"key",value:$j(this).data("key"),type:"hidden"}))}$j("body").append(tempForm);tempForm.submit();return false});$j("div#rules_analysis_tab_links a").click(function(){var tempForm=jQuery("<form>",{action:$j(location).attr("pathname"),method:"post","accept-charset":"UTF-8"}).append(jQuery("<input>",{name:"utf8",value:"✓",type:"hidden"})).append(jQuery("<input>",{name:"select",value:$j(this).data("select"),type:"hidden"})).append(jQuery("<input>",{name:"authenticity_token",value:$j('meta[name="csrf-token"]').attr("content"),type:"hidden"}));if($j(this).data("key")!==undefined){tempForm.append(jQuery("<input>",{name:"key",value:$j(this).data("key"),type:"hidden"}))}$j("body").append(tempForm);tempForm.submit();return false})});$z.defModule("rules/edit",{initialize:function(){$j("fieldset.conditions span select").autocompleteFromSelectIfLarge();function confirmDangerousAction(event){var confirmMessage;switch($j("#submit_type").val()){case"deactivate":confirmMessage=I18n.t("txt.admin.views.rules.confirm_deactivate");break;case"delete":confirmMessage=I18n.t("txt.admin.views.rules.confirm_delete");break;default:return true}var $form=$j(this);if($form.data("is-recently-confirmed")){$form.data("is-recently-confirmed",null);return true}else{event.stopImmediatePropagation();event.preventDefault();if(confirm(confirmMessage)){$form.data("is-recently-confirmed",true).trigger("submit")}return false}}function verifyColumnsForViews(){var columns=$$("ul#result_columns li").pluck("id");if(columns.length>1){$("output_columns").value=columns.join(",").gsub("sort_","");return true}else{alert("Please select at least two columns to include in table");return false}}var $form=$j("#viewform");switch($form.data("ruleType")){case"View":$form.submit(verifyColumnsForViews);break;case"Automation":case"Trigger":$form.submit(confirmDangerousAction)}}});jQuery(function($){var lists=$("#view_output_columns").find(".sortablelist");if(!lists.exists()){return}lists.each(function(){$(this).sortableWithEmptyTarget({emptyTargetClass:"item sortable",placeholder:"sortable target",connectWith:lists.not(this)})});$j("#result_columns").bind("sortreceive",function(event,ui){if($j(this).find("li").size()>11){$j(ui.sender).sortable("cancel")}})});$z.defModule("rules/index",{initialize:function(params){var sortByHtml=function(a,b){a=$j(a).html().strip().toLowerCase();b=$j(b).html().strip().toLowerCase();return(a<b)?-1:((a>b)?1:0)};var setOriginalList=function(sorted){var itemList=[];var originalList=$j("#active-rules div.item").not(".reorder");$j.each(sorted,function(index,div){var itemTemplate=originalList[index];var actions=$j(div).find("div.actions");$j(itemTemplate).find("div.title div").html(div.innerHTML);if(actions.length>0){$j(itemTemplate).find("div.item-actions").replaceWith(actions.html())}itemList[index]=itemTemplate});originalList.remove();$j("#active-rules").prepend(itemList)};var sortRules=function(direction){var sortedRules=$j("ul#active-rules-sort-list li.item.sortable").sort(function(a,b){if(direction=="desc"){return sortByHtml(b,a)}return sortByHtml(a,b)});setOriginalList(sortedRules);$j("ul#active-rules-sort-list li.item.sortable").remove();$j("ul#active-rules-sort-list").prepend(sortedRules)};$j("div#active-rules_sort input.sort_asc").click(function(event){sortRules("asc")});$j("div#active-rules_sort input.sort_desc").click(function(event){sortRules("desc")});$j("a.cancel-sorting").click(function(event){Ordering.cancelOrdering("div#active-rules");setOriginalList($j("ul#active-rules-sort-list li.item.sortable"))});$j("select#rule-select, select#rule-sort").change(function(event){var sortSelected=$j("select#rule-sort option:selected").val();var groupSelected=$j("select#rule-select option:selected").val();var query="/rules?";var queryParams=jQuery.queryParameters();var rawParams={filter:queryParams.filter};if(typeof(sortSelected)!="undefined"){rawParams.sort=sortSelected}if(typeof(groupSelected)!="undefined"){rawParams.select=groupSelected}window.location.href=$j(location).attr("protocol")+"//"+$j(location).attr("host")+query+$j.param(rawParams)})}});$z.defModule("rules/show",{initialize:function(){var selector="textarea[id*='ticket_fields'], input[id*='ticket_fields']";var defaultColor=$j(selector).css("color");$j(selector).css("color","gray");$j(selector).click(function(){$j(this).css("color",defaultColor)});$j(selector).blur(function(){if($j(this).val()==I18n.t("control.dropdown.value.no_change")){$j(this).css("color","gray")}});var subjectTh=$j("th:contains('Subject')");if(subjectTh.width()>50){subjectTh.css("width",subjectTh.width())}else{subjectTh.css("width","50px")}var comment_id="textarea#comment_value";var placeholder_warning_id="p#placeholders_in_comment_notice";$(document).observe("macro:applied",function(){if(($j(comment_id).val().indexOf("{{")>-1)||($j(comment_id).val().indexOf("{%")>-1)){$j(placeholder_warning_id).show()}else{$j(placeholder_warning_id).hide()}})}});Zendesk.NS.extend("Satisfaction",{Score:{offered:1,poor:4,good:16},ScoreValue:{"1":"offered","4":"poor","5":"poor","16":"good","17":"good"},Input:{init:function(){if($j(this._rootSelector).length){this._satisfactionButtons=$j("#satisfaction_rating form .rating");this._currentRatingContainer=$j("#current_rating");this._currentRating=this._parseCurrentRating();this._ratingTemplate=$j("#current_rating_template").html();this._form=$j("#satisfaction_rating form");this._reasonCode=$j("#satisfaction_reason_code");this._setHashFromIntention();this._app=this._buildSammyApplication(jQuery,this._rootSelector)}},_scoreSpanTemplate:'<span class="rating selected {{scoreKey}}">{{scoreText}}</span>',_ensureVisible:function(){if($j(this._rootSelector).is(":hidden")){if((this._currentRating&&this._currentRating.score>1)){if($j("#satisfaction_rating").data("csr-token-retention")&&this._currentRating["can_modify?"]){this._hideCurrentRatingAndShowForm()}else{this._form.hide();this._renderRating(this._currentRating).show()}}else{this._hideCurrentRatingAndShowForm()}$j(this._rootSelector).show()}},_hideCurrentRatingAndShowForm:function(){this._currentRatingContainer.hide();this._form.show()},_parseCurrentRating:function(){var encodedHTML=$j("#current_rating_data").html();var decodedHTML=$j("<div />").html(encodedHTML).text();return JSON.parse(decodedHTML)},_renderRating:function(rating){var scoreKey;if(rating.updated_score!==null&&rating.updated_score!==undefined){scoreKey=Zendesk.Satisfaction.ScoreValue[rating.updated_score]}else{scoreKey=Zendesk.Satisfaction.ScoreValue[rating.score]}var scoreText=$j.mustache(this._scoreSpanTemplate,{scoreKey:scoreKey,scoreText:I18n.t("txt.satisfaction.score."+scoreKey)});var presenter={header:I18n.t("txt.satisfaction.score.current",{score:scoreText}),commentHeader:I18n.t("txt.satisfaction.header.comment"),showComment:I18n.t("txt.satisfaction.comment.show"),hideComment:I18n.t("txt.satisfaction.comment.hide"),modifyRating:I18n.t("txt.satisfaction.rating.modify"),anonymousModifyRating:I18n.t("txt.satisfaction.rating.anonymous_modify"),comment:rating.comment,canModify:rating["can_modify?"],isAnonymous:currentUser.isAnonymous};return this._currentRatingContainer.html($j.mustache(this._ratingTemplate,presenter))},_rootSelector:"#satisfaction_rating",_setHashFromIntention:function(){var intention=this._currentRatingContainer.data("intention");var score=Zendesk.Satisfaction.ScoreValue[intention];var noHashGiven=window.location.hash.replace("#","")==="";if(score&&noHashGiven){window.location.hash="#/satisfaction/new/"+score}},_buildSammyApplication:function($,root){var app=$.sammy(root,function(){this.debug=true;this.before(function(){Zendesk.Satisfaction.Input._ensureVisible();return true});this.get("#/satisfaction",function(){});this.post(/^\/requests\/.+\/satisfaction/,function(context){var form=Zendesk.Satisfaction.Input._form;form.find('input[type="submit"]').prop("disabled",true);jQuery.ajax({url:form.attr("action"),type:form.attr("method").toUpperCase(),data:form.serialize(),dataType:"json",error:function(request,textStatus,errorThrown){context.redirect("#/satisfaction/error")},success:function(data,textStatus,XMLHttpRequest){Zendesk.Satisfaction.Input._currentRating=data;context.trigger("ticket.satisfaction.created",data);context.redirect("#/satisfaction/success")}})});this.get("#/satisfaction/success",function(){Zendesk.Satisfaction.Input._form.hide();Zendesk.Satisfaction.Input._renderRating(Zendesk.Satisfaction.Input._currentRating).show();this.redirect("#/satisfaction")});this.get("#/satisfaction/error",function(){});this.get("#/satisfaction/cancel",function(){Zendesk.Satisfaction.Input._satisfactionButtons.removeClass("selected");if(Zendesk.Satisfaction.Input._currentRating){Zendesk.Satisfaction.Input._form.hide();Zendesk.Satisfaction.Input._currentRatingContainer.show()}else{$j("#satisfaction_form_body").slideUp(500)}});this.get("#/satisfaction/comment/hide",function(){Zendesk.Satisfaction.Input._currentRatingContainer.find(".comment").slideUp().end().find("a.hide_comment").hide().end().find("a.show_comment").show()});this.get("#/satisfaction/comment/show",function(){Zendesk.Satisfaction.Input._currentRatingContainer.find(".comment").slideDown().end().find("a.show_comment").hide().end().find("a.hide_comment").show()});this.before("#/satisfaction/new",function(){Zendesk.Satisfaction.Input._currentRatingContainer.hide();Zendesk.Satisfaction.Input._form.show()});this.get("#/satisfaction/new",function(){var form=Zendesk.Satisfaction.Input._form;form.find('input[type="submit"]').prop("disabled",false)});this.before("#/satisfaction/new/poor",function(){Zendesk.Satisfaction.Input._reasonCode.show()});this.before("#/satisfaction/new/good",function(){Zendesk.Satisfaction.Input._reasonCode.hide()});this.get("#/satisfaction/new/:ratingName",function(){var ratingName=this.params.ratingName;var selected=Zendesk.Satisfaction.Input._satisfactionButtons.filter("."+ratingName);if(!selected.hasClass("selected")){Zendesk.Satisfaction.Input._satisfactionButtons.not(selected).removeClass("selected");selected.addClass("selected");$j("#satisfaction_form_body:hidden").slideDown(500);$j("#ticket_satisfaction_score").val(Zendesk.Satisfaction.Score[ratingName])}})});app.run("#/satisfaction");return app}}});jQuery(function(){Zendesk.Satisfaction.Input.init()});$j(function(){var $unitedStatesStateField=$j("#united-states-state-field"),$canadaStateField=$j("#canada-state-field"),$othersStateField=$j("#others-state-field"),$addressCountrySelect=$j("#address_country_id"),$currentStateField=enableStateField($addressCountrySelect.val());$unitedStatesStateField.find("select").select2({width:"310px"});$canadaStateField.find("select").select2({width:"310px"});$addressCountrySelect.change(function(e){$currentStateField.hide();$currentStateField.find("input").prop("disabled",true);$currentStateField.find("select").prop("disabled",true);$currentStateField.find("select").select2("disable");$currentStateField=enableStateField(e.val)});function enableStateField(countryId){if(countryId==156){$unitedStatesStateField.show();$unitedStatesStateField.find("select").prop("disabled",false);$unitedStatesStateField.find("select").select2("enable");return $unitedStatesStateField}else{if(countryId==29){$canadaStateField.show();$canadaStateField.find("select").prop("disabled",false);$canadaStateField.find("select").select2("enable");return $canadaStateField}else{$othersStateField.show();$othersStateField.find("input").prop("disabled",false);return $othersStateField}}}});Zendesk.NS("Zuora");Zendesk.Zuora.InvoicePage=function(){};Zendesk.Zuora.InvoicePage.prototype={show:function(){var self=this;$j("button[data-invoice-id]").click(function(){var currentElement=$j(this);var invoiceItemRowId="invoice-items-for-"+currentElement.data("invoice-id");var invoiceItemRow=function(){return $j("#"+invoiceItemRowId).first()};currentElement.find("span").html(invoiceItemRow().is(":visible")?"Details":"Hide");if(_.any(invoiceItemRow())){invoiceItemRow().toggle();return}$j(currentElement).addClass("activity").prop("disabled",true);$j.ajax({url:"/zuora/invoice/invoice_items.json?invoice_id="+$j(currentElement).data("invoice-id"),success:function(data){var invoiceItemRows=self.prepareInvoiceItems(data);var invoiceItemTable=$j('<table class="invoice-items">');invoiceItemTable.append('<tr><th>Description</th><th class="count">Quantity</th><th class="money">Amount</th><th class="money">Discount</th><th class="money">Total</th></tr>');_.each(invoiceItemRows,function(invoiceItem){var discountTotal=invoiceItem.discountAmount()+invoiceItem.discountPercentage();var isVoice=invoiceItem.description()=="Voice Usage";var quantityContent;if(isVoice){quantityContent="--"}else{quantityContent=invoiceItem.quantity()+" Agent(s)"}var invoiceItemRow=$j("<tr>").append($j("<td>").html(invoiceItem.description()).append($j("<div>").html(invoiceItem.serviceStartDate()+" to "+invoiceItem.serviceEndDate()))).append($j("<td>").addClass("count").html(quantityContent)).append($j("<td>").addClass("money").html("$"+invoiceItem.chargeAmount())).append($j("<td>").addClass("money").html("$"+discountTotal)).append($j("<td>").addClass("money").html("$"+invoiceItem.totalAmount()));invoiceItemTable.append(invoiceItemRow)});var currentRow=$j(currentElement).closest("tr");currentRow.after($j("<tr>").attr("id",invoiceItemRowId).append($j("<td colspan=5>").css("background-color",currentRow.find("td").first().css("background-color")).append(invoiceItemTable)));$j(currentElement).removeClass("activity").prop("disabled",false)}})})},prepareInvoiceItems:function(invoiceItems){var knownStartDates=_.uniq(_.pluck(invoiceItems,"service_start_date"));var dateAlignedCharges=_.map(knownStartDates,function(startDate){return _.filter(invoiceItems,function(item){return item.service_start_date==startDate})});return _.map(dateAlignedCharges,function(charges){return new Zendesk.Zuora.InvoiceItemRow(charges)})}};Zendesk.Zuora.InvoiceItemRow=function(attributeArray){this.rawInvoiceItems=attributeArray};Zendesk.Zuora.InvoiceItemRow.prototype={description:function(){return this._charge().charge_name},serviceStartDate:function(){return $j.datepicker.formatDate("mm-dd-yy",new Date(this.rawInvoiceItems[0].service_start_date))},serviceEndDate:function(){return $j.datepicker.formatDate("mm-dd-yy",new Date(this.rawInvoiceItems[0].service_end_date))},hasDiscount:function(){return _.any(this.rawInvoiceItems,function(invoiceItem){return invoiceItem.processing_type=="1"})},discountAmount:function(){if(!this.hasDiscount()){return 0}return parseFloat(this._discount().charge_amount)},discountPercentage:function(){if(!this.hasDiscount()){return 0}return" ("+this._discount().unit_price+"%)"},totalAmount:function(){return(parseFloat(this.chargeAmount())+parseFloat(this.discountAmount())).toFixed(2)},chargeAmount:function(){return parseFloat(this._charge().charge_amount).toFixed(2)},perUnitCharge:function(){return parseFloat(this._charge().unit_price).toFixed(2)},quantity:function(){return this._charge().quantity},_charge:function(){return _.find(this.rawInvoiceItems,function(invoiceItem){return invoiceItem.processing_type=="0"})},_discount:function(){return _.find(this.rawInvoiceItems,function(invoiceItem){return invoiceItem.processing_type=="1"})}};(function(){if(!this.require){var modules={},cache={};var require=function(name,root){var path=expand(root,name),indexPath=expand(path,"./index"),module,fn;module=cache[path]||cache[indexPath];if(module){return module}else{if(fn=modules[path]||modules[path=indexPath]){module={id:path,exports:{}};cache[path]=module.exports;fn(module.exports,function(name){return require(name,dirname(path))},module);return cache[path]=module.exports}else{throw"module "+name+" not found"}}};var expand=function(root,name){var results=[],parts,part;if(/^\.\.?(\/|$)/.test(name)){parts=[root,name].join("/").split("/")}else{parts=name.split("/")}for(var i=0,length=parts.length;i<length;i++){part=parts[i];if(part==".."){results.pop()}else{if(part!="."&&part!=""){results.push(part)}}}return results.join("/")};var dirname=function(path){return path.split("/").slice(0,-1).join("/")};this.require=function(name){return require(name,"")};this.require.define=function(bundle){for(var key in bundle){modules[key]=bundle[key]}};this.require.modules=modules;this.require.cache=cache}return this.require}).call(this);(function($){function zeroState(){return $(".zero-state").length!==0}function Capsule(element,options){this.element=$(element);options=$.extend({},options);this.activeHeaderElements=this.element.find(".clickable-header-item");if(options.dropdown){this.openText=options.dropdown.openText||"Edit";this.closeText=options.dropdown.closeText||"Close"}var capsule=this,menuOptions=[{element:"<li role='presentation' class='edit-action'><a role='menuitem' tabindex='-1' href='#''>"+capsule.openText+"</a></li>",onClick:function(event){capsule.element.closest(".capsule").trigger("open")}},{element:"<li role='presentation' class='close-action'><a role='menuitem' tabindex='-1' href='#''>"+capsule.closeText+"</a></li>",onClick:function(event){capsule.element.closest(".capsule").trigger("close")}}];if(options.dropdown&&options.dropdown.options){menuOptions=menuOptions.concat(options.dropdown.options)}this.element.find(".capsule-header").click(function(event){var target=$(event.target);if(target.is(capsule.activeHeaderElements)||capsule.activeHeaderElements.find(target).length){return}if(!capsule.isDisabled()&&!capsule.isNew()){capsule.toggle(event)}});this.element.find('button[type="reset"]').click(function(){capsule.close();if(capsule.isNew()){capsule.element.hide()}});this.element.on("open",this.open.bind(this));this.element.on("close",this.close.bind(this));this.onOpen=options.onOpen;this.onClose=options.onClose;if(options.dropdown){capsule.dropdown(menuOptions)}}Capsule.prototype.isDisabled=function(){return this.element.hasClass("disabled")};Capsule.prototype.toggle=function(event){return this.element.hasClass("closed")?this.open(event):this.close(event)};Capsule.prototype.open=function(event){this.element.removeClass("closed");if(this.onOpen){this.onOpen(event)}return this.element};Capsule.prototype.close=function(event){this.element.addClass("closed");if(this.onClose){this.onClose(event)}return this.element};Capsule.prototype.isNew=function(){return this.element.hasClass("new")};Capsule.prototype.isDefault=function(){return this.element.hasClass("default")};Capsule.prototype.dropdown=function(options){var $menu=this.element.find(".dropdown-menu");$(options).each(function(){var newElement=$(this.element);newElement.click(this.onClick);$menu.append(newElement)})};$.fn.capsule=function(options){this.each(function(){new Capsule($(this),options)});return this}}(jQuery));
/*!
 * .closestDescendant( selector [, findAll ] )
 * https://github.com/tlindig/jquery-closest-descendant
 *
 * v0.1.2 - 2014-02-17
 *
 * Copyright (c) 2014 Tobias Lindig
 * http://tlindig.de/
 *
 * License: MIT
 *
 * Author: Tobias Lindig <dev@tlindig.de>
 */
(function($){$.fn.closestDescendant=function(selector,findAll){if(!selector||selector===""){return $()}findAll=findAll?true:false;var resultSet=$();this.each(function(){var $this=$(this);var queue=[];queue.push($this);while(queue.length>0){var node=queue.shift();var children=node.children();for(var i=0;i<children.length;++i){var $child=$(children[i]);if($child.is(selector)){resultSet.push($child[0]);if(!findAll){return false}}else{queue.push($child)}}}});return resultSet}})(jQuery);require.define({"admin/flash_to_growl":function(exports,require,module){var lotusClient=require("admin/lotus_client");function processMessages(selector){$(selector).each(function(){lotusClient.growl($(this).html(),$(this).attr("class"))})}module.exports=Object.freeze({processMessages:processMessages})}});require.define({"admin/lotus_client":function(exports,require,module){var PromiseKlass=window.Promise;var mutex=false;function origin(location){return location.origin||location.protocol+"//"+location.hostname+(location.port?":"+location.port:"")}function sendXFrameMessage(msg){window.top.postMessage(JSON.stringify(msg),origin(window.location))}function modalXFrameMessage(name,memo){if(mutex){throw new Error("Cannot generate promise for multiple modal XFrame messages")}mutex=true;sendXFrameMessage({target:name,source:"admin-iframe",memo:memo});return getPromise(name)}function isValidOrigin(origin){var loc=window.location;var expectedOrigin=loc.protocol+"//"+loc.host;return origin===expectedOrigin}function xFrameResponseHandler(name,resolve,reject,event){if(!isValidOrigin(event.origin)||!event.data){return}var data=null;try{data=JSON.parse(event.data)}catch(e){return}if(data.target!==name||data.source==="admin-iframe"){return}if(data.confirmed){resolve(data)}else{reject(data)}mutex=false}function getPromise(name){var handler;return new PromiseKlass(function(resolve,reject){handler=xFrameResponseHandler.bind(null,name,resolve,reject);window.addEventListener("message",handler,false)}).then(function(data){window.removeEventListener("message",handler,false);return data})}function growl(message,action,options){sendXFrameMessage({target:"growl",source:"admin-iframe",memo:{action:action,message:message,options:options}})}function transitionTo(link){sendXFrameMessage({target:"route",source:"admin-iframe",memo:{hash:link}})}function closeModal(confirmed,data){sendXFrameMessage({target:"modal-close",source:"admin-iframe",memo:data,confirmed:!!confirmed})}function openModal(type,options){if(type==="iframe"&&!options.src){throw new Error("Iframe modal requires a 'src' to be defined")}return modalXFrameMessage("modal-open",{type:type,options:options})}function showConfirmationModal(options){return modalXFrameMessage("confirmation-modal",{title:options.title,message:options.message,confirmLabel:options.confirmLabel,cancelLabel:options.cancelLabel})}function showHelpCenter(){return modalXFrameMessage("show_help_center")}function showHelpCenterWithBrand(options){return modalXFrameMessage("show_help_center_for_brand",{brandId:options.brandId})}module.exports={configure:function(options){if(options.Promise){PromiseKlass=options.Promise}},showHelpCenter:showHelpCenter,showHelpCenterWithBrand:showHelpCenterWithBrand,showConfirmationModal:showConfirmationModal,growl:growl,transitionTo:transitionTo,openModal:openModal,closeModal:closeModal}}});require.define({"admin/onboarding":function(exports,require,module){var lotusClient=require("admin/lotus_client");var OnboardingMixin={getSteps:function(){return $(".onboarding-steps .step")},closeModal:function(confirmed,data){lotusClient.closeModal(confirmed,data)},changeStep:function(direction){var steps=this.getSteps();var currentStep=steps.filter(".current");var newStep;steps.removeClass("current");if(direction==="next"){newStep=currentStep.next()}else{if(direction==="prev"){newStep=currentStep.prev()}}newStep.addClass("current");this.updateStepper()},nextStep:function(){this.changeStep("next")},previousStep:function(){this.changeStep("prev")},updateStepper:function(){}};module.exports=OnboardingMixin}});(function($){function Tabs(container,options){options=$.extend({},options);this.container=$(container);this.linksContainer=container.closestDescendant(".tab-links");this.links=$("a",this.linksContainer);this.contentContainersContainer=container.closestDescendant(".tabs-content");this.contentContainers=$(" > div",this.contentContainersContainer);this.sharedContent=$(this.contentContainersContainer).siblings();var self=this;this.links.click(function(e){self.selectTab($(this));event.preventDefault()})}Tabs.prototype.selectTab=function(link){var otherLinks=this.links.not(link);var tabID=link.attr("href");var newlySelectedTab=this.contentContainers.filter(tabID);var otherTabs=this.contentContainers.not(newlySelectedTab);otherLinks.removeClass("current");otherTabs.hide();link.addClass("current");newlySelectedTab.trigger("tab.show");newlySelectedTab.show()};$.fn.tabs=function(options){this.each(function(){new Tabs($(this),options)});return this}}(jQuery));require.define({"admin/utils":function(exports,require,module){module.exports={mixin:function(){var args=Array.prototype.slice.call(arguments),obj=args.shift();args.forEach(function(props){Object.keys(props).forEach(function(prop){obj[prop]=props[prop]},this)},this)},ie9:function(){return $("html.ie9").length>0}}}});require.define({"admin/validation":function(exports,require,module){module.exports={clear:function(){this.element.closest(".validation").removeClass("success warning error error-silent");this.element.closest(".validation").find(".validation-message").remove();this.recountErrors()},success:function(options){this.clear();this.element.closest(".validation").addClass("success");this.validationMessage(options.message)},warning:function(options){this.clear();this.element.closest(".validation").addClass("warning");this.validationMessage(options.message);this.recountErrors()},error:function(options){this.clear();this.element.closest(".validation").addClass("error");this.validationMessage(options.message);this.recountErrors()},silentError:function(options){this.clear();this.element.closest(".validation").addClass("error-silent");this.recountErrors()},validationMessage:function(message){$("<div class='validation-message'></div>").text(message).appendTo(this.element.closest(".validation"))},disableSubmit:function(){this.element.closest("form").find('button[type="submit"]').attr("disabled","disabled")},enableSubmit:function(){this.element.closest("form").find('button[type="submit"]').removeAttr("disabled")},recountErrors:function(){var form=this.element.closest("form");if(form.find(".validation.error, .validation.error-silent").length>0){this.disableSubmit()}else{this.enableSubmit()}}}}});var lotusClient=require("admin/lotus_client");$z.defModule("settings/customers/_satisfaction_reasons",{inputStyles:"",reasons:{},maximum:5,minimum:2,nextReasonId:-1,dynamicContentRegEx:/{{dc.*}}/g,dom:{helpers:{toStringAttrs:function(attrs){return Object.keys(attrs||{}).map(function(key){return key+'="'+attrs[key]+'"'}).join(" ")},li:function(str,attrs){return"<li "+this.toStringAttrs(attrs)+">"+str+"</li>"},ul:function(str){return"<ul>"+str+"</ul>"},strong:function(str){return"<strong>"+str+"</strong>"},span:function(str,attrs){return"<span "+this.toStringAttrs(attrs)+">"+str+"</span>"},icon:function(attrs){return"<i "+this.toStringAttrs(attrs)+"></i>"},input:function(attrs){return"<input "+this.toStringAttrs(attrs)+"/>"},reason:function(attrs){return this.li(this.span(attrs.value,{"class":"reason_text"})+this.span(this.icon({"class":"icon-pencil edit_reason reason_icon"})+this.icon({"class":"icon-trash delete_reason reason_icon"}),{"class":"reason_icons"})+this.input({"data-reason-id":attrs.id,"class":"satisfaction_reason_input non_draggable edit_reason_input",style:attrs.inputStyles}),{"class":"sortable","data-reason-id":attrs.id})}}},initialize:function(reasons,locale_id,inputStyles){this.inputStyles=inputStyles;this.locale_id=locale_id||1;this.initReasons(reasons);this.initDom();this.initSortables();this.initListeners();this.render()},createReason:function(value,translated_value){var reason={id:this.nextReasonId,active:false,value:value,translated_value:translated_value||value,deleted:false,edited:false};this.nextReasonId--;return reason},initDom:function(){this.dom.reasonsContainer=$j("#reasons_container");this.dom.activeList=this.dom.reasonsContainer.find(".active");this.dom.inactiveColumn=this.dom.reasonsContainer.find(".inactive");this.dom.inactiveList=this.dom.inactiveColumn.find("ul");this.dom.placeholderText=this.dom.reasonsContainer.find(".emptylist_hint_text");this.dom.spacesAvailableCount=this.dom.reasonsContainer.find(".spaces_available_count");this.dom.satisfactionReasons=this.dom.reasonsContainer.find("#account_satisfaction_reasons");this.dom.addReasonButton=this.dom.reasonsContainer.find(".btn._tooltip");this.dom.addReasonInput=this.dom.reasonsContainer.find("#satisfaction_reason_input");this.dom.addReasonInputHelpText=this.dom.reasonsContainer.find(".satisfaction_reason_input_hint_text");this.dom.addReasonInput=this.dom.reasonsContainer.find(".add_reason_input");this.dom.addReasonInputHelpText=this.dom.reasonsContainer.find(".add_reason_input_hint_text");this.dom.editReasonIcon=this.dom.reasonsContainer.find(".edit_reason");this.dom.editReasonInput=this.dom.reasonsContainer.find(".edit_reason_input");this.dom.deleteReasonIcon=this.dom.reasonsContainer.find(".delete_reason")},initSortables:function(){this.dom.activeList.find(".sortablelist").sortable({placeholder:"sortable target",connectWith:this.dom.inactiveColumn.find(".sortablelist"),receive:this.handleActiveSortReceive.bind(this)});this.dom.inactiveColumn.find(".sortablelist").sortable({placeholder:"sortable target",connectWith:this.dom.activeList.find(".sortablelist"),receive:this.handleInactiveSortReceive.bind(this),over:this.handleInactiveSortover.bind(this),cancel:"#reasons_container .non_draggable"});this.dom.activeList.find(".icon-trash.delete_reason").hide()},initListeners:function(){this.dom.addReasonButton.click(this.handleAddReasonButtonClick.bind(this));this.dom.addReasonInput.blur(this.handleAddReasonInputBlur.bind(this));this.dom.editReasonIcon.click(this.handleShowEditReason.bind(this));this.dom.editReasonInput.blur(this.handleEnterEditReason.bind(this));this.dom.deleteReasonIcon.click(this.handleDeleteReasonClick.bind(this));this.dom.addReasonInput.keydown(this.handleInputKeyDown({escape:this.handleEscapeAddReason.bind(this),enter:this.handleEnterAddReason.bind(this)}));this.dom.editReasonInput.keydown(this.handleInputKeyDown({escape:this.handleEscapeEditReason.bind(this),enter:this.handleEnterEditReason.bind(this)}))},render:function(){this.updateSpacesAvailable();this.togglePlaceholderText();this.serializeReasons()},getActiveReasons:function(){return _.filter(this.reasons,function(reason){return reason.active&&!reason.deleted})},getInactiveReasons:function(){return _.filter(this.reasons,function(reason){return !reason.active&&!reason.deleted})},getSpacesAvailable:function(){return _.max([0,this.maximum-this.getActiveReasons().length])},togglePlaceholderText:function(){if(this.getInactiveReasons().length===0){this.dom.placeholderText.show()}else{this.dom.placeholderText.hide()}},updateSpacesAvailable:function(){var newSpacesAvailable;switch(this.getSpacesAvailable()){case 0:newSpacesAvailable=I18n.t("txt.admin.views.settings.customers._satisfaction.spaces_available.zero",{count:this.getSpacesAvailable()});break;case 1:newSpacesAvailable=I18n.t("txt.admin.views.settings.customers._satisfaction.spaces_available.one",{count:this.getSpacesAvailable()});break;default:newSpacesAvailable=I18n.t("txt.admin.views.settings.customers._satisfaction.spaces_available.other",{count:this.getSpacesAvailable()})}this.dom.spacesAvailableCount.text(newSpacesAvailable)},serializeReasons:function(){var remappedReasons=_.map(this.reasons,function(reason){return JSON.stringify(reason)});this.dom.satisfactionReasons.val("["+remappedReasons+"]")},setRecordActiveTo:function(value,item){var reasonId=$j(item).data("reason-id");_.find(this.reasons,function(reason){return reason.id===reasonId}).active=value},errorGrowl:function(heading,error){var growlHeading=this.dom.helpers.strong(heading);var growlBody=this.dom.helpers.ul(this.dom.helpers.li(error));lotusClient.growl(growlHeading+growlBody,"error")},handleDeleteReasonClick:function(e){var $li=$j(e.target).closest("li");var innerMessageText=I18n.t("txt.admin.views.settings.customers._satisfaction.delete_reason_modal_label");var message=this.dom.helpers.strong(innerMessageText);message=message+this.dom.helpers.span($li.find(".reason_text").text().trim(),{style:"padding-left: 60px"});lotusClient.showConfirmationModal({message:message,cancelLabel:I18n.t("txt.admin.javascript.views.twitter.cancel_label"),confirmLabel:I18n.t("txt.help_center.views.admin.appearance.theme_view.delete"),title:I18n.t("txt.admin.views.settings.customers._satisfaction.delete_reason_modal_heading")}).then(function(){this.deleteReason($li.data("reason-id"))}.bind(this))},handleInputKeyDown:function(options){return function(e){options=options||{};var supportedKeys={"27":"escape","13":"enter"};var keyPressed=supportedKeys[e.which];var functionToBeExecuted=options[keyPressed];if(functionToBeExecuted){if(keyPressed==="enter"){e.preventDefault()}functionToBeExecuted(e)}}},handleEscapeAddReason:function(){this.hideAndClearAddReasonInput();this.showAddReasonButton()},handleEnterAddReason:function(e){this.addReason(e.target.value);this.hideAndClearAddReasonInput();this.showAddReasonButton()},handleEscapeEditReason:function(e){var $input=$j(e.target);var $li=$input.closest("li");var $hintText=$li.find(".edit_reason_input_hint_text");$input.val("").hide();$hintText.hide();$li.find("span").show().removeAttr("style");this.showAddReasonButton();$li.addClass("sortable")},handleEnterEditReason:function(e){this.editReason($j(e.target).data("reason-id"),e.target.value);this.handleEscapeEditReason(e)},handleShowEditReason:function(e){var $li=$j(e.target).closest("li[data-reason-id]");var $hintText=$li.find(".edit_reason_input_hint_text");var $input=$li.find(".edit_reason_input");var reasonId=$li.data("reason-id");$li.find("span").hide();$li.removeClass("sortable");$input.val(this.reasons[reasonId].value.trim()).show().focus();$hintText.show();this.hideAddReasonButton()},deleteReason:function(id){if(!this.reasons[id]){return}if(id<0){delete this.reasons[id]}else{this.reasons[id].deleted=true}this.dom.reasonsContainer.find("li[data-reason-id="+id+"]").remove();this.serializeReasons();this.render()},addReason:function(value){if(!value.length){return}var reason=this.createReason(value);var li=this.dom.helpers.reason({id:reason.id,value:reason.value,inputStyles:this.inputStyles});var $newReason=this.dom.inactiveList.append(li);this.reasons[reason.id]=reason;$newReason.find(".edit_reason").click(this.handleShowEditReason.bind(this));$newReason.find(".edit_reason_input").blur(this.handleEnterEditReason.bind(this));$newReason.find(".edit_reason_input").keydown(this.handleInputKeyDown({escape:this.handleEscapeEditReason.bind(this),enter:this.handleEnterEditReason.bind(this)}));$newReason.find(".delete_reason").click(this.handleDeleteReasonClick.bind(this));this.serializeReasons();this.render();if(this.hasDynamicContent(value)){this.translateDynamicContent(reason)}},editReason:function(id,value){var reason=this.reasons[id];if(!value.length||!reason){return}reason.value=value;reason.translated_value=value;reason.edited=true;this.updateReasonTextInDom(reason);this.serializeReasons();this.render();if(this.hasDynamicContent(value)){this.translateDynamicContent(reason)}},updateReasonTextInDom:function(reason){this.dom.reasonsContainer.find("li[data-reason-id="+reason.id+"] .reason_text").text(reason.translated_value||reason.value)},handleAddReasonInputBlur:function(e){this.addReason(e.target.value);this.hideAndClearAddReasonInput();this.showAddReasonButton();this.togglePlaceholderText()},handleAddReasonButtonClick:function(e){this.showAddReasonButton();this.showAndFocusAddReasonInput();this.hideAddReasonButton()},handleActiveSortReceive:function(event,ui){if(this.getActiveReasons().length>=this.maximum){$j(ui.sender).sortable("cancel");this.errorGrowl(I18n.t("txt.admin.views.settings.customers._satisfaction.error_heading_adding_reason"),I18n.t("txt.admin.views.settings.customers._satisfaction.error_adding_reason",{count:this.maximum}));return}this.hideDeleteReasonIcon(ui.item);this.setRecordActiveTo(true,_.first(ui.item));this.render()},handleInactiveSortReceive:function(event,ui){if(this.getActiveReasons().length<=this.minimum){$j(ui.sender).sortable("cancel");this.errorGrowl(I18n.t("txt.admin.views.settings.customers._satisfaction.error_heading_removing_reason"),I18n.t("txt.admin.views.settings.customers._satisfaction.error_removing_reason",{count:this.minimum}));return}this.showDeleteReasonIcon(ui.item);this.setRecordActiveTo(false,_.first(ui.item));this.render()},handleInactiveSortover:function(){this.dom.placeholderText.hide()},showAndFocusAddReasonInput:function(){this.dom.addReasonInput.show().focus();this.dom.addReasonInputHelpText.show()},hideAndClearAddReasonInput:function(){this.dom.addReasonInput.hide().val("");this.dom.addReasonInputHelpText.hide()},showAddReasonButton:function(){this.dom.addReasonButton.show()},hideAddReasonButton:function(){this.dom.addReasonButton.hide()},hideDeleteReasonIcon:function(item){item.find(".icon-trash.delete_reason").hide()},showDeleteReasonIcon:function(item){item.find(".icon-trash.delete_reason").show()},hasDynamicContent:function(str){return str.search(this.dynamicContentRegEx)>-1},translateDynamicContent:function(reason){this.fetchDynamicContent(reason.value).then(function(response){reason.translated_value=response.value;this.updateReasonTextInDom(reason);this.serializeReasons()}.bind(this))},fetchDynamicContent:_.memoize(function(template){var api="/api/v2/format/dc";return $j.post(api,{template:template,locale_id:this.locale_id})}),initReasons:function(reasonsArray){reasonsArray.forEach(function(reason){this.reasons[reason.id]=reason}.bind(this))}});Zendesk.NS("Email");Zendesk.Email.RecipientAddress={init:function(scope){this.ADD_ADDRESS_SELECTOR=".add.colorbox";this.DELETE_SELECTOR=".delete.colorbox_inline";this.EDIT_SELECTOR=".edit_this.colorbox";this.MAKE_DEFAULT_SELECTOR=".make_default";scope=scope||jQuery("#recipient_addresses")[0];this.featuresPromise=this.loadFeatures();this.initBinding(scope)},initBinding:function(scope){this.bindTooltip(scope);this.bindMakeDefault(scope);this.bindRefreshForwarding(scope);this.bindAddAddress(scope);this.bindDelete(scope);this.bindEdit(scope)},loadFeatures:function(){return jQuery.ajax("/api/v2/account/features.json")},bindAddAddress:function(scope){var self=this;jQuery(this.ADD_ADDRESS_SELECTOR,scope).click(function(event){event.preventDefault();self.hasEmailAdminOnboardingAndLotus(function(){self.triggerLotusEmailSetupModal(event)},function(){self.triggerColorbox(event,function(){self.bindTooltip();self.bindSubmit()})});return false})},bindEdit:function(scope){var self=this;jQuery(this.EDIT_SELECTOR,scope).click(function(event){event.preventDefault();self.triggerColorbox(event,function(){self.hasEmailAdminOnboardingAndLotus(function(){var $row=jQuery(event.target).closest(".item.recipient_address");jQuery("#colorbox input[type=submit]").click(function(editEvent){editEvent.preventDefault();self.handleEdit(editEvent,$row);return false})},function(){self.bindTooltip();self.bindSubmit()})});return false})},bindDelete:function(scope){var self=this;jQuery(this.DELETE_SELECTOR,scope).click(function(event){event.preventDefault();self.triggerColorbox(event,function(){self.hasEmailAdminOnboardingAndLotus(function(){var $row=jQuery(event.target).closest(".item.recipient_address");jQuery("#colorbox .button.save[data-method=delete]").click(function(colorboxEvent){colorboxEvent.preventDefault();self.handleDelete(colorboxEvent,$row);return false})})});return false})},handleDelete:function(event,$row){var id=jQuery(event.target).attr("data-id");var self=this;jQuery.ajax({type:"DELETE",url:jQuery(event.target).attr("href"),dataType:"json",success:function(){jQuery.colorbox.close();$row.css({"background-color":"#f2fafd",transition:"opacity 0.5s ease-in-out"});setTimeout(function(){$row.css("opacity",0);$row.slideUp({duration:500})},200)},error:function(response){self.handleError(response)}})},triggerColorbox:function(event,onComplete){var $target=jQuery(event.target);var url=$target.attr("href");var options={};var self=this;if($target.attr("class").match("colorbox_inline")){options.html=jQuery(url).html()}else{options.href=url;options.innerWidth=395}if(onComplete){options.onComplete=function(){onComplete.call(self)}}jQuery.colorbox(options)},hasEmailAdminOnboardingAndLotus:function(newFn,oldFn){var self=this;this.featuresPromise.done(function(response){if(self.inLotus()&&response.features.email_admin_onboarding.enabled){newFn&&newFn.call(self)}else{oldFn&&oldFn.call(self)}})},inLotus:function(){return window.parent!==window},getEmailSetupModalStartPage:function(){var isAddZendeskAddress=jQuery(event.target).hasClass("add-zendesk-address");var isConnectOther=jQuery(event.target).hasClass("connect-other");var startPage="emailForwarding";if(isAddZendeskAddress){startPage="newSupportAddress"}else{if(isConnectOther){startPage="otherForwarding"}}return startPage},triggerLotusEmailSetupModal:function(event){var self=this;var startPage=this.getEmailSetupModalStartPage();var data={target:"email_setup_modal:show",options:{brandId:parseInt(jQuery(event.target).attr("data_brand_id")),startPage:startPage,makeDefault:false}};if(window.frameElement&&window.frameElement.id){data.options.iFrameId=window.frameElement.id}self.postToParent(data);var handler=function(messageEvent){self.emailSetupSuccess(event,messageEvent);window.removeEventListener("message",handler)};window.addEventListener("message",handler)},emailSetupSuccess:function(addAddressEvent,messageEvent){var message=JSON.parse(messageEvent.data);var self=this;var recipientAddressId;if(message.event==="email_setup_modal:close"&&(recipientAddressId=message.recipientAddressId)){var $row=jQuery("[data-id="+message.recipientAddressId+"]");if($row.length>0){self.highlightRow($row);return}jQuery.ajax("/settings/recipient_addresses/"+recipientAddressId).done(function(response){$row=jQuery(response).insertAfter(jQuery(addAddressEvent.target).parents("div.item"));self.initBinding($row);$row.css({opacity:0,"background-color":"#f2fafd",transition:"opacity 1s ease-in-out"});setTimeout(function(){$row.css("opacity",1)},200)})}},refreshRecipientAddressRow:function(id,$row){var self=this;jQuery.ajax("/settings/recipient_addresses/"+id).done(function(response){var html=jQuery(response).html();$row.html(html);self.initBinding($row);self.highlightRow($row)})},highlightRow:function($row){$row.css("transition","background-color 1s ease-in-out");setTimeout(function(){$row.css("background-color","#f2fafd")},200)},handleEdit:function(event,$row){var self=this;var $form=jQuery("#recipient_address_form");var $error=$form.find("#recipient_address_email_error");$error.html("&nbsp;");jQuery.ajax({type:$form.attr("method"),url:$form.attr("action"),data:$form.serialize(),dataType:"json",success:function(response){jQuery.colorbox.close();self.sendToGrowl("notice",I18n.t("txt.controllers.flash.notice.saved"));var id=response.id;self.refreshRecipientAddressRow(id,$row)},error:function(response){self.handleError(response);$error.html(response)}});return false},bindSubmit:function(){var $form=jQuery("#recipient_address_form");var self=this;$form.find("input[type=submit]").click(function(){var $error=$form.find("#recipient_address_email_error");$error.html("&nbsp;");jQuery.ajax({type:$form.attr("method"),url:$form.attr("action"),data:$form.serialize(),dataType:"json",success:function(){jQuery.colorbox.close();self.reloadPage()},error:function(response){$error.html(self.parseErrors(response).join("<br>"))}});return false})},bindTooltip:function(scope){jQuery("a[rel=tooltip]",scope).tooltip({tooltipClass:"gmail_recipient_address",show:true,position:{my:"right top",at:"right bottom"}})},bindMakeDefault:function(scope){var self=this;jQuery(this.MAKE_DEFAULT_SELECTOR,scope).click(function(event){event.preventDefault();self.makeDefault(jQuery(event.target).data("id"))})},makeDefault:function(id){var self=this;jQuery.ajax({type:"PUT",url:"/settings/recipient_addresses/"+id,dataType:"json",data:{recipient_address:{"default":true}},success:this.reloadPage,error:function(response){self.handleError(response)}})},livePreview:function(){jQuery(".live_preview").each(function(){var self=jQuery(this);var $form=jQuery(self.data("form"));var preview_url=self.data("url");var lastTimeout;var update=function(){var $disabled=$form.find(":input:disabled").removeAttr("disabled");var data=$form.serialize();$disabled.attr("disabled","disabled");jQuery("#cboxLoadedContent").css("height","auto");self.load(preview_url+"?"+data)};$form.find(":input").keyup(function(){if(lastTimeout){clearTimeout(lastTimeout)}lastTimeout=setTimeout(update,500)})})},bindEmailBrandSelect:function(brands){var $email=jQuery("#recipient_address_email");var $brand=jQuery("#recipient_address_brand_id");var change=function(){var domain=$email.val().split("@")[1];var brand_id=brands[domain];if(brand_id){$brand.val(brand_id);$brand.attr("disabled","disabled")}else{$brand.removeAttr("disabled")}};$email.change(change);change()},reloadPage:function(){jQuery("#recipient_addresses").responsiveLoad("/settings/recipient_addresses/table",function(){Zendesk.Email.RecipientAddress.init()})},bindRefreshForwarding:function(scope){var self=this;jQuery(".refresh_status",scope).click(function(event){event.preventDefault();var $link=jQuery(this);var recipientAddressId=$link.data("id");self.sendToGrowl("progress",I18n.t("txt.controllers.flash.progress.verification"));jQuery.ajax({type:"PUT",url:"/api/v2/recipient_addresses/"+recipientAddressId+"/verify",data:{type:$link.data("type")},dataType:"json",success:function(){self.hasEmailAdminOnboardingAndLotus(function(){self.sendToGrowl("notice",I18n.t("txt.controllers.flash.notice.saved"));var $row=jQuery(event.target).parents(".item.recipient_address");self.refreshRecipientAddressRow(recipientAddressId,$row)},function(){self.reloadPage()})},error:function(response){self.handleError(response)}})})},postToParent:function(data){if(data!=null&&typeof data==="object"){data=JSON.stringify(data)}var loc=window.location;var origin=loc.protocol+"//"+loc.host;window.top.postMessage(data,origin)},handleError:function(response){var errorMessages=this.parseErrors(response);this.sendToGrowl("error",errorMessages.join("<br>"))},sendToGrowl:function(action,msg){var data={target:"growl",memo:{action:action,message:msg,options:{sticky:false,life:2000}}};this.postToParent(data)},parseErrors:function(response){var responseJSON=JSON.parse(response.responseText);if(responseJSON&&responseJSON.details){var errorMessages=[];for(var attr in responseJSON.details){errorMessages=errorMessages.concat(responseJSON.details[attr][0].description)}return errorMessages}return[I18n.t("txt.controllers.flash.error.saved")]}};(function($){Zendesk.SalesforceConfiguration={init:function(){this.cache();this.events()},cache:function(){this.$openEditorLnk=$(".edit_salesforce_object");this.$openFilterLnk=$(".edit_object_filter");this.$expandLnk=$(".expand_link");this.$contractLnk=$(".contract_link");this.$selectLnk=$(".add_link a");this.$deselectLnk=$(".remove_link a");this.$objectForm=$("#salesforce_object_form");this.$filterForm=$("#salesforce_filter_form");this.$resetLnk=$("#reset_fields");this.$confSelector=$("#account_settings_use_salesforce_configuration");this.$configuration=$("#salesforce_configuration");this.$lookupChx=$("#account_settings_salesforce_integration");this.$lookupField=$("#lookup_field");this.boxWidth="820px";this.boxHeight="600px";this.sortTarget="salesforce_selected_objects";this.sortContainer="salesforce_selected_objects_sort";this.sortList="salesforce_selected_objects_sort_list"},events:function(){var _this=this;this.$openEditorLnk.live("click",function(){$.colorbox({href:$(this).attr("href"),width:_this.boxWidth,height:_this.boxHeight,onComplete:function(){_this.objSelector().change()}});return false});this.$openFilterLnk.live("click",function(){$.colorbox({href:$(this).attr("href"),width:_this.boxWidth,height:"380px",onComplete:function(){$("#date_filter_value").datepicker();$("#regular_filter_field, #date_filter_field").change()}});return false});$("#regular_filter_field, #date_filter_field").live("change",function(){if($(this).val()===""){$(this).addClass("empty")}else{$(this).removeClass("empty")}});this.$expandLnk.live("click",function(){var folder,children;folder=$(this).closest(".folder");children=_this.getChildren(folder);if(folder.data("loaded")===false){_this.loadFolder(folder,children,$(this))}_this.expandFolder(folder,children);return false});this.$contractLnk.live("click",function(){var folder,children;folder=$(this).closest(".folder");children=_this.getChildren(folder);_this.contractFolder(folder,children);return false});this.$selectLnk.live("click",function(){var field=$(this).closest(".field").data("field");_this.selectField(field);return false});this.$deselectLnk.live("click",function(){var field=$(this).closest("li").data("field");_this.deselectField(field);return false});this.$objectForm.live("submit",function(){if($("#mapping_salesforce_field option").length===0){alert(I18n.t("txt.admin.views.settings.extensions._salesforce3.select_some_field_alert"));return false}var formData,labels,relationships;formData=$(this).serializeArray();labels={};relationships={};$(".selected_fields li.field.selected").each(function(){var field,title,folder;field=$(this).data("field");title=$(this).data("title");formData.push({name:"fields[]",value:field});labels[field]=title;folder=_this.getFolder($(this));if(folder.exists()){relationships[folder.data("relationship")]={object:folder.data("object"),type:folder.data("type")}}});formData.push({name:"object_label",value:_this.selectedObjectLabel()});formData.push({name:"labels",value:JSON.stringify(labels)});formData.push({name:"relationships",value:JSON.stringify(relationships)});formData.push({name:"mapping_salesforce_field_type",value:$("#mapping_salesforce_field option:selected").data("type")});formData.push({name:"authenticity_token",value:Zendesk.currentUser.authenticityToken});$.post(_this.saveObjectUrl(),$.param(formData)).done(function(data){$("#salesforce_configuration").html(data)}).fail(function(jqXHR){$("#salesforce_configuration").prepend(jqXHR.responseText)}).always(function(){_this.setupSort();$.colorbox.close()});return false});this.$filterForm.live("submit",function(){var formData,filters,regularFilter,dateFilter;formData=[];formData.push({name:"object",value:$("#object_name").val()});formData.push({name:"relationship_name",value:$("#relationship_name").val()});formData.push({name:"limit",value:$("#limit").val()});regularFilter={field:$("#regular_filter_field").val(),type:$("#regular_filter_field option:selected").data("type"),operator:$("#regular_filter_operator").val(),value:$("#regular_filter_value").val()};dateFilter={field:$("#date_filter_field").val(),type:$("#date_filter_field option:selected").data("type"),operator:$("#date_filter_operator").val(),value:$("#date_filter_value").val()};formData.push({name:"filters[]",value:JSON.stringify(regularFilter)});formData.push({name:"filters[]",value:JSON.stringify(dateFilter)});formData.push({name:"authenticity_token",value:Zendesk.currentUser.authenticityToken});$.post(_this.saveFilterUrl(),$.param(formData)).done(function(data){}).fail(function(jqXHR){$("#salesforce_configuration").prepend(jqXHR.responseText)}).always(function(){$.colorbox.close()});return false});this.$resetLnk.live("click",function(){$("#regular_filter_field, #regular_filter_value, #date_filter_field, #date_filter_value").val("");$("#limit").val("5");$("#regular_filter_field, #date_filter_field").change();return false});this.objSelector().live("change",function(){var fieldsContainer,loadingMessage,object,label;object=$(this).val()||"";label=_this.selectedObjectLabel();fieldsContainer=$("#salesforce_fields");loadingMessage=_this.loadingImage()+"  "+I18n.t("txt.admin.views.settings.extensions._salesforce3.loading_fields",{object_name:label});fieldsContainer.html('<div class="salesforce_item">'+loadingMessage+"</div>");fieldsContainer.load(_this.fieldsUrl(object),function(){_this.setupFieldsSort();_this.addMappingSalesforceFields()})});this.testForm().find(":submit").live("click",function(){var fields,testData,crmApp;fields=_this.testForm().find("input[type=text]");testData=fields.serializeArray();crmApp=new Zendesk.CRM.Application(new Zendesk.CRM.SidebarRenderer());crmApp.fetchAndRenderData(_this.testUrl()+"?format=json&"+$.param(testData));return false});this.$confSelector.change(function(){var value=$(this).val();if(value==="0"){_this.$configuration.slideUp()}else{_this.$configuration.slideDown()}});this.$confSelector.change();this.$lookupChx.change(function(){if($(this).is(":checked")){_this.$lookupField.slideDown()}else{_this.$lookupField.slideUp()}});this.$lookupChx.change();$("a#cancel_sorting").live("click",function(){Ordering.cancelOrdering("#"+_this.sortTarget);return false});$("a#start_sorting").live("click",function(){Ordering.SetOrder("#"+_this.sortTarget);return false});this.setupSort()},selectField:function(field){var fieldElement,folder;fieldElement=$('li[data-field="'+field+'"]');folder=this.getFolder(fieldElement);fieldElement.removeClass("non_selected");fieldElement.closest("li").addClass("selected");folder.removeClass("non_selected");folder.closest("li").addClass("selected");this.addMappingSalesforceField(fieldElement)},deselectField:function(field){var fieldElement,folder;fieldElement=$('li[data-field="'+field+'"]');fieldElement.removeClass("selected");fieldElement.closest("li").addClass("non_selected");folder=this.getFolder(fieldElement);if(this.getChildren(folder).find("li.field.selected").length===0){folder.removeClass("selected");folder.closest("li").addClass("non_selected")}this.mappingSalesforceField().find("option[value='"+field+"']").remove()},expandFolder:function(folder,children){children.show();folder.addClass("expanded");folder.removeClass("contracted")},contractFolder:function(folder,children){children.hide();folder.addClass("contracted");folder.removeClass("expanded")},addMappingSalesforceField:function(fieldElement){var field,type,title,selected;field=fieldElement.data("field");type=fieldElement.data("type");title=fieldElement.data("title");selected=(field===this.mappingSalesforceField().data("selected"))?"selected=selected":"";if(!field.include("::")&&type!=="textarea"){this.mappingSalesforceField().append('<option value="'+field+'" data-type="'+type+'" '+selected+">"+title+"</option>")}},addMappingSalesforceFields:function(){var _this=this;$(".selected_fields li.field.selected").each(function(){_this.addMappingSalesforceField($(this))})},getChildren:function(folder){return folder.parent().find(".children")},getFolder:function(field){return field.parents(".folder_container").find(".folder")},fieldsUrl:function(object){var params={object:object};return"extensions/edit_salesforce_fields?"+$.param(params)},relatedFieldsUrl:function(folder){var params={object:folder.data("object"),relationship_name:folder.data("relationship")};return"extensions/salesforce_related_fields?"+$.param(params)},saveObjectUrl:function(){return"extensions/save_salesforce_object"},saveFilterUrl:function(){return"extensions/save_object_filter"},testUrl:function(){return"/crm/sync_ticket_info"},setupSort:function(){$("#"+this.sortList).sortable();submit_sortable_list(this.sortTarget,this.sortContainer,this.sortList,"extensions/sort_salesforce_objects")},setupFieldsSort:function(){var fields=$(".selected_fields").data("fields");$(".selected_fields .primary.selected").sortElements(function(a,b){return fields.indexOf($(a).data("field"))>fields.indexOf($(b).data("field"))?1:-1});$(".selected_fields .folder.selected").each(function(){$(this).parent().find(".field.selected").sortElements(function(a,b){return fields.indexOf($(a).data("field"))>fields.indexOf($(b).data("field"))?1:-1})});$(".selected_fields .primary_sortable_fields").sortable({cursor:"move",items:"li.selected.field.primary"}).disableSelection();$(".selected_fields .related_sortable_fields").sortable({cursor:"move",items:"li.selected.field.related"}).disableSelection()},loadFolder:function(folder,children){var _this,contractLink,contractImage;_this=this;contractLink=folder.find(".contract_link");contractImage=contractLink.html();contractLink.html(this.loadingImage);children.load(_this.relatedFieldsUrl(folder),function(){folder.data("loaded",true);_this.copyFolder(folder.data("relationship"),children);contractLink.html(contractImage);_this.setupFieldsSort()})},loadingImage:function(){return'<img src="/images/ajax_loader_small.gif" style="width:9px">'},copyFolder:function(relationship,children){var selectedFolder=this.selectedFields().find('li[data-relationship="'+relationship+'"]');selectedFolder.data("loaded",true);selectedFolder.addClass("expanded");selectedFolder.removeClass("contracted");this.getChildren(selectedFolder).html(children.html())},selectedObjectLabel:function(){return this.objSelector().find("option:selected").html()},selectedFields:function(){return $(".selected_fields")},testForm:function(){return $("#crm_test_form")},objSelector:function(){return $("#salesforce_object")},mappingSalesforceField:function(){return $("#mapping_salesforce_field")}}}(jQuery));$z.defModule("settings/extensions/show",{initialize:function(params){$j("#crm_integration").change(function(){var value=$j(this).val();if(value=="SalesforceIntegration"){$j("#sugar, #ms_dynamics").hide();$j("#salesforce").show()}else{if(value=="SugarCrmIntegration"){$j("#salesforce, #ms_dynamics").hide();$j("#sugar").show()}else{if(value=="MsDynamicsIntegration"){$j("#salesforce, #sugar").hide();$j("#ms_dynamics").show()}}}});$j("#ms_dynamics_integration_type_code").change(function(){var value=$j(this).val();if(value==="0"){$j(".ms_dynamics_on_premise").hide();$j(".ms_dynamics_on_ifd").hide();$j(".ms_dynamics_on_cloud").show()}else{if(value==="1"){$j(".ms_dynamics_on_cloud").hide();$j(".ms_dynamics_on_ifd").hide();$j(".ms_dynamics_on_premise").show()}else{$j(".ms_dynamics_on_cloud").hide();$j(".ms_dynamics_on_premise").hide();$j(".ms_dynamics_on_ifd").show()}}});$j("#ms_dynamics_integration_type_code").change();$j("#settings_extensions_ms_dynamics_save_button").click(function(){$j(this).val(I18n.t("txt.admin.public.javascript.views.settings.extensions.testing_connection_please_wait")).prop("disabled",true);$j("#ms_dynamics_form").submit()});$j("#settings_extensions_sugar_crm_save_button").click(function(){$j(this).val(I18n.t("txt.admin.public.javascript.views.settings.extensions.testing_connection_please_wait")).prop("disabled",true);$j("#sugar_crm_form").submit()});$j("#settings_extensions_salesforce_connect_button").click(function(){this.href="/settings/extensions/connect_to_salesforce?salesforce_environment="+$j("select#salesforce_environment option:selected").val();Zendesk.Instrumentation.track("Enabling salesforce.com","CRM")});Zendesk.SalesforceConfiguration.init()}});(function($){Zendesk.NS("Branding");Zendesk.Branding={init:function(branding,dynamicContent){this.branding=branding;this.dynamicContent=dynamicContent;this.colorCalc=require("views/color_preview/color_calc");this.hasLotusPreview=Zendesk.embeddedInLotusAdmin()&&$("#inner_branding_styles").length>0;this.cache();this.imgloader();this.autocomplete();this.events();this.xFrameInit();if(this.hasLotusPreview){this.preview=require("views/color_preview/preview_client").init()}},cache:function(){this.$el={previewHeaderWrapper:$("div#mobile-settings #settings_mobile_preview"),previewHeader:$("div#mobile-settings #mobile-header-wrapper header"),previewHeaderTitle:$("div#mobile-settings #settings_mobile_preview h1"),previewHeaderLogo:$("div#mobile-settings #logo-wrapper img"),previewHeaderSearch:$("div#mobile-settings #search-button"),inputTitle:$("#account_mobile_title"),inputFileLogo:$("#mobile_logo_uploaded_data:file"),pageHeaderDarker:$("#branding_tab_background_color"),revertColorsLink:$("#revert_colors_link"),lotusPreviewLink:$("#preview_color_link"),headerColor:$("#branding_header_color"),pageBackgroundColor:$("#branding_page_background_color"),sideboxColor:$("#branding_sidebox_color"),tabBackgroundColor:$("#branding_tab_background_color"),tabHoverColor:$("#branding_tab_hover_color"),textColor:$("#branding_text_color"),classicLogo:$("#image-block-header_logo img"),mobileLogo:$("#image-block-mobile_logo img"),saveButton:$("#settings_account_branding_save_button"),innerBrandingStyles:$("#inner_branding_styles")}},xFrameInit:function(){var globalEvents=require("views/color_preview/global_events");require("views/color_preview/x_frame_com").setup();globalEvents.on("@action:preview_state_response",this.previewStateHandler.bind(this))},imgloader:function(){this.fileReader=window.FileReader?new FileReader():false},autocomplete:function(){if(currentAccount.hasFeature("placeholderSuggestions")){this.suggest=new Suggest();this.suggest.suggestions=this.placeholders()}else{this.suggest=false}},placeholders:function(){var dc,placeholders={},placeholder;for(dc in this.dynamicContent){placeholder=this.dynamicContent[dc];placeholders["{{"+dc+"}}"]=placeholder.name}return placeholders},calculateLogoDimension:function(size){if(size>55){size=parseInt((size/114)*55,10)}else{size=null}return size},events:function(){var _this=this;if(this.fileReader){this.$el.inputFileLogo.change(function(){if(this.files&&this.files[0]){_this.fileReader.readAsDataURL(this.files[0])}});this.fileReader.onload=function(event){var img=$("<img src='"+event.target.result+"' />").load(function(){$(img).attr({width:_this.calculateLogoDimension(this.width),height:_this.calculateLogoDimension(this.height)});_this.updateLogo.call(_this,img)})}}if(this.suggest){this.$el.inputTitle.bind({focusin:function(event){_this.suggest.attach(this,event)},focusout:function(event){_this.suggest.detach(this,event)}})}if(!Zendesk.embeddedInLotusAdmin()){this.$el.lotusPreviewLink.remove()}this.$el.inputTitle.keyup(function(){_this.updateTitle()});this.$el.headerColor.change(function(){if(!Zendesk.embeddedInLotusAdmin()){_this.updateHeaderColors()}});this.$el.pageBackgroundColor.change(function(){_this.updatePageBgColor()});this.$el.revertColorsLink.click(function(){_this.revertColors();_this.updateHeaderColors()});this.$el.lotusPreviewLink.click(function(){_this.preview.startLotusPreview(_this.$el.headerColor.val(),"preview_manager_start")});this.$el.previewHeaderWrapper.click(function(){return false});this.$el.saveButton.click(function(event){if(_this.doubleCheck()||!(_this.colorElementsPresent())){if(_this.hasLotusPreview){_this.preview.setBranding(_this.$el.headerColor.val())}return true}var msg=I18n.t("txt.admin.views.settings.account._branding.hex_not_valid");alert(msg);event.preventDefault();return false})},updateLogo:function(img){this.$el.previewHeaderLogo.replaceWith(img);this.$el.previewHeaderLogo=img},updateTitle:function(){var title=this.$el.inputTitle.val(),dynamicTitle=this.dynamicTitle(title);this.$el.previewHeaderTitle.text(dynamicTitle)},dynamicTitle:function(title){var reg=new RegExp("{{([^}]{2,})}}","gi"),_this=this;return title.replace(reg,function(placeholder){var key=placeholder.substring(2,placeholder.length-2);return _this.dynamicContent[key].value})},colorElementsPresent:function(){return this.$el.pageBackgroundColor.length&&this.$el.headerColor.length},updatePageBgColor:function(){var color=this.$el.pageBackgroundColor.val(),hex=this.colorCalc.sanitize(color);if(!hex){return false}this.$el.pageBackgroundColor.val(hex);return true},updateHeaderColors:function(){var color=this.$el.headerColor.val();var colors=this.colorCalc.calculateColors(color);if(!colors){return false}this.updateInputFields(colors.bgColor,colors.tabBgColor,colors.tabHoverColor,colors.textColor);this.updateHeaderPreview(colors.bgColor,colors.tabBgColor,colors.borderColor,colors.textColor);this.updateLogoBackgrounds(colors.bgColor);return true},updateInputFields:function(bgColor,tabBgColor,tabHoverColor,textColor){this.$el.headerColor.val(bgColor);this.$el.tabBackgroundColor.val(tabBgColor);this.$el.tabHoverColor.val(tabHoverColor);this.$el.textColor.val(textColor)},updateHeaderPreview:function(bgColor,bgColorDarker,borderColor,textColor){this.$el.previewHeader.css({"background-color":"#"+bgColor}).css({"background-image":"-webkit-linear-gradient(top, #"+bgColor+", #"+bgColorDarker+")"}).css({"background-image":"-moz-linear-gradient(top, #"+bgColor+", #"+bgColorDarker+")"}).css({"background-image":"-ms-linear-gradient(top, #"+bgColor+", #"+bgColorDarker+")"}).css({"background-image":"-o-linear-gradient(top, #"+bgColor+", #"+bgColorDarker+")"}).css({"background-image":"linear-gradient(top, #"+bgColor+", #"+bgColorDarker+")"});this.$el.previewHeaderSearch.css({"background-color":"#"+bgColorDarker});this.$el.previewHeader.css({"border-bottom-color":"#"+borderColor});this.$el.previewHeaderTitle.css({color:"#"+textColor,"text-shadow":textColor==="FFFFFF"?"0px -1px rgba(0, 0, 0, 0.5)":"none"})},previewStateHandler:function(data){if(data.memo.previewing){this.$el.headerColor.val(data.memo.previewing)}},revertColors:function(){this.$el.sideboxColor.val(this.branding.sidebox_color);this.$el.headerColor.css("background-color","#"+this.branding.header_color).val(this.branding.header_color);this.$el.pageBackgroundColor.css("background-color","#"+this.branding.page_background_color).val(this.branding.page_background_color)},updateLogoBackgrounds:function(bgColor){this.$el.classicLogo.css({"background-color":"#"+bgColor});this.$el.mobileLogo.css({"background-color":"#"+bgColor})},doubleCheck:function(){return this.updateHeaderColors()&&this.updatePageBgColor()}}}(jQuery));$z.defModule("settings/account/_branding",{initialize:function(branding,dynamicContent){Zendesk.Branding.init(branding,dynamicContent)}});(function($z,$j,_,I18n){var options={searchBoostSliderSelector:null,onlyEnduserSliderLabel:"",onlyAgentsSliderLabel:""};function initializeBoostCuratedContentSlider(){var valueMappings={"10:1":-0.9,"4:1":-0.75,"2:1":-0.5,"1:1":0,"1:2":0.5,"1:4":0.75,"1:10":0.9};valueMappings[options.onlyAgentsSliderLabel]=-1;valueMappings[options.onlyEnduserSliderLabel]=1;function keyOfValue(value){var key,found=_.find(valueMappings,function(eachValue,eachKey){key=eachKey;return value===eachValue});return found!==undefined&&key}function onSliderChange(value){$j("#account_settings_boost_curated_content").val(value.toFixed(2));var $label=$j("#curated-search-slider .label"),key=keyOfValue(value);$label.text(key)}function setupBackGround(){var bg=$j("div.slider-bg");bg.html("<div/><div/><div/>");var divs=$j("div.slider-bg > div"),sliderWidth=divs.parent().width(),smallWidth=10,spacing=6;divs.filter(":nth-child(1)").css({width:smallWidth,left:0});divs.filter(":nth-child(2)").css({width:sliderWidth-smallWidth-smallWidth-2*spacing,left:smallWidth+spacing});divs.filter(":nth-child(3)").css({width:smallWidth,left:sliderWidth-smallWidth})}var relativePositions={"10:1":1+10*0.01,"4:1":1+10*0.3,"2:1":1+10*0.4,"1:1":1+10*0.5,"1:2":1+10*0.6,"1:4":1+10*0.7,"1:10":1+10*0.99};relativePositions[options.onlyAgentsSliderLabel]=1-0.9;relativePositions[options.onlyEnduserSliderLabel]=1+10+0.9;function valuePosition(val){return relativePositions[keyOfValue(val)]}setupBackGround();var values=_.values(valueMappings),value=parseFloat($j("#account_settings_boost_curated_content").val())||0,valuePositions=values.collect(function(value){return valuePosition(value)});$z.Slider.setup(options.searchBoostSliderSelector,{onSliderChange:onSliderChange,range:[0,12],relativePositions:valuePositions,values:values,value:value,showTicks:true})}$j(function(){function showTOS(){var tos_confirmed=(confirm(I18n.t("txt.admin.spam_filter.tos_v2")))?"sf":"cm";var radio_id="#account_spam_prevention_"+tos_confirmed;$j(radio_id).prop("checked",true)}$j("#account_spam_prevention_sf").click(function(e){showTOS()});$j("#account_settings_spam_prevention").click(function(e){if($j("#account_settings_spam_prevention").is(":checked")){showTOS()}})});$z.defModule("settings/portal/_settings",{initialize:function(params){options.searchBoostSliderSelector=params&&params.sliderId;if(!options.searchBoostSliderSelector){return}options.onlyEnduserSliderLabel=params.enduser_string;options.onlyAgentsSliderLabel=params.agents_string;$j(initializeBoostCuratedContentSlider)}})})(this.Zendesk,this.jQuery,this._,this.I18n);Zendesk.NS("Screenr");Zendesk.Screenr.Provisioning={init:function(domain,triggeringCheckBoxId,scope){Zendesk.Screenr.Provisioning.requestedDomain=domain;Zendesk.Screenr.Provisioning.scope=scope;this.bindCheckBox(triggeringCheckBoxId);this.bindProvisioningForm()},requestedDomain:"",triggeringCheckBoxId:"",scope:"",bindCheckBox:function(checkBoxId){$j(checkBoxId).click(function(event){this.showProvisioningModal();event.preventDefault()}.bind(this));Zendesk.Screenr.Provisioning.triggeringCheckBoxId=checkBoxId},showProvisioningModal:function(){$j.colorbox({inline:true,href:"#screenr_provisioning",width:"620px",onComplete:function(){$j("#screenr_provisioning  #domain").focus()},onClosed:function(){Zendesk.Screenr.Provisioning._removeError()}})},bindProvisioningForm:function(){$j("#screenr_provisioning form").submit(function(event){event.preventDefault();this.onSubmit()}.bind(this))},onSubmit:function(){Zendesk.Screenr.Provisioning._disableSubmitButton();Zendesk.Screenr.Provisioning._removeError();Zendesk.Screenr.Provisioning._enqueueProvisioning()},_enqueueProvisioning:function(){if(this.poller){this.poller.stop()}$j("#provisioning_spinner").show();$j.ajax({type:"POST",url:"/screenr_tenants",data:{domain:Zendesk.Screenr.Provisioning.requestedDomain,scope:Zendesk.Screenr.Provisioning.scope},success:this._startPoller.bind(this)})},_startPoller:function(response){var ajaxParams={url:response.status_url,type:"GET",dataType:"json"};this.poller=new Zendesk.Utils.Poller(ajaxParams,1000,20000,this._pollingCallback.bind(this),this._errorCallback.bind(this),this._timeoutCallback.bind(this));this.poller.start()},_pollingCallback:function(response){switch(response.job_status.status){case"completed":this._onCompletedPolling(response.job_status.results);break;case"failed":this._errorCallback(this);break;case"killed":this._errorCallback(this);break;default:return true}},_onCompletedPolling:function(results){switch(results.api_status){case"provisioned":this._onSucessfulProvisioning();break;case"validation_failed":this._onValidationFailed(results.message,results.error_on);break;default:this._errorCallback(this)}},_onSucessfulProvisioning:function(){$j("#provisioning_spinner").hide();var account_created_text=I18n.t("public.javascripts.views.settings.screencasts.screenr_account_created"),close_text=I18n.t("public.javascripts.views.settings.screencasts.close_window_button"),final_feedback_text=I18n.t("public.javascripts.views.settings.screencasts.final_feedback"),feedback_modal=$j('<div class="info">'),feedback_main=$j("<p>"),close_bt_wrapper=$j('<div class="submit">'),close_bt=$j('<input class="button" name="commit" type="submit"/>');$j("#screenr_provisioning").html("");feedback_modal.html("&#10004;&nbsp; "+account_created_text).appendTo($j("#screenr_provisioning"));feedback_main.html(final_feedback_text).appendTo($j("#screencasts_wrapper"));close_bt.attr("value",close_text).appendTo(close_bt_wrapper).click(function(event){$j.colorbox.close();feedback_main.effect("highlight",{},3000)}.bind(this));close_bt_wrapper.appendTo($j("#screenr_provisioning"));Zendesk.Screenr.Provisioning._setTriggeringCheckboxAsChecked(Zendesk.Screenr.Provisioning.triggeringCheckBoxId);$j.colorbox.resize();_.defer(function(){$j.colorbox.resize()})},_setTriggeringCheckboxAsChecked:function(checkBoxId){$j(checkBoxId).attr("checked",true).unbind().click(function(event){event.preventDefault()})},_onValidationFailed:function(message,error_on){this._displayError(message);$j("#provisioning_spinner").hide();$j("#downgrading_spinner").hide();this._enableSubmitButton();this._enableDowngradingButton()},_errorCallback:function(response){this._displayError(I18n.t("public.javascripts.views.settings.screencasts.screenr_unavailable"));$j("#provisioning_spinner").hide();$j("#downgrading_spinner").hide();this._enableSubmitButton();this._enableDowngradingButton()},_timeoutCallback:function(response){this._displayError(I18n.t("public.javascripts.views.settings.screencasts.screenr_unavailable"));$j("#provisioning_spinner").hide();$j("#downgrading_spinner").hide();this._enableSubmitButton();this._enableDowngradingButton()},_displayError:function(message){$j(".error").html(message).show();$j.colorbox.resize();_.defer(function(){$j.colorbox.resize()})},_removeError:function(){$j(".error").hide();$j.colorbox.resize();_.defer(function(){$j.colorbox.resize()})},_disableSubmitButton:function(){$j("#screenr_provisioning .button").attr("disabled","disabled")},_enableSubmitButton:function(){$j("#screenr_provisioning .button").removeAttr("disabled")},recorderId:null,host:null,screenrBaseUri:null,confirmState:false,setupDowngrade:function(recorderId,host,screenrBaseUri){this.recorderId=recorderId;this.host=host;this.screenrBaseUri=screenrBaseUri;this._bindDowngradeLink()},_bindDowngradeLink:function(){$j("#screenr_downgrade").click(function(event){this._checkTenantStatus();event.preventDefault()}.bind(this))},_checkTenantStatus:function(){var checkUrl=Zendesk.Screenr.Helper.publicUrlToTenantStatus(this.recorderId,this.host,this.screenrBaseUri);$j.ajax({type:"GET",url:checkUrl,success:this._parseTenantStatus.bind(this),error:this._errorCallback.bind(this)})},_parseTenantStatus:function(data){var response=data;if(typeof response=="string"){response=response.evalJSON()}switch(response.StatusCode){case 200:this._displayDowngrade();break;case 403:this._displayImpossibleToDowngrade();break;default:this._errorCallback()}},_displayImpossibleToDowngrade:function(){var modal=$j("#screenr_downgrading");modal.find("#no_downgrade").show();modal.find("#close_modal").click(function(event){$j.colorbox.close();event.preventDefault()}.bind(this));this._showDowngradingModal()},_displayDowngrade:function(){var modal=$j("#screenr_downgrading");modal.find("#downgrade").show();modal.find("#downgrade_button").click(function(event){if(!this.confirmState){this.confirmState=true;this._onDowngradeClick()}event.preventDefault()}.bind(this));modal.find("#close_modal").click(function(event){$j.colorbox.close();event.preventDefault()}.bind(this));this._showDowngradingModal();this.confirmState=false},_onDowngradeClick:function(){var answer=confirm(I18n.t("public.javascripts.views.settings.screencasts.sure_you_want_downgrade"));if(answer){this._enqueueDowngrading()}else{$j.colorbox.close()}},_enqueueDowngrading:function(){if(this.poller){this.poller.stop()}$j("#downgrading_spinner").show();this._disableDowngradingButton();$j.ajax({type:"POST",url:"/screenr_tenant_downgrades",success:this._startDowngradingPoller.bind(this)})},_startDowngradingPoller:function(response){var ajaxParams={url:response.status_url,type:"GET",dataType:"json"};this.poller=new Zendesk.Utils.Poller(ajaxParams,1000,20000,this._pollingDowngradingCallback.bind(this),this._errorCallback.bind(this),this._timeoutCallback.bind(this));this.poller.start()},_pollingDowngradingCallback:function(response){switch(response.job_status.status){case"completed":this._onCompletedDowngradingPolling(response.job_status.results);break;case"failed":this.confirmState=false;this._errorCallback(this);break;case"killed":this.confirmState=false;this._errorCallback(this);break;default:return true}},_onCompletedDowngradingPolling:function(results){switch(results.api_status){case"downgraded":this._onSucessfulDowngrading();break;case"validation_failed":this.confirmState=false;this._onValidationFailed(I18n.t("public.javascripts.views.settings.screencasts.screenr_account_impossible_to_downgrade"),"");break;default:this._errorCallback(this)}},_onSucessfulDowngrading:function(){var modal,button;modal=$j('<div class="info">'+I18n.t("public.javascripts.views.settings.screencasts.screenr_account_downgraded")+'</div><form><fieldset><input id="close_button" class="button" name="commit" type="submit" /></fieldset></form>');button=modal.find("#close_button");button.attr("value",I18n.t("public.javascripts.views.settings.screencasts.screenr_account_downgraded_close_button")).click(function(event){event.preventDefault();$j.colorbox.close()}.bind(this));$j("#provisioning_spinner").hide();$j("#screenr_downgrading").empty();modal.appendTo($j("#screenr_downgrading"));$j.colorbox.resize();_.defer(function(){$j.colorbox.resize()})},_disableDowngradingButton:function(){$j("#screenr_downgrading .button").attr("disabled","disabled")},_enableDowngradingButton:function(){$j("#screenr_downgrading .button").removeAttr("disabled")},_showDowngradingModal:function(){$j.colorbox({inline:true,href:"#screenr_downgrading",width:"620px",onComplete:function(){},onClosed:function(){Zendesk.Screenr.Provisioning._removeError()}})}};(function(exports,$){var AuthSaveButtonEventHandler=function AuthSaveButtonEventHandler(){var agents=$("#agents"),endUsers=$("#end_users");agents.find(".remote_auth_selection").click(this.toggleSaveButton.bind(this,agents));endUsers.find(".remote_auth_selection").click(this.toggleSaveButton.bind(this,endUsers));$("#account_role_settings_agent_remote_login").bind("change",this.toggleSaveButton.bind(this,agents));$("#account_role_settings_end_user_remote_login").bind("change",this.toggleSaveButton.bind(this,endUsers))};AuthSaveButtonEventHandler.prototype.toggleSaveButton=function toggleSaveButton(root){var checkboxes=$(root).find(".remote_auth_selection"),saveButton=$(root).find(".save_button"),serviceChoice=$(checkboxes[0]).closest(".login_service").find(".service_choice").val();saveButton.attr("disabled","disabled");saveButton.removeClass("button").removeClass("save").addClass("button_disabled");checkboxes.each(function(i,checkbox){if(serviceChoice==="0"||$(checkbox).is(":checked")){saveButton.removeAttr("disabled");saveButton.removeClass("button_disabled").addClass("button").addClass("save")}})};exports.AuthSaveButtonEventHandler=AuthSaveButtonEventHandler})(window.Zendesk,jQuery);(function(exports,$){var GlobalAuthSettingsHandler=function GlobalAuthSettingsHandler(settings){this.settings=settings;this.initializeGlobalSettings();$("#account_settings_ip_restriction_enabled").change(this.enableIPRestrictions)};GlobalAuthSettingsHandler.prototype.initializeGlobalSettings=function initializeGlobalSettings(){if(this.settings.ip_restriction_enabled==="true"){$("#sub_setting_ip_restrictions").addClass("enabled")}var audioeyeCheckbox=$("#account_settings_agreed_to_audioeye_tos");if(audioeyeCheckbox){new AudioEyeTOSModal(audioeyeCheckbox)}};GlobalAuthSettingsHandler.prototype.enableIPRestrictions=function enableIPRestrictions(){var enabled=$(this).is(":checked"),target=$("#sub_setting_ip_restrictions");enabled?target.slideDown():target.slideUp()};exports.GlobalAuthSettingsHandler=GlobalAuthSettingsHandler;var AudioEyeTOSModal=function(checkBox){this.$root=checkBox.parents(".enable_audioeye_checkbox");this.$checkBox=checkBox;this.$checkBox.click(this.displayModal.bind(this,false));$("button.enable-audioeye").live("click",this.acceptTOS.bind(this));this.$root.find("a.audioeye-notice").click(this.displayModal.bind(this,true))};AudioEyeTOSModal.prototype={displayModal:function(displayAsNotice,event){if(!displayAsNotice&&!this.$checkBox[0].checked){return}event.preventDefault();var modalContent=this.$root.find(".audioeye_tos");if(displayAsNotice){modalContent.find("button.enable-audioeye").hide()}else{modalContent.find("button.enable-audioeye").show()}this.modal=jQuery.colorbox({html:modalContent.html()})},acceptTOS:function(event){event.preventDefault();this.$checkBox[0].checked=true;$.colorbox.close()}}})(window.Zendesk,jQuery);(function(exports,$){var TRUE=1,FALSE=0;function displayEnabledLoginServices(root,loginServices){var target;$.each(loginServices,function(loginService,enabled){target=root.find(".login_service."+loginService);if(target){if(enabled){target.addClass("selected");target.find(".options").show()}target.trigger("login_service.change")}})}function updateLoginServiceSelectionValues(elm,root){var serviceChoices=root.find(".service_choice");serviceChoices.each(function(i,serviceChoice){$(serviceChoice).val(FALSE)});elm.find(".service_choice").val(TRUE);$(serviceChoices).change()}var LoginSettingsHandler=function LoginSettingsHandler(root,settings){this.settings=settings;this.root=$("#"+root);this.initializeFormDisplay()};LoginSettingsHandler.prototype.initializeFormDisplay=function initializeFormDisplay(){displayEnabledLoginServices(this.root,this.settings);this.root.find(".login_service .head").click($.proxy(this.selectLoginService,this))};LoginSettingsHandler.prototype.selectLoginService=function selectLoginService(e){var clickedElm=$(e.currentTarget),loginServiceElm;this.root.find(".login_service .head").each($.proxy(function(i,elm){if(elm===clickedElm[0]){return}loginServiceElm=$(elm).closest(".login_service");loginServiceElm.removeClass("selected");loginServiceElm.trigger("login_service.change");loginServiceElm.find(".options").slideUp()},this));loginServiceElm=clickedElm.closest(".login_service");loginServiceElm.addClass("selected");loginServiceElm.trigger("login_service.change");loginServiceElm.find(".options").slideDown();updateLoginServiceSelectionValues(loginServiceElm,this.root)};exports.LoginSettingsHandler=LoginSettingsHandler})(window.Zendesk,jQuery);(function(exports,$){var roleMapping={agents:"agent_zendesk_login",end_users:"end_user_zendesk_login"};var PolicyChangeHandler=function PolicyChangeHandler(root,currentPolicyID){this.scope=$("#"+root+" ."+roleMapping[root]);this.currentPolicyID=currentPolicyID;var radioButtons=this.scope.find('input[type="radio"]');radioButtons.click($.proxy(this.displayWarningBox,this));radioButtons.click($.proxy(this.toggleCustomPolicyForm,this))};PolicyChangeHandler.prototype.displayWarningBox=function displayWarningBox(e){var clickedButton=$(e.currentTarget),selectedPolicyID=parseInt(clickedButton.val()),warningBox=this.scope.find(".warning");if(selectedPolicyID>this.currentPolicyID){warningBox.show()}else{warningBox.hide()}};PolicyChangeHandler.prototype.toggleCustomPolicyForm=function toggleCustomPolicyForm(e){var customPolicyRadioButton=$("#account_role_settings_agent_security_policy_id_400"),target=$("#custom_security_policy_options");if(customPolicyRadioButton.is(":checked")){target.slideDown()}else{target.slideUp()}};exports.PolicyChangeHandler=PolicyChangeHandler})(window.Zendesk,jQuery);(function(exports,$){var nextToken,authModes={1:"native",3:"jwt"},roots=["#agents","#end_users"];var RemoteAuthSettingsHandler=function RemoteAuthSettingsHandler(authObj,generatedToken){this.authObj=authObj;nextToken=generatedToken;this.initializeFormDisplay()};RemoteAuthSettingsHandler.prototype.initializeFormDisplay=function initializeFormDisplay(){var remoteAuthType=authModes[this.authObj.auth_mode];$(".remote_auth_selection").click(this.toggleRemoteAuthType);$(roots).each(function(i,root){$(root).find(".option."+remoteAuthType+" .generate_remote_auth_token").click(this.displayNewSharedSecret)}.bind(this))};RemoteAuthSettingsHandler.prototype.displayActiveForm=function displayActiveForm(){var authMode=this.settings.auth_mode,inactiveForm=(authMode===2)?".zendesk_remote_auth":".saml_remote_auth";this.root.find(inactiveForm).hide()};RemoteAuthSettingsHandler.prototype.displayNewSharedSecret=function displayNewSharedSecret(){var target=$(this).closest(".option");target.find(".new_shared_secret input").val(nextToken);target.find(".existing_shared_secret").hide();target.find(".new_shared_secret").show();return false};RemoteAuthSettingsHandler.prototype.toggleRemoteAuthType=function toggleRemoteAuthType(e){var checkbox=$(this);target=checkbox.closest(".option").find(".remote_auth");if(checkbox.is(":checked")){target.slideDown()}else{target.slideUp()}};exports.RemoteAuthSettingsHandler=RemoteAuthSettingsHandler})(window.Zendesk,jQuery);(function(exports,$){var SSLSettingsHandler=function SSLSettingsHandler(initialState){this.root=$("#ssl-certificates");this.$newCertificateActionButtons=this.root.find("#new-certificate-action-buttons");this.initialDNSCheckStarted=false;this.provisioningStatusChecker=null;this.root.find("#have-a-certificate-button").click(this.showHaveACertificate.bind(this));this.root.find("#do-not-have-a-certificate-button").click(this.doNotHaveACertificate.bind(this));this.root.find("a.reset-certificate-form").click(this.resetCertificateForm.bind(this));this.root.find("#replace-certificate-link a").click(this.toggleCertificateForm.bind(this));this.root.find(".file-with-label input[type=file]").change(this.updateFileLabel.bind(this));$("#account_automatic_certificate_provisioning").click(this.toggleLE.bind(this));this.zendeskProvisionedSSLChecker=new ZendeskProvisionedSSLChecker(this.root.find("#zendesk-provisioned-ssl-dns-check")[0]);if(initialState=="have_a_certificate"){this.showHaveACertificate()}else{if(initialState=="do_not_have_a_certificate"){this.doNotHaveACertificate()}}this.root.find(".dns-check-link").live("click",function(e){e.preventDefault();var element=$(e.target).parents(".dns-check")[0];new DNSChecker(element,true)}.bind(this));$("#ssl").live("tab.show",function(){if(!this.initialDNSCheckStarted){this.initialDNSCheckStarted=true;this.root.find("#ssl-current-certificate .dns-check").each(function(i,element){new DNSChecker(element,true)}.bind(this))}if(this.provisioningStatusChecker){this.provisioningStatusChecker.start()}else{var throbber=this.root.find(".provisioning.ssl-throbber").first();if(throbber.size()==1){this.provisioningStatusChecker=new ProvisioningStatusChecker(throbber)}}}.bind(this));$("#ssl").live("tab.hide",function(){if(this.provisioningStatusChecker){this.provisioningStatusChecker.stop()}}.bind(this))};SSLSettingsHandler.prototype.toggleLE=function(e){if($("#account_automatic_certificate_provisioning")[0].checked){this.resetCertificateForm();this.root.find("#self-manage-certificate").hide();this.root.find("#zendesk-provisioned-ssl").addClass("enabled").removeClass("disabled");this.zendeskProvisionedSSLChecker.startCheck()}else{this.root.find("#self-manage-certificate").show();this.root.find("#zendesk-provisioned-ssl").addClass("disabled").removeClass("enabled");this.zendeskProvisionedSSLChecker.stopCheck()}};SSLSettingsHandler.prototype.showHaveACertificate=function(e){if(e){e.preventDefault()}this.root.find("#hosted_ssl_form_state")[0].value="have_a_certificate";this.$newCertificateActionButtons.hide();this.root.find("#i-have-a-certificate-section").show();this.root.find("#do-not-have-a-certificate-section").hide();this.root.find("#new-certificate-form").show();this.root.find("#certificate-private-key").show()};SSLSettingsHandler.prototype.doNotHaveACertificate=function(e){if(e){e.preventDefault()}this.root.find("#hosted_ssl_form_state")[0].value="do_not_have_a_certificate";this.$newCertificateActionButtons.hide();this.root.find("#i-have-a-certificate-section").hide();this.root.find("#do-not-have-a-certificate-section").show();this.root.find("#new-certificate-form").show();this.root.find("#certificate-private-key").hide()};SSLSettingsHandler.prototype.resetCertificateForm=function(e){if(e){e.preventDefault()}this.root.find("#hosted_ssl_form_state")[0].value="";this.$newCertificateActionButtons.show();this.root.find("#i-have-a-certificate-section").hide();this.root.find("#do-not-have-a-certificate-section").hide();this.root.find("#new-certificate-form").hide()};SSLSettingsHandler.prototype.toggleCertificateForm=function(e){e.preventDefault();this.root.find("#add-certificate-section").toggle()};SSLSettingsHandler.prototype.updateFileLabel=function(e){e.preventDefault();var selectedFile=e.target;var selectedFileName=this.extractFileName(selectedFile);var label=$(selectedFile).siblings(".file-label");if(selectedFileName==null){label.html(label.data("no-file-string"))}else{label.html(selectedFileName)}};SSLSettingsHandler.prototype.extractFileName=function(fileField){if(fileField.value===""){return null}if(fileField.files){return fileField.files[0].name}else{return fileField.value.split(/(\\|\/)/g).pop()}};exports.SSLSettingsHandler=SSLSettingsHandler;var ZendeskProvisionedSSLChecker=function(root){this.enabled=root!=null;if(this.enabled){this.$root=$(root);this.$errorMessage=this.$root.find("p.certificate-warning-alert");this.$errorMessage.hide();this.$throbber=this.$root.find(".ssl-throbber");this.$results=this.$root.find("#zendesk-provisioned-ssl-dns-check-results");this.$results.hide();this.dnsChecks=[];this.$root.find(".dns-check").each(function(i,element){var checker=new DNSChecker(element,false);checker.showCheckStatus=false;checker.onCheckFinish=this.checkFinished.bind(this);this.dnsChecks.push(checker)}.bind(this))}};ZendeskProvisionedSSLChecker.prototype={startCheck:function(){if(!this.enabled){return}this.$results.hide();this.displayThrobber();this.$root.show();this.disableSave();this.dnsChecks.each(function(c){c.start()})},displayThrobber:function(){this.$root.find(".check-in-progress").show();this.$throbber.show()},hideThrobber:function(){this.$root.find(".check-in-progress").hide();this.$throbber.hide()},enableSave:function(){$("#ssl input.button.save").prop("disabled",false)},disableSave:function(){$("#ssl input.button.save").prop("disabled",true)},checkFinished:function(){if(this.failedChecks().any()){this.hideThrobber();this.$results.show();this.$errorMessage.show()}else{if(this.allChecksPassed()){this.hideThrobber();this.enableSave();this.$results.hide()}}},failedChecks:function(){return this.dnsChecks.select(function(c){return c.didCheckFinish&&!c.didCheckPassed})},allChecksPassed:function(){return this.dnsChecks.select(function(c){return !c.didCheckFinish||!c.didCheckPassed}).size()===0},stopCheck:function(){if(!this.enabled){return}this.$root.hide();this.enableSave()}};var ProvisioningStatusChecker=function(throbber){this.$throbber=throbber;this.checkURL=throbber.data("check-url");this.checkEvery=10;this.stopAfter=10*60;this.failures=0;this.maxFailures=5;this.checksRemaining=Math.floor(this.stopAfter/this.checkEvery);this.intervalID=null;this.start()};ProvisioningStatusChecker.prototype={start:function(){if(!this.intervalID){this.$throbber.show();this.intervalID=window.setInterval(this.requestStatus.bind(this),this.checkEvery*1000)}},stop:function(){this.$throbber.hide();if(this.intervalID){window.clearInterval(this.intervalID);this.intervalID=null}},requestStatus:function(){this.checksRemaining-=1;if(this.checksRemaining>0&&this.failures<this.maxFailures){$.ajax({method:"get",url:this.checkURL,dataType:"json",success:this.checkFinished.bind(this),error:this.checkFailed.bind(this)})}else{this.stop()}},checkFinished:function(data,status,jqXHR){if(data.provisioning_status=="success"||data.provisioning_status=="failed"){this.stop();document.location.reload()}},checkFailed:function(data,status,jqXHR){this.failures+=1}};var DNSChecker=function(element,autoStart){this.$element=$(element);this.brandId=this.$element.data("brand-id");this.checkPath=this.$element.data("brand-check-path");this.subdomain=this.$element.data("brand-subdomain");this.$throbber=this.$element.find(".dns-check-throbber");this.$results=this.$element.find("div.dns-check-results");this.didCheckFinish=false;this.didCheckPassed=false;this.showCheckStatus=true;if(autoStart){this.start()}};DNSChecker.prototype={start:function(){this.didCheckFinish=false;this.didCheckPassed=false;this.$throbber.show();this.clearResults();$.ajax({url:this.checkPath,dataType:"json",success:this.checkFinished.bind(this)})},clearResults:function(){var cell=this.$results.parents("td");cell.height(cell.height());cell.width(cell.width());this.$results.html("")},checkFinished:function(data,status,jqXHR){this.$throbber.hide();if(data.is_valid){this.checkPassed(data)}else{this.checkFailed(data)}this.didCheckFinish=true;if(this.onCheckFinish){this.onCheckFinish()}this.$results.show()},checkPassed:function(data){this.didCheckPassed=true;this.$element.removeClass("error").addClass("verified");var html='<img class="dns-check-icon" src="/images/icons/success.png">';html+=I18n.t("txt.admin.controllers.settings.security_controller.ssl.current_certificate.verified");this.$results.html(html)},checkFailed:function(data){this.$element.removeClass("verified").addClass("error");var html='<span class="invalid"><img class="dns-check-icon" src="/images/icons/error.png">';html+=I18n.t("txt.admin.controllers.settings.security_controller.ssl.current_certificate.error_match_cname");html+="</span>";html+='<table class="dns-check-results"><thead><tr>';html+="<th>"+I18n.t("txt.admin.controllers.settings.security_controller.ssl.current_certificate.host_record")+"</th>";html+="<th>"+I18n.t("txt.admin.controllers.settings.security_controller.ssl.current_certificate.points_to")+"</th>";html+="<th>"+I18n.t("txt.admin.controllers.settings.security_controller.ssl.current_certificate.ttl")+"</th>";html+="</tr></thead>";html+="<tbody><tr>";html+="<td>";html+=this.subdomain;html+="</td>";html+="<td>";html+=data.expected_cnames[0];html+="</td>";html+="<td>14400</td>";html+="</tbody></table>";if(this.showCheckStatus){html+='<a href="#" class="dns-check-link">';html+=I18n.t("txt.admin.controllers.settings.security_controller.ssl.current_certificate.check_status");html+="</a>"}this.$results.html(html);var cell=this.$results.parents("td");cell.height("auto");cell.width("auto")}}})(window.Zendesk,jQuery);(function(exports,$){var DISPLAY_NAMES={account_remote_authentications_saml_is_active:I18n.t("txt.admin.views.settings.security._authentication.sam_label"),account_remote_authentications_jwt_is_active:I18n.t("txt.admin.views.settings.security._authentication.jwt_label")};var numberOfSSOMethodsSelected=function numberOfSSOMethodsSelected(checkboxes){var count=0;$(checkboxes).each(function(i,checkbox){if($(checkbox).is(":checked")){count+=1}});return count};var hasAnySSOMethodsSelected=function hasAnySSOMethodsSelected(checkboxes){return numberOfSSOMethodsSelected(checkboxes)>=1};var hasMultipleSSOMethodsSelected=function hasMultipleSSOMethodsSelected(checkboxes){return numberOfSSOMethodsSelected(checkboxes)>1};var SSOSettings=function SSOSettings(selectedPrimarySSO){this.selectedPrimarySSO=selectedPrimarySSO.toString();this.initializeFormDisplay()};SSOSettings.prototype.initializeFormDisplay=function initializeFormDisplay(){$(".primary_sso_select").change(this.updateSelectedPrimarySSO.bind(this));$(".remote_auth_selection").click(this.togglePrimarySSOSection.bind(this));$("input[type=checkbox].password_allowed").change(this.toggleSSOBypass.bind(this));$(".login_service").live("login_service.change",this.toggleSSOBypassForm.bind(this))};SSOSettings.prototype.updateSelectedPrimarySSO=function updateSelectedPrimarySSO(e){var select=$(e.target);this.selectedPrimarySSO=select.val()};SSOSettings.prototype.toggleSSOBypass=function toggleSSOBypass(e){var $checkbox=$(e.target),$ssoSection=$checkbox.closest(".login_service"),$ssoBypass=$ssoSection.find("div.sso_bypass");if($checkbox[0].checked){$ssoBypass.show()}else{$ssoBypass.hide()}};SSOSettings.prototype.toggleSSOBypassForm=function toggleSSOBypassForm(e){var $loginService=$(e.target);var isVisible=$loginService.hasClass("selected");$loginService.find(".zendesk_passwords select, .zendesk_passwords input").prop("disabled",!isVisible)};SSOSettings.prototype.togglePrimarySSOSection=function togglePrimarySSOSection(e){var checkbox=$(e.target),ssoSection=checkbox.closest(".login_service"),allCheckboxes=ssoSection.find(".remote_auth_selection"),primarySSO=ssoSection.find(".primary_sso"),alternateLogin=ssoSection.find(".alternate_login");if(hasMultipleSSOMethodsSelected(allCheckboxes)){this.setPrimarySSOOptions(ssoSection);primarySSO.removeClass("hidden")}else{primarySSO.addClass("hidden")}if(hasAnySSOMethodsSelected(allCheckboxes)){alternateLogin.removeClass("hidden")}else{alternateLogin.addClass("hidden")}};SSOSettings.prototype.setPrimarySSOOptions=function setPrimarySSOOptions(ssoSection){var allCheckboxes=ssoSection.find(".remote_auth_selection"),selectBox=ssoSection.find(".primary_sso_select"),selectedValue=selectBox.val(),selectOptions="";$(allCheckboxes).each(function(i,checkboxElm){var checkbox=$(checkboxElm),checkboxId=checkbox.siblings(".remote_auth_id").val();if(checkbox.is(":checked")){var isPrimarySSO=this.selectedPrimarySSO===checkboxId,elmOpts={value:checkboxId,html:DISPLAY_NAMES[checkbox.attr("id")]};if(isPrimarySSO){$.extend(elmOpts,{selected:"selected"})}selectOptions+=$("<option>",elmOpts).prop("outerHTML")}}.bind(this));if(selectOptions){selectBox.html(selectOptions)}};exports.SSOSettings=SSOSettings})(window.Zendesk,jQuery);Zendesk.NS("Alerts");Zendesk.Alerts={showTwitterAuthorization:function(){var alertType="twitter_authorization_failure";var unauthorizedAccounts=_.select(currentAccount.twitterAccounts,function(twitterAccount){if(twitterAccount.screen_name!=null){return twitterAccount.authorized==false}});if(_.size(unauthorizedAccounts)>0){$j("#flash").append(this.renderTwitterAuthorization(unauthorizedAccounts));new Zendesk.AlertManager("#"+alertType,this.cookieName(alertType)).show()}},showFacebookAuthorization:function(){var alertType="facebook_authorization_failure";var unauthorizedPages=_.select(currentAccount.facebookPages,function(page){return page.unauthorized});if(_.size(unauthorizedPages)>0){$j("#flash").append(this.renderFacebookAuthorization(unauthorizedPages));new Zendesk.AlertManager("#"+alertType,this.cookieName(alertType)).show()}},showPasswordExpiration:function(){var alertType="password_expiration";if(currentUser&&currentUser.isPasswordExpiring()){$j("#flash").append(this.renderPasswordExpiration(alertType));new Zendesk.AlertManager("#"+alertType,this.cookieName(alertType)).show()}},showWebPortalDeprecationNotice:function(){var alertType="wp_deprecation";if(currentUser.isAgent){$j("#flash").append(this.renderWebPortalDeprecationNotice(alertType));new Zendesk.AlertManager("#"+alertType,this.cookieName(alertType)).show()}},showUserAssumeNotice:function(){var alertType="user_assume";if(currentUser.assumed){$j("#flash").append(this.renderUserAssumeNotice(alertType));new Zendesk.AlertManager("#"+alertType,this.cookieName(alertType)).show()}},showSystemNotice:function(alertName){new Zendesk.AlertManager("#"+alertName,alertName).show()},cookieName:function(alertType){return"accounts."+currentAccount.id+"."+alertType},renderWebPortalDeprecationNotice:function(){var url=I18n.t("txt.admin.public.javascripts.views.shared._alert.web_portal_deprecation_learn_more_url"),link=I18n.t("txt.admin.public.javascripts.views.shared._alert.web_portal_deprecation_learn_more",{url:url}),message=I18n.t("txt.admin.public.javascripts.views.shared._alert.web_portal_message",{learn_more:link}),template='<div id="wp_deprecation" class="alert">{{{message}}}</div>';return jQuery.mustache(template,{message:message})},renderTwitterAuthorization:function(twitterAccounts){var i18n_first_part=I18n.t("txt.admin.public.javascripts.views.shared._alert.your_account_no_longer");var i18n_second_part=I18n.t("txt.admin.public.javascripts.views.shared._alert.reauthorize_twitter");var template='<div id="twitter_authorization_failure" style="display:none" class="alert">'+i18n_first_part+"<ul>        {{#accounts}}        <li>{{screen_name}}</li>        {{/accounts}}      </ul>"+i18n_second_part;return jQuery.mustache(template,{accounts:twitterAccounts})},renderFacebookAuthorization:function(facebookPages){var i18n_first_part=I18n.t("txt.admin.public.javascripts.views.shared._alert.your_account_not_longer_permissions_facebook");var i18n_second_part=I18n.t("txt.admin.public.javascripts.views.shared._alert.reauthorize_facebook");var template='<div id="facebook_authorization_failure" style="display:none" class="alert">'+i18n_first_part+'<ul>        {{#pages}}        <li>{{name}} - <span class="facebook_authorization_failure_reason">{{reason_for_unauthorization}}</span></li>        {{/pages}}      </ul>'+i18n_second_part+"</div>";return jQuery.mustache(template,{pages:facebookPages})},renderPasswordExpiration:function(id){var template='<div id="password_expiration" style="display:none" class="alert">{{{message}}}      <a style="margin-left:10px" id="hide_expiration" class="close" href="#">'+I18n.t("txt.public.javascripts.views.shared._alert.hide_this_notice")+"</a></div>";var message=I18n.t("txt.security_policy.expiration_alert",{count:i18n_distance_of_time_in_words(currentUser.passwordExpiresAt,new Date()),url:"/password"});return jQuery.mustache(template,{message:message})},renderUserAssumeNotice:function(elementId){var i18nPrimaryMessage=I18n.t("txt.admin.public.javascripts.views.shared._alert.user_assume_notice_primary_text"),i18nSecondaryMessage=I18n.t("txt.admin.public.javascripts.views.shared._alert.user_assume_notice_secondar_text"),i18nRevertIdentityLinkText=I18n.t("txt.admin.public.javascripts.views.shared._alert.revert_identity_link_text"),template='<div id="{{elementId}}" style="display:none" class="alert">          <span class="preamble"> {{primaryMessage}} </span>          <span> {{secondaryMessage}} </span>          <a href="{{revertIdentityUrl}}"> {{revertIdentityLinkText}} </a>        </div>';return jQuery.mustache(template,{elementId:elementId,primaryMessage:i18nPrimaryMessage,secondaryMessage:i18nSecondaryMessage,revertIdentityLinkText:i18nRevertIdentityLinkText,revertIdentityUrl:"/users/revert"})}};(function($,Zendesk){var firstDay=Number(I18n.t("date.datepicker.first_day"));var isRTL=Boolean(Number(I18n.t("date.datepicker.is_rtl")));var showMonthAfterYear=Boolean(Number(I18n.t("date.datepicker.show_month_after_year")));var defaultDateFormat="yy-mm-dd";function localizeCalendarDates(){$(".new_date_picker").each(function(){try{var parsed=$.datepicker.parseDate(defaultDateFormat,$(this).val());var formatted=$.datepicker.formatDate(I18n.t("date.datepicker.date_format"),parsed);$(this).val(formatted)}catch(exception){}var altFieldSelector="#"+$(this).data("field");if($(altFieldSelector).exists()){var dateFieldWas=$(this).val();$(this).datepicker("option","altField",altFieldSelector);$(this).datepicker("option","altFormat",defaultDateFormat);if(dateFieldWas!=$(this).val()){$(this).val(dateFieldWas);$(altFieldSelector).val(dateFieldWas)}}})}$(document).ready(function(){$.datepicker.regional.localized_datepicker={closeText:I18n.t("date.datepicker.close_text"),dayNamesMin:I18n.t("date.min_day_names"),prevText:I18n.t("date.datepicker.prev_text"),nextText:I18n.t("date.datepicker.next_text"),currentText:I18n.t("date.datepicker.current_text"),monthNames:I18n.t("date.month_names").slice(1),monthNamesShort:I18n.t("date.abbr_month_names").slice(1),dayNames:I18n.t("date.min_day_names"),dayNamesShort:I18n.t("date.abbr_day_names"),weekHeader:I18n.t("date.datepicker.week_header"),dateFormat:I18n.t("date.datepicker.date_format"),firstDay:firstDay,isRTL:isRTL,showMonthAfterYear:showMonthAfterYear,yearSuffix:I18n.t("date.datepicker.year_suffix")};$.datepicker.setDefaults($.datepicker.regional.localized_datepicker);$(".new_date_picker").datepicker({showOn:"both",buttonImage:"/images/calendar_date_select/calendar.gif",buttonImageOnly:true,showAnim:"slideDown",defaultDate:+7});$(".new_date_picker").keyup(function(e){if((e.keyCode==46||e.keyCode==8)&&$(this).data("clear-allowed")){$.datepicker._clearDate($(this))}});localizeCalendarDates()})}(window.jQuery,window.Zendesk));$z.defModule("shared/_help_container",{initialize:function(){$j("span.question-link").click(function(){$j(this).nextAll(".help-bubble").slideToggle(50)});$j("span.question-link img").hover(function(){$j(this).attr("src","/images/question-hover.png")},function(){$j(this).attr("src","/images/question.png")})}});zd.jsInitializers.push(["shared/_help_container",[]]);if(!Zendesk){Zendesk={}}if(!Zendesk.UI){Zendesk.UI={}}Zendesk.UI.MacroList={MAX_RESULTS:20,initialize:function(macros,macro_search_enabled,id){var self=this;self.root=$j(id);self.macro_search_enabled=macro_search_enabled;$j(document).bind("keydown","ctrl+m",self.toggle_macro_menu_with_key_combo());$j("form#ticket-chat").find("input,textarea,select").bind("keydown","ctrl+m",self.toggle_macro_menu_with_key_combo());$j(document).keydown(self.escape_close());if(macro_search_enabled){self.search_results=self.root.find("ul.search_results");self.nested_macros=self.root.find("ul.first-drop > li");self.root.data("cache",{"":{results:[],max_index:0}});self.root.data("full_results",$j.map(macros,function(macro,index){return(index)}));self.macros=macros;self.root.data("macro_list",self.root.find("ul.search_results li.search_result"));self.add_apply_macro();self.root.data("input",$j(id+"_search"));self.root.find("ul.drop-list li ul.first-drop div.search img.clear").click(function(event){self.clear()});self.root.find("ul.drop-list li ul.first-drop ul.search_results li.no_results div.explain p.try_again a.clear_search").click(function(event){self.clear()});self.root.data("input").bind("keydown",self.escape_clear()).bind("keyup change",self.on_text_changed(id,self.root.data("cache"),self.root.data("full_results"),macros,self.root.data("macro_list")));self.root.find("ul.drop-list > li").click(function(event){self.open_macro_menu()});self.root.data("input").keydown(self.advance_on_key(38,-1)).keydown(self.advance_on_key(40,1)).keydown(self.select_with_enter())}},select_with_enter:function(){var self=this;return(function(event){var selection=self.search_results.data("selection");if(event.keyCode===13&&(selection!==null&&selection!==undefined)){event.preventDefault();event.stopPropagation();self.root.data("macro_list").eq(selection).click()}})},advance_on_key:function(key_code,steps){var self=this;return(function(event){if(event.keyCode===key_code){event.stopPropagation();event.preventDefault();self.advance_selection(steps)}})},advance_selection:function(steps){var self=this;var search_term=(typeof(self.root.data("search_term"))!=="undefined")?self.root.data("search_term"):"";var cache=self.root.data("cache")[search_term];if(cache.results.length>0){steps%=cache.max_index;var selection_index=((typeof(self.search_results.data("selection_index"))==="undefined")?0:self.search_results.data("selection_index")+steps+cache.max_index)%cache.max_index;self.select(selection_index)}},select:function(selection_index){var self=this;var previous_selection=self.search_results.data("selection");var search_term=(typeof(self.root.data("search_term"))!=="undefined")?self.root.data("search_term"):"";var cached_results=self.root.data("cache")[search_term].results;if(typeof(previous_selection)!=="undefined"){self.root.data("macro_list").eq(previous_selection).removeClass("selected")}if(typeof(selection_index)==="number"&&selection_index>=0){self.search_results.data("selection_index",selection_index);self.search_results.data("selection",cached_results[selection_index]);self.root.data("macro_list").eq(cached_results[selection_index]).addClass("selected")}else{self.search_results.data("selection",null)}},toggle_macro_menu_with_key_combo:function(){var self=this;var menu=self.root.find("ul.first-drop");return(function(event){event.stopPropagation();event.preventDefault();if(menu.css("display")==="none"){self.open_macro_menu()}else{self.close_macro_menu()}})},close_macro_menu:function(){var self=this;self.root.find("ul.first-drop").hide();if(self.macro_search_enabled){self.clear()}},open_macro_menu:function(){var self=this;self.root.find("ul.first-drop").show();if(self.macro_search_enabled){self.root.data("input").focus()}},clear:function(){var self=this;self.root.data("input").val("");self.root.data("input").change()},escape_close:function(){var self=this;return(function(event){if(event.keyCode===27){self.close_macro_menu()}})},escape_clear:function(){var self=this;return(function(event){if(event.keyCode===27){event.preventDefault();if($j.trim($j(this).val())!==""){event.stopPropagation();self.clear()}}})},on_text_changed:function(id,cache,full_results,macros,macro_list){var self=this;var no_results=self.root.find("ul.search_results li.no_results");var display_term=no_results.find("span.search_term");var search_img=self.root.find("ul.drop-list li ul.first-drop div.search img.search");var clear_img=self.root.find("ul.drop-list li ul.first-drop div.search img.clear");var highlight=function(index,regex){return(macros[index].label.replace(regex,'<span class="highlight">$1</span>'))};var update_macro=function(index,new_html){macro_list.eq(index).find(" > a").html(new_html)};return(function(event){var previous_search_term=(typeof(self.root.data("search_term"))!=="undefined")?self.root.data("search_term"):"";var previous_cache=cache[previous_search_term];var search_term=$j.trim($j(this).val());self.root.data("search_term",search_term);var cachify=function(superset,hide_previous_results){if(typeof(hide_previous_results)==="undefined"){hide_previous_results=false}var regex_escaped_search_term=$j.ui.autocomplete.escapeRegex(search_term);var regex=RegExp(regex_escaped_search_term,"i");var highlight_regex=RegExp("("+regex_escaped_search_term+")","gi");var highlighted;var superset_index=0;var subset=[];var highlights=[];if(hide_previous_results){for(var i=0;i<previous_cache.max_index;i++){macro_list.eq(previous_cache.results[i]).hide()}for(;subset.length<self.MAX_RESULTS&&superset_index<superset.length;superset_index++){if(macros[superset[superset_index]].label!==(highlighted=highlight(superset[superset_index],highlight_regex))){subset.push(superset[superset_index]);highlights.push(highlighted);update_macro(superset[superset_index],highlighted);macro_list.eq(superset[superset_index]).show()}}}else{for(;subset.length<self.MAX_RESULTS&&superset_index<superset.length;superset_index++){if(macros[superset[superset_index]].label===(highlighted=highlight(superset[superset_index],highlight_regex))){macro_list.eq(superset[superset_index]).hide()}else{subset.push(superset[superset_index]);highlights.push(highlighted);update_macro(superset[superset_index],highlighted);macro_list.eq(superset[superset_index]).show()}}for(;superset[superset_index]<previous_cache.results[previous_cache.max_index];superset_index++){macro_list.eq(superset[superset_index]).hide();if(regex.test(macros[superset[superset_index]].label)){subset.push(superset[superset_index])}}}for(;superset_index<superset.length;superset_index++){if(regex.test(macros[superset[superset_index]].label)){subset.push(superset[superset_index])}}cache[search_term]={max_index:Math.min.apply(Math,[subset.length,self.MAX_RESULTS]),regex:regex,results:subset,highlights:highlights}};if(search_term!==previous_search_term){if(search_term.length===0){clear_img.hide();search_img.show();self.search_results.hide();self.nested_macros.show();for(var i=0;i<previous_cache.max_index;i++){macro_list.eq(previous_cache.results[i]).hide()}}else{if(previous_search_term.length===0){search_img.hide();clear_img.show();self.nested_macros.hide();self.search_results.show()}var previous_index=0,current_index=0;if(previous_search_term.length>0&&search_term.length>previous_search_term.length&&previous_cache.regex.test(search_term)){if(typeof(cache[search_term])==="object"&&cache[search_term].max_index>0){if(previous_cache.results[previous_cache.max_index-1]<cache[search_term].results[cache[search_term].max_index-1]){for(;previous_index<previous_cache.max_index;previous_index++){if(previous_cache.results[previous_index]<cache[search_term].results[current_index]){macro_list.eq(previous_cache.results[previous_index]).hide()}else{update_macro(cache[search_term].results[current_index],cache[search_term].highlights[current_index]);current_index++}}for(;current_index<cache[search_term].max_index;current_index++){update_macro(cache[search_term].results[current_index],cache[search_term].highlights[current_index]);macro_list.eq(cache[search_term].results[current_index]).show()}}else{for(;cache[search_term].results[current_index]<=previous_cache.results[previous_cache.max_index-1];current_index++){update_macro(cache[search_term].results[current_index],cache[search_term].highlights[current_index]);for(;previous_cache.results[previous_index]<cache[search_term].results[current_index];previous_index++){macro_list.eq(previous_cache.results[previous_index]).hide()}if(previous_cache.results[previous_index]===cache[search_term].results[current_index]){previous_index++}}for(;previous_index<previous_cache.max_index;previous_index++){macro_list.eq(previous_cache.results[previous_index]).hide()}}}else{cachify(previous_cache.results,false)}}else{if(typeof(cache[search_term])==="object"){for(previous_index=0,current_index=0;previous_index<previous_cache.max_index&&current_index<cache[search_term].max_index;){if(previous_cache.results[previous_index]<cache[search_term].results[current_index]){macro_list.eq(previous_cache.results[previous_index]).hide();previous_index++}else{if(previous_cache.results[previous_index]>cache[search_term].results[current_index]){update_macro(cache[search_term].results[current_index],cache[search_term].highlights[current_index]);macro_list.eq(cache[search_term].results[current_index]).show();current_index++}else{update_macro(cache[search_term].results[current_index],cache[search_term].highlights[current_index]);current_index++;previous_index++}}}if(previous_index===previous_cache.max_index){for(;current_index<cache[search_term].max_index;current_index++){update_macro(cache[search_term].results[current_index],cache[search_term].highlights[current_index]);macro_list.eq(cache[search_term].results[current_index]).show()}}if(current_index===cache[search_term].max_index){for(;previous_index<previous_cache.max_index;previous_index++){macro_list.eq(previous_cache.results[previous_index]).hide()}}}else{cachify(full_results,true)}}if(cache[search_term].results.length>0){self.select(0);if(previous_cache.results.length===0){no_results.hide()}}else{self.select();display_term.html(search_term);if(previous_cache.results.length>0||previous_search_term.length===0){no_results.show()}}}}})},add_apply_macro:function(index){var self=this;self.root.find("ul.search_results li.search_result").each(function(index,element){var case_id=self.macros[index].value;if(Number(case_id)>=0){$j(element).click(function(event){var ticketForm=$j("#ticket-chat");if(typeof(ticket_id)==="undefined"){var this_id=0}else{var this_id=ticket_id}if(jQuery("#tickets_to_bulk_update",ticketForm).length>0){new Zendesk.API.Macro(case_id).applyToTicket(null,ticketForm)}else{new Zendesk.API.Macro(case_id).applyToTicket(this_id,ticketForm)}$j(this).fadeOut("fast").fadeIn("fast",function(){self.clear();self.root.find("ul.drop-list li ul.first-drop").hide()})})}})}};$z.defModule("shared/_macro_list",{initialize:function(macros,macroSearchEnabled,id){Zendesk.UI.MacroList.initialize(macros,macroSearchEnabled,id)}});(function($,Zendesk){var container,linksContainer,contentContainers,sharedContent;function selectTab(link){var otherLinks=links().not(link);var tabID=link.attr("href");var newlySelectedTab=contentContainers.filter(tabID);var otherTabs=contentContainers.not(newlySelectedTab);otherLinks.removeClass("current");otherTabs.filter(":visible").trigger("tab.hide");otherTabs.hide();link.addClass("current");newlySelectedTab.trigger("tab.show");newlySelectedTab.show();sharedContent.forceRedraw()}function selectInitialTab(){$.history.init(function(hash){var tab=links().filter('[href="#'+hash+'"]');if(tab.length===0){tab=links().first()}selectTab(tab)})}function addHandlers(){$(window).bind("popstate:tabs",function(event){selectInitialTab()});links().click(function(event){var hash=$(this).attr("href").replace(/^.*#/,"");$.history.load(hash);event.preventDefault()})}function init(root){container=$(root||".tabbed_container");linksContainer=$(".tab_links",container);contentContainers=$(".tabs_content .tabs_canvas > div",container);sharedContent=$(".tabs_content .tabs_canvas",container).siblings();addHandlers();selectInitialTab()}function links(){return $(".tab_links a",container)}Zendesk.NS.extend("TabbedContainer",{init:function(root){init(root)},destroy:function(){$(window).unbind("popstate:tabs")}});$(document).ready(function(){if($("div.tabbed_container[mode!='static']").length>0){Zendesk.TabbedContainer.init()}})}(window.jQuery,window.Zendesk));Zendesk.TabbedContainer.SammyApp=function(options){options=options||{};this.options=options;this.container=options.root||".sammy_tabbed_container";this.links=$j(".tab_links a",this.container);this.contentContainers=$j(".tabs_content .tabs_canvas > div",this.container);this.app=this._createSammyApp();this.PATH_NAME_MATCHER=/:([\w\d]+)/g;this.PATH_REPLACER="([^/]+)"};Zendesk.TabbedContainer.SammyApp.prototype={init:function(){this.app.disable_push_state=true;this.app.run()},extractParams:function(path,pathParams,paramNames){var self=this,params={};$j.each(pathParams,function(i,param){if(paramNames[i]){params[paramNames[i].slice(1)]=self._decode(param)}else{if(!params.splat){params.splat=[]}params.splat.push(self._decode(param))}});return params},selectTab:function(tab){var id="#"+tab,link=this.links.filter('[href="'+id+'"]');if(link.length===0||(link.hasClass("current"))){return}this.links.removeClass("current");link.addClass("current");this.contentContainers.hide().filter(id).show()},_createSammyApp:function(){var self=this;return $j.sammy(this.container,function(app){this.helpers({matchPath:function(path,routePath){var paramNames=routePath.match(self.PATH_NAME_MATCHER)||[],pathParams;routePath=new RegExp(routePath.replace(self.PATH_NAME_MATCHER,self.PATH_REPLACER)+"$");if(!(pathParams=path.match(routePath))){return}return self.extractParams(path,pathParams.slice(1),paramNames)}});this.get(/\#([\w\d]*)[\/]?(.*)/,function(){var subPath=this.params.splat[1],tabID=this.params.splat[0];self.selectTab(tabID);this.trigger("tab.change",{tabID:tabID,path:this.path,subPath:subPath})});this.get("",function(){app.setLocation(self.links.first().attr("href"))})})},_decode:function(str){return decodeURIComponent((str||"").replace(/\+/g," "))}};$z.defModule("shared/_tickets_table",{initialize:function(){$j("input.tickets_to_bulk_update").enableCheckboxRangeSelection()}});(function($){$.fn.enableCheckboxRangeSelection=function(){var lastCheckbox=null;var $spec=this;$spec.unbind("click.checkboxrange");$spec.bind("click.checkboxrange",function(e){if(lastCheckbox!=null&&(e.shiftKey||e.metaKey)){$spec.slice(Math.min($spec.index(lastCheckbox),$spec.index(e.target)),Math.max($spec.index(lastCheckbox),$spec.index(e.target))+1).attr({checked:e.target.checked?"checked":""})}lastCheckbox=e.target})}})(jQuery);zd.jsInitializers.push(["shared/_tickets_table",[]]);$z.defModule("tabindex",{addtabindexes:function(){var args=Array.prototype.slice.call(arguments);var tabindex=args.slice(-1)[0];if(typeof(tabindex)==="number"){args.pop()}else{tabindex=1}$j(args).each(function(index,selector){$j(selector).each(function(index,element){$j(element).attr({tabindex:tabindex++})})})}});$z.defModule("tags/show",{initialize:function(){},showTagJobStatus:function(request){var job=request.responseJSON;var jobStatus=new Zendesk.JobStatus(job.status_url,{title:I18n.t("txt.js.tags.processing_tags"),renderResult:function(jobStatus){var output={title:""+I18n.t("txt.js.tags.processed_tags",{number:jobStatus.results.total}),body:$j("<ul/>")};if(jobStatus.status==="completed"){document.location="/tags/bulk_result?background="+jobStatus.job.id}return output}})}});(function($){var initialized=false;function Selectable(){this.reset()}Selectable.prototype.reset=Selectable.prototype.update=function(items){var previous=this.active;this.selected=0;this.items=items||[];this.active=this.items.length>0;if(previous!==this.active){if(this.active){this.activated()}else{this.hide()}}};Selectable.prototype.keyMap={tab:9,enter:13,esc:27,up:38,down:40};Selectable.prototype.keyMapReverse=[9,13,27,38,40];Selectable.prototype.attach=function(textInput){var self=this;if(!initialized){$("body").append('<div id="suggest"></div>');initialized=true}$(textInput).unbind(".selectable").bind("keydown.selectable",function(e){self.keyDown(this,e)})};Selectable.prototype.detach=function(textInput){$(textInput).unbind("keydown.selectable");this.reset();this.hide()};Selectable.prototype.keyDown=function(element,event){if(!this.active){return}var prevent=true,key=Selectable.prototype.keyMap;switch(event.keyCode){case key.up:this.selected=Math.max(this.selected-1,0);break;case key.down:this.selected=Math.min(this.selected+1,this.items.length-1);break;case key.tab:case key.enter:this.complete();break;case key.esc:this.reset();break;default:prevent=false}if(prevent){event.preventDefault();this.render()}};Selectable.prototype.isNavigationEvent=function(event){return($.inArray(event.keyCode,Selectable.prototype.keyMapReverse)>-1)};Selectable.prototype.render=function(){if(!this.items){return}var start=this.selected,end=start+5;if(start>0){start--;end--}var views=$.map(this.items,this.renderItem).slice(start,end);$("#suggest").html("<ul>"+views.join("")+"</ul>");return this};Selectable.prototype.hide=function(){this.active=false;$("#suggest").hide();return this};Selectable.prototype.show=function(){$("#suggest").show();return this};Selectable.prototype.move=function(pos){$("#suggest").css(pos);return this};function InputSuggest(textInput){var self=this;textInput.bind("focusin",function(e){self.attach(this,e)});textInput.bind("focusout",function(e){self.detach(this,e)});this.re=/\{\{[^}]*$/;this.lastToken="";this.suggestions=LiquidPlaceholders();this.selectable=new Selectable();this.selectable.complete=function(){self.complete()};this.selectable.renderItem=function(item,index){return'<li class="suggest-li '+(index===self.selectable.selected?"suggest-li-focus":"")+'">'+item+'<div class="suggest-detail">'+self.suggestions[item]+"</div></li>"};this.selectable.activated=function(){var sel=self.getTokenPos(self.getText(),self.getCaretPos()),pos=self.getInputTextCoordsByIndex(self.textInput,sel.start),cpos=$(self.textInput).position();self.selectable.move({top:pos.top+cpos.top,left:pos.left+cpos.left}).show()}}InputSuggest.prototype.match=function(search){if(!this.re.test(search)){return[]}var filtered=[];for(var key in this.suggestions){if(search.length<key.length&&this.suggestions.hasOwnProperty(key)&&key.substr(0,search.length)===search){filtered.push(key)}}return filtered};InputSuggest.prototype.getToken=function(){var content=this.getText(),pos=this.getTokenPos(content,this.getCaretPos());return content.substring(pos.start,pos.end)};InputSuggest.prototype.getTokenPos=function(content,caretPos){var index=content.search(this.re);return{start:index,end:caretPos}};InputSuggest.prototype.keyUp=function(element,event){var token=this.getToken();if(this.lastToken!==token){this.selectable.update(this.match(token));this.selectable.render();this.lastToken=token}};InputSuggest.prototype.complete=function(){var content=this.getText(),pos=this.getTokenPos(content,this.getCaretPos()),placeholderEnd=content.substr(0,pos.start)+this.selectable.items[this.selectable.selected];this.textInput.value=placeholderEnd+content.substr(pos.end);this.selectable.reset();this.setCaretToPos(this.textInput,placeholderEnd.length)};InputSuggest.prototype.attach=function(el){var self=this;$(el).unbind(".suggest").bind("keyup.suggest",function(ev){self.keyUp(this,ev)});this.textInput=el;this.selectable.attach(el)};InputSuggest.prototype.detach=function(el){$(el).unbind("keyup.suggest");this.textInput=null;this.selectable.detach(el)};InputSuggest.prototype.getText=function(){return this.textInput.value};InputSuggest.prototype.getCaretPos=function(){return this.textInput.selectionEnd};InputSuggest.prototype.getInputTextCoordsByIndex=function(inputText,index){if(index===null){return}var properties=["height","width","padding-top","padding-right","padding-bottom","padding-left","lineHeight","textDecoration","letterSpacing","font-family","font-size","font-style","font-variant","font-weight"],elProp={position:"absolute",overflow:"auto","white-space":"pre-wrap",top:0,left:-9999},span=document.createElement("span"),el=document.createElement("div"),jEl=$(el),pos;for(var i=0,len=properties.length;i<len;i++){elProp[properties[i]]=$(inputText).css(properties[i])}span.innerHTML="&nbsp;";jEl.css(elProp).text(inputText.value.substring(0,index)).insertAfter(inputText);el.scrollTop=el.scrollHeight;el.appendChild(span);pos=$(span).position();jEl.remove();return pos};InputSuggest.prototype.setSelectionRange=function(input,selectionStart,selectionEnd){if(input.setSelectionRange){input.focus();input.setSelectionRange(selectionStart,selectionEnd)}else{if(input.createTextRange){var range=input.createTextRange();range.collapse(true);range.moveEnd("character",selectionEnd);range.moveStart("character",selectionStart);range.select()}}};InputSuggest.prototype.setCaretToPos=function(input,pos){this.setSelectionRange(input,pos,pos)};window.InputSuggest=InputSuggest})(jQuery);(function($){function LiquidPlaceholders(placeholderPrefix){var placeholders={},keys,key,regex,prefix,substringLength;prefix=placeholderPrefix||"placeholder.";regex=RegExp("^"+prefix);substringLength=prefix.length;keys=$.grep(Object.keys(I18n.translations),function(key){return regex.test(key)});for(var i=0,l=keys.length;i<l;i++){key=keys[i];if(key==="placeholder.ticket.brand.name"&&currentAccount&&!currentAccount.hasFeature("multibrand")){continue}if(key==="placeholder.ticket.current_holiday_name"&&currentAccount&&!currentAccount.hasFeature("businessHours")){continue}if(key==="placeholder.current_user.tags"&&currentAccount&&!currentAccount.hasFeature("userAndOrganizationTags")){continue}placeholders["{{"+key.substring(substringLength)+"}}"]=I18n.translations[key]}return placeholders}window.LiquidPlaceholders=LiquidPlaceholders})(jQuery);(function($){$(document).ready(function(){$("#target_method").change(function(){if($(this).val()!=="get"){$(".content-type").show()}else{$(".content-type").hide()}}).trigger("change");var options=function(link,type){return{href:"#"+link.find(".raw_http_"+type).attr("id"),inline:true,width:"780px"}};$(".open_raw_request").colorbox(options($(this),"request"));$(".open_raw_response").colorbox(options($(this),"response"));new InputSuggest($("#target_url"));var passwordField=$("#target_password"),passwordPlaceholder=passwordField.attr("placeholder");passwordField.focus(function(){$(this).removeAttr("placeholder")});passwordField.blur(function(){$(this).attr("placeholder",passwordPlaceholder)});var basicAuthSubsetting=$("#sub_setting_basic_auth"),basicAuthCheckbox=$("#basic_auth_checkbox");basicAuthCheckbox.change(function(){if(basicAuthCheckbox.is(":checked")){basicAuthSubsetting.slideDown()}else{basicAuthSubsetting.slideUp()}});if(basicAuthCheckbox.is(":checked")){basicAuthSubsetting.addClass("enabled")}})}(jQuery));$z.defModule("ticket_fields/_list_for_index",{initialize:function(params){$j("a.cancel-sorting").click(function(event){Ordering.cancelOrdering("div#fields")})}});$z.defModule("ticket_fields/_field_tagger",{initialize:function(options){var self=$z("ticket_fields/_field_tagger");$j("fieldset.conditions a").live("click",function(event){event.preventDefault();$j(this).closest("fieldset.conditions").remove();return false});$j(".customFieldName").live("blur",function(){var valueField=$j(this).closest("fieldset.conditions").find(".customFieldValue");if(valueField.val()===""){var matchAlphaNumeric=new XRegExp("[\\p{L}\\p{N}]");valueField.val(self.substituteNotAcceptedCharacters($j(this).val(),matchAlphaNumeric))}});$j("fieldset.conditions.add").click(function(event){event.preventDefault();self.insertOptionRow("","","");return false});options&&options.each(function(field){self.insertOptionRow(field)});$j("fieldset.conditions .customFieldName").each(function(i,field){field.value=field.value.replace("\\\\","\\")});var hdf=$j(".customFieldHiddenDefault:first").clone();$j(".customFieldDefault:checked").each(function(){$j(this).siblings().remove(".customFieldHiddenDefault")});$j(".customFieldDefault").live("change",function(){if(this.checked){$j(".customFieldDefault:checked").not(this).each(function(){$j(this).click()});$j(this).siblings().remove(".customFieldHiddenDefault")}else{hdf.clone().insertBefore(this)}})},substituteNotAcceptedCharacters:function(tag,regex){var tagWithAlphaAndNumeric="";for(var i=0;i<tag.length;i++){var characterBeingTested=tag.charAt(i);if(XRegExp.test(characterBeingTested,regex)==true){tagWithAlphaAndNumeric+=characterBeingTested.toLowerCase()}else{tagWithAlphaAndNumeric+="_"}}return tagWithAlphaAndNumeric},insertOptionRow:function(field){var self=$z("ticket_fields/_field_tagger");field.index=self._nextIndex();var newOptionRow=$j.mustache(self.optionRowTemplate(),field);self.optionsContainer().append(newOptionRow)},optionsContainer:function(){return $j("#optionsContainer")},optionRowTemplate:function(){var self=$z("ticket_fields/_field_tagger");if(self._optionRowTemplate){return self._optionRowTemplate}self._optionRowTemplate=$j("#custom-field-fieldset-template").html();return self._optionRowTemplate},_nextIndex:function(){this._nextFieldsetIndex=(this._nextFieldsetIndex||-1)+1;return this._nextFieldsetIndex}});$z.defModule("tickets/_editable_notes",{initialize:function(field,url){button=$j("#"+field+"-submit");button.click(function(event){data=$j("#"+field+"-form").serialize();data._method="put";jQuery.post(url,data);InputTracking.trackedElements=[]});$j("#"+field+"-link-show").click(function(){$j("div#"+field+"-edit").toggle();$j("div#"+field+"-show").toggle()})}});Zendesk.NS("Ticket",function(){this.CommentDrafts=function(niceID,userID,commentSelector,commentPrivacySelector){this.niceID=niceID;this.userID=userID;this.key="drafts/"+this.niceID+"/"+this.userID;this.timestampKey=this.key+"/ts";this.privacyKey=this.key+"/privacy";this.translatedVersion=this.key+"/translated";this.translatedHash=this.key+"/translatedHash";this.commentSelector=commentSelector;this.commentPrivacySelector=commentPrivacySelector;this.translationSelector="#translated_flag";this._keyHandler=_.debounce(this._keyHandler,300)};this.CommentDrafts.STALE_TIMEOUT_SECONDS=8*60*60;this.CommentDrafts.prototype={clear:function(){if(!Zendesk.Storage.isSupported()){return}this.localStorage=Zendesk.Storage.handle();return this._clear()},startWatching:function(){if(!Zendesk.Storage.isSupported()){return}this.localStorage=Zendesk.Storage.handle();this.commentInput=$j(this.commentSelector);this.commentPrivacyInput=$j(this.commentPrivacySelector);this.translationLink=jQuery(this.translationSelector);if(this._isStale()){this._clear()}var savedComment=this._load();if(savedComment.comment){this.comment=savedComment.comment;this.commentInput.val(this.comment);this._renderDraftNotification(I18n.t("comment_draft.recovered_a_comment_from_draft"))}else{this.comment=this.commentInput.val()}if(savedComment.commentPrivacy){this.commentPrivacy=savedComment.commentPrivacy;this.commentPrivacyInput.prop("checked",this.commentPrivacy==="public").change()}else{this.commentPrivacy=this.commentPrivacyInput.prop("checked")?"public":"private"}this._bindEvents()},_bindEvents:function(){$j(this.commentInput).keyup($j.proxy(function(e){this._keyHandler(e)},this));var proxiedHandler=$j.proxy(function(e){this._updateDraftFromDom(e)},this);$j(this.commentInput).change(proxiedHandler);$j(document).bind("applied.macro.zendesk",proxiedHandler);$j(this.commentPrivacyInput).change(proxiedHandler);$j(this.translationLink).bind("saveTranslated",proxiedHandler)},_keyHandler:function(evt){this._updateDraftFromDom(evt)},_updateDraftFromDom:function(event){var privacy=(this.commentPrivacyInput.prop("checked")?"public":"private");if((this.comment!=this.commentInput.val())||(this.commentPrivacy!=privacy)){if(!$j(event.target).is(this.commentPrivacyInput)){this._renderDraftSaveNotification()}this._store(this.commentInput.val(),privacy)}},_renderDraftSaveNotification:function(){var message=I18n.t("txt.public.javascript.views.tickets.comment_drafts.comment_draft_saved");var displayed_message=message+' (<abbr id="draft_timestamp" title="'+this._iso8601Timestamp(new Date())+'"></abbr>)';this._renderDraftNotification(displayed_message);$j("#draft_timestamp").timeago()},_store:function(str,privacy){this.comment=str;this.commentPrivacy=privacy;this.localStorage.setItem(this.timestampKey,(new Date()).toString());this.localStorage.setItem(this.privacyKey,this.commentPrivacy);if(jQuery("#translated_flag").exists()&&jQuery("#translated_flag").val()=="true"){this.localStorage.setItem(this.translatedVersion,this.comment)}else{this.localStorage.setItem(this.key,this.comment)}},_renderDraftNotification:function(message){this.commentInput.css({backgroundPosition:"bottom center",paddingBottom:"25px"});if($j("#draft_status").length===0){this.commentInput.after('<div id="draft_status"></div>')}$j("#draft_status").html(message)},_zeropad:function(num){return((num<10)?"0":"")+num},_iso8601Timestamp:function(date){return date.getUTCFullYear()+"-"+this._zeropad(date.getUTCMonth()+1)+"-"+this._zeropad(date.getUTCDate())+"T"+this._zeropad(date.getUTCHours())+":"+this._zeropad(date.getUTCMinutes())+":"+this._zeropad(date.getUTCSeconds())+"Z"},_load:function(){return{comment:this.localStorage.getItem(this.key),commentPrivacy:this.localStorage.getItem(this.privacyKey)}},_clear:function(){this.localStorage.removeItem(this.key);this.localStorage.removeItem(this.timestampKey);this.localStorage.removeItem(this.privacyKey)},_isStale:function(){var timestamp=this.localStorage.getItem(this.timestampKey);if(!timestamp){return false}var curTime=(new Date()).getTime();timestamp=new Date(timestamp).getTime();return(curTime-timestamp)>Zendesk.Ticket.CommentDrafts.STALE_TIMEOUT_SECONDS*1000}}});(function($j){$j.widget("zd.ticketTagger",{_create:function(){var fieldID=this.element.data("field-id");this.$input=this.element.parent().find("#ticket_fields_"+fieldID);this.$output=this.element.find("#title-tagger-"+fieldID);this._addBindings()},val:function(newValue){if(arguments.length===1){this.$input.val(newValue).change();return this}else{return this.$input.val()}},_addBindings:function(){var widget=this;this.element.delegate("li.link","click.ticketTagger",function(){widget.$input.val($j(this).data("value")).trigger("change.ticketTagger");selection_feedback($(this));return false});this.$input.bind("change.ticketTagger",function(event,source){var $li=widget._findLIByValue($j(this).val());widget.$output.html($li.data("full-title"))})},_findLIByValue:function(value){return this.element.find('li.link[data-value="'+value+'"]')}});$j(".field-tagger").ticketTagger()}(jQuery));function IncidentsWarning(){this._registerEvents()}IncidentsWarning.instance=null;IncidentsWarning.getInstance=function(){if(IncidentsWarning.instance===null){IncidentsWarning.instance=new IncidentsWarning()}return IncidentsWarning.instance};IncidentsWarning.prototype={confirmed:false,isShowingWarning:function(){var self=this;if($j("#associated_incidents_warning").length!==0&&self._updating()&&self._solving()&&!self.confirmed){$j.colorbox({inline:true,href:"#associated_incidents_warning"});return true}else{return false}},_registerEvents:function(){var self=this;$j("#confirm_incidents_warning").click(function(event){$j.colorbox.close();self.confirmed=true;submitTicketForm()});$j("#cancel_incidents_warning").click(function(event){$j.colorbox.close()})},_updating:function(){var type=$j("#submit_type").val();return type===""||type==="macro"||type==="entry"},_solving:function(){return $j("#ticket_status_id").val()==="3"},_addingPublicComment:function(){return $j.trim($j("#comment_value").val()).length!==0&&$j("#comment_is_public").is(":checked")}};$j(function(){var jiraElement=$j("#jira_details");if(jiraElement.length){var ticketID=jiraElement.data("ticketid");$j.ajax({url:"/tickets/"+ticketID+"/jira_ticket_details"}).done(function(jira){jira=$j.makeArray(jira)[0];var resolution=(jira.RESOLUTION||" - ");var assignee=(jira.ASSIGNEE||" - ");var string="<ul>";string=string+"<li><strong>Issue ID</strong>: <a href="+jira.URL+">"+jira.KEY+"</a></li>";string=string+"<li><strong>Resolution</strong>: "+resolution+"</li>";string=string+"<li><strong>Assignee</strong>: "+assignee+"</li>";string=string+"</ul>";$j("#jira_ticket #jira_details").html(string)}).fail(function(){$j("#jira_ticket #jira_details").html("Unable to retrieve issue details from JIRA.")})}});jQuery(function($){var projectIDElm,projectID,projectOptions,issueIDElm,issueOptions,projectIssues,jiraProjects;var selectedAgreementElm,jiraAgreementIDs,agreementID;var agreementIDElm=$("#ticket_agreement_id");if(!agreementIDElm.length){return}projectIDElm=$("#jira_project_id");issueIDElm=$("#issue_type_id");jiraProjects={};function isJiraAgreementSelected(agreementID){jiraAgreementIDs=agreementIDElm.data("jira-agreement-ids");return($.inArray(agreementID,jiraAgreementIDs)!==-1)}function updateIssues(){if(!jiraProjects){return}projectID=$("#jira_project_id option:selected").val();if(!projectID){return}issueOptions="";projectIssues=jiraProjects[projectID].issueTypes;for(var issue in projectIssues){if(projectIssues.hasOwnProperty(issue)){issueOptions+='<option value="'+projectIssues[issue].id+'">'+projectIssues[issue].name+"</option>"}}issueIDElm.html(issueOptions)}function updateProjects(){projectOptions="";for(var project in jiraProjects){if(jiraProjects.hasOwnProperty(project)){projectOptions+='<option value="'+project+'">'+jiraProjects[project].name+"</option>"}}projectIDElm.html(projectOptions)}function getJIRAInfo(){if(!jiraProjects){return}$.ajax({url:"/sharing_agreements/"+agreementID+"/jira_projects"}).done(function(data){data.each(function(project){jiraProjects[project.id]=project});updateProjects();updateIssues()}).fail(function(){$("#jira_projects").html("Unable to load projects from JIRA");$("#jira_issues").html("Unable to load issues types from JIRA")})}function showColorbox(){$.colorbox({width:"550px",inline:true,href:"#jira_sharing_options",onComplete:getJIRAInfo,onLoad:function(){$("#cboxClose").remove()},overlayClose:false,escKey:false})}function saveAndClose(){$.colorbox.close()}function clearOptions(){projectIDElm.val("");issueIDElm.val("");$("#jira_issue_key").val("")}function agreementChanged(e){agreementID=parseInt(e.target.value,10);if(isJiraAgreementSelected(agreementID)){showColorbox()}else{clearOptions()}}function cancel(){clearOptions();$.colorbox.close()}$("#jira_sharing_options a").click(function(event){event.preventDefault()});$("#cancel_jira_sharing_options").click(cancel);$("#save_jira_sharing_options").click(saveAndClose);agreementIDElm.change(agreementChanged);projectIDElm.change(updateIssues)});(function(window,$,Zd){var switchToEditMode=function(instance){if(instance.mode==="edit"){return false}instance.mode="edit";instance.previewModeLink.removeClass("disabled");instance.editModeLink.addClass("disabled");instance.markdownContainer.hide();instance.commentField.show().focus();$(instance.draftStatusSelector).show()};var switchToPreviewMode=function(instance){if(instance.mode==="preview"){return false}instance.mode="preview";instance.commentFieldHeight=instance.commentField.height();instance.editModeLink.removeClass("disabled");instance.previewModeLink.addClass("disabled");instance.markdownContainer.html('<center><img src="/images/ajax_loader_small.gif" alt="Loading"/></center>').css("min-height",instance.commentFieldHeight).show();instance.commentField.hide();$(instance.draftStatusSelector).hide();var request=jQuery.ajax({url:"/api/v1/format/markdown.json",type:"POST",data:{text:instance.commentField.val()}});request.done(function(data){instance.markdownContainer.html(data.html)});request.fail(function(){instance.markdownContainer.html(I18n.t("txt.admin.helpers.tickets_helper.preview_mode_error"))})};Zd.MarkdownPreview=function(options){options=options||{};this.previewModeLinkSelector=options.previewModeLinkSelector||"#comment_preview_mode_link";this.editModeLinkSelector=options.editModeLinkSelector||"#comment_edit_mode_link";this.markdownContainerSelector=options.markdownContainerSelector||"#markdown_preview";this.commentFieldSelector=options.commentFieldSelector||"#comment_value";this.draftStatusSelector=options.draftStatusSelector||"#draft_status";this.init(this)};Zd.MarkdownPreview.prototype.init=function(instance){instance.previewModeLink=$(instance.previewModeLinkSelector);instance.editModeLink=$(instance.editModeLinkSelector);instance.markdownContainer=$(instance.markdownContainerSelector);instance.commentField=$(instance.commentFieldSelector);instance.editModeLink.click(function(){switchToEditMode(instance)});instance.previewModeLink.click(function(){switchToPreviewMode(instance)});switchToEditMode(instance)}}(this,jQuery,Zendesk));$z.defModule("tickets/merge/show",{initialize:function(){},showMergeJobStatus:function(request){$j.colorbox.close();var job=request.responseJSON;var jobStatus=new Zendesk.JobStatus(job.status_url,{title:I18n.t("txt.public.javascripts.views.tickets.merge.merging_tickets"),renderResult:function(jobStatus){var output={title:"",body:$j("<ul/>")};if(jobStatus.status==="completed"){document.location="/merge/result?background="+jobStatus.job.id}return output}})}});function NewUserFromTicket(){this.registerEvents()}NewUserFromTicket.prototype={type:null,registerEvents:function(){var self=this;self.link().click(function(){self.type=$j(this).attr("data-type");$j.colorbox({href:$j(this).attr("href"),onComplete:function(){self.emailField().focus()}});return false});self.form().live("submit",function(){var email=$j.trim(self.emailField().val());if(email===""){alert(I18n.t("txt.public.javascripts.views.tickets.new_user_from_ticket.please_enter_an_email_address_new_user"));self.emailField().focus()}else{$j.ajax({type:$j(this).attr("method"),data:$j(this).serialize(),url:$j(this).attr("action"),beforeSend:function(request){self.submitButton().val(I18n.t("txt.public.javascripts.views.tickets.new_user_from_ticket.creating")).prop("disabled",true)},success:function(response){var value=null;if(response.email!=null&&response.email!==""){value=response.name+" <"+response.email+">"}if(self.type==="requester"){$j("#ticket_requester_name").val(value);$j("#ticket_requester_name").effect("highlight",{},3000)}else{collaboratorsInput.addEntry(response.id,value);$j("div#edit_cc li[choice_id="+response.id+"]").effect("highlight",{},3000)}$j.colorbox.close()},error:function(request,textStatus,errorThrown){self.submitButton().val(I18n.t("txt.public.javascripts.views.tickets.new_user_from_ticket.create")).prop("disabled",false);if(request.responseText.include("The organization")){self.organizationField().focus();new Effect.Highlight(self.organizationField().attr("id"),{duration:3})}else{self.emailField().focus();new Effect.Highlight(self.emailField().attr("id"),{duration:3})}}})}return false})},link:function(){return $j("a.new_user_from_ticket")},form:function(){return $j("#new_user_form")},emailField:function(){return this.form().find("#user_email")},organizationField:function(){return this.form().find("#user_organization_name")},submitButton:function(){return this.form().find("input[type='submit']")}};var hexcase=0;var b64pad="";function hex_md5(s){return rstr2hex(rstr_md5(str2rstr_utf8(s)))}function b64_md5(s){return rstr2b64(rstr_md5(str2rstr_utf8(s)))}function any_md5(s,e){return rstr2any(rstr_md5(str2rstr_utf8(s)),e)}function hex_hmac_md5(k,d){return rstr2hex(rstr_hmac_md5(str2rstr_utf8(k),str2rstr_utf8(d)))}function b64_hmac_md5(k,d){return rstr2b64(rstr_hmac_md5(str2rstr_utf8(k),str2rstr_utf8(d)))}function any_hmac_md5(k,d,e){return rstr2any(rstr_hmac_md5(str2rstr_utf8(k),str2rstr_utf8(d)),e)}function md5_vm_test(){return hex_md5("abc").toLowerCase()=="900150983cd24fb0d6963f7d28e17f72"}function rstr_md5(s){return binl2rstr(binl_md5(rstr2binl(s),s.length*8))}function rstr_hmac_md5(key,data){var bkey=rstr2binl(key);if(bkey.length>16){bkey=binl_md5(bkey,key.length*8)}var ipad=Array(16),opad=Array(16);for(var i=0;i<16;i++){ipad[i]=bkey[i]^909522486;opad[i]=bkey[i]^1549556828}var hash=binl_md5(ipad.concat(rstr2binl(data)),512+data.length*8);return binl2rstr(binl_md5(opad.concat(hash),512+128))}function rstr2hex(input){try{hexcase}catch(e){hexcase=0}var hex_tab=hexcase?"0123456789ABCDEF":"0123456789abcdef";var output="";var x;for(var i=0;i<input.length;i++){x=input.charCodeAt(i);output+=hex_tab.charAt((x>>>4)&15)+hex_tab.charAt(x&15)}return output}function rstr2b64(input){try{b64pad}catch(e){b64pad=""}var tab="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";var output="";var len=input.length;for(var i=0;i<len;i+=3){var triplet=(input.charCodeAt(i)<<16)|(i+1<len?input.charCodeAt(i+1)<<8:0)|(i+2<len?input.charCodeAt(i+2):0);for(var j=0;j<4;j++){if(i*8+j*6>input.length*8){output+=b64pad}else{output+=tab.charAt((triplet>>>6*(3-j))&63)}}}return output}function rstr2any(input,encoding){var divisor=encoding.length;var i,j,q,x,quotient;var dividend=Array(Math.ceil(input.length/2));for(i=0;i<dividend.length;i++){dividend[i]=(input.charCodeAt(i*2)<<8)|input.charCodeAt(i*2+1)}var full_length=Math.ceil(input.length*8/(Math.log(encoding.length)/Math.log(2)));var remainders=Array(full_length);for(j=0;j<full_length;j++){quotient=Array();x=0;for(i=0;i<dividend.length;i++){x=(x<<16)+dividend[i];q=Math.floor(x/divisor);x-=q*divisor;if(quotient.length>0||q>0){quotient[quotient.length]=q}}remainders[j]=x;dividend=quotient}var output="";for(i=remainders.length-1;i>=0;i--){output+=encoding.charAt(remainders[i])}return output}function str2rstr_utf8(input){var output="";var i=-1;var x,y;while(++i<input.length){x=input.charCodeAt(i);y=i+1<input.length?input.charCodeAt(i+1):0;if(55296<=x&&x<=56319&&56320<=y&&y<=57343){x=65536+((x&1023)<<10)+(y&1023);i++}if(x<=127){output+=String.fromCharCode(x)}else{if(x<=2047){output+=String.fromCharCode(192|((x>>>6)&31),128|(x&63))}else{if(x<=65535){output+=String.fromCharCode(224|((x>>>12)&15),128|((x>>>6)&63),128|(x&63))}else{if(x<=2097151){output+=String.fromCharCode(240|((x>>>18)&7),128|((x>>>12)&63),128|((x>>>6)&63),128|(x&63))}}}}}return output}function str2rstr_utf16le(input){var output="";for(var i=0;i<input.length;i++){output+=String.fromCharCode(input.charCodeAt(i)&255,(input.charCodeAt(i)>>>8)&255)}return output}function str2rstr_utf16be(input){var output="";for(var i=0;i<input.length;i++){output+=String.fromCharCode((input.charCodeAt(i)>>>8)&255,input.charCodeAt(i)&255)}return output}function rstr2binl(input){var output=Array(input.length>>2);for(var i=0;i<output.length;i++){output[i]=0}for(var i=0;i<input.length*8;i+=8){output[i>>5]|=(input.charCodeAt(i/8)&255)<<(i%32)}return output}function binl2rstr(input){var output="";for(var i=0;i<input.length*32;i+=8){output+=String.fromCharCode((input[i>>5]>>>(i%32))&255)}return output}function binl_md5(x,len){x[len>>5]|=128<<((len)%32);x[(((len+64)>>>9)<<4)+14]=len;var a=1732584193;var b=-271733879;var c=-1732584194;var d=271733878;for(var i=0;i<x.length;i+=16){var olda=a;var oldb=b;var oldc=c;var oldd=d;a=md5_ff(a,b,c,d,x[i+0],7,-680876936);d=md5_ff(d,a,b,c,x[i+1],12,-389564586);c=md5_ff(c,d,a,b,x[i+2],17,606105819);b=md5_ff(b,c,d,a,x[i+3],22,-1044525330);a=md5_ff(a,b,c,d,x[i+4],7,-176418897);d=md5_ff(d,a,b,c,x[i+5],12,1200080426);c=md5_ff(c,d,a,b,x[i+6],17,-1473231341);b=md5_ff(b,c,d,a,x[i+7],22,-45705983);a=md5_ff(a,b,c,d,x[i+8],7,1770035416);d=md5_ff(d,a,b,c,x[i+9],12,-1958414417);c=md5_ff(c,d,a,b,x[i+10],17,-42063);b=md5_ff(b,c,d,a,x[i+11],22,-1990404162);a=md5_ff(a,b,c,d,x[i+12],7,1804603682);d=md5_ff(d,a,b,c,x[i+13],12,-40341101);c=md5_ff(c,d,a,b,x[i+14],17,-1502002290);b=md5_ff(b,c,d,a,x[i+15],22,1236535329);a=md5_gg(a,b,c,d,x[i+1],5,-165796510);d=md5_gg(d,a,b,c,x[i+6],9,-1069501632);c=md5_gg(c,d,a,b,x[i+11],14,643717713);b=md5_gg(b,c,d,a,x[i+0],20,-373897302);a=md5_gg(a,b,c,d,x[i+5],5,-701558691);d=md5_gg(d,a,b,c,x[i+10],9,38016083);c=md5_gg(c,d,a,b,x[i+15],14,-660478335);b=md5_gg(b,c,d,a,x[i+4],20,-405537848);a=md5_gg(a,b,c,d,x[i+9],5,568446438);d=md5_gg(d,a,b,c,x[i+14],9,-1019803690);c=md5_gg(c,d,a,b,x[i+3],14,-187363961);b=md5_gg(b,c,d,a,x[i+8],20,1163531501);a=md5_gg(a,b,c,d,x[i+13],5,-1444681467);d=md5_gg(d,a,b,c,x[i+2],9,-51403784);c=md5_gg(c,d,a,b,x[i+7],14,1735328473);b=md5_gg(b,c,d,a,x[i+12],20,-1926607734);a=md5_hh(a,b,c,d,x[i+5],4,-378558);d=md5_hh(d,a,b,c,x[i+8],11,-2022574463);c=md5_hh(c,d,a,b,x[i+11],16,1839030562);b=md5_hh(b,c,d,a,x[i+14],23,-35309556);a=md5_hh(a,b,c,d,x[i+1],4,-1530992060);d=md5_hh(d,a,b,c,x[i+4],11,1272893353);c=md5_hh(c,d,a,b,x[i+7],16,-155497632);b=md5_hh(b,c,d,a,x[i+10],23,-1094730640);a=md5_hh(a,b,c,d,x[i+13],4,681279174);d=md5_hh(d,a,b,c,x[i+0],11,-358537222);c=md5_hh(c,d,a,b,x[i+3],16,-722521979);b=md5_hh(b,c,d,a,x[i+6],23,76029189);a=md5_hh(a,b,c,d,x[i+9],4,-640364487);d=md5_hh(d,a,b,c,x[i+12],11,-421815835);c=md5_hh(c,d,a,b,x[i+15],16,530742520);b=md5_hh(b,c,d,a,x[i+2],23,-995338651);a=md5_ii(a,b,c,d,x[i+0],6,-198630844);d=md5_ii(d,a,b,c,x[i+7],10,1126891415);c=md5_ii(c,d,a,b,x[i+14],15,-1416354905);b=md5_ii(b,c,d,a,x[i+5],21,-57434055);a=md5_ii(a,b,c,d,x[i+12],6,1700485571);d=md5_ii(d,a,b,c,x[i+3],10,-1894986606);c=md5_ii(c,d,a,b,x[i+10],15,-1051523);b=md5_ii(b,c,d,a,x[i+1],21,-2054922799);a=md5_ii(a,b,c,d,x[i+8],6,1873313359);d=md5_ii(d,a,b,c,x[i+15],10,-30611744);c=md5_ii(c,d,a,b,x[i+6],15,-1560198380);b=md5_ii(b,c,d,a,x[i+13],21,1309151649);a=md5_ii(a,b,c,d,x[i+4],6,-145523070);d=md5_ii(d,a,b,c,x[i+11],10,-1120210379);c=md5_ii(c,d,a,b,x[i+2],15,718787259);b=md5_ii(b,c,d,a,x[i+9],21,-343485551);a=safe_add(a,olda);b=safe_add(b,oldb);c=safe_add(c,oldc);d=safe_add(d,oldd)}return Array(a,b,c,d)}function md5_cmn(q,a,b,x,s,t){return safe_add(bit_rol(safe_add(safe_add(a,q),safe_add(x,t)),s),b)}function md5_ff(a,b,c,d,x,s,t){return md5_cmn((b&c)|((~b)&d),a,b,x,s,t)}function md5_gg(a,b,c,d,x,s,t){return md5_cmn((b&d)|(c&(~d)),a,b,x,s,t)}function md5_hh(a,b,c,d,x,s,t){return md5_cmn(b^c^d,a,b,x,s,t)}function md5_ii(a,b,c,d,x,s,t){return md5_cmn(c^(b|(~d)),a,b,x,s,t)}function safe_add(x,y){var lsw=(x&65535)+(y&65535);var msw=(x>>16)+(y>>16)+(lsw>>16);return(msw<<16)|(lsw&65535)}function bit_rol(num,cnt){return(num<<cnt)|(num>>>(32-cnt))}var TicketForm=function(){};TicketForm.prototype={_cacheFollowing:function(mth,requester,value){TicketForm.twitterFollowingCache=TicketForm.twitterFollowingCache||{};var cache=TicketForm.twitterFollowingCache;var cacheKey=[mth.screenName,requester.screenName].join(",");if(value!==undefined){return cache[cacheKey]=value}else{return cache[cacheKey]}},isFollowing:function(mth,requester){var self=this;var cached=this._cacheFollowing(mth,requester);if(cached!==undefined){jQuery("#comment_channel_back option[value='dm']").prop("disabled",(cached!==true));return}jQuery.ajax({url:Zendesk.Proxy.domain()+"/twitter/api/"+mth.id+"/1.1/friendships/lookup.json",data:{screen_name:requester.screenName},type:"GET",success:function(data){self.isFollowingCallback(data,mth,requester)}})},isFollowingCallback:function(data,mth,requester){var following=!!data.find(function(d){return requester.id===d.id&&d.connections.include("followed_by")});this._cacheFollowing(mth,requester,following);jQuery("#comment_channel_back option[value='dm']").prop("disabled",following!==true)},updateBalloon:function(){var checkbox=jQuery("#comment_is_public");var balloon=jQuery("#comment_type");if(checkbox.attr("checked")){balloon.removeClass("private");balloon.addClass("public")}else{balloon.removeClass("public");balloon.addClass("private")}},updateTwitterControls:function(){var checkbox=jQuery("#comment_is_public");var controls=jQuery("#twitter_controls");(checkbox.attr("checked"))?controls.show():controls.hide()},updateTwitterCounter:function(){var checkbox=jQuery("#comment_is_public");var counter=jQuery("#charcounter");var channel=jQuery("#comment_channel_back").val();var dm=jQuery("#comment_channel_back_dm");counter.toggle(checkbox.is(":checked")&&(channel=="1"||channel=="dm"))},updateMthSelector:function(){var checkbox=jQuery("#comment_is_public");var selector=jQuery("#monitored_twitter_handle_selection");(checkbox.attr("checked"))?selector.show():selector.hide()},bindEditRequesterLink:function(){$j("#edit_requester_link a").bind("click",function(event){$j("#edit_requester").show();$j("#dynamic_requester").hide();$j("#static_requester").show();$j("#edit_requester_link").hide();return false})},bindCheckbox:function(){var self=this;jQuery("#comment_is_public").change(function(){self.updateBalloon();self.updateMthSelector();self.updateTwitterControls();self.updateTwitterCounter()})},bindRadioButtons:function(){var self=this;jQuery('#twitter_controls input[type="radio"]').click(function(){self.updateTwitterCounter()})}};function TicketMergeWizard(){this.url="/merge/new?source_ids="+this.sources()+"&unchecked="+this.unchecked()+"&background=true";this.registerEvents();this.show()}TicketMergeWizard.prototype={url:null,registerEvents:function(){var self=this;self.winnerLinks().live("click",function(e){$j("#target_id").val($j(this).data("target-id"));self.winnerForm().submit();return false});$j(document).bind("cbox_closed",function(){$j("#submit-button").val("Submit").prop("disabled",false)})},show:function(){var self=this;$j.colorbox({href:this.url,onComplete:function(){if(self.loaded){return}self.winnerForm().submit(function(){var niceId=$j.trim($j("#target_id").val());if(niceId===""){alert("Please enter a ticket ID")}else{$j.ajax({type:$j(this).attr("method"),data:$j(this).serialize(),url:$j(this).attr("action"),success:function(response){$j.colorbox({html:response});self.appendComment()},error:function(request,textStatus,errorThrown){$j.colorbox({html:request.responseText})}})}return false})}})},appendComment:function(){if($j.trim($j("#comment_value").val())!==""){var text="\n\nComment during merge: "+$j("#comment_value").val();$j("#target_comment").append(text);$j("#source_comment").append(text)}},sources:function(){if($j("#ticket-chat").attr("data-ticket")!==undefined){return $j("#ticket-chat").attr("data-ticket")}else{return this.checked()}},checked:function(){return this.values("input.tickets_to_bulk_update:checked")},unchecked:function(){return this.values("input.tickets_to_bulk_update:not(:checked)")},values:function(filter){var array=[];$j(filter).each(function(){array.push($j(this).val())});return array.join(",")},winnerForm:function(){return $j("#merge_form")},winnerField:function(){return this.winnerForm().find("input[type='text']")},continueButton:function(){return this.winnerForm().find("input[type='submit']")},winnerLinks:function(){return $j(".winner_selector")}};$z.defModule("tickets/new",{initialize:function(){$j("input#ticket_requester_name").focus();$z("tabindex").addtabindexes("input#ticket_requester_name","#edit_cc input","form#ticket-chat div.selects div.select > input[readonly != readonly][attribute_name != additional_tags],form#ticket-chat div.selects div.select > select[readonly != readonly],form#ticket-chat div.selects div.select > textarea[readonly != readonly]","textarea#comment_value","#ticket_tags",".selects .multi_value_field .search_field_item input","select#submit_type","input#submit_type","input#submit-button");$z("tickets").addSubmitBindings();$z("tickets").monitorRequesterChange();$z("tickets").autoselectAssigneesIfManyAgents();if($j("#ticket_linked_id").attr("auto-complete")){$j("#ticket_linked_id").autocompleteFromSelect()}new NewUserFromTicket()}});$z.defModule("tickets/show",{initialize:function(){$j("textarea#comment_value").focus();$z("tabindex").addtabindexes("#edit_cc input","form#ticket-chat div.selects div.select > input[readonly != readonly][attribute_name != additional_tags], form#ticket-chat div.selects div.select > select[readonly != readonly], form#ticket-chat div.selects div.select > textarea[readonly != readonly]","#ticket_tags",".selects .multi_value_field .search_field_item input","textarea#comment_value","input#comment_is_public","select#submit_type","input#submit_type","input#submit-button");$z("tickets").addSubmitBindings();$z("tickets").monitorRequesterChange();$z("tickets").autoselectAssigneesIfManyAgents();if($j("#ticket_linked_id").attr("auto-complete")){$j("#ticket_linked_id").autocompleteFromSelect()}$j(".visibility-controls").click(function(){$j("a.toggle-twitter-data",this).toggle()});$j("a.toggle-twitter-data").click(function(){$j(".twitter-properties").toggle();return false});$j("#comment_full .link, #comment_partial .link").click(function(){$j("#comment_full, #comment_partial, #comment_up, #comment_down").toggle();return false});$j("#sharing_with :first-child").hover(function(){$j("#shared_tickets_list").fadeIn(300)},function(){$j("#shared_tickets_list").fadeOut(100)});if($j("body.tickets-show").length&&currentAccount.daysLeftInTrial){Zendesk.Instrumentation.track("View Ticket","Trial")}new UserMergeWizard(false);new NewUserFromTicket();$j("input, select, textarea","#ticket_properties.read_only").prop("disabled",true);Zendesk.Ticket.commentDrafts=new Zendesk.Ticket.CommentDrafts(ticket_id,currentUser.id,"#comment_value","#comment_is_public");Zendesk.Ticket.commentDrafts.startWatching();new Zendesk.Twitter.TicketCreationForm()._updateCounter()},setupCommentCharacterCounter:function(options){options=options||{};options.ticketPage=true;new Zendesk.Twitter.TicketCreationForm().setupTweetCounter(options)}});$z.defModule("tickets",{addSubmitBindings:function(){function submit(event){event.preventDefault();if($j("input#submit-button").is(":disabled")){return}$j("input#submit-button").click()}function submitAndNext(event){$j("form#submit_form select#submit_type option[value='next']").prop("selected",true);submit(event)}(function($){var s=83;function submitOnKeyEvents(event){if(event.ctrlKey&&event.which===s){if(event.shiftKey){submitAndNext(event)}else{submit(event)}}}$(document).bind("keydown.zendesk.keyboard-shortcut",submitOnKeyEvents)})(jQuery)},autoselectAssigneesIfManyAgents:function(){if(typeof(agents)!=="undefined"&&agents.length>LARGE_SELECT_LENGTH){$j("select.assignee").autocompleteFromSelect()}},monitorRequesterChange:function(){var re=new RegExp(/<(.*)>/);$j("#ticket_requester_name").observe_field(3,function(){if(re.test($j(this).val())){$z("tickets").requesterChanged($j(this))}})},requesterChanged:function(ticketForm){$j.ajax({url:"/tickets/requester_change",data:ticketForm.serialize(),beforeSend:function(){$j("#user_details").fadeOut("fast");$j("#add_widget_button").hide()},success:function(){$j("#user_details").fadeIn("fast");$j("#add_widget_button").show()}})}});
/*!
* ZeroClipboard
* The ZeroClipboard library provides an easy way to copy text to the clipboard using an invisible Adobe Flash movie and a JavaScript interface.
* Copyright (c) 2014 Jon Rohan, James M. Greene
* Licensed MIT
* http://zeroclipboard.org/
* v1.3.2
*/
(function(){var currentElement;var flashState={bridge:null,version:"0.0.0",disabled:null,outdated:null,ready:null};var _clipData={};var clientIdCounter=0;var _clientMeta={};var elementIdCounter=0;var _elementMeta={};var _amdModuleId=null;var _cjsModuleId=null;var _swfPath=function(){var i,jsDir,tmpJsPath,jsPath,swfPath="ZeroClipboard.swf";if(document.currentScript&&(jsPath=document.currentScript.src)){}else{var scripts=document.getElementsByTagName("script");if("readyState" in scripts[0]){for(i=scripts.length;i--;){if(scripts[i].readyState==="interactive"&&(jsPath=scripts[i].src)){break}}}else{if(document.readyState==="loading"){jsPath=scripts[scripts.length-1].src}else{for(i=scripts.length;i--;){tmpJsPath=scripts[i].src;if(!tmpJsPath){jsDir=null;break}tmpJsPath=tmpJsPath.split("#")[0].split("?")[0];tmpJsPath=tmpJsPath.slice(0,tmpJsPath.lastIndexOf("/")+1);if(jsDir==null){jsDir=tmpJsPath}else{if(jsDir!==tmpJsPath){jsDir=null;break}}}if(jsDir!==null){jsPath=jsDir}}}}if(jsPath){jsPath=jsPath.split("#")[0].split("?")[0];swfPath=jsPath.slice(0,jsPath.lastIndexOf("/")+1)+swfPath}return swfPath}();var _camelizeCssPropName=function(){var matcherRegex=/\-([a-z])/g,replacerFn=function(match,group){return group.toUpperCase()};return function(prop){return prop.replace(matcherRegex,replacerFn)}}();var _getStyle=function(el,prop){var value,camelProp,tagName,possiblePointers,i,len;if(window.getComputedStyle){value=window.getComputedStyle(el,null).getPropertyValue(prop)}else{camelProp=_camelizeCssPropName(prop);if(el.currentStyle){value=el.currentStyle[camelProp]}else{value=el.style[camelProp]}}if(prop==="cursor"){if(!value||value==="auto"){tagName=el.tagName.toLowerCase();if(tagName==="a"){return"pointer"}}}return value};var _elementMouseOver=function(event){if(!event){event=window.event}var target;if(this!==window){target=this}else{if(event.target){target=event.target}else{if(event.srcElement){target=event.srcElement}}}ZeroClipboard.activate(target)};var _addEventHandler=function(element,method,func){if(!element||element.nodeType!==1){return}if(element.addEventListener){element.addEventListener(method,func,false)}else{if(element.attachEvent){element.attachEvent("on"+method,func)}}};var _removeEventHandler=function(element,method,func){if(!element||element.nodeType!==1){return}if(element.removeEventListener){element.removeEventListener(method,func,false)}else{if(element.detachEvent){element.detachEvent("on"+method,func)}}};var _addClass=function(element,value){if(!element||element.nodeType!==1){return element}if(element.classList){if(!element.classList.contains(value)){element.classList.add(value)}return element}if(value&&typeof value==="string"){var classNames=(value||"").split(/\s+/);if(element.nodeType===1){if(!element.className){element.className=value}else{var className=" "+element.className+" ",setClass=element.className;for(var c=0,cl=classNames.length;c<cl;c++){if(className.indexOf(" "+classNames[c]+" ")<0){setClass+=" "+classNames[c]}}element.className=setClass.replace(/^\s+|\s+$/g,"")}}}return element};var _removeClass=function(element,value){if(!element||element.nodeType!==1){return element}if(element.classList){if(element.classList.contains(value)){element.classList.remove(value)}return element}if(value&&typeof value==="string"||value===undefined){var classNames=(value||"").split(/\s+/);if(element.nodeType===1&&element.className){if(value){var className=(" "+element.className+" ").replace(/[\n\t]/g," ");for(var c=0,cl=classNames.length;c<cl;c++){className=className.replace(" "+classNames[c]+" "," ")}element.className=className.replace(/^\s+|\s+$/g,"")}else{element.className=""}}}return element};var _getZoomFactor=function(){var rect,physicalWidth,logicalWidth,zoomFactor=1;if(typeof document.body.getBoundingClientRect==="function"){rect=document.body.getBoundingClientRect();physicalWidth=rect.right-rect.left;logicalWidth=document.body.offsetWidth;zoomFactor=Math.round(physicalWidth/logicalWidth*100)/100}return zoomFactor};var _getDOMObjectPosition=function(obj,defaultZIndex){var info={left:0,top:0,width:0,height:0,zIndex:_getSafeZIndex(defaultZIndex)-1};if(obj.getBoundingClientRect){var rect=obj.getBoundingClientRect();var pageXOffset,pageYOffset,zoomFactor;if("pageXOffset" in window&&"pageYOffset" in window){pageXOffset=window.pageXOffset;pageYOffset=window.pageYOffset}else{zoomFactor=_getZoomFactor();pageXOffset=Math.round(document.documentElement.scrollLeft/zoomFactor);pageYOffset=Math.round(document.documentElement.scrollTop/zoomFactor)}var leftBorderWidth=document.documentElement.clientLeft||0;var topBorderWidth=document.documentElement.clientTop||0;info.left=rect.left+pageXOffset-leftBorderWidth;info.top=rect.top+pageYOffset-topBorderWidth;info.width="width" in rect?rect.width:rect.right-rect.left;info.height="height" in rect?rect.height:rect.bottom-rect.top}return info};var _cacheBust=function(path,options){var cacheBust=options==null||options&&options.cacheBust===true&&options.useNoCache===true;if(cacheBust){return(path.indexOf("?")===-1?"?":"&")+"noCache="+new Date().getTime()}else{return""}};var _vars=function(options){var i,len,domain,str=[],domains=[],trustedOriginsExpanded=[];if(options.trustedOrigins){if(typeof options.trustedOrigins==="string"){domains.push(options.trustedOrigins)}else{if(typeof options.trustedOrigins==="object"&&"length" in options.trustedOrigins){domains=domains.concat(options.trustedOrigins)}}}if(options.trustedDomains){if(typeof options.trustedDomains==="string"){domains.push(options.trustedDomains)}else{if(typeof options.trustedDomains==="object"&&"length" in options.trustedDomains){domains=domains.concat(options.trustedDomains)}}}if(domains.length){for(i=0,len=domains.length;i<len;i++){if(domains.hasOwnProperty(i)&&domains[i]&&typeof domains[i]==="string"){domain=_extractDomain(domains[i]);if(!domain){continue}if(domain==="*"){trustedOriginsExpanded=[domain];break}trustedOriginsExpanded.push.apply(trustedOriginsExpanded,[domain,"//"+domain,window.location.protocol+"//"+domain])}}}if(trustedOriginsExpanded.length){str.push("trustedOrigins="+encodeURIComponent(trustedOriginsExpanded.join(",")))}if(typeof options.jsModuleId==="string"&&options.jsModuleId){str.push("jsModuleId="+encodeURIComponent(options.jsModuleId))}return str.join("&")};var _inArray=function(elem,array,fromIndex){if(typeof array.indexOf==="function"){return array.indexOf(elem,fromIndex)}var i,len=array.length;if(typeof fromIndex==="undefined"){fromIndex=0}else{if(fromIndex<0){fromIndex=len+fromIndex}}for(i=fromIndex;i<len;i++){if(array.hasOwnProperty(i)&&array[i]===elem){return i}}return -1};var _prepClip=function(elements){if(typeof elements==="string"){throw new TypeError("ZeroClipboard doesn't accept query strings.")}if(!elements.length){return[elements]}return elements};var _dispatchCallback=function(func,context,args,async){if(async){window.setTimeout(function(){func.apply(context,args)},0)}else{func.apply(context,args)}};var _getSafeZIndex=function(val){var zIndex,tmp;if(val){if(typeof val==="number"&&val>0){zIndex=val}else{if(typeof val==="string"&&(tmp=parseInt(val,10))&&!isNaN(tmp)&&tmp>0){zIndex=tmp}}}if(!zIndex){if(typeof _globalConfig.zIndex==="number"&&_globalConfig.zIndex>0){zIndex=_globalConfig.zIndex}else{if(typeof _globalConfig.zIndex==="string"&&(tmp=parseInt(_globalConfig.zIndex,10))&&!isNaN(tmp)&&tmp>0){zIndex=tmp}}}return zIndex||0};var _deprecationWarning=function(deprecatedApiName,debugEnabled){if(deprecatedApiName&&debugEnabled!==false&&typeof console!=="undefined"&&console&&(console.warn||console.log)){var deprecationWarning="`"+deprecatedApiName+"` is deprecated. See docs for more info:\n    https://github.com/zeroclipboard/zeroclipboard/blob/master/docs/instructions.md#deprecations";if(console.warn){console.warn(deprecationWarning)}else{console.log(deprecationWarning)}}};var _extend=function(){var i,len,arg,prop,src,copy,target=arguments[0]||{};for(i=1,len=arguments.length;i<len;i++){if((arg=arguments[i])!=null){for(prop in arg){if(arg.hasOwnProperty(prop)){src=target[prop];copy=arg[prop];if(target===copy){continue}if(copy!==undefined){target[prop]=copy}}}}}return target};var _extractDomain=function(originOrUrl){if(originOrUrl==null||originOrUrl===""){return null}originOrUrl=originOrUrl.replace(/^\s+|\s+$/g,"");if(originOrUrl===""){return null}var protocolIndex=originOrUrl.indexOf("//");originOrUrl=protocolIndex===-1?originOrUrl:originOrUrl.slice(protocolIndex+2);var pathIndex=originOrUrl.indexOf("/");originOrUrl=pathIndex===-1?originOrUrl:protocolIndex===-1||pathIndex===0?null:originOrUrl.slice(0,pathIndex);if(originOrUrl&&originOrUrl.slice(-4).toLowerCase()===".swf"){return null}return originOrUrl||null};var _determineScriptAccess=function(){var _extractAllDomains=function(origins,resultsArray){var i,len,tmp;if(origins!=null&&resultsArray[0]!=="*"){if(typeof origins==="string"){origins=[origins]}if(typeof origins==="object"&&"length" in origins){for(i=0,len=origins.length;i<len;i++){if(origins.hasOwnProperty(i)){tmp=_extractDomain(origins[i]);if(tmp){if(tmp==="*"){resultsArray.length=0;resultsArray.push("*");break}if(_inArray(tmp,resultsArray)===-1){resultsArray.push(tmp)}}}}}}};var _accessLevelLookup={always:"always",samedomain:"sameDomain",never:"never"};return function(currentDomain,configOptions){var asaLower,allowScriptAccess=configOptions.allowScriptAccess;if(typeof allowScriptAccess==="string"&&(asaLower=allowScriptAccess.toLowerCase())&&/^always|samedomain|never$/.test(asaLower)){return _accessLevelLookup[asaLower]}var swfDomain=_extractDomain(configOptions.moviePath);if(swfDomain===null){swfDomain=currentDomain}var trustedDomains=[];_extractAllDomains(configOptions.trustedOrigins,trustedDomains);_extractAllDomains(configOptions.trustedDomains,trustedDomains);var len=trustedDomains.length;if(len>0){if(len===1&&trustedDomains[0]==="*"){return"always"}if(_inArray(currentDomain,trustedDomains)!==-1){if(len===1&&currentDomain===swfDomain){return"sameDomain"}return"always"}}return"never"}}();var _objectKeys=function(obj){if(obj==null){return[]}if(Object.keys){return Object.keys(obj)}var keys=[];for(var prop in obj){if(obj.hasOwnProperty(prop)){keys.push(prop)}}return keys};var _deleteOwnProperties=function(obj){if(obj){for(var prop in obj){if(obj.hasOwnProperty(prop)){delete obj[prop]}}}return obj};var _detectFlashSupport=function(){var hasFlash=false;if(typeof flashState.disabled==="boolean"){hasFlash=flashState.disabled===false}else{if(typeof ActiveXObject==="function"){try{if(new ActiveXObject("ShockwaveFlash.ShockwaveFlash")){hasFlash=true}}catch(error){}}if(!hasFlash&&navigator.mimeTypes["application/x-shockwave-flash"]){hasFlash=true}}return hasFlash};function _parseFlashVersion(flashVersion){return flashVersion.replace(/,/g,".").replace(/[^0-9\.]/g,"")}function _isFlashVersionSupported(flashVersion){return parseFloat(_parseFlashVersion(flashVersion))>=10}var ZeroClipboard=function(elements,options){if(!(this instanceof ZeroClipboard)){return new ZeroClipboard(elements,options)}this.id=""+clientIdCounter++;_clientMeta[this.id]={instance:this,elements:[],handlers:{}};if(elements){this.clip(elements)}if(typeof options!=="undefined"){_deprecationWarning("new ZeroClipboard(elements, options)",_globalConfig.debug);ZeroClipboard.config(options)}this.options=ZeroClipboard.config();if(typeof flashState.disabled!=="boolean"){flashState.disabled=!_detectFlashSupport()}if(flashState.disabled===false&&flashState.outdated!==true){if(flashState.bridge===null){flashState.outdated=false;flashState.ready=false;_bridge()}}};ZeroClipboard.prototype.setText=function(newText){if(newText&&newText!==""){_clipData["text/plain"]=newText;if(flashState.ready===true&&flashState.bridge){flashState.bridge.setText(newText)}else{}}return this};ZeroClipboard.prototype.setSize=function(width,height){if(flashState.ready===true&&flashState.bridge){flashState.bridge.setSize(width,height)}else{}return this};var _setHandCursor=function(enabled){if(flashState.ready===true&&flashState.bridge){flashState.bridge.setHandCursor(enabled)}else{}};ZeroClipboard.prototype.destroy=function(){this.unclip();this.off();delete _clientMeta[this.id]};var _getAllClients=function(){var i,len,client,clients=[],clientIds=_objectKeys(_clientMeta);for(i=0,len=clientIds.length;i<len;i++){client=_clientMeta[clientIds[i]].instance;if(client&&client instanceof ZeroClipboard){clients.push(client)}}return clients};ZeroClipboard.version="1.3.2";var _globalConfig={swfPath:_swfPath,trustedDomains:window.location.host?[window.location.host]:[],cacheBust:true,forceHandCursor:false,zIndex:999999999,debug:true,title:null,autoActivate:true};ZeroClipboard.config=function(options){if(typeof options==="object"&&options!==null){_extend(_globalConfig,options)}if(typeof options==="string"&&options){if(_globalConfig.hasOwnProperty(options)){return _globalConfig[options]}return}var copy={};for(var prop in _globalConfig){if(_globalConfig.hasOwnProperty(prop)){if(typeof _globalConfig[prop]==="object"&&_globalConfig[prop]!==null){if("length" in _globalConfig[prop]){copy[prop]=_globalConfig[prop].slice(0)}else{copy[prop]=_extend({},_globalConfig[prop])}}else{copy[prop]=_globalConfig[prop]}}}return copy};ZeroClipboard.destroy=function(){ZeroClipboard.deactivate();for(var clientId in _clientMeta){if(_clientMeta.hasOwnProperty(clientId)&&_clientMeta[clientId]){var client=_clientMeta[clientId].instance;if(client&&typeof client.destroy==="function"){client.destroy()}}}var htmlBridge=_getHtmlBridge(flashState.bridge);if(htmlBridge&&htmlBridge.parentNode){htmlBridge.parentNode.removeChild(htmlBridge);flashState.ready=null;flashState.bridge=null}};ZeroClipboard.activate=function(element){if(currentElement){_removeClass(currentElement,_globalConfig.hoverClass);_removeClass(currentElement,_globalConfig.activeClass)}currentElement=element;_addClass(element,_globalConfig.hoverClass);_reposition();var newTitle=_globalConfig.title||element.getAttribute("title");if(newTitle){var htmlBridge=_getHtmlBridge(flashState.bridge);if(htmlBridge){htmlBridge.setAttribute("title",newTitle)}}var useHandCursor=_globalConfig.forceHandCursor===true||_getStyle(element,"cursor")==="pointer";_setHandCursor(useHandCursor)};ZeroClipboard.deactivate=function(){var htmlBridge=_getHtmlBridge(flashState.bridge);if(htmlBridge){htmlBridge.style.left="0px";htmlBridge.style.top="-9999px";htmlBridge.removeAttribute("title")}if(currentElement){_removeClass(currentElement,_globalConfig.hoverClass);_removeClass(currentElement,_globalConfig.activeClass);currentElement=null}};var _bridge=function(){var flashBridge,len;var container=document.getElementById("global-zeroclipboard-html-bridge");if(!container){var opts=ZeroClipboard.config();opts.jsModuleId=typeof _amdModuleId==="string"&&_amdModuleId||typeof _cjsModuleId==="string"&&_cjsModuleId||null;var allowScriptAccess=_determineScriptAccess(window.location.host,_globalConfig);var flashvars=_vars(opts);var swfUrl=_globalConfig.moviePath+_cacheBust(_globalConfig.moviePath,_globalConfig);var html='      <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" id="global-zeroclipboard-flash-bridge" width="100%" height="100%">         <param name="movie" value="'+swfUrl+'"/>         <param name="allowScriptAccess" value="'+allowScriptAccess+'"/>         <param name="scale" value="exactfit"/>         <param name="loop" value="false"/>         <param name="menu" value="false"/>         <param name="quality" value="best" />         <param name="bgcolor" value="#ffffff"/>         <param name="wmode" value="transparent"/>         <param name="flashvars" value="'+flashvars+'"/>         <embed src="'+swfUrl+'"           loop="false" menu="false"           quality="best" bgcolor="#ffffff"           width="100%" height="100%"           name="global-zeroclipboard-flash-bridge"           allowScriptAccess="'+allowScriptAccess+'"           allowFullScreen="false"           type="application/x-shockwave-flash"           wmode="transparent"           pluginspage="http://www.macromedia.com/go/getflashplayer"           flashvars="'+flashvars+'"           scale="exactfit">         </embed>       </object>';container=document.createElement("div");container.id="global-zeroclipboard-html-bridge";container.setAttribute("class","global-zeroclipboard-container");container.style.position="absolute";container.style.left="0px";container.style.top="-9999px";container.style.width="15px";container.style.height="15px";container.style.zIndex=""+_getSafeZIndex(_globalConfig.zIndex);document.body.appendChild(container);container.innerHTML=html}flashBridge=document["global-zeroclipboard-flash-bridge"];if(flashBridge&&(len=flashBridge.length)){flashBridge=flashBridge[len-1]}flashState.bridge=flashBridge||container.children[0].lastElementChild};var _getHtmlBridge=function(flashBridge){var isFlashElement=/^OBJECT|EMBED$/;var htmlBridge=flashBridge&&flashBridge.parentNode;while(htmlBridge&&isFlashElement.test(htmlBridge.nodeName)&&htmlBridge.parentNode){htmlBridge=htmlBridge.parentNode}return htmlBridge||null};var _reposition=function(){if(currentElement){var pos=_getDOMObjectPosition(currentElement,_globalConfig.zIndex);var htmlBridge=_getHtmlBridge(flashState.bridge);if(htmlBridge){htmlBridge.style.top=pos.top+"px";htmlBridge.style.left=pos.left+"px";htmlBridge.style.width=pos.width+"px";htmlBridge.style.height=pos.height+"px";htmlBridge.style.zIndex=pos.zIndex+1}if(flashState.ready===true&&flashState.bridge){flashState.bridge.setSize(pos.width,pos.height)}}return this};ZeroClipboard.prototype.on=function(eventName,func){var i,len,events,added={},handlers=_clientMeta[this.id]&&_clientMeta[this.id].handlers;if(typeof eventName==="string"&&eventName){events=eventName.toLowerCase().split(/\s+/)}else{if(typeof eventName==="object"&&eventName&&typeof func==="undefined"){for(i in eventName){if(eventName.hasOwnProperty(i)&&typeof i==="string"&&i&&typeof eventName[i]==="function"){this.on(i,eventName[i])}}}}if(events&&events.length){for(i=0,len=events.length;i<len;i++){eventName=events[i].replace(/^on/,"");added[eventName]=true;if(!handlers[eventName]){handlers[eventName]=[]}handlers[eventName].push(func)}if(added.noflash&&flashState.disabled){_receiveEvent.call(this,"noflash",{})}if(added.wrongflash&&flashState.outdated){_receiveEvent.call(this,"wrongflash",{flashVersion:flashState.version})}if(added.load&&flashState.ready){_receiveEvent.call(this,"load",{flashVersion:flashState.version})}}return this};ZeroClipboard.prototype.off=function(eventName,func){var i,len,foundIndex,events,perEventHandlers,handlers=_clientMeta[this.id]&&_clientMeta[this.id].handlers;if(arguments.length===0){events=_objectKeys(handlers)}else{if(typeof eventName==="string"&&eventName){events=eventName.split(/\s+/)}else{if(typeof eventName==="object"&&eventName&&typeof func==="undefined"){for(i in eventName){if(eventName.hasOwnProperty(i)&&typeof i==="string"&&i&&typeof eventName[i]==="function"){this.off(i,eventName[i])}}}}}if(events&&events.length){for(i=0,len=events.length;i<len;i++){eventName=events[i].toLowerCase().replace(/^on/,"");perEventHandlers=handlers[eventName];if(perEventHandlers&&perEventHandlers.length){if(func){foundIndex=_inArray(func,perEventHandlers);while(foundIndex!==-1){perEventHandlers.splice(foundIndex,1);foundIndex=_inArray(func,perEventHandlers,foundIndex)}}else{handlers[eventName].length=0}}}}return this};ZeroClipboard.prototype.handlers=function(eventName){var prop,copy=null,handlers=_clientMeta[this.id]&&_clientMeta[this.id].handlers;if(handlers){if(typeof eventName==="string"&&eventName){return handlers[eventName]?handlers[eventName].slice(0):null}copy={};for(prop in handlers){if(handlers.hasOwnProperty(prop)&&handlers[prop]){copy[prop]=handlers[prop].slice(0)}}}return copy};var _dispatchClientCallbacks=function(eventName,context,args,async){var handlers=_clientMeta[this.id]&&_clientMeta[this.id].handlers[eventName];if(handlers&&handlers.length){var i,len,func,originalContext=context||this;for(i=0,len=handlers.length;i<len;i++){func=handlers[i];context=originalContext;if(typeof func==="string"&&typeof window[func]==="function"){func=window[func]}if(typeof func==="object"&&func&&typeof func.handleEvent==="function"){context=func;func=func.handleEvent}if(typeof func==="function"){_dispatchCallback(func,context,args,async)}}}return this};ZeroClipboard.prototype.clip=function(elements){elements=_prepClip(elements);for(var i=0;i<elements.length;i++){if(elements.hasOwnProperty(i)&&elements[i]&&elements[i].nodeType===1){if(!elements[i].zcClippingId){elements[i].zcClippingId="zcClippingId_"+elementIdCounter++;_elementMeta[elements[i].zcClippingId]=[this.id];if(_globalConfig.autoActivate===true){_addEventHandler(elements[i],"mouseover",_elementMouseOver)}}else{if(_inArray(this.id,_elementMeta[elements[i].zcClippingId])===-1){_elementMeta[elements[i].zcClippingId].push(this.id)}}var clippedElements=_clientMeta[this.id].elements;if(_inArray(elements[i],clippedElements)===-1){clippedElements.push(elements[i])}}}return this};ZeroClipboard.prototype.unclip=function(elements){var meta=_clientMeta[this.id];if(meta){var clippedElements=meta.elements;var arrayIndex;if(typeof elements==="undefined"){elements=clippedElements.slice(0)}else{elements=_prepClip(elements)}for(var i=elements.length;i--;){if(elements.hasOwnProperty(i)&&elements[i]&&elements[i].nodeType===1){arrayIndex=0;while((arrayIndex=_inArray(elements[i],clippedElements,arrayIndex))!==-1){clippedElements.splice(arrayIndex,1)}var clientIds=_elementMeta[elements[i].zcClippingId];if(clientIds){arrayIndex=0;while((arrayIndex=_inArray(this.id,clientIds,arrayIndex))!==-1){clientIds.splice(arrayIndex,1)}if(clientIds.length===0){if(_globalConfig.autoActivate===true){_removeEventHandler(elements[i],"mouseover",_elementMouseOver)}delete elements[i].zcClippingId}}}}}return this};ZeroClipboard.prototype.elements=function(){var meta=_clientMeta[this.id];return meta&&meta.elements?meta.elements.slice(0):[]};var _getAllClientsClippedToElement=function(element){var elementMetaId,clientIds,i,len,client,clients=[];if(element&&element.nodeType===1&&(elementMetaId=element.zcClippingId)&&_elementMeta.hasOwnProperty(elementMetaId)){clientIds=_elementMeta[elementMetaId];if(clientIds&&clientIds.length){for(i=0,len=clientIds.length;i<len;i++){client=_clientMeta[clientIds[i]].instance;if(client&&client instanceof ZeroClipboard){clients.push(client)}}}}return clients};_globalConfig.hoverClass="zeroclipboard-is-hover";_globalConfig.activeClass="zeroclipboard-is-active";_globalConfig.trustedOrigins=null;_globalConfig.allowScriptAccess=null;_globalConfig.useNoCache=true;_globalConfig.moviePath="ZeroClipboard.swf";ZeroClipboard.detectFlashSupport=function(){_deprecationWarning("ZeroClipboard.detectFlashSupport",_globalConfig.debug);return _detectFlashSupport()};ZeroClipboard.dispatch=function(eventName,args){if(typeof eventName==="string"&&eventName){var cleanEventName=eventName.toLowerCase().replace(/^on/,"");if(cleanEventName){var clients=currentElement?_getAllClientsClippedToElement(currentElement):_getAllClients();for(var i=0,len=clients.length;i<len;i++){_receiveEvent.call(clients[i],cleanEventName,args)}}}};ZeroClipboard.prototype.setHandCursor=function(enabled){_deprecationWarning("ZeroClipboard.prototype.setHandCursor",_globalConfig.debug);enabled=typeof enabled==="boolean"?enabled:!!enabled;_setHandCursor(enabled);_globalConfig.forceHandCursor=enabled;return this};ZeroClipboard.prototype.reposition=function(){_deprecationWarning("ZeroClipboard.prototype.reposition",_globalConfig.debug);return _reposition()};ZeroClipboard.prototype.receiveEvent=function(eventName,args){_deprecationWarning("ZeroClipboard.prototype.receiveEvent",_globalConfig.debug);if(typeof eventName==="string"&&eventName){var cleanEventName=eventName.toLowerCase().replace(/^on/,"");if(cleanEventName){_receiveEvent.call(this,cleanEventName,args)}}};ZeroClipboard.prototype.setCurrent=function(element){_deprecationWarning("ZeroClipboard.prototype.setCurrent",_globalConfig.debug);ZeroClipboard.activate(element);return this};ZeroClipboard.prototype.resetBridge=function(){_deprecationWarning("ZeroClipboard.prototype.resetBridge",_globalConfig.debug);ZeroClipboard.deactivate();return this};ZeroClipboard.prototype.setTitle=function(newTitle){_deprecationWarning("ZeroClipboard.prototype.setTitle",_globalConfig.debug);newTitle=newTitle||_globalConfig.title||currentElement&&currentElement.getAttribute("title");if(newTitle){var htmlBridge=_getHtmlBridge(flashState.bridge);if(htmlBridge){htmlBridge.setAttribute("title",newTitle)}}return this};ZeroClipboard.setDefaults=function(options){_deprecationWarning("ZeroClipboard.setDefaults",_globalConfig.debug);ZeroClipboard.config(options)};ZeroClipboard.prototype.addEventListener=function(eventName,func){_deprecationWarning("ZeroClipboard.prototype.addEventListener",_globalConfig.debug);return this.on(eventName,func)};ZeroClipboard.prototype.removeEventListener=function(eventName,func){_deprecationWarning("ZeroClipboard.prototype.removeEventListener",_globalConfig.debug);return this.off(eventName,func)};ZeroClipboard.prototype.ready=function(){_deprecationWarning("ZeroClipboard.prototype.ready",_globalConfig.debug);return flashState.ready===true};var _receiveEvent=function(eventName,args){eventName=eventName.toLowerCase().replace(/^on/,"");var cleanVersion=args&&args.flashVersion&&_parseFlashVersion(args.flashVersion)||null;var element=currentElement;var performCallbackAsync=true;switch(eventName){case"load":if(cleanVersion){if(!_isFlashVersionSupported(cleanVersion)){_receiveEvent.call(this,"onWrongFlash",{flashVersion:cleanVersion});return}flashState.outdated=false;flashState.ready=true;flashState.version=cleanVersion}break;case"wrongflash":if(cleanVersion&&!_isFlashVersionSupported(cleanVersion)){flashState.outdated=true;flashState.ready=false;flashState.version=cleanVersion}break;case"mouseover":_addClass(element,_globalConfig.hoverClass);break;case"mouseout":if(_globalConfig.autoActivate===true){ZeroClipboard.deactivate()}break;case"mousedown":_addClass(element,_globalConfig.activeClass);break;case"mouseup":_removeClass(element,_globalConfig.activeClass);break;case"datarequested":var targetId=element.getAttribute("data-clipboard-target"),targetEl=!targetId?null:document.getElementById(targetId);if(targetEl){var textContent=targetEl.value||targetEl.textContent||targetEl.innerText;if(textContent){this.setText(textContent)}}else{var defaultText=element.getAttribute("data-clipboard-text");if(defaultText){this.setText(defaultText)}}performCallbackAsync=false;break;case"complete":_deleteOwnProperties(_clipData);break}var context=element;var eventArgs=[this,args];return _dispatchClientCallbacks.call(this,eventName,context,eventArgs,performCallbackAsync)};if(typeof define==="function"&&define.amd){define(["require","exports","module"],function(require,exports,module){_amdModuleId=module&&module.id||null;return ZeroClipboard})}else{if(typeof module==="object"&&module&&typeof module.exports==="object"&&module.exports){_cjsModuleId=module.id||null;module.exports=ZeroClipboard}else{window.ZeroClipboard=ZeroClipboard}}})();(function($,Zendesk){var log=Minilog("voice");var app=$.sammy("#call-console",function(){this.use("Mustache");this.use("ActiveTemplate");this.call=null;this.state="idle";this.restoring=false;this.maxDisplayStringLength=30;this.init=function(capabilityToken){this.capabilityToken=capabilityToken;this.clientAvailable=false;this.name="CallConsole";log.info("#init");RadarClient.initialize(function(){log.info("RadarClient.initialize")});$(window).load(function(){_.delay(function(){log.info("#twilio-load-start");var twilioClientVersion=currentAccount.hasFeature("voiceClassicTwilio13")?"1.3":"1.2";var scriptSource="//static.twilio.com/libs/twiliojs/"+twilioClientVersion+"/twilio.min.js";$.getScript(scriptSource,function(data,textStatus,jqxhr){log.info("#twilio-load-finish",{status:textStatus});if(textStatus==="success"){if(!window.Twilio){log.error("#twilio-load-error",{message:"ec5"});Zendesk.voiceMenu&&Zendesk.voiceMenu.updateAvailability("off","twilio");alert(I18n.t("txt.voice.error.ec5"));return}$("#__soundFlash__").css("visibility","hidden");if(Zendesk.voiceMenu){var bO=Zendesk.voiceMenu.backOff([1,2,4,8],function(){return Twilio&&Twilio.MediaStream});bO.done(function(){$("#__soundFlash__").css("visibility","hidden")})}app.hookUpTwilioDevice()}else{log.error("#twilio-load-error",{message:"ec10"});Zendesk.voiceMenu&&Zendesk.voiceMenu.updateAvailability("off","twilio-asset");alert(I18n.t("txt.voice.error.ec10"))}})},100)});var self=this;$(window).bind("beforeunload",function(){var currentCall=self.call;if(currentCall){var availability=currentCall.outgoing_kind,callIsActive=currentCall&&currentCall.status!=="completed"&&currentCall.status!=="ended"&&currentCall.status!=="cancelled";if(availability==="client"&&callIsActive){return I18n.t("txt.voice.warning.on_browser_exit")}}});$(window).unload(function(){window.voiceUnloading=true;if(self.connection){self.connection.reject()}});this.setupVoiceInMaintenance();this.callOverlay=new Zendesk.CallOverlay();this.banner=new Zendesk.VoiceBanner();if(Zendesk.currentUser.voice.current_call){app.setCurrentCall(Zendesk.currentUser.voice.current_call)}};this.showConsoleIfNeeded=function(){if(!this.$element().is(":visible")){this.trigger("show-console")}};this.hideConsoleIfNeeded=function(){if(this.$element().is(":visible")){this.trigger("close-console")}};this.logTrigger=function(name,data){log.info("#trigger",{name:name,payload:data});this.trigger.apply(this,[name,data])};this.safeTrigger=_.debounce(this.logTrigger,300);this.retrigger=function(){if(this.lastTrigger){log.info("#retrigger",{last:this.lastTrigger});this.safeTrigger(this.lastTrigger)}};this.getCallInfo=function(sid,tries,untilFunc,dfd){var self=this;if(!dfd){dfd=new jQuery.Deferred()}if(this.callInfoDeferred){this.callInfoDeferred.reject(self.call);this.callInfoDeferred=dfd}var data={sid:sid};if(app.call&&app.call.id){data.call_id=app.call.id}else{data.outgoing_sid=sid}$.ajax({url:"/voice/calls/incoming_info",type:"GET",data:data,dataType:"json"}).always(function(data){if(data.outbound){self.setCurrentCall(data);dfd.resolve(data)}else{if(untilFunc&&!untilFunc(data)&&!dfd.isResolved()){if(tries<1){if(data&&sid&&!data.outgoing_sid){data.outgoing_sid=sid}self.setCurrentCall(data);log.error("#incoming-info-failed",{sid:sid,data:data});dfd.reject(self.call)}else{var getCallInfo=_.bind(self.getCallInfo,self);_.delay(getCallInfo,1000,sid,tries-1,untilFunc,dfd);log.info("#incoming-info-retry",{sid:sid,tries:tries})}}else{log.debug("#incoming-info-retrieved",{sid:sid,tries:tries});self.setCurrentCall(data);dfd.resolve(data)}}});return dfd.promise()};this.waitForAfterSetup=function(){log.info("#twilio-device-wait");if(!Twilio.Device.__afterSetup){log.info("#twilio-device-still-waiting");setTimeout(this.waitForAfterSetup.bind(this),100)}else{if(this.afterSetupCallback){this.afterSetupCallback()}}};this.hookUpTwilioDevice=function(){var self=this;log.info("#hookup-device-start");if(!window.Twilio){log.info("#hookup-device-error",{message:"no-twilio"});return}var bootUpTwilioDevice=function(available){self._acceptCalls=(available!=="off");if(available==="client"&&!self.clientAvailable&&!self.clientReadying){self.clientReadying=true;Zendesk.voiceMenu.catchFlash(function(){self.afterSetupCallback=function(){log.info("#twilio-device-after-setup-callback");if(Twilio.Device.__afterSetup){Twilio.Device.__afterSetup(function(){Twilio.Device.instance.log.handler=function(x){if(typeof x==="string"){log.debug("#twilio-device",x)}else{log.debug("#twilio-device",JSON.stringify(x))}}})}if(window.WebSocket&&!window.WebSocket.__flash&&window.WebSocket.__initialize){WebSocket.__initialize()}log.info("#twilio-device-setup",{token:self.capabilityToken,debug:Zendesk.currentUser.voice.logging});Twilio.Device.setup(self.capabilityToken,{debug:Zendesk.currentUser.voice.logging})};if(Zendesk.currentUser.voice.logging){self.waitForAfterSetup()}else{self.afterSetupCallback()}})}};RadarClient.alloc("voice_availability",function(){RadarClient.status("voice/availability/"+Zendesk.currentUser.id).get(function(message){if(!message||!message.value){return}var available=message.value[Zendesk.currentUser.id]&&message.value[Zendesk.currentUser.id].availability;bootUpTwilioDevice(available)}).on(function(message){if(!message||!message.value){return}bootUpTwilioDevice(message.value.availability)}).subscribe()});Twilio.Device.ready(function(device){log.info("#twilio-ready",{status:device._status});self.clientAvailable=true;self.clientReadying=false;if(!self.fightStaged){var fightClass=Zendesk.RadarFight;self.fight=new fightClass("ringer",{win:function(){Twilio.Device.sounds.incoming(true)},lose:function(){Twilio.Device.sounds.incoming(false)},check:function(){return Twilio.Device.sounds.incoming()}})}self.fightStaged=true;if(Zendesk.voiceMenu.flashPermissionsDeferred){Twilio.MediaStream.__queue(function(){Zendesk.voiceMenu.showFlashPermissions()});Zendesk.voiceMenu.flashPermissionsDeferred=null}});Twilio.Device.incoming(function(conn){log.info("#twilio-incoming",{conn:conn.parameters});self.connection=conn;if(!self._acceptCalls&&conn){conn.disconnect()}conn.error(function(error){log.error("#twilio-error2",{conn:conn.parameters,message:error.message,code:error.code})});self.clearState();self.getCallInfo(conn.parameters.CallSid,3,function(call){return call&&call.status=="routing"}).always(function(){self.gotCallInfo=true;self.trigger("routing");self.gotCallInfo=false}).fail(function(){self.call.human_calling_number="Unknown"})});Twilio.Device.connect(function(conn){log.info("#twilio-connect",{conn:conn.parameters});self.connection=conn;self.getCallInfo(conn.parameters.CallSid,15,function(call){return call&&call.status==="in_conference"}).done(function(){self.getCallInfo(conn.parameters.CallSid,5,function(call){return call&&call.connected_at}).always(function(){self.trigger("in_conference");self.lastTrigger="in_conference";self.callOverlay.show();self.getCallInfo(conn.parameters.CallSid,10,function(call){return call&&call.ticket&&call.ticket.nice_id}).done(function(call){self.retrigger()})}).fail(function(){self.call.connected_at=new Date();self.retrigger()})}).fail(function(){log.error("#twilio-connect:conference-fail",{conn:conn.parameters,kind:Zendesk.currentUser.availableForVoiceOn});if(Zendesk.currentUser.availableForVoiceOn==="client"){log.error("#twilio-connect:disconnect:start",{conn:conn.parameters});Twilio.Device.instance.disconnectAll();log.error("#twilio-connect:disconnect:finished",{conn:conn.parameters})}})});Twilio.Device.disconnect(function(conn){log.info("#twilio-disconnect",{conn:conn.parameters});self.connection=null;self.callOverlay.hide();self.getCallInfo(conn.parameters.CallSid,3,function(call){return call&&call.status==="completed"||call.status==="ended"}).done(function(){self.getCallInfo(conn.parameters.CallSid,5,function(call){return call&&call.recording_url&&call.is_recording_url_ready}).always(function(call){self.trigger(call.status);self.lastTrigger=call.status;self.getCallInfo(conn.parameters.CallSid,3,function(call){return call&&call.ticket&&call.ticket.nice_id}).always(function(call){self.retrigger()})})}).fail(function(){self.trigger("missed-call")})});Twilio.Device.cancel(function(conn){log.info("#twilio-cancel",{conn:conn.parameters});self.connection=null;self.getCallInfo(conn.parameters.CallSid,3,function(call){return call&&call.id&&call.reasons&&call.reasons[Zendesk.currentUser.id]}).fail(function(){self.trigger("close-console")})});Twilio.Device.offline(function(){log.error("#twilio-offline",{args:arguments});self.connection=null;self.clientAvailable=false;self.clientReadying=false;if(self.checkingOffline||Zendesk.currentUser.availableForVoiceOn!=="client"){return}var b0=Zendesk.voiceMenu.backOff([2,4,8,16],function(){if(Twilio.Device.status()!=="ready"){Twilio.Device.setup(self.capabilityToken,{debug:Zendesk.currentUser.voice.logging});return false}else{return true}});b0.fail(function(){self.knockOfflineIfNotUnloading()}).always(function(){self.checkingOffline=false});self.checkingOffline=true});self.invalidTokenCount=0;self.refreshing=false;Twilio.Device.error(function(error){log.error("#twilio-error",{conn:self.connection&&self.connection.parameters,message:error.message,code:error.code});self.connection=null;if(Zendesk.currentUser.availableForVoiceOn!=="client"){return}if((self.fight&&self.fight.check())||!self.clientAvailable){if(error.message==="No microphone is available"){log.error("#twilio-no-microphone-error",{message:"ec2"});alert(I18n.t("txt.voice.error.ec2"));Zendesk.voiceMenu.updateAvailability("off","error-ec2")}else{if(error.message==="This AccessToken is no longer valid"){self.refreshCapabilityToken()}else{log.error("#twilio-unknown-error",{message:"ec3"});alert(I18n.t("txt.voice.error.ec3"));Zendesk.voiceMenu.updateAvailability("off","error-ec3")}}}});log.info("#hookup-device-finish")};this.refreshCapabilityToken=function(){var self=this;var oldToken=Zendesk.currentUser.voice.client_capability_token;if(this.refreshing){return}if(this.invalidTokenCount>=3){log.error("#invalid-token-error",{message:"ec13"});Zendesk.voiceMenu.updateAvailability("off","error-ec13");alert(I18n.t("txt.voice.error.ec13"));return}this.refreshing=true;this.invalidTokenCount++;log.info("#refresh-token",{count:self.invalidTokenCount});jQuery.ajax({async:false,url:"/api/v2/channels/voice/call_console.json?include=classic_call"}).done(function(json){Zendesk.currentUser.voice=json.call_console;if(oldToken!=Zendesk.currentUser.voice.client_capability_token){log.info("#new-token","#twilio-device-setup",{count:self.invalidTokenCount,token:Zendesk.currentUser.voice.client_capability_token});Twilio.Device.setup(Zendesk.currentUser.voice.client_capability_token,{debug:Zendesk.currentUser.voice.logging})}else{log.error("#stale-token",{count:self.invalidTokenCount,token:oldToken})}self.refreshing=false})};this.knockOfflineIfNotUnloading=function(){var self=this;var bO=Zendesk.voiceMenu.backOff([1,2,3],function(){return window.voiceUnloading});bO.fail(function(){if(self.fight&&self.fight.check()){log.error("#twilio-offline-error",{message:"ec1"});Zendesk.voiceMenu.updateAvailability("off","offline");alert(I18n.t("txt.voice.error.ec1"))}})};this.setupVoiceInMaintenance=function(){if(!Zendesk.currentUser.voice.in_maintenance){return}$(".console-title-bar").addClass("notice");$(".console-title-notice").css("display","block")};this._muteCall=function(muted){if(this.connection){if(muted){log.info("#mute");this.connection.mute(true)}else{log.info("#unmute");this.connection.mute(false)}}};this.restoreState=function(){if(!this.call){return}else{if(this.call.outgoing_kind!=="client"||this.call.status==="completed"){this.state=this.call.status;this.trigger(this.state,this.call)}}};this.clearState=function(){this.callOverlay.hide();this.stopTimer();this.call=null};var ReasonMessaging=function(){};ReasonMessaging.prototype={ignoring:false,ignore:function(){this.ignoring=true},reset:function(){this.ignoring=false}};this.reasonMessaging=new ReasonMessaging();this.setCurrentCall=function(call_data){if(!call_data){return this.call}if(call_data.caller){call_data.caller.name=this.truncateString(call_data.caller.name,this.maxDisplayStringLength);if(call_data.caller.organization){call_data.caller.organization.name=this.truncateString(call_data.caller.organization.name,15)}}log.debug("#set-current-call",{call:call_data});this.call=call_data;this.call.calling_number_encoded=encodeURIComponent(call_data.calling_number);return this.call};this.bind("run",function(e){this.app.restoreState()});this.bind("show-console",function(e){log.info("#show-console");this.$element().show()});this.bind("unanswered",function(e){this.trigger("close-console")});this.bind("close-console",function(e){log.info("#close-console");this.$element().hide();this.app.clearState()});this.bind("accept-call",function(e,data){log.info("#accept-call",{available:Zendesk.currentUser.availableForVoiceOn,conn:this.app.connection&&this.app.connection.parameters});if(Zendesk.currentUser.availableForVoiceOn==="client"&&this.app.connection){this.app.connection.accept()}else{this.app.updateCall("agent_accepts")}this.renderTemplate($("#title_bar_waiting_template"));this.renderTemplate($("#action_bar_accepted_call_template"))});this.bind("deny-call",function(e,data){log.info("#deny-call",{available:Zendesk.currentUser.availableForVoiceOn,conn:this.app.connection&&this.app.connection.parameters});if(Zendesk.currentUser.availableForVoiceOn==="client"&&this.app.connection){this.app.connection.disconnect()}this.app.updateCall("agent_declines");this.app.reasonMessaging.ignore();this.trigger("close-console")});this.bind("end-call",function(e,data){log.info("#end-call",{available:Zendesk.currentUser.availableForVoiceOn,conn:this.app.connection&&this.app.connection.parameters});if(Zendesk.currentUser.availableForVoiceOn==="client"&&this.app.connection){this.app.connection.disconnect()}else{this.app.updateCall("agent_end_call")}this.renderTemplate($("#action_bar_ending_call_template"));this.$element().find(".console-number").slideUp("slow")});this.bind("mute-call",function(e,data){if(this.app.clientAvailable){if(this.$element().find(".mute_call").hasClass("muted")){this.app._muteCall(false)}else{this.app._muteCall(true)}this.$element().find(".mute_call").toggleClass("muted")}});this.bind("finish-call",function(e,data){log.info("#finish-call",{available:Zendesk.currentUser.availableForVoiceOn,conn:this.app.connection&&this.app.connection.parameters});if(!this.app.call){return}if(this.app.audioPlayer){this.app.audioPlayer.pause()}this.app.updateCall("finish");this.trigger("close-console")});this.bind("close",function(e,data){this.trigger("close-console")});this.bind("missed-call",function(e){this.app.callOverlay.hide();log.info("#missed-call");if(Zendesk.currentUser.availableForVoiceOn==="client"){Twilio.Device.instance.disconnectAll()}if(this.app.reasonMessaging.ignoring){log.info("#ignore-reason-messaging");this.trigger("close-console");return}var self=this;var processReasons=function(){if(!self.app.call.reasons){return}var reasons=self.app.call.reasons[Zendesk.currentUser.id];if(!reasons){return}var reason=reasons[reasons.length-1];if(!reason){return}var allReasons=self.app.call.reasons.all;if(reason.title==="call_returned_to_queue"){if(allReasons&&allReasons.length>0){for(var i=allReasons.length-1;i>=0;i--){var all=allReasons[i];var allAt=new Date(all.at);var reasonAt=new Date(reason.at);if(allAt>=reasonAt){return all}}}}return reason};var reason=processReasons();if(!reason){return}log.info("#missed-call",{reason:reason});var title=reason.title;var details=reason.details;if(title!=="call_routed_to_agent"){title=I18n.t("txt.views.voice.call_console.reason.title."+title);if(details){details=I18n.t("txt.views.voice.call_console.reason.detail."+details)}}else{title=I18n.t("txt.views.voice.call_console.reason.title."+title,{name:details});details=null}var both=title&&details;var titleBarTemplate=$("#title_bar_missed_call_template");if($(".console-title-text").hasClass("waiting")){titleBarTemplate=$("#title_bar_unable_to_accept_call_template")}this.renderTemplate(titleBarTemplate,{id:self.app.call.id}).then(function(){var titleContent=$(".console-title-content");titleContent.hover(function(){titleContent.find(".title").hide();titleContent.find(".call-id").show();titleContent.addClass("clickable")},function(){titleContent.find(".title").show();titleContent.find(".call-id").hide();titleContent.removeClass("clickable")});if(navigator.mimeTypes["application/x-shockwave-flash"]){ZeroClipboard.config({moviePath:"/javascripts/ZeroClipboard.swf"});var clipboard=new ZeroClipboard($(".copy-button"))}});this.renderTemplate($("#routing_reason_template"),{title:title,details:details,both:both});this.renderTemplate($("#action_bar_close_template"));this.app.showConsoleIfNeeded()});this.setCall=function(call_data){this.call=call_data;this.call.calling_number_encoded=encodeURIComponent(call_data.calling_number)};this.updateCall=function(response){var self=this;var pushVisibility=self.$element().is(":visible");$.ajax({url:"/voice/calls/update_status?call_id="+this.call.id+"&outgoing_sid="+this.call.outgoing_sid,type:"POST",data:{event:response},error:function(){log.error("#update-call-error",{message:"ec4"});alert(I18n.t("txt.voice.error.ec4"));if(pushVisibility){self.showConsoleIfNeeded()}else{self.hideConsoleIfNeeded()}}})};this.startTimer=function(){if(this.timer){return}var timer=new Voice.Timer(this.$element().find(".console-title-text"));if(this.call&&this.call.connected_at){this.timer=new Voice.TimerManager(timer,new Date(this.call.connected_at))}else{this.timer=new Voice.TimerManager(timer,new Date())}};this.stopTimer=function(){if(this.timer){this.timer.stop();delete this.timer}};this.bind("routing",function(e,call_data){if(this.app.reporter()){this.app.reporter().increment("voice.classic_call_accepted",1)}log.info("#trigger-routing",{available:Zendesk.currentUser.availableForVoiceOn,gotInfo:this.app.gotCallInfo});if(Zendesk.currentUser.availableForVoiceOn==="client"&&!this.app.gotCallInfo){return}call_data=this.app.setCurrentCall(call_data);var self=this;this.app.reasonMessaging.reset();this.renderTemplate($("#title_bar_incoming_call_template")).then(function(){self.$element().find(".console-title-prefix").html(I18n.t("txt.admin.public.javascripts.views.voice.call_console.incoming_call_answer_in"));var timer=new Voice.CountdownTimer(self.$element().find(".console-title-timer"));timer.stop(function(){self.$element().find(".console-title-prefix").html(I18n.t("txt.admin.public.javascripts.views.voice.call_console.incoming_call"))});self.app.routingTimer=new Voice.TimerManager(timer,new Date((new Date()).valueOf()+call_data.answer_in*1000))});this.renderTemplate($("#number_template"),call_data);this.$element().find(".console-number").show();this.renderTemplate($("#call_console_user_card"),call_data);var template=call_data.outbound?"action_bar_in_call_template":"action_bar_user_calling_template";this.renderTemplate($("#"+template),call_data);this.app.showConsoleIfNeeded()});this.bind("accepted",function(e,call_data){log.info("#trigger-accepted",{available:Zendesk.currentUser.availableForVoiceOn,gotInfo:this.app.gotCallInfo});this.renderTemplate($("#title_bar_waiting_template"));this.renderTemplate($("#action_bar_accepted_call_template"));this.app.showConsoleIfNeeded()});this.bind("check_agent",function(e,call_data){var self=this;if(self.app.routingTimer){self.app.routingTimer.stop();delete self.app.routingTimer}this.renderTemplate($("#title_bar_incoming_call_template")).then(function(){self.$element().find(".console-title-prefix").html(I18n.t("txt.admin.public.javascripts.views.voice.call_console.incoming_call_accept_in"));var timer=new Voice.CountdownTimer(self.$element().find(".console-title-timer"));timer.stop(function(){self.$element().find(".console-title-prefix").html(I18n.t("txt.admin.public.javascripts.views.voice.call_console.incoming_call"))});new Voice.TimerManager(timer,new Date((new Date()).valueOf()+call_data.accept_in*1000))})});this.bind("in_conference",function(e,call_data){log.info("#trigger-in-conference",{available:Zendesk.currentUser.availableForVoiceOn,client:this.app.clientAvailable});if(Zendesk.currentUser.availableForVoiceOn==="client"&&!this.app.clientAvailable){return}call_data=this.app.setCurrentCall(call_data);var self=this;this.renderTemplate($("#action_bar_in_call_template"));this.renderTemplate($("#number_template"),call_data);this.$element().find(".console-number").show();this.renderTemplate($("#call_console_user_card"),call_data);if(!this.app.timer){this.renderTemplate($("#title_bar_in_call_template")).then(function(){if(Zendesk.currentUser.availableForVoiceOn==="client"){self.$element().find(".mute_call").show();self.$element().find(".mute_call").unbind("click");self.$element().find(".mute_call").click(function(){self.app.trigger("mute-call")})}else{self.$element().find(".mute_call").hide()}self.app.startTimer()})}this.app.showConsoleIfNeeded()});this.bind("completed",function(e,call_data){call_data=this.app.setCurrentCall(call_data);var self=this;log.info("#trigger-completed",{wrap:call_data["agent_wrap_up_after_calls?"]});if(call_data["agent_wrap_up_after_calls?"]===false){this.trigger("close-console");return}this.app.stopTimer();this.$element().find(".mute_call").hide();this.$element().find(".console-number").hide();this.renderTemplate($("#title_bar_call_ended_template"));this.renderTemplate($("#action_bar_completed_call_template"));this.renderTemplate($("#call_console_user_card"),call_data).then(function(){self.app.setupAudioPlayer()});this.app.showConsoleIfNeeded()});this.bind("voicemail",function(){this.trigger("missed-call")});this.bind("voicemail_transcription_completed",function(){this.trigger("missed-call")});this.bind("cancelled",function(){this.trigger("missed-call")});this.bind("queued",function(){this.trigger("missed-call")});this.bind("ended",function(){this.trigger("close-console")});this.truncateString=function(string,maxLength){if(string.length>maxLength){string=string.slice(0,maxLength-string.length)+"..."}return string};this.notFound=function(){};this.messageHandler=_.bind(function(message){message=message.value.classic;var messageType=message.name;var data=message.data;var triggers=message.triggers;if(_.isUndefined(messageType)){return}this.setCurrentCall(data);if(data.outgoing_kind!=="client"||data.status==="completed"||data.status==="ended"){app.safeTrigger(messageType,data)}if(data.status==="cancelled"){app.safeTrigger(messageType,data)}},this);this.subscribeForMessages=function(){if(Zendesk.currentUser.voice.in_maintenance){return}log.info("#subscribe-for-messages",{channel:"call_console."+Zendesk.currentUser.id});var self=this;RadarClient.alloc("current_call",function(){RadarClient.status("voice/call_console/"+Zendesk.currentUser.id).on(self.messageHandler.bind(self)).subscribe()})};this.reporter=_.memoize(function(){if(window.ZendeskReporter){return new window.ZendeskReporter(["classic"])}});this.pubsubChannel="call_console."+Zendesk.currentUser.id;this.initAudioPlayer=function(){var self=this;log.info("#init-audio-player-start",{call:self.call});var player=new Player({domId:"audio_player_console_"+self.call.id,url:self.call.player_recording_urls,swfUrl:"/media/voice/soundmanager"})};this.setupAudioPlayer=function(){var self=this;if(this.call.recording_url&&this.call.is_recording_url_ready){self.initAudioPlayer()}else{if(this.call.outgoing_sid){this.getCallInfo(this.call.outgoing_sid,3,function(call){return call&&call.recording_url&&call.is_recording_url_ready}).done(function(){self.initAudioPlayer()})}}}});Zendesk.CallConsoleApp=app}(jQuery,Zendesk));(function($,Zendesk){Zendesk.CallOverlay=(function(){var _shouldBlockOutgoingLinks,_initializedBlocker;var initializeBlocker=function(){if(!_initializedBlocker){$("#call-console a, #cboxWrapper a").live("click",function(event){if(!_shouldBlockOutgoingLinks){return}event.preventDefault();event.stopPropagation();window.open(this.href,"_blank")});_initializedBlocker=true}};function CallOverlay(){this.show=function(){_shouldBlockOutgoingLinks=true;$("#voice-blocking-banner").slideDown(1000);$("#voice-blocking-overlay").show();initializeBlocker()};this.hide=function(){_shouldBlockOutgoingLinks=false;$("#voice-blocking-banner").slideUp(1000);$("#voice-blocking-overlay").hide()}}return CallOverlay})()}(jQuery,Zendesk));(function($,Zendesk){var log=Minilog("fight");Zendesk.RadarFight=(function(){function RadarFight(name,options){this.options=options||{};this.check=options.check||function(){};this.win=options.win||function(){};this.lose=options.lose||function(){};var self=this;var scope="voice.fight."+Zendesk.currentUser.id;var _state;var transition=function(state){if(_state!==undefined&&(_state==state)){return}log.info("#transition",_state,state);_state=state;switch(_state){case"win":self.win();break;case"lose":self.lose();break}};var clients=[];RadarClient.alloc(scope,function(){RadarClient.presence(scope).set("online").on(function(message){var clientId;if(message.op==="client_online"){clientId=message.value.clientId;clients.push(clientId);if(clientId===RadarClient._socket.id){transition("win")}else{transition("lose")}}else{if(message.op==="client_offline"){clientId=message.value.clientId;var index=clients.indexOf(clientId);if(index>-1){clients.splice(index,1)}if(clients[clients.length-1]===RadarClient._socket.id){transition("win")}else{transition("lose")}}}}).sync()})}return RadarFight}())}(jQuery,Zendesk));Zendesk.NS("Voice");Zendesk.Voice.AssociateGreetingNumbers={init:function(selector){this.container=$j(selector);this.setup()},setup:function(selector){var self=this;this.container.find(".std_tile").click(function(){self.toggleNumberSelected($j(this));self.updateSelectedNumbers($j(this))})},toggleNumberSelected:function(elem){elem.toggleClass("selected")},updateSelectedNumbers:function(elem){var selected_ids=this.container.find(".std_tile.selected").map(function(){return $j(this).attr("data-phone-number-id")}).get();this.container.find("#numbers_selected").val(selected_ids.join());phone_number_id=this.container.find("input[value="+elem.attr("data-phone-number-id")+"]");if(phone_number_id.length>0){var phone_number_id=$j(phone_number_id[0]);phone_number_id.attr("checked",!phone_number_id.attr("checked"))}}};Zendesk.NS("Voice");Zendesk.Voice.AudioPlayer={init:function(selector){this.setupAudioPlayers(selector)},setupAudioPlayers:function(selector){$j(selector).find(".audio:enabled").each(function(n,audio){var $audio=$j(audio);if(!$audio.attr("data-audio-id")){var audioID=_.uniqueId("audio_");$audio.attr("data-audio-id",audioID);var playerAudio=new Player.Audio({domId:audioID,url:$audio.attr("data-audio-src"),swfUrl:"/media/voice/soundmanager",stream:true});playerAudio.ready(function(sound){$audio.click(function(){if($audio.hasClass("playing")){if(!$audio.hasClass("small")){$audio.val(I18n.t("txt.admin.public.javascripts.views.voice.settings.greeting_config.play"))}$audio.removeClass("playing buffering");sound.pause()}else{if(!$audio.hasClass("small")){$audio.val(I18n.t("txt.admin.public.javascripts.views.voice.settings.greeting_config.pause"))}$audio.addClass("playing");var audioUrl=$audio.attr("data-audio-src");if(playerAudio.url!==audioUrl){sound=window.soundManager.createSound({id:audioUrl,url:audioUrl,stream:true});playerAudio.url=audioUrl}sound.play({onbufferchange:function(){if(sound.isBuffering){setTimeout(function(){if(sound.isBuffering){$audio.addClass("buffering")}},300)}else{$audio.removeClass("buffering")}},onfinish:function(){if(!$audio.hasClass("small")){$audio.val(I18n.t("txt.admin.public.javascripts.views.voice.settings.greeting_config.play"))}$audio.removeClass("playing")}})}})})}})}};Zendesk.NS("Voice");Zendesk.Voice.AudioRecorder={init:function(selector){var self=this;this.greetingID=$j(selector).data("greeting-id");$j(selector).click(function(e){self.updateColorbox("#custom_greeting_form_main_page");$j("#custom_greeting_form #record_custom_greeting_button").click(function(e){self.showCustomGreetingFormRecordPage();if(e){e.preventDefault()}});$j("#voice_custom_greeting_form #greeting_upload").change(function(){$j("#voice_custom_greeting_form").submit()});var fileInput=$j("#voice_custom_greeting_form #greeting_upload_attributes_uploaded_data");fileInput.change(function(){$j("#voice_custom_greeting_form").submit()});$j("#upload_custom_greeting_button").click(function(e){fileInput.trigger("click")});$j.colorbox({inline:true,href:"#custom_greeting_form",scrolling:false})})},showCustomGreetingFormRecordPage:function(){var self=this;this.updateColorbox("#custom_greeting_form_record_page");var callingNumber=$j("#custom_greeting_form #call_phone_number");$j(callingNumber).prop("selectionStart",callingNumber.val().length);$j(callingNumber).focus();$j("#custom_greeting_form #call_phone_number_button").click(function(e){self.startRecordingFlow();if(e){e.preventDefault()}})},startRecordingFlow:function(){var self=this;var callingNumber=$j("#custom_greeting_form #call_phone_number").val();if(!self.validatePhoneNumber(callingNumber)){return}$j.ajax({url:"/voice/calls/greetings/call_number",type:"post",data:{greeting_id:this.greetingID,call_phone_number:callingNumber,authenticity_token:Zendesk.currentUser.authenticityToken},success:function(){var message=I18n.t("txt.admin.public.javascripts.views.voice.settings.greeting_config.calling_you_at",{number:callingNumber});$j("#custom_greeting_form").html($j.mustache($j("#custom_greeting_form_record_wait_page").html(),{message:message}));RadarClient.initialize(function(){RadarClient.alloc("voice_recordings",function(){RadarClient.status("call_recording/"+Zendesk.currentAccount.subdomain).once(self.recordingUpdateHandler.bind(self)).subscribe()})})},error:function(){self.showInvalidPhoneNumberError(callingNumber)},complete:function(){_.defer($j.colorbox.resize)}})},validatePhoneNumber:function(number){number=$j.trim(number);if(number.match(/^(\s*|\++)$/)){this.showEmptyPhoneNumberError()}else{if(!number.match(/\d+/)){this.showInvalidPhoneNumberError(number)}else{return true}}_.defer($j.colorbox.resize);return false},showEmptyPhoneNumberError:function(){$j("#custom_greeting_call_status").html(I18n.t("txt.admin.public.javascripts.views.voice.settings.greeting_config.empty_phone_number_error"))},showInvalidPhoneNumberError:function(number){number=number.escapeHTML();$j("#custom_greeting_call_status").html(I18n.t("txt.admin.public.javascripts.views.voice.settings.greeting_config.phone_number_error",{number:number}))},recordingUpdateHandler:function(msg){var self=this;var status=msg.value.status;switch(status){case"complete":$j("#custom_greeting_form #record_wait_message").html(I18n.t("txt.admin.public.javascripts.views.voice.settings.greeting_config.updated_successfully"));_.defer($j.colorbox.resize);_.delay(self.reloadPage,2000);break;case"incomplete":$j("#custom_greeting_form #record_wait_message").html(I18n.t("txt.admin.public.javascripts.views.voice.settings.greeting_config.couldnt_complete_recording"));_.defer($j.colorbox.resize);_.delay($j.colorbox.close,2000);break}},updateColorbox:function(selector,options){$j("#custom_greeting_form").html($j(selector).html(),options);$j.colorbox.resize()},reloadPage:function(){window.location.reload(true)}};(function($){var msOldDiv="";var dd=function(element,options){var sElement=element;var $this=this;var options=$.extend({height:120,visibleRows:7,rowHeight:23,showIcon:true,zIndex:9999,mainCSS:"dd",useSprite:false,animStyle:"slideDown",onInit:"",style:""},options);this.ddProp=new Object;var oldSelectedValue="";var actionSettings={};actionSettings.insideWindow=true;actionSettings.keyboardAction=false;actionSettings.currentKey=null;var ddList=false;var config={postElementHolder:"_msddHolder",postID:"_msdd",postTitleID:"_title",postTitleTextID:"_titletext",postChildID:"_child",postAID:"_msa",postOPTAID:"_msopta",postInputID:"_msinput",postArrowID:"_arrow",postInputhidden:"_inp"};var styles={dd:options.mainCSS,ddTitle:"ddTitle",arrow:"arrow",ddChild:"ddChild",ddTitleText:"ddTitleText",disabled:0.3,ddOutOfVision:"ddOutOfVision",borderTop:"borderTop",noBorderTop:"noBorderTop",selected:"selected"};var attributes={actions:"focus,blur,change,click,dblclick,mousedown,mouseup,mouseover,mousemove,mouseout,keypress,keydown,keyup",prop:"size,multiple,disabled,tabindex"};this.onActions=new Object;var elementid=$(sElement).prop("id");if(typeof elementid=="undefined"||elementid.length<=0){elementid="msdrpdd"+$.msDropDown.counter++;$(sElement).attr("id",elementid)}var inlineCSS=$(sElement).prop("style");options.style+=inlineCSS==undefined?"":inlineCSS;var allOptions=$(sElement).children();ddList=$(sElement).prop("size")>1||$(sElement).prop("multiple")==true?true:false;if(ddList){options.visibleRows=$(sElement).prop("size")}var a_array={};var currentP=0;var isFilter=false;var oldHeight;var cacheElement={};var getElement=function(a){if(typeof cacheElement[a]=="undefined"){cacheElement[a]=document.getElementById(a)}return cacheElement[a]};var getPostID=function(a){return elementid+config[a]};var getOptionsProperties=function(a){var b=a;var c=$(b).prop("style");return c};var matchIndex=function(a){var b=$("#"+elementid+" option:selected");if(b.length>1){for(var c=0;c<b.length;c++){if(a==b[c].index){return true}}}else{if(b.length==1){if(b[0].index==a){return true}}}return false};var createA=function(a,b,c,d){var e="";var f=d=="opt"?getPostID("postOPTAID"):getPostID("postAID");var g=d=="opt"?f+"_"+b+"_"+c:f+"_"+b;var h="";var i="";if(options.useSprite!=false){i=" "+options.useSprite+" "+a.className}else{h=$(a).prop("title");h=h.length==0?"":'<img src="'+h+'" align="absmiddle" /> '}var j=$(a).text();var k=$(a).val();var l=$(a).prop("disabled")==true?"disabled":"enabled";a_array[g]={html:h+j,value:k,text:j,index:a.index,id:g};var m=getOptionsProperties(a);if(matchIndex(a.index)==true){e+='<a href="javascript:void(0);" class="'+styles.selected+" "+l+i+'"'}else{e+='<a  href="javascript:void(0);" class="'+l+i+'"'}if(m!==false&&m!==undefined){e+=" style='"+m+"'"}e+=' id="'+g+'">';e+=h+'<span class="'+styles.ddTitleText+'">'+j+"</span></a>";return e};var in_array=function(a){var b=a.toLowerCase();if(b.length==0){return -1}var c="";for(var d in a_array){var e=a_array[d].text.toLowerCase();if(e.substr(0,b.length)==b){c+="#"+a_array[d].id+", "}}return c==""?-1:c};var createATags=function(){var a=allOptions;if(a.length==0){return""}var b="";var c=getPostID("postAID");var d=getPostID("postOPTAID");a.each(function(c){var d=a[c];if(d.nodeName=="OPTGROUP"){b+="<div class='opta'>";b+="<span style='font-weight:bold;font-style:italic; clear:both;'>"+$(d).prop("label")+"</span>";var e=$(d).children();e.each(function(a){var d=e[a];b+=createA(d,c,a,"opt")});b+="</div>"}else{b+=createA(d,c,"","")}});return b};var createChildDiv=function(){var a=getPostID("postID");var b=getPostID("postChildID");var c=options.style;sDiv="";sDiv+='<div id="'+b+'" class="'+styles.ddChild+'"';if(!ddList){sDiv+=c!=""?' style="'+c+'"':""}else{sDiv+=c!=""?' style="border-top:1px solid #c3c3c3;display:block;position:relative;'+c+'"':""}sDiv+=">";return sDiv};var createTitleDiv=function(){var a=getPostID("postTitleID");var b=getPostID("postArrowID");var c=getPostID("postTitleTextID");var d=getPostID("postInputhidden");var e="";var f="";if(getElement(elementid).options.length>0){e=$("#"+elementid+" option:selected").text();f=$("#"+elementid+" option:selected").prop("title")}f=f.length==0||f==undefined||options.showIcon==false||options.useSprite!=false?"":'<img src="'+f+'" align="absmiddle" /> ';var g='<div id="'+a+'" class="'+styles.ddTitle+'"';g+=">";g+='<span id="'+b+'" class="'+styles.arrow+'"></span><span class="'+styles.ddTitleText+'" id="'+c+'">'+f+'<span class="'+styles.ddTitleText+'">'+e+"</span></span></div>";return g};var applyEventsOnA=function(){var a=getPostID("postChildID");$("#"+a+" a.enabled").unbind("click");$("#"+a+" a.enabled").bind("click",function(b){b.preventDefault();manageSelection(this);setValue();if(!ddList){$("#"+a).unbind("mouseover");setInsideWindow(false);var c=options.showIcon==false?$(this).text():$(this).html();setTitleText(c);$this.close()}})};var createDropDown=function(){var a=false;var b=getPostID("postID");var c=getPostID("postTitleID");var d=getPostID("postTitleTextID");var e=getPostID("postChildID");var f=getPostID("postArrowID");var g=$("#"+elementid).outerWidth()+20;g=g+2;var h=options.style;if($("#"+b).length>0){$("#"+b).remove();a=true}var i='<div id="'+b+'" class="'+styles.dd+'"';i+=h!=""?' style="'+h+'"':"";i+=">";i+=createTitleDiv();i+=createChildDiv();i+=createATags();i+="</div>";i+="</div>";if(a==true){var j=getPostID("postElementHolder");$("#"+j).after(i)}else{$("#"+elementid).after(i)}if(ddList){var c=getPostID("postTitleID");$("#"+c).hide()}$("#"+b).css("width",g+"px");$("#"+e).css("width",g-2+"px");if(allOptions.length>options.visibleRows){var k=parseInt($("#"+e+" a:first").css("padding-bottom"))+parseInt($("#"+e+" a:first").css("padding-top"));var l=options.rowHeight*options.visibleRows-k;$("#"+e).css("height",l+"px")}else{if(ddList){var l=$("#"+elementid).height();$("#"+e).css("height",l+"px")}}if(a==false){setOutOfVision();addRefreshMethods(elementid)}if($("#"+elementid).prop("disabled")==true){$("#"+b).css("opacity",styles.disabled)}applyEvents();$("#"+c).bind("mouseover",function(a){hightlightArrow(1)});$("#"+c).bind("mouseout",function(a){hightlightArrow(0)});applyEventsOnA();$("#"+e+" a.disabled").css("opacity",styles.disabled);if(ddList){$("#"+e).bind("mouseover",function(a){if(!actionSettings.keyboardAction){actionSettings.keyboardAction=true;$(document).bind("keydown",function(a){var b=a.keyCode;actionSettings.currentKey=b;if(b==39||b==40){a.preventDefault();a.stopPropagation();next();setValue()}if(b==37||b==38){a.preventDefault();a.stopPropagation();previous();setValue()}})}})}$("#"+e).bind("mouseout",function(a){setInsideWindow(false);$(document).unbind("keydown");actionSettings.keyboardAction=false;actionSettings.currentKey=null});$("#"+c).bind("click",function(a){setInsideWindow(false);if($("#"+e+":visible").length==1){$("#"+e).unbind("mouseover")}else{$("#"+e).bind("mouseover",function(a){setInsideWindow(true)});$this.open()}});$("#"+c).bind("mouseout",function(a){setInsideWindow(false)});if(options.showIcon&&options.useSprite!=false){setTitleImageSprite()}};var getByIndex=function(a){for(var b in a_array){if(a_array[b].index==a){return a_array[b]}}return -1};var manageSelection=function(a){var b=getPostID("postChildID");if($("#"+b+" a."+styles.selected).length==1){oldSelectedValue=$("#"+b+" a."+styles.selected).text()}if(!ddList){$("#"+b+" a."+styles.selected).removeClass(styles.selected)}var c=$("#"+b+" a."+styles.selected).prop("id");if(c!=undefined){var d=actionSettings.oldIndex==undefined||actionSettings.oldIndex==null?a_array[c].index:actionSettings.oldIndex}if(a&&!ddList){$(a).addClass(styles.selected)}if(ddList){var e=actionSettings.currentKey;if($("#"+elementid).prop("multiple")==true){if(e==17){actionSettings.oldIndex=a_array[$(a).prop("id")].index;$(a).toggleClass(styles.selected)}else{if(e==16){$("#"+b+" a."+styles.selected).removeClass(styles.selected);$(a).addClass(styles.selected);var f=$(a).prop("id");var g=a_array[f].index;for(var h=Math.min(d,g);h<=Math.max(d,g);h++){$("#"+getByIndex(h).id).addClass(styles.selected)}}else{$("#"+b+" a."+styles.selected).removeClass(styles.selected);$(a).addClass(styles.selected);actionSettings.oldIndex=a_array[$(a).prop("id")].index}}}else{$("#"+b+" a."+styles.selected).removeClass(styles.selected);$(a).addClass(styles.selected);actionSettings.oldIndex=a_array[$(a).prop("id")].index}}};var addRefreshMethods=function(a){var b=a;getElement(b).refresh=function(a){$("#"+b).msDropDown(options)}};var setInsideWindow=function(a){actionSettings.insideWindow=a};var getInsideWindow=function(){return actionSettings.insideWindow};var applyEvents=function(){var a=getPostID("postID");var b=attributes.actions.split(",");for(var c=0;c<b.length;c++){var d=b[c];var e=has_handler(d);if(e==true){switch(d){case"focus":$("#"+a).bind("mouseenter",function(a){getElement(elementid).focus()});break;case"click":$("#"+a).bind("click",function(a){$("#"+elementid).trigger("click")});break;case"dblclick":$("#"+a).bind("dblclick",function(a){$("#"+elementid).trigger("dblclick")});break;case"mousedown":$("#"+a).bind("mousedown",function(a){$("#"+elementid).trigger("mousedown")});break;case"mouseup":$("#"+a).bind("mouseup",function(a){$("#"+elementid).trigger("mouseup")});break;case"mouseover":$("#"+a).bind("mouseover",function(a){$("#"+elementid).trigger("mouseover")});break;case"mousemove":$("#"+a).bind("mousemove",function(a){$("#"+elementid).trigger("mousemove")});break;case"mouseout":$("#"+a).bind("mouseout",function(a){$("#"+elementid).trigger("mouseout")});break}}}};var setOutOfVision=function(){var a=getPostID("postElementHolder");$("#"+elementid).after("<div class='"+styles.ddOutOfVision+"' style='height:0px;overflow:hidden;position:absolute;' id='"+a+"'></div>");$("#"+elementid).appendTo($("#"+a))};var setTitleText=function(a){var b=getPostID("postTitleTextID");$("#"+b).html(a)};var navigateA=function(a){var b=a;var c=getPostID("postChildID");var d=$("#"+c+" a:visible");var e=d.length;var f=$("#"+c+" a:visible").index($("#"+c+" a.selected:visible"));var g;switch(b){case"next":if(f<e-1){f++;g=d[f]}break;case"previous":if(f<e&&f>0){f--;g=d[f]}break}if(typeof g=="undefined"){return false}$("#"+c+" a."+styles.selected).removeClass(styles.selected);$(g).addClass(styles.selected);var h=g.id;if(!ddList){var i=options.showIcon==false?a_array[h].text:$("#"+h).html();setTitleText(i);setTitleImageSprite(a_array[h].index)}if(b=="next"){if(parseInt($("#"+h).position().top+$("#"+h).height())>=parseInt($("#"+c).height())){$("#"+c).scrollTop($("#"+c).scrollTop()+$("#"+h).height()+$("#"+h).height())}}else{if(parseInt($("#"+h).position().top+$("#"+h).height())<=0){$("#"+c).scrollTop($("#"+c).scrollTop()-$("#"+c).height()-$("#"+h).height())}}};var next=function(){navigateA("next")};var previous=function(){navigateA("previous")};var setTitleImageSprite=function(a){if(options.useSprite!=false){var b=getPostID("postTitleTextID");var c=typeof a=="undefined"?getElement(elementid).selectedIndex:a;var d=getElement(elementid).options[c].className;if(d.length>0){var e=getPostID("postChildID");var f=$("#"+e+" a."+d).prop("id");var g=$("#"+f).css("background-image");var h=$("#"+f).css("background-position");var i=$("#"+f).css("padding-left");if(g!=undefined){$("#"+b).find("."+styles.ddTitleText).attr("style","background:"+g)}if(h!=undefined){$("#"+b).find("."+styles.ddTitleText).css("background-position",h)}if(i!=undefined){$("#"+b).find("."+styles.ddTitleText).css("padding-left",i)}$("#"+b).find("."+styles.ddTitleText).css("background-repeat","no-repeat");$("#"+b).find("."+styles.ddTitleText).css("padding-bottom","2px")}}};var setValue=function(){var a=getPostID("postChildID");var b=$("#"+a+" a."+styles.selected);if(b.length==1){var c=$("#"+a+" a."+styles.selected).text();var d=$("#"+a+" a."+styles.selected).prop("id");if(d!=undefined){var e=a_array[d].value;getElement(elementid).selectedIndex=a_array[d].index}if(options.showIcon&&options.useSprite!=false){setTitleImageSprite()}}else{if(b.length>1){for(var f=0;f<b.length;f++){var d=$(b[f]).prop("id");var g=a_array[d].index;getElement(elementid).options[g].selected="selected"}}}var h=getElement(elementid).selectedIndex;$this.ddProp.selectedIndex=h};var has_handler=function(a){if($("#"+elementid).prop("on"+a)!=undefined){return true}var b=$("#"+elementid).data("events");if(b&&b[a]){return true}return false};var checkMethodAndApply=function(){var a=getPostID("postChildID");if(has_handler("change")==true){var b=a_array[$("#"+a+" a.selected").prop("id")].text;if($.trim(oldSelectedValue)!==$.trim(b)&&oldSelectedValue!==""){$("#"+elementid).trigger("change")}}if(has_handler("mouseup")==true){$("#"+elementid).trigger("mouseup")}if(has_handler("blur")==true){$(document).bind("mouseup",function(a){$("#"+elementid).focus();$("#"+elementid)[0].blur();setValue();$(document).unbind("mouseup")})}};var hightlightArrow=function(a){var b=getPostID("postArrowID");if(a==1){$("#"+b).css({backgroundPosition:"0 100%"})}else{$("#"+b).css({backgroundPosition:"0 0"})}};var setOriginalProperties=function(){for(var a in getElement(elementid)){if(typeof getElement(elementid)[a]!="function"&&getElement(elementid)[a]!==undefined&&getElement(elementid)[a]!==null){$this.set(a,getElement(elementid)[a],true)}}};var setValueByIndex=function(a,b){if(getByIndex(b)!=-1){getElement(elementid)[a]=b;var c=getPostID("postChildID");$("#"+c+" a."+styles.selected).removeClass(styles.selected);$("#"+getByIndex(b).id).addClass(styles.selected);var d=getByIndex(getElement(elementid).selectedIndex).html;setTitleText(d)}};var addRemoveFromIndex=function(a,b){if(b=="d"){for(var c in a_array){if(a_array[c].index==a){delete a_array[c];break}}}var d=0;for(var c in a_array){a_array[c].index=d;d++}};var shouldOpenOpposite=function(){var a=getPostID("postChildID");var b=getPostID("postID");var c=$("#"+b).position();var d=$("#"+b).height();var e=$(window).height();var f=$(window).scrollTop();var g=$("#"+a).height();var h={zIndex:options.zIndex,top:c.top+d+"px",display:"none"};var i=options.animStyle;var j=false;var k=styles.noBorderTop;$("#"+a).removeClass(styles.noBorderTop);$("#"+a).removeClass(styles.borderTop);if(e+f<Math.floor(g+d+c.top)){var l=c.top-g;if(c.top-g<0){l=10}h={zIndex:options.zIndex,top:l+"px",display:"none"};i="show";j=true;k=styles.borderTop}return{opp:j,ani:i,css:h,border:k}};var fireOpenEvent=function(){if($this.onActions.onOpen!=null){eval($this.onActions.onOpen)($this)}};var fireCloseEvent=function(){checkMethodAndApply();if($this.onActions.onClose!=null){eval($this.onActions.onClose)($this)}};this.open=function(){if($this.get("disabled",true)==true||$this.get("options",true).length==0){return}var a=getPostID("postChildID");if(msOldDiv!=""&&a!=msOldDiv){$("#"+msOldDiv).slideUp("fast");$("#"+msOldDiv).css({zIndex:"0"})}if($("#"+a).css("display")=="none"){oldSelectedValue=a_array[$("#"+a+" a.selected").prop("id")].text;var b="";oldHeight=$("#"+a).height();$("#"+a+" a").show();$(document).bind("keydown",function(c){var d=c.keyCode;if(d==8){c.preventDefault();c.stopPropagation();b=b.length==0?"":b.substr(0,b.length-1)}switch(d){case 39:case 40:c.preventDefault();c.stopPropagation();next();break;case 37:case 38:c.preventDefault();c.stopPropagation();previous();break;case 27:case 13:$this.close();setValue();break;default:if(d>46){b+=String.fromCharCode(d)}var e=in_array(b);if(e!=-1){$("#"+a).css({height:"auto"});$("#"+a+" a").hide();$(e).show();var f=shouldOpenOpposite();$("#"+a).css(f.css);$("#"+a).css({display:"block"})}else{$("#"+a+" a").show();$("#"+a).css({height:oldHeight+"px"})}break}if(has_handler("keydown")==true){getElement(elementid).onkeydown()}});$(document).bind("keyup",function(a){if($("#"+elementid).prop("onkeyup")!=undefined){getElement(elementid).onkeyup()}});$(document).bind("mouseup",function(a){if(getInsideWindow()==false){$this.close()}});var c=shouldOpenOpposite();$("#"+a).css(c.css);if(c.opp==true){$("#"+a).css({display:"block"});$("#"+a).addClass(c.border);fireOpenEvent()}else{$("#"+a)[c.ani]("fast",function(){$("#"+a).addClass(c.border);fireOpenEvent()})}if(a!=msOldDiv){msOldDiv=a}}};this.close=function(){var a=getPostID("postChildID");var b=$("#"+getPostID("postTitleID")).position().top;var c=shouldOpenOpposite();isFilter=false;if(c.opp==true){$("#"+a).animate({height:0,top:b},function(){$("#"+a).css({height:oldHeight+"px",display:"none"});fireCloseEvent()})}else{$("#"+a).slideUp("fast",function(b){fireCloseEvent();$("#"+a).css({zIndex:"0"});$("#"+a).css({height:oldHeight+"px"})})}setTitleImageSprite();$(document).unbind("keydown");$(document).unbind("keyup");$(document).unbind("mouseup")};this.selectedIndex=function(a){if(typeof a=="undefined"){return $this.get("selectedIndex")}else{$this.set("selectedIndex",a)}};this.debug=function(a){if(typeof a=="undefined"||a==true){$("."+styles.ddOutOfVision).removeAttr("style")}else{$("."+styles.ddOutOfVision).attr("style","height:0px;overflow:hidden;position:absolute")}};this.set=function(a,b,c){if(a==undefined||b==undefined){throw {message:"set to what?"}}$this.ddProp[a]=b;if(c!=true){switch(a){case"selectedIndex":setValueByIndex(a,b);break;case"disabled":$this.disabled(b,true);break;case"multiple":getElement(elementid)[a]=b;ddList=$(sElement).prop("size")>0||$(sElement).prop("multiple")==true?true:false;if(ddList){var d=$("#"+elementid).height();var e=getPostID("postChildID");$("#"+e).css("height",d+"px");var f=getPostID("postTitleID");$("#"+f).hide();var e=getPostID("postChildID");$("#"+e).css({display:"block",position:"relative"});applyEventsOnA()}break;case"size":getElement(elementid)[a]=b;if(b==0){getElement(elementid).multiple=false}ddList=$(sElement).prop("size")>0||$(sElement).prop("multiple")==true?true:false;if(b==0){var f=getPostID("postTitleID");$("#"+f).show();var e=getPostID("postChildID");$("#"+e).css({display:"none",position:"absolute"});var g="";if(getElement(elementid).selectedIndex>=0){var h=getByIndex(getElement(elementid).selectedIndex);g=h.html;manageSelection($("#"+h.id))}setTitleText(g)}else{var f=getPostID("postTitleID");$("#"+f).hide();var e=getPostID("postChildID");$("#"+e).css({display:"block",position:"relative"})}break;default:try{getElement(elementid)[a]=b}catch(i){}break}}};this.get=function(a,b){if(a==undefined&&b==undefined){return $this.ddProp}if(a!=undefined&&b==undefined){return $this.ddProp[a]!=undefined?$this.ddProp[a]:null}if(a!=undefined&&b!=undefined){return getElement(elementid)[a]}};this.visible=function(a){var b=getPostID("postID");if(a==true){$("#"+b).show()}else{if(a==false){$("#"+b).hide()}else{return $("#"+b).css("display")}}};this.add=function(a,b){var c=a;var d=c.text;var e=c.value==undefined||c.value==null?d:c.value;var f=c.title==undefined||c.title==null?"":c.title;var g=b==undefined||b==null?getElement(elementid).options.length:b;getElement(elementid).options[g]=new Option(d,e);if(f!=""){getElement(elementid).options[g]["title"]=f}var h=getByIndex(g);if(h!=-1){var i=createA(getElement(elementid).options[g],g,"","");$("#"+h.id).html(i)}else{var i=createA(getElement(elementid).options[g],g,"","");var j=getPostID("postChildID");$("#"+j).append(i);applyEventsOnA()}};this.remove=function(a){getElement(elementid).remove(a);if(getByIndex(a)!=-1){$("#"+getByIndex(a).id).remove();addRemoveFromIndex(a,"d")}if(getElement(elementid).length==0){setTitleText("")}else{var b=getByIndex(getElement(elementid).selectedIndex).html;setTitleText(b)}$this.set("selectedIndex",getElement(elementid).selectedIndex)};this.disabled=function(a,b){getElement(elementid).disabled=a;var c=getPostID("postID");if(a==true){$("#"+c).css("opacity",styles.disabled);$this.close()}else{if(a==false){$("#"+c).css("opacity",1)}}if(b!=true){$this.set("disabled",a)}};this.form=function(){return getElement(elementid).form==undefined?null:getElement(elementid).form};this.item=function(){if(arguments.length==1){return getElement(elementid).item(arguments[0])}else{if(arguments.length==2){return getElement(elementid).item(arguments[0],arguments[1])}else{throw {message:"An index is required!"}}}};this.namedItem=function(a){return getElement(elementid).namedItem(a)};this.multiple=function(a){if(typeof a=="undefined"){return $this.get("multiple")}else{$this.set("multiple",a)}};this.size=function(a){if(typeof a=="undefined"){return $this.get("size")}else{$this.set("size",a)}};this.addMyEvent=function(a,b){$this.onActions[a]=b};this.fireEvent=function(nm){eval($this.onActions[nm])($this)};var updateCommonVars=function(){$this.set("version",$.msDropDown.version);$this.set("author",$.msDropDown.author)};var init=function(){createDropDown();setOriginalProperties();updateCommonVars();if(options.onInit!=""){eval(options.onInit)($this)}};init()};$.msDropDown={version:2.37,author:"Marghoob Suleman",counter:20,create:function(a,b){return $(a).msDropDown(b).data("dd")}};$.fn.extend({msDropDown:function(a){return this.each(function(){var b=new dd(this,a);$(this).data("dd",b)})}});if(typeof $.fn.prop=="undefined"){$.fn.prop=function(a){return $(this).attr(a)}}})(jQuery);Zendesk.NS("Voice");Zendesk.Voice.AssociatePhoneNumberGroups={init:function(selector){this.container=$j(selector);this.setup()},setup:function(){this.attachGroupClickHandlers();this.attachDropdownChangeHandlers();this.attachSubmitHandlers()},attachGroupClickHandlers:function(){var self=this;this.container.find(".std_tile").click(function(){self.toggleGroupSelected($j(this));self.updateSelectedGroups($j(this))})},attachDropdownChangeHandlers:function(){var self=this;this.container.find("#default_group_id").change(function(){self.setIntendedGroupDefault($j(this));self.validateDefaultGroupsDropdown()})},attachSubmitHandlers:function(){var self=this;var $frm=this.container.closest("form");$frm.submit(function(e){if(!self.validateDefaultGroupsDropdown()){e.preventDefault()}})},validateDefaultGroupsDropdown:function(){if(this.container.find("#default_group_id option:selected").val()===""){this.showValidationMessage();return false}else{this.hideValidationMessage();return true}},showValidationMessage:function(){this.container.find("#default_group_id").addClass("error");this.container.find("#groups_validation_msg").addClass("error").show()},hideValidationMessage:function(){this.container.find("#default_group_id").removeClass("error");this.container.find("#groups_validation_msg").removeClass("error").hide()},setIntendedGroupDefault:function(elem){this.container.find(".std_tile").attr("data-intended-default-group","false");this.container.find("#group_"+elem.val()).attr("data-intended-default-group","true")},toggleGroupSelected:function(elem){elem.toggleClass("selected");if(elem.hasClass("selected")){this.markAsNotIntendedDefault(elem)}this.toggleDropdownDisplay();this.createDefaultDropdown()},markAsNotIntendedDefault:function(elem){elem.attr("data-intended-default-group","false")},toggleDropdownDisplay:function(){var selected=this.getSelectedGroups();if(selected.length<2){this.container.find("#group_routing_default").slideUp()}else{this.container.find("#group_routing_default").slideDown()}},updateSelectedGroups:function(elem){var groups=this.container.find("input[value="+elem.attr("data-group-id")+"]");if(groups.length>0){var group=$j(groups[0]);group.attr("checked",!group.attr("checked"))}},getDefaultGroupID:function(){var groupDefault=this.container.find(".std_tile.selected[data-intended-default-group=true]");if(!groupDefault.length){groupDefault=this.container.find(".std_tile.selected[data-default-group=true]")}if(groupDefault.length){return groupDefault.attr("data-group-id")}return null},createDefaultDropdown:function(){var selectedGroups=this.getSelectedGroups();var defaultGroupID=this.getDefaultGroupID();var select=this.container.find("#default_group_id");select.children().remove();selectedGroups.each($j.proxy(function(group){var option=$j("<option />").attr({value:group.id}).html(group.name);if(group.id==defaultGroupID){option.attr({selected:"selected"})}option.appendTo(select)},this));if(!defaultGroupID&&selectedGroups.length>1){var option=$j("<option />").attr({value:"",selected:"selected"}).html("");option.appendTo(select)}},getSelectedGroups:function(){var selected=this.container.find(".std_tile.selected").map(function(){var group={id:$j(this).attr("data-group-id"),name:$j(this).attr("title"),isDefault:$j(this).attr("data-default-group"),intendedDefault:$j(this).attr("data-intended-default-group")};return group}).get();return selected},getSelectedGroupIDs:function(){var selected=this.getSelectedGroups();var selectedIDs=selected.map(function(group){return group.id});return selectedIDs}};Zendesk.NS("Voice");Zendesk.Voice.PhoneNumberEditor={init:function(selector){Zendesk.Voice.AudioPlayer.init(selector);this.setupGreetingsDropdowns(selector);Zendesk.Channels.setupBrandsDropdown("#voice_phone_number_brand_id")},setupGreetingsDropdowns:function(selector){$j(selector).find("select.greeting").each(function(index,selectField){var $selectField=$j(selectField);$selectField.change(function(){var newAudioSource=$selectField.find(":selected").attr("data-audio-src");var $audioButton=$selectField.parent().find(".audio");$audioButton.attr("data-audio-src",newAudioSource);var enabled=!!newAudioSource;$audioButton.attr("disabled",!enabled);Zendesk.Voice.AudioPlayer.init(selector)})})}};Zendesk.NS("Voice");(function($,Zendesk){$(".call-history-container a.sortable, .call-history-container .pagination a").live("click",function(){$.getScript(this.href);return false});$("#call_history a.more").live("click",function(){var call_id=$(this).attr("data-call-id");$("#call_history .breakdown[data-call-id="+call_id+"]").toggle();$(this).toggleClass("expanded");if($(this).hasClass("expanded")){$(this).html(I18n.t("txt.views.voice.settings._call_settings.less_label"))}else{$(this).html(I18n.t("txt.views.voice.settings._call_settings.more_label"))}});Zendesk.Voice.History={filter:function(){$.ajax({url:"/voice/settings/call_history_list?period="+$("#call_billing_period").val(),type:"GET",dataType:"script",beforeSend:function(){$("#call_history .loading-placeholder").addClass("loading")}})}}}(jQuery,Zendesk));Zendesk.NS("Voice");Zendesk.Voice.GreetingsPicker=function(containerSelector){this.formContainer=$j(containerSelector)};Zendesk.Voice.GreetingsPicker.prototype={init:function(){this.availableContainer=this.formContainer.find("#wait_greeting_audio");this.voicemailContainer=this.formContainer.find("#voicemail_greeting_audio");this.waitContainer=this.formContainer.find("#hold_greeting_audio");this.bindAddGreetingLink();_(["available","voicemail","wait"]).each(function(kind){this.setupAudioPlayer(kind);this.bindGreetingsSelect(kind)},this)},containerForKind:function(kind){switch(kind){case"available":return this.availableContainer;case"voicemail":return this.voicemailContainer;case"wait":return this.waitContainer}},bindAddGreetingLink:function(){var self=this;$j("#add_greeting").click(function(e){$j("#custom_greeting_form").html($j("#new_greeting_modal_form").html());$j.colorbox.resize();$j("#create_greeting_button").click(function(e){var $greeting_name=$j("#greeting_name");var value=$j.trim($greeting_name.val());$greeting_name.val(value);$greeting_name.focus();if(value.length===0){if(e){e.preventDefault()}}});$j.colorbox({inline:true,href:"#custom_greeting_form",scrolling:false});if(e){e.preventDefault()}})},setupAudioPlayer:function(kind){var container=this.containerForKind(kind);this.setupAudioPlayerForContainer(container)},setupAudioPlayerForContainer:function(container){container.find(".audio").each(function(n,audio){audio=$j(audio);var audioID=audio.attr("data-audio-id");var audioURL=audio.attr("data-audio-src");var playerAudio=new Player.Audio({domId:audioID,url:audioURL,swfUrl:"/media/voice/soundmanager",stream:true});playerAudio.ready(function(sound){audio.click(function(){if(audio.hasClass("playing")){audio.val(I18n.t("txt.admin.public.javascripts.views.voice.settings.greeting_config.play"));audio.removeClass("playing buffering");sound.pause()}else{audio.val(I18n.t("txt.admin.public.javascripts.views.voice.settings.greeting_config.pause"));audio.addClass("playing");sound.play({onbufferchange:function(){if(sound.isBuffering){setTimeout(function(){if(sound.isBuffering){audio.addClass("buffering")}},300)}else{audio.removeClass("buffering")}},onfinish:function(){audio.val(I18n.t("txt.admin.public.javascripts.views.voice.settings.greeting_config.play"));audio.removeClass("playing")}})}})})})},bindGreetingsSelect:function(kind){var container=this.containerForKind(kind);var self=this;container.find(".greeting_options").change(function(e){var greetingSelect=this;var selectedValue=$j(this).val();if(selectedValue==="default"){self.resetGreeting(kind)}else{if(selectedValue==="default_jp"){self.japaneseGreeting(kind)}else{if(selectedValue==="new_custom"){self.showCustomGreetingFormMainPage(kind)}else{if(selectedValue==="none"){self.emptyGreeting(kind)}}}}if(e){e.preventDefault()}})},showCustomGreetingFormMainPage:function(kind){var container=this.containerForKind(kind);var greetingSelect=container.find(".greeting_options");if(kind==="wait"){$j("#custom_greeting_form").html($j("#custom_greeting_form_upload_page").html())}else{$j("#custom_greeting_form").html($j("#custom_greeting_form_main_page").html())}$j("#custom_greeting_form #greeting_upload").attr("name",kind);$j("#custom_greeting_form h2.title").hide();switch(kind){case"available":$j("#custom_greeting_available_agents_title").show();break;case"voicemail":$j("#custom_greeting_voicemail_title").show();break}$j.colorbox.resize();var self=this;$j("#voice_custom_greeting_form #record_custom_greeting_button").click(function(e){self.showCustomGreetingFormRecordPage(kind);if(e){e.preventDefault()}});$j("#voice_custom_greeting_form #greeting_upload").change(this.submitCustomGreetingForm);$j.colorbox({inline:true,href:"#custom_greeting_form",scrolling:false,onClosed:function(){$j(greetingSelect).val($j(greetingSelect).attr("data-audio-type"))},onComplete:function(){var uploadElm=$j("#greeting_upload");var buttonElm=$j("#upload_custom_greeting_button");uploadElm.mouseover(function(){buttonElm.addClass("hover")});uploadElm.mouseout(function(){buttonElm.removeClass("hover")});uploadElm.mousedown(function(){buttonElm.addClass("active")});uploadElm.mouseup(function(){buttonElm.removeClass("active")})}})},showCustomGreetingFormRecordPage:function(kind){var self=this;$j("#custom_greeting_form").html($j("#custom_greeting_form_record_page").html());$j("#voice_custom_greeting_form h2.title").hide();switch(kind){case"available":$j("#custom_greeting_available_agents_title").show();break;case"voicemail":$j("#custom_greeting_voicemail_title").show();break}$j.colorbox.resize();var callingNumber=$j("#custom_greeting_form #call_phone_number");$j(callingNumber).prop("selectionStart",callingNumber.val().length);$j(callingNumber).focus();$j("#custom_greeting_form #call_phone_number_button").click(function(e){self.startRecordingFlow(kind);if(e){e.preventDefault()}})},startRecordingFlow:function(kind){var self=this;this.callingNumber=$j("#custom_greeting_form #call_phone_number").val();this.recordingKind=kind;if(!self.validatePhoneNumber(self.callingNumber)){return}$j.ajax({url:"/voice/calls/greetings/call_number",type:"post",data:{call_phone_number:this.callingNumber,kind:kind,authenticity_token:Zendesk.currentUser.authenticityToken},success:function(){var message=I18n.t("txt.admin.public.javascripts.views.voice.settings.greeting_config.calling_you_at",{number:self.callingNumber});$j("#custom_greeting_form").html($j.mustache($j("#custom_greeting_form_record_wait_page").html(),{message:message}));$j("#custom_greeting_form h2.title").hide();switch(kind){case"available":$j("#custom_greeting_available_agents_title").show();break;case"voicemail":$j("#custom_greeting_voicemail_title").show();break}RadarClient.initialize(function(){RadarClient.alloc("voice_recordings",function(){RadarClient.status("call_recording/"+Zendesk.currentAccount.subdomain).once(self.recordingUpdateHandler.bind(self)).subscribe()})})},error:function(){self.showInvalidPhoneNumberError(self.callingNumber)},complete:function(){_.defer($j.colorbox.resize)}})},validatePhoneNumber:function(number){number=$j.trim(number);if(number.match(/^(\s*|\++)$/)){this.showEmptyPhoneNumberError()}else{if(!number.match(/\d+/)){this.showInvalidPhoneNumberError(number)}else{return true}}_.defer($j.colorbox.resize);return false},showEmptyPhoneNumberError:function(){$j("#custom_greeting_call_status").html(I18n.t("txt.admin.public.javascripts.views.voice.settings.greeting_config.empty_phone_number_error"))},showInvalidPhoneNumberError:function(number){number=number.escapeHTML();$j("#custom_greeting_call_status").html(I18n.t("txt.admin.public.javascripts.views.voice.settings.greeting_config.phone_number_error",{number:number}))},recordingUpdateHandler:function(msg){var status=msg.value.status;switch(status){case"complete":this.reloadGreeting(this.recordingKind,function(){$j.colorbox.close();window.location.reload(true)});break;case"incomplete":$j("#custom_greeting_form #record_wait_message").html(I18n.t("txt.admin.public.javascripts.views.voice.settings.greeting_config.couldnt_complete_recording"));_.defer($j.colorbox.resize);_.delay($j.colorbox.close,2000);break}},reloadGreeting:function(kind,callback){var self=this;$j.ajax({url:"/voice/settings/greeting",type:"get",data:{kind:kind},success:function(responseText){self.renderGreeting(kind,responseText);if(_.isFunction(callback)){callback()}},error:function(){alert("Error fetching greeting");if(_.isFunction(callback)){callback()}}})},renderGreeting:function(kind,html){$j("#"+kind+"_audio").html(html).effect("highlight",{},1000);switch(kind){case"available":this.availableContainer=this.formContainer.find("#wait_greeting_audio");break;case"voicemail":this.voicemailContainer=this.formContainer.find("#voicemail_greeting_audio");break;case"wait":this.waitContainer=this.formContainer.find("#hold_greeting_audio");break}this.setupAudioPlayer(kind)},submitCustomGreetingForm:function(){$j("#voice_custom_greeting_form").submit()}};(function($){Zendesk.embeddedInLotusAdmin=function(){return window.name=="zendesk-clean-admin"};Zendesk.embeddedInLotusLaunchpad=function(){return window.name=="lotus-launchpad"};var document=this.document,embeddedInLotus=Zendesk.embeddedInLotusAdmin();var lotusHrefs={"^/rules/(\\d+)$":"#/filters/$1","^/tickets/(\\d+)":"#/tickets/$1","^/users/new":"#/users/new","^/users/(\\d+)$":"#/users/$1","^/users/(\\d+)/edit":"#/users/$1","^/organizations/(\\d+)(/edit)?":"#/organizations/$1","^/organizations/new":"#/organizations/new","^/settings/account#subscription/lotus":"#/admin/subscription","^/agent/admin/business_hours":"#/admin/business_hours","^/agent/admin/widget":"#/admin/widget","^/agent/admin/brands":"#/admin/brands"};var rewrittenLotusHrefs=[/#\/filters\/\d+/,/#\/tickets\/\d+/,/#\/users\/new/,/#\/users\/\d+/,/#\/organizations\/\d+/,/#\/organizations\/new/,/#\/admin\/subscription/,/#\/admin\/business_hours/,/#\/admin\/widget/,/#\/admin\/brands/];var forumHref=new RegExp("^/entries/");var chatHref=new RegExp("/chat");function lotusHref(href){var regex;for(var r in lotusHrefs){if(lotusHrefs.hasOwnProperty(r)){regex=new RegExp(r);if(regex.test(href)){return href.replace(regex,lotusHrefs[r])}}}for(var i=0;i<rewrittenLotusHrefs.length;i++){if(rewrittenLotusHrefs[i].test(href)){var split=href.split("#");return"#"+split[split.length-1]}}return null}function appendLotusQueryParams(elem){var href=elem.attr("href");var param="lotus=true";var join_with;if(href.indexOf(param)>-1){return}if(href.indexOf("?")>-1){join_with="&"}else{join_with="?"}elem.attr("href",href+join_with+param);elem.prop("href",href+join_with+param)}function rewriteHrefOnMouseDown(evt){var $a=$(this),lotusLink=lotusHref($a.attr("href")),forumLink=forumHref.test($a.attr("href")),chatLink=chatHref.test($a.attr("href"));if(lotusLink){if(embeddedInLotus){rewriteLinkToLotus($a,"_top")}else{if(currentUser.isAgent&&currentAccount.doAgentsPreferLotus){rewriteLinkToLotus($a,"_blank")}}}else{if(embeddedInLotus&&chatLink){appendLotusQueryParams($a)}else{if(embeddedInLotus&&forumLink){$a.attr("target","_blank")}}}}function handlePossibleLotusClick(evt){if(evt.metaKey||evt.ctrlKey){return}var $a=$(this),lotusLink=lotusHref($a.attr("href")),forumLink=forumHref.test($a.attr("href")),chatLink=chatHref.test($a.attr("href"));if(lotusLink){if(embeddedInLotus){transitionToLotus($a,evt)}else{if(currentUser.isAgent&&currentAccount.doAgentsPreferLotus){rewriteLinkToLotus($a,"_blank")}}}else{if(embeddedInLotus&&chatLink){appendLotusQueryParams($a)}else{if(embeddedInLotus&&forumLink){$a.attr("target","_blank")}}}}function origin(location){return location.origin||location.protocol+"//"+location.hostname+(location.port?":"+location.port:"")}function transitionToLotus(element,event){var $element=$(element),split=lotusHref($element.attr("href")).split("#"),href=split[split.length-1];event.preventDefault();var data=JSON.stringify({target:"route",memo:{hash:href}});window.parent.postMessage(data,origin(location))}function rewriteLinkToLotus(elem,target){var $elem=$(elem),envIsDev=(currentAccount.domain=="localhost")?true:false,topDomain=(envIsDev)?"localhost:3000":currentAccount.domain,protocol=(envIsDev)?"http://":"https://",accountUrl=protocol+currentAccount.subdomain+"."+topDomain+"/agent/",lotus=accountUrl+lotusHref($elem.attr("href"));$elem.attr("target",target).attr("href",lotus).prop("href",lotus)}$(function(){$(document).delegate("a","click",handlePossibleLotusClick);$(document).delegate("a","mouseover",rewriteHrefOnMouseDown);if(Zendesk.embeddedInLotusAdmin()){$("body").addClass("embedded_in_lotus")}})}(this.jQuery));if(Zendesk.embeddedInLotusAdmin()){Zendesk.NS("Voice");Zendesk.Voice.Settings={init:function(){this.bindAddNumberLink();this.numberPicker=new Zendesk.Voice.NumberPicker($j("#number_picker"));this.greetingsPicker=new Zendesk.Voice.GreetingsPicker("#greetings_form");this.greetingsPicker.init();this.ajaxHistoryLoad()},bindAddNumberLink:function(){var self=this;$j("#add_number_link").click(function(e){self.showNumberPicker();if(e){e.preventDefault()}})},showNumberPicker:function(){var self=this;$j("#number_form").html($j.mustache($j("#area_code_search_form").html()));$j("#number_results").html("");$j("#number_picker #country").change(function(e){self.numberPicker.changeAreaCode()});$j("#number_picker #local").change(function(e){self.numberPicker.changeAreaCode()});$j("#number_picker form").submit(function(event){event.preventDefault();self.numberPicker.fetchAvailableNumbers();return false});$j.colorbox({inline:true,href:"#number_picker",width:"490px",onComplete:function(){var numberPicker=$j("#number_picker");numberPicker.find("#country").msDropDown();numberPicker.find("#local").msDropDown();numberPicker.find("#prefix").msDropDown();numberPicker.find("#country").focus()}})},ajaxHistoryLoad:function(){$j.sammy(".tab_links a",function(){this.get("#call_activity",function(){Zendesk.Voice.LiveStats.init()});this.get("#call_history",function(){var call_history_url="/voice/settings/call_history_list?period="+$j("#call_billing_period").val();$j("#call_history .loading-placeholder").addClass("loading");$j.get(call_history_url,{},function(data){$j("#call_history").html(data)}).always(function(){$j("#call_history .loading-placeholder").removeClass("loading")})})}).run()}};var agentSubscription=null;var updateAgent=function(update){var value=update.value;var agentId=update.key;var status=value.status;var forwardingNumber=value.forwarding_number;if(status=="available"){status=status+"_via_"+value.via}var className="status-"+value.status;var agentStatus=$j(".agent-status.agent-"+agentId);if(agentStatus.length>0){agentStatus.data("currentStatus",status);agentStatus.data("forwardingNumber",forwardingNumber);agentStatus.html('<span class="'+className+'">'+Zendesk.Voice.LiveStats.statusStrings[status]+"</span>");Zendesk.Voice.LiveStats.insertSelectInSpan(agentStatus);return false}else{Zendesk.Voice.LiveStats.rebuildAgentsActivityTable();return true}};var updateAgents=function(update){var values=update.value;_.some(Object.keys(values),function(key){return updateAgent({key:key,value:values[key]})})};var createSubscription=function(){window.top.RadarClient.alloc("voice_stats",function(){if(agentSubscription){return}agentSubscription=window.top.RadarClient.status("voice/availability");agentSubscription.get(updateAgents).on(updateAgent).subscribe()})};var destroySubscription=function(){agentSubscription.unsubscribe();agentSubscription=null};Zendesk.Voice.LiveStats={init:function(){setTimeout(this.refreshLiveStats,0);setTimeout(this.refreshLast24Stats,0);Zendesk.Voice.LiveStats.rebuildAgentsActivityTable();if(window.location.hash==="#call_activity"||window.location.hash==="#voice"){createSubscription()}else{destroySubscription()}this.bindAgentToggler();this.transformStatusIntoSelect()},statusStrings:{available_via_phone:I18n.t("txt.admin.helpers.voice.settings_helper.available_via_phone"),available_via_client:I18n.t("txt.admin.helpers.voice.settings_helper.available_via_client"),available:I18n.t("txt.admin.helpers.voice.settings_helper.available"),on_call:I18n.t("txt.admin.helpers.voice.settings_helper.on_call"),wrap_up:I18n.t("txt.admin.helpers.voice.settings_helper.wrap_up_label"),not_available:I18n.t("txt.admin.helpers.voice.settings_helper.not_available")},refreshLiveStats:function(){var url="/api/v2/channels/voice/stats/current_queue_activity";$j.ajax({url:url,type:"GET",dataType:"json",success:function(data){var previous=parseInt($j(".stat.current_calls_waiting .val").html(),10);if(data.current_calls_waiting!=previous){if(data.current_calls_waiting>previous){$j(".stat.current_calls_waiting .indicator").addClass("up");$j(".stat.current_calls_waiting .indicator").removeClass("down")}else{$j(".stat.current_calls_waiting .indicator").removeClass("up");$j(".stat.current_calls_waiting .indicator").addClass("down")}$j(".stat.current_calls_waiting .indicator").fadeIn()}else{$j(".stat.current_calls_waiting .indicator").fadeOut()}$j(".stat.current_calls_waiting .val").html(data.current_queue_activity.calls_waiting);$j(".stat.current_avg_wait_time").html(Zendesk.Voice.LiveStats.digitalClock(data.current_queue_activity.average_wait_time));$j(".stat.current_longest_wait_time").html(Zendesk.Voice.LiveStats.digitalClock(data.current_queue_activity.longest_wait_time))}});if(window.location.hash==="#call_activity"||window.location.hash==="#voice"){setTimeout(Zendesk.Voice.LiveStats.refreshLiveStats,5000)}},digitalClock:function(seconds){if(seconds===null){return"00:00"}var clock=[Math.floor(seconds/60)%60,seconds%60];if(Math.floor(seconds/3600)>=1){clock.unshift(Math.floor(seconds/3600))}return clock.map(function(i){return Zendesk.Voice.LiveStats.zeroPadNumber(i,2)}).join(":")},zeroPadNumber:function(number,length){var value=number.toString();for(var i=0;i<length;i++){if(value.length<length){value="0"+value}}return value},agentsActivitySideLoad:function(){if($j("#toggle_show_all_agents").data("filterAgentActivity")){return"recent_agents_activity"}else{return"agents_activity"}},rebuildAgentsActivityTable:function(){$j.ajax({url:"/api/v2/channels/voice/stats/historical_queue_activity?include="+Zendesk.Voice.LiveStats.agentsActivitySideLoad(),type:"GET",dataType:"json",success:function(data){var newTBody=$j("<tbody></tbody>");for(var i=0;i<data.historical_queue_activity.agents_activity.length;i++){var agentData=data.historical_queue_activity.agents_activity[i];newTBody.append(Zendesk.Voice.LiveStats.buildAgentRow(agentData))}$j("#call_stats_agent_activity > tbody").replaceWith(newTBody);Zendesk.Voice.LiveStats.transformStatusIntoSelect()}})},buildAgentRow:function(agentData){var agentId=agentData.agent_id;var agentStatus=agentData.status_code;var agentForwardingNumber=agentData.forwarding_number;if(agentStatus=="available"){agentStatus=agentStatus+"_via_"+agentData.via}return $j(['<tr class="agent-row agent-'+agentId+'">',"<td>",'<span class="agent-name agent-'+agentId+'">','<a href="/users/'+agentId+'">'+agentData.name+"</a>","</span>",'<span class="agent-status agent-'+agentId+'" data-current-status="'+agentStatus+'" data-agent-id="'+agentId+'" data-forwarding-number="'+agentForwardingNumber+'">','<span class="status-'+agentData.status_code+'">',Zendesk.Voice.LiveStats.statusStrings[agentStatus],"</span>","</span>","</td>",'<td class="agent-stat agent-'+agentId+' available_time">',Zendesk.Voice.LiveStats.digitalClock(agentData.available_time),"</td>",'<td class="agent-stat agent-'+agentId+' calls_accepted">',agentData.calls_accepted,"</td>",'<td class="agent-stat agent-'+agentId+' calls_denied">',agentData.calls_denied,"</td>",'<td class="agent-stat agent-'+agentId+' calls_missed">',agentData.calls_missed,"</td>",'<td class="agent-stat agent-'+agentId+' avg_talk_time">',Zendesk.Voice.LiveStats.digitalClock(agentData.average_talk_time),"</td>","</tr>"].join(""))},refreshLast24Stats:function(){$j.ajax({url:"/api/v2/channels/voice/stats/historical_queue_activity?include="+Zendesk.Voice.LiveStats.agentsActivitySideLoad(),type:"GET",dataType:"json",success:function(data){$j(".stat.total_calls").html(data.historical_queue_activity.total_calls);$j(".stat.most_calls_waiting").html(data.historical_queue_activity.most_calls_waiting);$j(".stat.avg_wait_time").html(Zendesk.Voice.LiveStats.digitalClock(data.historical_queue_activity.average_wait_time));$j(".stat.longest_wait_time").html(Zendesk.Voice.LiveStats.digitalClock(data.historical_queue_activity.longest_wait_time));$j(".stat.avg_talk_time").html(Zendesk.Voice.LiveStats.digitalClock(data.historical_queue_activity.average_talk_time));for(var i=0;i<data.historical_queue_activity.agents_activity.length;i++){var agentData=data.historical_queue_activity.agents_activity[i];var agentId=agentData.agent_id;$j(".agent-stat.available_time.agent-"+agentId).html(Zendesk.Voice.LiveStats.digitalClock(agentData.available_time));$j(".agent-stat.calls_accepted.agent-"+agentId).html(agentData.calls_accepted);$j(".agent-stat.calls_denied.agent-"+agentId).html(agentData.calls_denied);$j(".agent-stat.calls_missed.agent-"+agentId).html(agentData.calls_missed);$j(".agent-stat.avg_talk_time.agent-"+agentId).html(Zendesk.Voice.LiveStats.digitalClock(agentData.average_talk_time))}$j(".last-updated-at-value").html(data.historical_queue_activity.last_updated_at)}});if(window.location.hash==="#call_activity"||window.location.hash==="#voice"){setTimeout(Zendesk.Voice.LiveStats.refreshLast24Stats,15000)}},agentTogglerClick:function(){var toggler=$j("#toggle_show_all_agents");toggler.data("filterAgentActivity",!toggler.data("filterAgentActivity"));if(toggler.data("filterAgentActivity")){toggler.text(I18n.t("txt.admin.public.javascripts.views.admin.settings.show_all_agents"))}else{toggler.text(I18n.t("txt.admin.public.javascripts.views.admin.settings.show_active_agents"))}Zendesk.Voice.LiveStats.rebuildAgentsActivityTable()},bindAgentToggler:function(){var toggler=$j("#toggle_show_all_agents");toggler.removeClass("hidden");toggler.click(Zendesk.Voice.LiveStats.agentTogglerClick)},transitionsByState:{available_via_phone:["available_via_client","not_available"],available_via_client:["available_via_phone","not_available"],available_via_client_only:["not_available"],available:[],on_call:[],wrap_up:["available","not_available"],not_available:["available"]},transformStatusIntoSelect:function(){$j(".agent-row .agent-status").each(function(i,agentStatus){Zendesk.Voice.LiveStats.insertSelectInSpan($j(agentStatus))})},insertSelectInSpan:function(agentStatus){if(!currentUser.availabilityControlsEnabled){return}if(agentStatus.find("select").length>0){return}var currentStatus=agentStatus.data("currentStatus");var forwardingNumber=agentStatus.data("forwardingNumber");var agentId=agentStatus.data("agentId");var transitions=Zendesk.Voice.LiveStats.transitionsByState[currentStatus];if(currentStatus==="available_via_client"&&!forwardingNumber){transitions=Zendesk.Voice.LiveStats.transitionsByState.available_via_client_only}if(transitions===undefined||transitions.length===0){return}var selectOptions='<option value="'+currentStatus+'" selected >'+Zendesk.Voice.LiveStats.statusStrings[currentStatus]+"</option>";selectOptions+=$j.map(transitions,function(transition){return'<option value="'+transition+'">'+Zendesk.Voice.LiveStats.statusStrings[transition]+"</option>"}).join("");var select=$j('<select class="status-'+currentStatus+'" data-current-status="'+currentStatus+'" data-agent-id="'+agentId+'">'+selectOptions+"</select>");select.change(Zendesk.Voice.LiveStats.statusChanged);agentStatus.empty();agentStatus.append(select)},parametersForTransitions:{available_via_phone:{available:true,via:"phone"},available_via_client:{available:true,via:"client"},available:{available:true},not_available:{available:false}},statusChanged:function(){var agentId=$j(this).data("agentId");var currentStatus=$j(this).data("currentStatus");var newAvailability=Zendesk.Voice.LiveStats.parametersForTransitions[$j(this).find("option:selected").attr("value")];$j.ajax({url:"/api/v2/channels/voice/availabilities/"+agentId+".json",type:"PUT",dataType:"json",data:{previous_status:currentStatus,availability:newAvailability},complete:function(jqXHR){if(jqXHR.status==409){window.top.require("lib/growl").error(I18n.t("txt.admin.public.javascripts.views.admin.settings.agent_changed_status"))}else{if(jqXHR.status>400){window.top.require("lib/growl").error(I18n.t("txt.admin.public.javascripts.views.admin.settings.changing_status_unknown_error"))}}}});$j(this).val(currentStatus)}}}Zendesk.NS("Voice");Zendesk.Voice.NumberPicker=function(elem){this.elem=elem;this.pickedNumber=null};Zendesk.Voice.NumberPicker.prototype={fetchAvailableNumbers:function(){var query=this._getQuery();var self=this;this.elem.find(".area_code_loading_spinner").show();$j.colorbox.resize();$j.get("/voice/phone_numbers/available",{country:query.country,area_code:query.areaCode,contains:query.search,toll_free:query.tollFree},function(data){$j("#pre_results").hide();$j(".area_code_loading_spinner").hide();$j("#number_results").html(data);$j("#available_number_list input:radio:first").prop("checked",true);var numberPicker=$j("#number_picker");numberPicker.find("#number_info").hide();numberPicker.find("#number_form .submit input").val("Search again");numberPicker.find("#number_results form").submit(function(e){e.preventDefault();var picked=numberPicker.find(".number_list input:radio:checked");self.showConfirmation(picked.attr("friendly"),picked.attr("price"),query);return false});new Zendesk.Pager(numberPicker.find("#available_number_list"),numberPicker.find(".pagination_links .previous"),numberPicker.find(".pagination_links .next")).paginate(function(){$j.colorbox.resize()});_.defer(function(){$j.colorbox.resize()})})},changeAreaCode:function(){var numberPicker=$j("#number_picker");var country=numberPicker.find("#country").val();var resources=Zendesk.Voice.NumberResources;if(resources[country].area_code){numberPicker.find("#number_field_instructions").html(I18n.t("txt.admin.views.voice.phone_numbers._area_code_search_form.Search_by_area_code_digits"));numberPicker.find("#area_code_field, .area_code_parens").show()}else{numberPicker.find("#number_field_instructions").html(I18n.t("txt.admin.views.voice.phone_numbers._area_code_search_form.Search_by_digits"));numberPicker.find("#area_code_field, .area_code_parens").hide()}numberPicker.find("#country_code .code").html("+"+resources[country].code);this._setPrefix(country,numberPicker,resources);$j.colorbox.resize()},_setPrefix:function(country,numberPicker,resources){numberPicker.find("#fixed_prefix").html("");numberPicker.find("#toll_free_dropdown").hide();if(resources[country].toll_free){numberPicker.find("#local_picker").show();var tollFree=numberPicker.find("#local").val()==="true";if(tollFree){this._setTollFreePrefix(country,numberPicker);this._lastAreaCode=numberPicker.find("#area_code").val()}else{numberPicker.find("#area_code").val(this._lastAreaCode||"");if(country=="GB"){numberPicker.find("#area_code").attr("maxlength",4)}else{numberPicker.find("#area_code").attr("maxlength",3)}}}else{numberPicker.find("#local_picker").hide();this._setCountryPrefix(country,numberPicker,resources)}},_setTollFreePrefix:function(country,numberPicker){numberPicker.find("#area_code_field").hide();if(country=="US"||country=="CA"){numberPicker.find(".area_code_parens").show();numberPicker.find("#toll_free_dropdown").show();numberPicker.find("#toll_prefix").msDropDown()}else{if(country=="GB"){numberPicker.find("#area_code_field, .area_code_parens").hide();numberPicker.find("#fixed_prefix").html("800");numberPicker.find("#area_code").val("")}}},_setCountryPrefix:function(country,numberPicker,resources){var prefix=resources[country].prefix;if(!prefix){prefix=""}numberPicker.find("#fixed_prefix").html(prefix)},_getQuery:function(){var resources=Zendesk.Voice.NumberResources;var numberPicker=$j("#number_picker");var country=numberPicker.find("#country").val();var areaCode=numberPicker.find("#area_code").val();var search=numberPicker.find("#number").val();var countryCode=resources[country].code;var tollFree=numberPicker.find("#local").val()==="true";if(!resources[country].toll_free||tollFree==null){tollFree=false}if(country=="US"||country=="CA"){if(tollFree){areaCode=numberPicker.find("#toll_prefix").val();numberPicker.find("#area_code").val(areaCode);if(isNaN(areaCode)){areaCode=""}}}var searchByPrefix=this._searchByPrefix(areaCode,country,resources);var customSearch=(search!=="");return{country:country,areaCode:areaCode,search:search,countryCode:countryCode,tollFree:tollFree,searchByPrefix:searchByPrefix,customSearch:customSearch}},_searchByPrefix:function(areaCode,country,resources){if(areaCode===""){return false}return resources[country].area_code},showConfirmation:function(number,price,query){var self=this;var data={friendlynumber:number,price:price};var confirmationPage=$j.mustache($j("#confirmation").html(),data);this.elem.find("#number_info").html(confirmationPage).show();this.elem.find("#number_form").hide();this.elem.find("#number_results").hide();this.elem.find(".number_select_loading_spinner").hide();$j.colorbox.resize();_.defer(function(){$j.colorbox.resize()});this.elem.find("#number_info form").submit(function(e){e.preventDefault();var selectedPhoneNumber=self.elem.find(".number_list input:radio:checked");self.addNumber(selectedPhoneNumber.val(),selectedPhoneNumber.attr("token"));return false});this.elem.find(".back a").click(function(e){e.preventDefault();self.elem.find("#number_info").hide();self.elem.find("#number_form").show();self.elem.find("#number_results").show();$j.colorbox.resize();_.defer(function(){$j.colorbox.resize()})})},addNumber:function(number,token){this.elem.find(".number_select_loading_spinner").show();this.pickedNumber=number;$j.ajax({url:"/voice/phone_numbers",type:"POST",data:{token:token},success:function(data){$j("#number_info").html(data);$j("#number_info a#finished").click(function(e){e.preventDefault();document.location.href="/voice/settings?number_added="+number});$j.colorbox.resize()},error:function(){$j(".error").html("<p>Error occurred when adding number. Please try again.</p>");$j(".number_select_loading_spinner").hide();$j(".error").show();$j.colorbox.resize()}});Zendesk.Instrumentation.track("Enabled Trial","Voice")}};var lotusClient=require("admin/lotus_client");$j(document).ready(function(){$j("#trigger-onboarding-modal").click(function(){lotusClient.openModal("iframe",{src:"/voice/admin/onboarding",height:"85%",width:1030,classNames:"modal2"})})});if(!Zendesk.embeddedInLotusAdmin()){Zendesk.NS("Voice");Zendesk.Voice.Settings={init:function(){this.bindAddNumberLink();this.numberPicker=new Zendesk.Voice.NumberPicker($j("#number_picker"));this.greetingsPicker=new Zendesk.Voice.GreetingsPicker("#greetings_form");this.greetingsPicker.init();this.ajaxHistoryLoad()},bindAddNumberLink:function(){var self=this;$j("#add_number_link").click(function(e){self.showNumberPicker();if(e){e.preventDefault()}})},showNumberPicker:function(){var self=this;$j("#number_form").html($j.mustache($j("#area_code_search_form").html()));$j("#number_results").html("");$j("#number_picker #country").change(function(e){self.numberPicker.changeAreaCode()});$j("#number_picker #local").change(function(e){self.numberPicker.changeAreaCode()});$j("#number_picker form").submit(function(event){event.preventDefault();self.numberPicker.fetchAvailableNumbers();return false});$j.colorbox({inline:true,href:"#number_picker",width:"490px",onComplete:function(){var numberPicker=$j("#number_picker");numberPicker.find("#country").msDropDown();numberPicker.find("#local").msDropDown();numberPicker.find("#prefix").msDropDown();numberPicker.find("#country").focus()}})},ajaxHistoryLoad:function(){$j.sammy(".tab_links a",function(){this.get("#call_activity",function(){Zendesk.Voice.LiveStats.init()});this.get("#call_history",function(){var call_history_url="/voice/settings/call_history_list?period="+$j("#call_billing_period").val();$j("#call_history .loading-placeholder").addClass("loading");$j.get(call_history_url,{},function(data){$j("#call_history").html(data)}).always(function(){$j("#call_history .loading-placeholder").removeClass("loading")})});this.get("#general_settings",function(){});this.get("#numbers",function(){});this.get("#greetings",function(){});this.get("/voice/settings",function(){})}).run()}};Zendesk.Voice.LiveStats={init:function(){setTimeout(this.refreshLiveStats,0);setTimeout(this.refreshLast24Stats,0)},statusStrings:{available:I18n.t("txt.admin.helpers.voice.settings_helper.available"),on_call:I18n.t("txt.admin.helpers.voice.settings_helper.on_call"),wrap_up:I18n.t("txt.admin.helpers.voice.settings_helper.wrap_up_label"),not_available:I18n.t("txt.admin.helpers.voice.settings_helper.not_available")},refreshLiveStats:function(){$j.ajax({url:"/api/v2/channels/voice/stats/current_queue_activity?include=agent_availability",type:"GET",dataType:"json",success:function(data){var previous=parseInt($j(".stat.current_calls_waiting .val").html(),10);if(data.current_calls_waiting!=previous){if(data.current_calls_waiting>previous){$j(".stat.current_calls_waiting .indicator").addClass("up");$j(".stat.current_calls_waiting .indicator").removeClass("down")}else{$j(".stat.current_calls_waiting .indicator").removeClass("up");$j(".stat.current_calls_waiting .indicator").addClass("down")}$j(".stat.current_calls_waiting .indicator").fadeIn()}else{$j(".stat.current_calls_waiting .indicator").fadeOut()}$j(".stat.current_calls_waiting .val").html(data.current_queue_activity.calls_waiting);$j(".stat.current_avg_wait_time").html(Zendesk.Voice.LiveStats.digitalClock(data.current_queue_activity.average_wait_time));$j(".stat.current_longest_wait_time").html(Zendesk.Voice.LiveStats.digitalClock(data.current_queue_activity.longest_wait_time));$j.each(data.current_queue_activity.agent_availability,function(status,agents){$j.each(agents,function(index,agent_id){$j(".agent-status.agent-"+agent_id).html("<span class='status-"+status+"'>"+Zendesk.Voice.LiveStats.statusStrings[status]+"</span>")})})}});if(window.location.hash==="#call_activity"||window.location.hash==="#voice"){setTimeout(Zendesk.Voice.LiveStats.refreshLiveStats,5000)}},digitalClock:function(seconds){if(seconds===null){return"00:00"}var clock=[Math.floor(seconds/60)%60,seconds%60];if(Math.floor(seconds/3600)>=1){clock.unshift(Math.floor(seconds/3600))}return clock.map(function(i){return Zendesk.Voice.LiveStats.zeroPadNumber(i,2)}).join(":")},zeroPadNumber:function(number,length){var value=number.toString();for(var i=0;i<length;i++){if(value.length<length){value="0"+value}}return value},refreshLast24Stats:function(){$j.ajax({url:"/api/v2/channels/voice/stats/historical_queue_activity?include=agents_activity",type:"GET",dataType:"json",success:function(data){$j(".stat.total_calls").html(data.historical_queue_activity.total_calls);$j(".stat.most_calls_waiting").html(data.historical_queue_activity.most_calls_waiting);$j(".stat.avg_wait_time").html(Zendesk.Voice.LiveStats.digitalClock(data.historical_queue_activity.average_wait_time));$j(".stat.longest_wait_time").html(Zendesk.Voice.LiveStats.digitalClock(data.historical_queue_activity.longest_wait_time));$j(".stat.avg_talk_time").html(Zendesk.Voice.LiveStats.digitalClock(data.historical_queue_activity.average_talk_time));for(var i=0;i<data.historical_queue_activity.agents_activity.length;i++){var agent_data=data.historical_queue_activity.agents_activity[i];var id=agent_data.id;$j(".agent-stat.available_time.agent-"+id).html(Zendesk.Voice.LiveStats.digitalClock(agent_data.available_time));$j(".agent-stat.calls_accepted.agent-"+id).html(agent_data.calls_accepted);$j(".agent-stat.calls_denied.agent-"+id).html(agent_data.calls_denied);$j(".agent-stat.calls_missed.agent-"+id).html(agent_data.calls_missed);$j(".agent-stat.avg_talk_time.agent-"+id).html(Zendesk.Voice.LiveStats.digitalClock(agent_data.average_talk_time))}$j(".last-updated-at-value").html(data.historical_queue_activity.last_updated_at)}});if(window.location.hash==="#call_activity"||window.location.hash==="#voice"){setTimeout(Zendesk.Voice.LiveStats.refreshLast24Stats,30000)}}}}(function($,Zendesk){Zendesk.VoiceBanner=(function(){function VoiceBanner(){var self=this;var via_was;var banner=Zendesk.Banner.create({text:"",visible:false,reload:true}).addClass("urgent");var scope="user/"+Zendesk.currentUser.id;var content=function(count){if(count===1){return I18n.t("txt.admin.views.voice._voice_banner.You_have_missed_X_phone_calls_and_are_now_offline.one")}else{return I18n.t("txt.admin.views.voice._voice_banner.You_have_missed_X_phone_calls_and_are_now_offline.other",{count:count})}};var syncBannerDisappear=function(){RadarClient.status(scope).set({availability:"ignored"})};$(banner).find(".reload").show();$(banner).find(".reload a").html(I18n.t("txt.agent.views.voice._voice_banner.make_available")).unbind("click").click(function(){if(via_was&&(via_was==="phone"||via_was==="client")){Zendesk.voiceMenu.updateAvailability(via_was,"banner-make-available")}banner.disappear();syncBannerDisappear();return false});RadarClient.alloc("agent_availability").once("ready",function(){RadarClient.status(scope).on(function(message){if(!message.value||!message.value.availability){return}if(message.value.availability==="off"){Zendesk.voiceMenu.updateMenu("off");via_was=message.value.via_was;banner.setContent(content(message.value.max));banner.appear()}if(message.value.availability==="ignored"){banner.disappear()}}).subscribe()});$(banner).bind("ignore.zd.banner",function(){syncBannerDisappear()});this.show=function(){banner.appear()}}return VoiceBanner}())}(jQuery,Zendesk));(function($,Zendesk){var log=Minilog("voice-menu");Zendesk.VoiceMenu=function(){this.name="VoiceMenu"};Zendesk.VoiceMenu.prototype={initialize:function(){log.info("#init-start");var self=this;var _pickAvailability=function(element){var availabilityKind=$(element).attr("data-available");self.updateAvailability(availabilityKind,"user")};var _pickAvailabilityThrottled=_.throttle(_pickAvailability,100);$("#phone_menu .pick_availability").click(function(e){_pickAvailabilityThrottled(this);e.preventDefault();return false});if($.browser.msie&&$.browser.version<8){$("#phone_menu li[data-available='client']").remove()}$("a.audio_settings").click(function(e){e.preventDefault();self.showFlashPermissions(true)});$(window).load(function(){_.defer(function(){log.info("#voice-menu-init");RadarClient.initialize(function(){RadarClient.alloc("voice_menu",function(){RadarClient.status("voice/availability/"+Zendesk.currentUser.id).get(function(message){if(!message||!message.value){self.updateMenu(Zendesk.currentUser.availableForVoiceOn);return}var available=message.value[Zendesk.currentUser.id]&&message.value[Zendesk.currentUser.id].availability;if(available){self.updateMenu(available)}else{self.updateMenu("off")}}).on(function(message){if(!message||!message.value){return}self.updateMenu(message.value.availability)}).subscribe()})})})});log.info("#init-finish")},updateAvailability:function(availabilityKind,reason){if(!availabilityKind){return}var self=this;var is_available=availabilityKind!="off";var via=availabilityKind=="off"?"client":availabilityKind;var endpoint="/api/v2/channels/voice/availabilities/"+Zendesk.currentUser.id+".json";var method="PUT";var data={availability:{available:is_available,via:via}};log.info("#update-availability",{from:Zendesk.currentUser.availableForVoiceOn,to:availabilityKind,reason:reason});var postAvailability=function(){return $.ajax({url:endpoint,type:method,data:data,dataType:"json",error:function(data,status,error){log.error("#update-availability-error",{result:status,reason:reason});if(data.responseText){var response=JSON.parse(data.responseText);var message=response.message;if(message){log.error("#update-availability-error:message",{result:status,reason:reason,message:message});alert(I18n.t(message))}}}})};postAvailability().done(function(data){log.info("#update-availability-success",{result:data.available,reason:reason});self.lastReason=reason})},updateMenu:function(availableOn){var lastReason=this.lastReason;this.lastReason=null;log.info("#update-menu",{from:Zendesk.currentUser.availableForVoiceOn,to:availableOn,lastReason:lastReason});Zendesk.currentUser.availableForVoiceOn=availableOn;$("#phone_menu .pick_availability a").removeClass("on");$("#phone_menu li[data-available='client'] a").toggleClass("on",availableOn==="client");$("#phone_menu li[data-available='phone'] a").toggleClass("on",availableOn==="phone");$("#phone_menu li[data-available='off'] a").toggleClass("on",availableOn==="off");$("#phone_menu #phone_menu_item").toggleClass("on",availableOn!="off");if(availableOn!=="off"&&!this._pubsubEnabled){log.info("#subscribe-for-messages");Zendesk.CallConsoleApp.subscribeForMessages();this._pubsubEnabled=true}if(availableOn==="client"){if(lastReason==="user"){log.info("#update-menu","#show-flash-permissions");var self=this;var bO=this.backOff([1,2,4,8],function(){return Twilio.MediaStream&&Twilio.MediaStream.initialized});bO.done(function(){Twilio.MediaStream.__queue(function(){self.showFlashPermissions()})}).fail(function(){log.error("#twilio-mediastream-error",{message:"ec6"});alert(I18n.t("txt.voice.error.ec6"))})}}},backOff:function(delayList,check){var dfd=$.Deferred(),timeouts=[],self=this;$.each(delayList,function(index,delay){var fails=(index==delayList.length-1);var to=setTimeout(function(){log.info("#twilio-mediastream",{delay:delay});if(check&&check()){dfd.resolve(delay)}else{if(fails){dfd.reject(delay)}}},delay*1000);timeouts.push(to)});dfd.done(function(delay){log.info("#twilio-mediastream-done",{delay:delay});$.each(timeouts,function(i,to){clearTimeout(to)})}).fail(function(delay){log.error("#twilio-mediastream-fail",{delay:delay})});return dfd.promise()},safeIsMicMuted:function(verbose){try{return Twilio.MediaStream.isMicMuted()}catch(err){log.error("#is-mic-muted-fail",{message:err.message,verbose:verbose});if(verbose){alert(I18n.t("txt.voice.error.ec7"))}return true}},catchFlash:function(callback){try{callback.call(this)}catch(err){if(err.message&&err.message.match("Flash")){log.error("#catch-flash-error",{message:err.message});Zendesk.voiceMenu.updateAvailability("off","flash. "+err.message);alert(I18n.t("txt.voice.error.ec8",{error:err.message}))}throw (err)}},showFlashPermissions:function(force){log.info("#show-flash-permissions");var self=this;self.catchFlash(function(){if(!Twilio.Device.instance){Twilio.Device.setup(Zendesk.CallConsoleApp.capabilityToken);log.info("#flash-setup")}if(self.safeIsMicMuted(true)||force){log.info("#flash-show");if(Twilio.Device.getMediaEngine()===Twilio.Device.getMediaEngine.WEBRTC){alert(I18n.t("txt.voice.webrtc_settings.has_access.message"))}else{Twilio.MediaStream.__queue(function(){Twilio.Device.instance.showSettings(function(){if(self.safeIsMicMuted(false)){if(Zendesk.currentUser.availableForVoiceOn==="client"){log.error("#flash-setup-denied");Zendesk.voiceMenu.updateAvailability("off","microphone");alert(I18n.t("txt.voice.error.ec9"))}}})})}}})}}}(jQuery,Zendesk));if(typeof(Voice)==="undefined"){Voice={}}Voice.Timer=(function(){function Timer(selector){this.element=jQuery(selector);this.turnOff()}Timer.prototype.off=function(){return this._lastReset===null};Timer.prototype.reset=function(){this._lastReset=new Date();return this};Timer.prototype.turnOff=function(){this._lastReset=null;return this};Timer.prototype.shouldStop=function(){return false};Timer.prototype.update=function(){this.element.html(this._toHTML());return this};Timer.prototype.stop=function(callback){this.stopCallback=callback;return this};Timer.prototype.triggerStop=function(callback){if(this.stopCallback){this.stopCallback()}this.element.hide();return this};Timer.prototype._toHTML=function(){if(this._lastReset){var since=this._sinceLastReset();return I18n.t("txt.admin.public.javascripts.views.voice.voice_timer.time",{minutes:since[0],seconds:since[1]})}else{return"--"}};Timer.prototype._sinceLastReset=function(){var diffInSeconds=this._diffInSeconds();return[Math.floor(diffInSeconds/60),Math.floor(diffInSeconds%60)]};Timer.prototype._diffInSeconds=function(){var diffInSeconds=((new Date())-this._lastReset)/1000;return diffInSeconds};return Timer}());var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key)){child[key]=parent[key]}}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor();child.__super__=parent.prototype;return child};Voice.CountdownTimer=(function(_super){__extends(CountdownTimer,_super);function CountdownTimer(){return CountdownTimer.__super__.constructor.apply(this,arguments)}CountdownTimer.prototype.shouldStop=function(){var diffInSeconds=-1*this._diffInSeconds();diffInSeconds=Math.round(diffInSeconds);if(diffInSeconds<=0){return true}return false};CountdownTimer.prototype._toHTML=function(){if(this._lastReset){var diffInSeconds=-1*this._diffInSeconds();diffInSeconds=Math.round(diffInSeconds);return I18n.t("txt.admin.public.javascripts.views.voice.voice_countdown_timer.seconds",{seconds:diffInSeconds})}else{return"--"}};return CountdownTimer}(Voice.Timer));Voice.TimerManager=(function(){function TimerManager(timer,startTime){timer._lastReset=startTime;var manager=this;this._job=function(){if(timer.shouldStop()){manager.stop();timer.triggerStop()}timer.update()};this.start()}TimerManager.prototype.start=function(){var worker=TimerManager.worker();worker.jobs.push(this._job);worker.start();return this};TimerManager.prototype.stop=function(){var worker=TimerManager.worker();worker.jobs=_(worker.jobs).without(this._job);if(worker.jobs.length===0){worker.stop()}return this};TimerManager.worker=function(){if(!this._worker){var updatesPerSecond=5;this._worker=new PeriodicWorker(1000/updatesPerSecond)}return this._worker};return TimerManager}());Zendesk.NS("Facebook.integration",function($j){function availablePages(current,limit){var colorbox=$j("#to_colorbox");if(colorbox.length===0){return}var data=colorbox.html();colorbox.html("");$j.colorbox({html:data,onComplete:function(){var existingPages=$j("#active_facebook_pages .facebook-page").length;var totalPages=$j(".add_page").length;$j("#available_facebook_pages").parent().addClass("colorbox-facebook");$j("#available_facebook_pages").parent().css({height:"100%"});$j(".info-icon").click(function(e){var el=$j(this);var isActive=el.hasClass("active");$j(".info-icon").removeClass("active");$j(".contextual-tooltip .tip").hide();if(isActive){$j(document).unbind("click",onLoseFocusOnce)}else{el.addClass("active");el.closest(".contextual-tooltip").find(".tip").show();e.stopPropagation();$j(document).unbind("click",onLoseFocusOnce).bind("click",onLoseFocusOnce)}});$j(".setting").click(function(){var el=$j(this);el.toggleClass("selected",!el.hasClass("selected"));if(el.attr("id")==="enable_hidden_wall_posts"||el.attr("id")==="enable_unpublished_posts"){el.closest(".item-info").find("#enable_wall_posts").addClass("selected")}});$j(".add_page").click(function(){var pageId=this.id.split("-")[1];$j("#pageframe-"+pageId).fadeOut();current++;var pageDiv=getPageDiv(current,limit);$j.colorbox.resize();$j.post("/facebook/pages/select",getSettings(pageId),function(data){$j("#fbpages").show();pageDiv.html(pageDiv.html()+data);styleFacebookPages(limit);if(current-existingPages==totalPages){$j.colorbox.close()}})})},onClosed:function(){window.location.replace("/facebook/settings#general_settings")}})}$j(function(){var pages=$j("#facebook-page-limit-notify");var box=$j("#to_colorbox").html();if(pages.length>0){availablePages(pages.find("#current").html(),pages.find("#limit").html())}else{if(box!=null){availablePages(0,0)}}});function onLoseFocusOnce(){$j(".info-icon").removeClass("active");$j(".contextual-tooltip .tip").hide();$j(document).unbind("click",onLoseFocusOnce)}function getSettings(page_id){var settings=$j("#settings_"+page_id);var wallPostsEnabled=settings.find("#enable_wall_posts").hasClass("selected");var hiddenPostsEnabled=settings.find("#enable_hidden_wall_posts").hasClass("selected");var unpublishedPosts=settings.find("#enable_unpublished_posts").hasClass("selected");var messages=settings.find("#enable_messages").hasClass("selected");var activity=settings.find("#import_activity").hasClass("selected");return{id:page_id,include_wall_posts:wallPostsEnabled,include_hidden_posts:hiddenPostsEnabled,include_promotable_posts:unpublishedPosts,include_messages:messages,import_activity:activity}}function getPageDiv(current,limit){if(current<=limit){$j("#facebook-page-limit-notify").html(I18n.t("txt.facebook_integration.views.colorbox.pages_added",{active_pages:current,page_limit:limit}))}var div="#active_facebook_pages";if(current>limit){div="#inactive_facebook_pages";$j(div).show()}return $j(div)}function styleFacebookPages(limit){var facebook_pages=$j(".facebook_page");$j("#no_pages").hide();facebook_pages.removeClass("nobottom");$j(facebook_pages[limit-1]).addClass("nobottom");$j(facebook_pages[facebook_pages.length-1]).addClass("nobottom")}function setControls(selector){if(selector.is(":checked")===true){$j("#facebook-controls").show()}else{$j("#facebook-controls").hide()}}$j(document).ready(function(){var selector=$j("#comment_is_public");setControls(selector);selector.change(function(){setControls(selector)})})},jQuery);Zendesk.NS("Facebook");Zendesk.Facebook.Settings={init:function(){Zendesk.Channels.setupBrandsDropdown("#facebook_page_brand_id")}};Zendesk.NS("Twitter");Zendesk.Twitter.SearchApplication=function($,options){options=options||{};var savedSearches=options.savedSearches,shortenedUrlFrequency=options.shortenedUrlFrequency,defaultSearch=savedSearches[0];var findInArray=function(array,matcher){var matchedElement=null;$j.each(array,function(idx,element){if(matcher(element)){matchedElement=element;return}});return matchedElement};var startPolling=function(query,mostRecentTweetId){stopPolling();this.poller=new TwitterSearchPoller(defaultSearch.monitored_twitter_handle,query,mostRecentTweetId);this.poller.start()};var stopPolling=function(){if(this.poller){this.poller.stop();this.poller=null}};var setReplyDropdownDefault=function(){if($j("#monitored_twitter_handle_selection #monitored_twitter_handle_id").length){$j("#monitored_twitter_handle_selection #monitored_twitter_handle_id").val(self.currentSearch.monitored_twitter_handle.id)}};var app=$.sammy(function(){this.element_selector="#twitter_search";this.any("#/",function(context){var self=this;var query=this.params.q;var searchId=this.params.id;stopPolling();this.currentSearch=findInArray(savedSearches,function(element){return(element.id==searchId)});self.currentMonitoredAccount=this.currentSearch.monitored_twitter_handle;Sammy.apps["#twitter_search"].trigger("search-configuration-changed",{search:this.currentSearch,query:query});self.currentSearchStream=new TwitterSearchStream(self.currentMonitoredAccount).searchFor(query,1,function(streamData){Sammy.apps["#twitter_search"].trigger("search-configuration-changed",{search:this.currentSearch,query:query});startPolling(query,streamData[0].id_str)});return false});this.bind("on-error",function(event,errorString){$j("#twitter_search_loading_indicator").html(Zendesk.Twitter.Templates.twitter_is_down_template);$j("#twitter_search_loading_indicator").show()});this.bind("twitter-search-started",function(e){var template=Zendesk.Twitter.Templates.tweet_downloading_template;var thinkingPleaseWait=$j.mustache(template);$j("#twitter_search_loading_indicator").html(thinkingPleaseWait);$j("#twitter_search_loading_indicator").show();$j("#no_results").empty();$j("#twitter_new_result_count").empty()});this.bind("twitter-search-completed",function(event,searchResults){new Zendesk.Twitter.TicketCreationForm()._cancelForm();$j("#twitter_search_loading_indicator").slideUp("slow",function(){$j("#twitter_search_loading_indicator").empty()});if(searchResults&&searchResults.results&&searchResults.results.length>0){new Zendesk.Twitter.SearchRenderer(searchResults).render();var searchId=self.currentSearch.id;var sinceId=searchResults.results[0].id_str;if((typeof(Zendesk.Twitter._notifier)!="undefined")&&Zendesk.Twitter._notifier){Zendesk.Twitter._notifier.recordView(searchId,sinceId)}Sammy.apps["#twitter_search"].trigger("update-timestamps")}else{if(typeof(Zendesk.Twitter._notifier)!="undefined"){Zendesk.Twitter._notifier.recordView(searchId,"0")}$j("#twitter_search_results").html("Your search returned no results.")}});this.bind("search-configuration-changed",function(e,config){self.currentSearch=config.search;self.currentMonitoredAccount=self.currentSearch.monitored_twitter_handle;$j("#twitter_search_name").html(config.search.safe_name);if(config.search.editable){$j("#twitter_edit_search_link").show();$j("#twitter_edit_search_link").attr("href","/twitter/search/"+config.search.id+"/edit")}else{$j("#twitter_edit_search_link").hide()}$j('#twitter_search_bar input[type="text"]').val($("<div/>").html(config.query).text());$j('#twitter_search_bar input[type="hidden"]').val(config.search.id)});this.bind("convert-status-to-ticket",function(e,statusMessage){var container=$j("#tweet_"+statusMessage.id_str+" .drawer");setReplyDropdownDefault();new Zendesk.Twitter.TweetActivation().activate(statusMessage.id_str);new Zendesk.Twitter.TicketCreationForm().showSingleTicketForm(statusMessage,container,self.currentSearch.monitored_twitter_handle,shortenedUrlFrequency);container.find("#new_ticket #ticket_subject").val(statusMessage.text)});this.bind("drawer-cancel-btn-clicked",function(){new Zendesk.Twitter.TweetActivation().makeInactive()});this.bind("retweet-button-clicked",function(e,statusMessage){new Zendesk.Twitter.Retweet().show(statusMessage,self.currentMonitoredAccount);new Zendesk.Twitter.TweetActivation().activate(statusMessage.id_str)});this.bind("show-bulk-ticket-form-link-clicked",function(e,data){var statusMessageIds=[];$j(".tweet_checkbox:checked").map(function(idx,e){statusMessageIds.push($j(e).val())});if(statusMessageIds.length>0){stopPolling();setReplyDropdownDefault();new Zendesk.Twitter.TweetActivation().activateBulkAction();new Zendesk.Twitter.TicketCreationForm().showBulkTicketForm(statusMessageIds,$j("#twitter_bulk_ticket_form"),shortenedUrlFrequency)}else{alert("Please select at least one tweet.")}});this.bind("mark-as-reviewed",function(event,data){new TwitterSearchActions().markAsReviewed(data)});this.bind("follow-button-clicked",function(event,data){new Zendesk.Twitter.FollowActions(self.currentMonitoredAccount).displayConfirmationMessage(data);new Zendesk.Twitter.TweetActivation().activate(data.searchObj["id_str"])});this.bind("follow-success",function(event){new Zendesk.Twitter.FollowActions(self.currentMonitoredAccount).successfulFollow()});this.bind("retweet-success",function(event){new Zendesk.Twitter.FollowActions(self.currentMonitoredAccount).successfulFollow()});this.bind("next-page-btn-clicked",function(event,queryString){$j("#twitter_search #show_more").html('<img src="/images/loader.gif" />').css("background","none");new TwitterMultiRequest(self.currentMonitoredAccount).nextPage(queryString,function(data){new Zendesk.Twitter.SearchRenderer(data,false).render();Sammy.apps["#twitter_search"].trigger("update-timestamps")})});this.bind("update-timestamps",function(event){$j("a.timeago").attr("title",function(idx,txt){return new Date(txt).toISOString()});$j("a.timeago").timeago()});this.bind("ticket-creation-success",function(event,data){var tweetElement=$j("#tweet_"+data.statusMessageId);tweetElement.find("input.tweet_checkbox").attr("checked",false).prop("disabled",true).addClass("inactive");tweetElement.find("a.convert_to_ticket").replaceWith('<span class="converted">'+I18n.t("txt.admin.views.twitter.search._ticket_form.Convert_to_Ticket")+"</span>");tweetElement.find(".review_status").html('<a href="/tickets/'+data.ticketId+'" class="ticket_badge" target="_blank">#'+data.ticketId+"</a>");if(self.bulkTicketWatcher){self.bulkTicketWatcher.markCompleted(data)}else{new Zendesk.Twitter.TicketCreationForm()._cancelForm();$j("#submit_button").val(I18n.t("txt.admin.views.twitter.search._ticket_form.Create_Ticket")).prop("disabled",false);new Zendesk.Twitter.TweetActivation().makeInactive()}});this.bind("ticket-creation-failure",function(event,data){if(self.bulkTicketWatcher){self.bulkTicketWatcher.markFailed(data)}else{new Zendesk.Twitter.TicketCreationForm()._showError(data.response);$j("#submit_button").val(I18n.t("txt.admin.views.twitter.search._ticket_form.Create_Ticket")).prop("disabled",false)}});this.bind("bulk-ticket-creation-started",function(event,statusMessages){self.bulkTicketWatcher=new Zendesk.Twitter.BulkTicketWatcher(statusMessages)});this.bind("bulk-ticket-request-completed",function(event,requestCount){new Zendesk.Twitter.BulkActions().checkForBulkActivation()});this.bind("bulk-ticket-creation-complete",function(event,numberCreated){self.bulkTicketWatcher=null;new Zendesk.Twitter.TicketCreationForm()._cancelForm();$j("#submit_button").val(I18n.t("txt.admin.views.twitter.search._ticket_form.Create_Ticket")).prop("disabled",false);new Zendesk.Twitter.TweetActivation().makeInactive()});this.bindToAllEvents(function(){setTimeout(function(){new Zendesk.UI.NestedMenu("div.frame_header ul.drop-list").collapse()},50)})});$(function(){app.run("#/?q="+encodeURIComponent(defaultSearch.query)+"&id="+defaultSearch.id)});return app};Zendesk.NS("Twitter");Zendesk.Twitter.BulkActions=function(){};Zendesk.Twitter.BulkActions.prototype={setup:function(){$j("#bulk_review").click(function(event){event.preventDefault();var selectedTweets=[];$j("#twitter_search_results input:checked").each(function(i,checkbox){selectedTweets.push($j(checkbox).val())});Sammy.apps["#twitter_search"].trigger("mark-as-reviewed",selectedTweets);return false});$j("#bulk_select").click(function(event){if($j("#bulk_select:checked").size()>0){$j(".tweet_checkbox:not(.inactive)").each(function(idx,element){element.checked=true})}else{$j(".tweet_checkbox:checked").each(function(idx,element){element.checked=false})}new Zendesk.Twitter.BulkActions().checkForBulkActivation()})},checkForBulkActivation:function(){if($j(".tweet_checkbox:checked").length>0){$j(".bulk_convert_button").prop("disabled",false)}else{$j(".bulk_convert_button").prop("disabled",true)}}};Zendesk.NS("Twitter");Zendesk.Twitter.BulkTicketWatcher=function(statusMessageIds){this.messageIds=statusMessageIds;this.requestCounter=0};Zendesk.Twitter.BulkTicketWatcher.prototype={markCompleted:function(data){this._observeRequestCompleted()},markFailed:function(data){this._observeRequestCompleted();var tweetElement=$j("#tweet_"+data.statusMessageId);var error;if(data.response){if(data.response.error){error="try_again"}else{error=data.response}}else{error="failed"}error=I18n.t("txt.admin.views.twitter.search.bulk_ticket_watcher."+error);tweetElement.find(".review_status").html('<span class="ticket_badge error" target="_blank">'+error+"</span>")},_observeRequestCompleted:function(){this.requestCounter+=1;Sammy.apps["#twitter_search"].trigger("bulk-ticket-request-completed",this.requestCounter);if(this.requestCounter>=this.messageIds.length){Sammy.apps["#twitter_search"].trigger("bulk-ticket-creation-complete",this.requestCounter)}}};Zendesk.NS("Twitter");Zendesk.Twitter.FollowActions=function(twitterAccount){this.twitterAccount=twitterAccount};Zendesk.Twitter.FollowActions.prototype={displayConfirmationMessage:function(data){var self=this;var tweetElement=$j(data.tweetElement);var template=Zendesk.Twitter.Templates.follow_confirmation_template;var content=$j.mustache(template,data.searchObj);tweetElement.find(".drawer").first().html(content).show();tweetElement.find(".drawer .confirm").first().click(function(){$j(".drawer .confirm").html(I18n.t("txt.admin.javascript.views.twitter.please_wait_label")+' <img src="/images/indicator2.gif" />').css({backgroundColor:"#fff"});self.follow(data.searchObj.from_user);return false});tweetElement.find(".drawer .cancel").click(function(event){Sammy.apps["#twitter_search"].trigger("drawer-cancel-btn-clicked");event.preventDefault();return false})},follow:function(screenName){$j.ajax({url:Zendesk.Proxy.domain()+"/twitter/api/"+this.twitterAccount.id+"/1.1/friendships/create.json",type:"POST",data:{screen_name:screenName,follow:"true"},success:function(){Sammy.apps["#twitter_search"].trigger("follow-success")}})},successfulFollow:function(){$j(".activated a.follow").replaceWith('<span class="following">'+I18n.t("txt.admin.views.twitter.search.templates._tweet_controls_template.Following_label")+"</span>");new Zendesk.Twitter.TweetActivation().makeInactive()}};Zendesk.NS("Proxy");Zendesk.Proxy={domain:function(){var proxyDomain=window.location.protocol+"//"+window.location.hostname;if(proxyDomain.indexOf("localhost")!=-1){proxyDomain+=":3000"}return proxyDomain+"/proxy"}};Zendesk.NS("Twitter");Zendesk.Twitter.Retweet=function(){};Zendesk.Twitter.Retweet.prototype={show:function(statusMessage,monitoredAccount){var template=Zendesk.Twitter.Templates.retweet_template;var content=$j($j.mustache(template,{screen_name:monitoredAccount.screen_name}));content.find(".confirm").first().click(function(){$j("#tweet_"+statusMessage.id_str+" .confirm").html(I18n.t("txt.admin.javascript.views.twitter.please_wait_label")+' <img src="/images/indicator2.gif" />').css({backgroundColor:"#fff"});$j.ajax({url:Zendesk.Proxy.domain()+"/twitter/api/"+monitoredAccount.id+"/1.1/statuses/retweet/"+statusMessage.id_str+".json",type:"POST",success:function(data){$j("#tweet_"+statusMessage.id_str+" .retweet").replaceWith('<span class="retweeted">'+I18n.t("txt.admin.views.twitter.search.templates._tweet_controls_template.Retweeted_label")+"</span>");var screen_name=monitoredAccount.screen_name.substring(1);$j("#tweet_"+statusMessage.id_str+" .meta").append('<span class="retweeted_by">'+I18n.t("txt.admin.javascript.views.twitter.retweeted_by_twitter")+'<a href="http://twitter.com/'+screen_name+'">'+screen_name+"</a>");new Zendesk.Twitter.TweetActivation().makeInactive()}})});$j("#tweet_"+statusMessage.id_str+" .drawer").html(content).show();$j("#tweet_"+statusMessage.id_str+" .drawer .cancel").click(function(event){Sammy.apps["#twitter_search"].trigger("drawer-cancel-btn-clicked");event.preventDefault();return false})}};Zendesk.NS("Twitter");Zendesk.Twitter.TicketCreationForm=function(){};Zendesk.Twitter.TicketCreationForm.prototype={_updateFollowing:function(statusMessage,mth){var requester={id:statusMessage.profile.id,screenName:statusMessage.profile.screen_name.replace(/@/,"")};new TicketForm().isFollowing(mth,requester)},showSingleTicketForm:function(statusMessage,targetContainer,defaultMTH,shortenedUrlFrequency){var formArgs={statusMessageIds:[statusMessage.id_str],targetContainer:targetContainer,shortenedUrlFrequency:shortenedUrlFrequency};this._showForm(formArgs);if(statusMessage.follower){targetContainer.find("#comment_channel_back option[value='dm']").prop("disabled",false)}else{targetContainer.find("#comment_channel_back option[value='dm']").prop("disabled",true)}if(defaultMTH){targetContainer.find("#ticket_monitored_twitter_handle_id").val(defaultMTH.id);var mth={id:defaultMTH.id,screenName:defaultMTH.mention_name.replace(/@/,"")};this._updateFollowing(statusMessage,mth)}var self=this;targetContainer.find("#ticket_monitored_twitter_handle_id").change(function(){var selector=targetContainer.find("#ticket_monitored_twitter_handle_id");var mth={id:selector.val(),screenName:selector.find("option:selected").html().replace(/@/,"")};self._updateFollowing(statusMessage,mth)})},showBulkTicketForm:function(statusMessageIds,targetContainer,shortenedUrlFrequency){var formArgs={statusMessageIds:statusMessageIds,targetContainer:targetContainer,statusMessageSelector:this._getSelectedTweets,shortenedUrlFrequency:shortenedUrlFrequency};this._showForm(formArgs);$j(".cancel_link.bottom").show();targetContainer.find("#channel_back_dm").show();targetContainer.find("#submit_button").click(function(){Sammy.apps["#twitter_search"].trigger("bulk-ticket-creation-started",statusMessageIds)});var updateTicketCount=function(){var update_translated_message=I18n.t("txt.public.javascripts.views.twitter.search.ticket_creating_form.convert_many_tweets_to_tickets",{count:$j(".tweet input:checked").length});if($j(".tweet input:checked").length==1){update_translated_message=I18n.t("txt.public.javascripts.views.twitter.search.ticket_creating_form.convert_one_tweet_to_ticket")}$j("#twitter_convert_to_ticket h3:first").html(update_translated_message)};updateTicketCount();$j(".tweet input:not(.inactive)").bind("click.updateCount",function(){updateTicketCount()});targetContainer.find("#submit_button").bind("click.updateCount",function(){var messageCount=$j(".tweet input:checked").length;$j(".cancel_link.bottom").hide();$j(this).after('<div id="bulk_creation_counter"><img src="/images/loader.gif"/>'+I18n.t("txt.admin.views.twitter.search.ticket_creation_form.creating")+"</div>")})},_getSelectedTweets:function(){var filteredIds=[];$j(".tweet_checkbox:checked").map(function(idx,e){filteredIds.push($j(e).val())});return filteredIds},_updateCounter:function(){if($j("textarea#comment_value").length===0){return}var urls=twitterText.txt.extractUrls($j("textarea#comment_value").val());var currentUrlLength=urls.join("").length;var newLength=0;for(i=0;i<urls.length;i++){newLength+=23}$j("div#charcounter > div").html(140-($j("#charcounter").data("offset")+$j("textarea#comment_value").val().length)+currentUrlLength-newLength)},_setupCharCounter:function(){var self=this;if($j("#charcounter").length===0){$j("div#comment_type").prepend('<div id="charcounter"><div title="Remaining Character Count: Characters past this limit will be truncated on Twitter but appear in their entirety in Zendesk. A shortened link to this ticket will be appended to the tweet, depending on the setup of your zendesk."></div></div>');$j("textarea#comment_value").keyup(function(){self._updateCounter()})}},_setOffset:function(options){options=options||{};var offset,screenName,shortenedUrlFrequency;screenName=(options.ticketPage)?$j(".options .twitter a").html():$j("#tweet_"+options.statusMessageIds[0]+" .screen_name").html();shortenedUrlFrequency=options.shortenedUrlFrequency;offset=shortenedUrlFrequency&&shortenedUrlFrequency==="always"?21:0;if(options.ticketPage){offset+=screenName.length+1}else{if(options.statusMessageIds.length===1){offset+=screenName.length+2}}this._setupCharCounter();$j("#charcounter").data("offset",offset);$j("div#charcounter > div").html(140-offset)},_handleReplyOrNot:function(){var option=$j("#comment_channel_back_optional_add_url");$j("#comment_channel_back").change(function(){option.toggle($j(this).val()!="no_action");new TicketForm().updateTwitterCounter()})},_handleAppendTicketUrl:function(){var self=this;$j("#comment_add_short_url").change(function(){var originalOffset=$j("#charcounter").data("offset");if($j(this).is(":checked")){$j("#charcounter").data("offset",originalOffset+21)}else{$j("#charcounter").data("offset",originalOffset-21)}self._updateCounter()})},setupTweetCounter:function(options){options=options||{};this._setOffset(options);this._handleReplyOrNot();this._handleAppendTicketUrl()},_showForm:function(options){options=options||{};var self=this,statusMessageIds=options.statusMessageIds,targetContainer=options.targetContainer,statusMessageSelector=options.statusMessageSelector,shortenedUrlFrequency=options.shortenedUrlFrequency;this._addFormToContainer(targetContainer);targetContainer.slideDown(200);$j(".cancel_link.bottom").show();this.setupTweetCounter({ticketPage:false,statusMessageIds:statusMessageIds,shortenedUrlFrequency:shortenedUrlFrequency});targetContainer.find(".cancel_link").click(function(event){self._cancelForm();new Zendesk.Twitter.TweetActivation().makeInactive();return false});this._fillFormWithTweetInfo(self,statusMessageIds,targetContainer,statusMessageSelector,shortenedUrlFrequency)},showSuccess:function(callbackData){var ticketResource=callbackData.location.match(/[0-9]+.json/ig)[0];var ticketId=ticketResource.split(".")[0];Sammy.apps["#twitter_search"].trigger("ticket-creation-success",{statusMessageId:callbackData.statusMessageId,ticketId:ticketId,url:callbackData.location})},apply_macro:function(macro_id,evt){var ticketForm=$j("#twitter_convert_to_ticket #new_ticket");new Zendesk.API.Macro(macro_id).applyToTicket(0,ticketForm);var e=(evt)?evt:window.event;Event.stop(e);var li=e.findElement();selection_feedback(li);return(false)},_addFormToContainer:function(container){container.children().remove();$j("#twitter_convert_to_ticket").appendTo(container);container.find(".cancel_link").unbind("click");container.find("#comment_add_short_url").unbind("change");container.find("#submit_button").unbind("click")},_fillFormWithTweetInfo:function(self,statusMessageIds,targetContainer,statusMessageSelector,shortenedUrlFrequency){targetContainer.find("select.assignee").autocompleteFromSelectIfLarge();targetContainer.find("#submit_button").click(function(event){targetContainer.find("#submit_button").val(I18n.t("txt.admin.javascript.views.twitter.please_wait_label")).prop("disabled",true);var bulkTicketCreator=new Zendesk.API.TicketForm("#new_ticket");var statusMessageIdsForCreation=(typeof(statusMessageSelector)=="undefined")?statusMessageIds:statusMessageSelector();var errorCallback=function(httpRequest,textStatus,errorThrown){$j.each(statusMessageIdsForCreation,function(index,statusMessageId){Sammy.apps["#twitter_search"].trigger("ticket-creation-failure",{statusMessageId:statusMessageId,response:null})})};var successCallback=function(response){response=JSON.parse(response);$j.each(response.results,function(index,result){var statusMessageId=statusMessageIdsForCreation[index];if(result.ticket){self.showSuccess({statusMessageId:statusMessageId,location:result.ticket.url})}else{Sammy.apps["#twitter_search"].trigger("ticket-creation-failure",{statusMessageId:statusMessageId,response:result})}});if(response.summary&&response.summary.errors&&response.summary.errors.length>0){$j("#twitter_conversion_errors").html('<div class="errors">'+response.summary.errors.join(". ")+"</div>")}else{$j("#twitter_conversion_errors").html("")}};var data=bulkTicketCreator.formDefaults();data.push({name:"comment[value]",value:bulkTicketCreator.ticketForm.find('[name="comment[value]"]').val()},{name:"comment[public]",value:bulkTicketCreator.ticketForm.find('[name="comment[is_public]"][type="checkbox"]').is(":checked")},{name:"comment[channel_back]",value:true},{name:"twitter_status_message_ids",value:statusMessageIdsForCreation.join(",")});if(shortenedUrlFrequency==="optional"){data.push({name:"comment[add_short_url]",value:bulkTicketCreator.ticketForm.find('[name="comment[add_short_url]"][type="checkbox"]').is(":checked")})}$j.ajax({url:"/api/v2/channels/twitter/tickets/bulk_create_from_search.json",dataType:"text",type:"POST",data:data}).done(successCallback).fail(errorCallback);Zendesk.Instrumentation.track("Created","Twicket");event.preventDefault();return false})},_cancelForm:function(){$j(".ticket_errors").hide();$j("#twitter_convert_to_ticket").appendTo($j("#ticket-conversion-template"));var form=$j("#twitter_convert_to_ticket form");form[0].reset();$j("input, select",form).css("color","");if(typeof(ticketTagField)!="undefined"){ticketTagField.clear()}form.find("#ticket_monitored_twitter_handle_id").unbind("change");form=new TicketForm();form.updateBalloon();form.updateTwitterControls();form.updateMthSelector()},_showError:function(callbackData){if(callbackData){var template=Zendesk.Twitter.Templates.ticket_conversion_error_template;var model={messageId:callbackData.statusMessageId,errorMessages:this._errorMessages(callbackData)};var errorContent=$j($j.mustache(template,model));$j("#twitter_convert_to_ticket .cancel_link.top").after(errorContent)}$j("#submit_button").val(I18n.t("txt.admin.views.twitter.search._ticket_form.Create_Ticket")).prop("disabled",false)},_errorMessages:function(callbackData){var errorMessages=[];var details=callbackData.details;for(var element in details){$j.each(details[element],function(index,error){if(element=="base"){errorMessages.push({message:error.description})}else{errorMessages.push({message:element+" "+error.description})}})}return errorMessages}};Zendesk.NS("Twitter");Zendesk.Twitter.TweetActivation=function(){};Zendesk.Twitter.TweetActivation.prototype={makeInactive:function(tweetId){$j("#twitter_convert_to_ticket h3:first").html(I18n.t("txt.admin.views.twitter.search._ticket_form.Convert_to_Ticket"));$j(".tweet input:not(.inactive)").unbind("click.updateCount");$j("#submit_button").unbind("click.updateCount");$j("#bulk_creation_counter").remove();if($j(".activated").length>0){if($j("html, body").scrollTop()>$j(".activated:first").offset().top){$j("html, body").animate({scrollTop:$j(".activated:first").offset().top},500)}$j(".activated:first").effect("highlight",{},1200)}new TwitterSearchActions().dropDrawers()},activate:function(tweetId){$j(".tweet_actions").removeClass("enabled");$j("#tweet_"+tweetId).addClass("activated");$j(".tweet input").prop("disabled",true)},activateBulkAction:function(){$j(".tweet_actions").removeClass("enabled")}};var TwitterMultiRequest=function(twitterAccount){this.mthId=twitterAccount.id;this.twitterAccount=twitterAccount;this.tweetsPerPage=30};TwitterMultiRequest.prototype={searchFor:function(query,callback){this.callback=callback;this.searchType="query";this.fireRequests(query)},nextPage:function(queryString,callback){this.callback=callback;this.searchType="nextPage";this.fireRequests(queryString)},fireRequests:function(query){this.reset();this.search(query);this.getRetweets();this.getFriends();this.getFollowers()},reset:function(){this.metaData=null;this.searchData=null;this.retweetData=null;this.friendsData=null;this.followerData=null;this.lookupData=null;this.reviewedData=null},search:function(query){var options=this.searchOptions();if(this.searchType==="query"){options.data={count:this.tweetsPerPage,q:query}}else{options.url=options.url+query}$j.ajax(options)},searchOptions:function(){var self=this;return{url:Zendesk.Proxy.domain()+"/twitter/api/"+this.twitterAccount.id+"/1.1/search/tweets.json",type:"GET",dataType:"jsonp",success:function(data){self.searchCallback(data)},error:function(data,errorString){Sammy.apps["#twitter_search"].trigger("on-error",errorString)}}},apiV2Prefix:function(){if(Zendesk.currentAccount){return"https://"+Zendesk.currentAccount.subdomain+"."+Zendesk.currentAccount.domain}else{return""}}(),getCurrentUser:function(){var self=this;return $j.ajax({url:this.apiV2Prefix+"/api/v2/users/me",type:"GET",xhrFields:{withCredentials:true}}).done(function(data){self.authenticityToken=data.user.authenticity_token}).fail(function(data,errorString){Sammy.apps["#twitter_search"].trigger("on-error",errorString)})},getChannelsResourceData:function(tweetIds){var self=this;$j.ajax({url:this.apiV2Prefix+"/api/v2/channels/resources/show_many",data:{external_ids:tweetIds.join(","),type:"twitter_status"},headers:{"X-CSRF-Token":self.authenticityToken},type:"POST",xhrFields:{withCredentials:true},success:function(data){self.channelsResourceDataCallback(data)},error:function(data,errorString){Sammy.apps["#twitter_search"].trigger("on-error",errorString)}})},getRetweets:function(){var self=this;$j.ajax({url:Zendesk.Proxy.domain()+"/twitter/api/"+this.mthId+"/1.1/statuses/user_timeline.json",type:"GET",data:{include_rts:true,user_id:this.twitterAccount.twitter_user_id,screen_name:this.twitterAccount.mention_name},dataType:"jsonp",success:function(data){self.retweetCallback(data)},error:function(data,errorString){Sammy.apps["#twitter_search"].trigger("on-error",errorString)}})},getFriends:function(){var self=this;$j.ajax({url:Zendesk.Proxy.domain()+"/twitter/api/"+this.mthId+"/1.1/friends/ids.json",data:{user_id:this.twitterAccount.twitter_user_id,screen_name:this.twitterAccount.mention_name},type:"GET",dataType:"jsonp",success:function(data){self.friendsCallback(data)},error:function(data,errorString){Sammy.apps["#twitter_search"].trigger("on-error",errorString)}})},getFollowers:function(){var self=this;$j.ajax({url:Zendesk.Proxy.domain()+"/twitter/api/"+this.mthId+"/1.1/followers/ids.json",data:{screen_name:this.twitterAccount.mention_name},type:"GET",dataType:"jsonp",success:function(data){self.followersCallback(data)},error:function(data,errorString){Sammy.apps["#twitter_search"].trigger("on-error",errorString)}})},getReviewed:function(tweetIds){var self=this;$j.ajax({url:"/twitter/reviewed_tweets.json",data:{tweet_ids:tweetIds.join(",")},type:"GET",success:function(data){self.reviewedCallback(data)},error:function(data,errorString){Sammy.apps["#twitter_search"].trigger("on-error",errorString)}})},lookupUsers:function(screenNames){var self=this;$j.ajax({url:Zendesk.Proxy.domain()+"/twitter/api/"+this.mthId+"/1.1/users/lookup.json",data:{screen_name:screenNames.join(",")},type:"GET",dataType:"jsonp",success:function(data){self.lookupCallback(data)},error:function(data,errorString){Sammy.apps["#twitter_search"].trigger("on-error",errorString)}})},searchCallback:function(data){var tweetIds=[];var screenNames=[];var screenNameSet={};var self=this;this.searchData=data;if(!this.searchData.statuses){Sammy.apps["#twitter_search"].trigger("on-error");return}$j.each(this.searchData.statuses,function(index,item){tweetIds.push(item.id_str);screenNameSet[item.user.screen_name]=1});for(var i in screenNameSet){screenNames.push(i)}if(tweetIds.length===0||screenNames.length===0){$j("#show_more").empty();$j("#twitter_search_loading_indicator").empty();$j("#twitter_search_results").html('<div id="no_results" class="message">'+I18n.t("txt.admin.public.javascript.views.twitter.search.application.your_search_returned_no_results_twitter")+"</div>")}else{this.getCurrentUser().done(function(){self.getChannelsResourceData(tweetIds)});this.lookupUsers(screenNames);this.getReviewed(tweetIds)}},metaDataCallback:function(data){this.metaData=data;this.synchronizeCallbacks()},channelsResourceDataCallback:function(data){this.metaData={tickets:data.resources.map(function(resource){return{status_id:parseInt(resource.external_id,10),status_id_str:resource.external_id,ticket_id:resource.ticket_id}})};this.synchronizeCallbacks()},retweetCallback:function(data){this.retweetData=data;this.synchronizeCallbacks()},friendsCallback:function(data){this.friendsData=data;this.synchronizeCallbacks()},followersCallback:function(data){this.followersData=data;this.synchronizeCallbacks()},lookupCallback:function(data){this.lookupData=data;this.synchronizeCallbacks()},reviewedCallback:function(data){this.reviewedData=data;this.synchronizeCallbacks()},synchronizeCallbacks:function(){if(this.metaData&&this.retweetData&&this.friendsData&&this.lookupData&&this.followersData&&this.reviewedData){this.passThroughGate();this.working=false}},passThroughGate:function(){if(typeof(this.callback)!=="undefined"){var data=this.compileData();this.callback(data)}},compileData:function(){var data={results:[],nextPage:this.searchData.search_metadata.next_results};var self=this;$j.each(this.searchData.statuses,function(i,result){$j.each(self.metaData.tickets,function(j,meta){if(meta.status_id_str===result.id_str){result.ticketId=meta.ticket_id;return false}});if(!result.ticketId){$j.each(Zendesk.currentAccount.twitter_accounts,function(i,handle){if(result.text.match(handle.screen_name)&&handle.mention_autoconversion_enabled_at&&Date.parse(result.created_at)>handle.mention_autoconversion_enabled_at){result.ticketId=-1;result.pending=true}})}$j.each(self.retweetData,function(j,retweet){if(retweet&&retweet.retweet_count>0&&retweet.retweeted_status&&retweet.retweeted_status.id_str==result.id_str){result.retweeted=true;result.retweeted_by=retweet.user.screen_name;return false}});$j.each(self.lookupData,function(j,profile){if(profile.screen_name.toLowerCase()===result.user.screen_name.toLowerCase()){result.profile=profile;return false}});$j.each(self.friendsData,function(j,friendId){if(typeof(friendId)=="string"){friendId=Number(friendId)}var isFollowing=typeof(friendId)=="number"?friendId==result.profile.id:(friendId.indexOf&&friendId.indexOf(result.profile.id)>-1);if(result.profile&&isFollowing){result.friend=true;result.profile.friend=true;return false}});$j.each(self.followersData,function(j,followerId){if(result.profile&&followerId==result.profile.id){result.follower=true;return false}});data.results.push(result)});if(data.results.length===this.tweetsPerPage){data.displayMoreLink=true}return data}};var TwitterSearchActions=function(mthId){this.mthId=mthId};TwitterSearchActions.prototype={dropDrawers:function(){$j(".tweet_actions").addClass("enabled");$j(".tweet input:not(.inactive)").prop("disabled",false);$j(".tweet .drawer").hide();$j(".tweet.activated").removeClass("activated")},showLoading:function(twitterStatusId,selector){var tweet=$j("#tweet_"+twitterStatusId);var loadingImage=$j('<span><img src="/images/ajax_small_bar.gif" /></span>');tweet.find(selector).html(loadingImage)},markAsReviewed:function(twitterStatusIds){this.dropDrawers();var self=this;$j.each(twitterStatusIds,function(i,twitterStatusId){self.showLoading(twitterStatusId,"span.review_status")});$j.ajax({url:"/twitter/reviewed_tweets.json",data:{tweet_ids:twitterStatusIds.join(",")},type:"POST",success:function(data){self.reviewedCallback(data)}})},reviewedCallback:function(data){$j.each(data,function(i,twitterStatusId){var tweet=$j("#tweet_"+twitterStatusId);tweet.find(".review_status").first().html('<span class="reviewed">Reviewed</span>')})}};var TwitterSearchPoller=function(twitterAccount,query,mostRecentTweetId){this.twitterAccount=twitterAccount;this.query=query;this.mostRecentTweetId=mostRecentTweetId;this.tweetsPerPage=30;this.sleepTime=15000;this.killed=false};TwitterSearchPoller.prototype={start:function(){this.sleepThenPoll()},stop:function(){this.killed=true;$j("#twitter_new_result_count").empty()},sleepThenPoll:function(){var self=this;var t=setTimeout(function(){self.poll()},this.sleepTime)},poll:function(){var self=this;$j.ajax({url:Zendesk.Proxy.domain()+"/twitter/api/"+this.twitterAccount.id+"/1.1/search/tweets.json",type:"GET",dataType:"jsonp",data:{count:this.tweetsPerPage,q:this.query,since_id:this.mostRecentTweetId},success:function(data){self.callback(data)}})},callback:function(data){if(this.killed){return}var newTweetCount=this.calculateNewTweetCount(data);if(newTweetCount>0&&newTweetCount<this.tweetsPerPage){this.renderNewTweetMessage(newTweetCount)}if(newTweetCount>=this.tweetsPerPage){this.renderMaxTweetsMessage()}else{this.sleepThenPoll()}},calculateNewTweetCount:function(data){if(data&&data.statuses&&data.statuses.length){return data.statuses.length}else{return 0}},renderNewTweetMessage:function(count){var tweet;if(count!=1){tweet=I18n.t("txt.admin.views.twitter.search.templates._more_tweets_template.count_new_tweets_plural",{count:count})}else{tweet=I18n.t("txt.admin.views.twitter.search.templates._more_tweets_template.count_new_tweets_singular")}var object={tweets:tweet};var message=$j.mustache(Zendesk.Twitter.Templates.more_tweets_template,object);$j("#twitter_new_result_count").html(message);$j("a.twitter_search_refresh").click(function(event){Sammy.apps["#twitter_search"].refresh();return false})},renderMaxTweetsMessage:function(){var message=$j.mustache(Zendesk.Twitter.Templates.max_tweets_template,{max:this.tweetsPerPage});$j("#twitter_new_result_count").html(message);$j("a.twitter_search_refresh").click(function(event){Sammy.apps["#twitter_search"].refresh();return false})}};var TwitterSearchPreview=function(){};TwitterSearchPreview.prototype={startQuery:function(query){var self=this;var monitoredTwitterHandleId=$j("#channels_twitter_search_monitored_twitter_handle_id").val();$j.ajax({url:Zendesk.Proxy.domain()+"/twitter/api/"+monitoredTwitterHandleId+"/1.1/search/tweets.json",type:"GET",dataType:"jsonp",data:{count:"5",q:query},success:function(data){self.queryCallback(data)}})},queryCallback:function(data){$j.each(data.statuses,function(index,item){item.profile_image_url=item.user.profile_image_url;item.from_user=item.user.screen_name});var template;template=Zendesk.Twitter.Templates.tweet_preview_template;var renderedTweets=$j.mustache(template,data);$j("#tweet_preview_container").empty();$j("#tweet_preview_container").append(renderedTweets);$j("a.timeago").attr("title",function(idx,txt){return new Date(txt).toISOString()});$j("a.timeago").timeago()}};Zendesk.NS("Twitter");Zendesk.Twitter.SearchRenderer=function(data,removeExistingStatuses){this.data=data;if(typeof(removeExistingStatuses)=="undefined"){this.removeExistingStatuses=true}else{this.removeExistingStatuses=removeExistingStatuses}};Zendesk.Twitter.SearchRenderer.prototype={render:function(){var self=this;this.removeTemporaryElements();$j.each(this.data.results,function(i,statusMessage){var tweet=self.buildTweet(statusMessage);var controls=self.buildTweetControls(statusMessage);tweet.find(".tweet_body").append(controls);if(typeof(statusMessage.ticket_id)==="undefined"){self.attachEventsTo(tweet,statusMessage)}self.attachProfileMouseOver(tweet,statusMessage);$j("#twitter_search_results").append(tweet)});$j(".tweet_checkbox").unbind("change").change(function(event){new Zendesk.Twitter.BulkActions().checkForBulkActivation()});if(this.data.displayMoreLink){this.appendMoreLink()}},removeTemporaryElements:function(){$j("#twitter_search_results .temp").remove();if(this.removeExistingStatuses){$j("#twitter_search_results").empty()}},buildTweet:function(statusMessage){statusMessage.html=Zendesk.Text.autoLink(statusMessage.text);statusMessage.from_user=statusMessage.user.screen_name;statusMessage.profile_image_url=statusMessage.user.profile_image_url;return $j($j.mustache(Zendesk.Twitter.Templates.tweet_template,statusMessage))},buildTweetControls:function(statusMessage){return $j.mustache(Zendesk.Twitter.Templates.tweet_controls_template,statusMessage)},attachEventsTo:function(element,twitterStatusMessage){var self=this;element.find("a.convert_to_ticket").first().click(function(event){event.preventDefault();Sammy.apps["#twitter_search"].trigger("convert-status-to-ticket",twitterStatusMessage)});element.find("a.retweet").first().click(function(event){event.preventDefault();Sammy.apps["#twitter_search"].trigger("retweet-button-clicked",twitterStatusMessage)});element.find("a.follow").first().click(function(event){event.preventDefault();Sammy.apps["#twitter_search"].trigger("follow-button-clicked",{tweetElement:element,searchObj:twitterStatusMessage})});element.find("a.review").first().click(function(event){event.preventDefault();Sammy.apps["#twitter_search"].trigger("mark-as-reviewed",[twitterStatusMessage.id_str])})},attachProfileMouseOver:function(element,tweet){if(tweet.profile){var image=element.find("img.profile_image").first();var profile=element.find(".profile_details").first();var template=Zendesk.Twitter.Templates.tweet_profile_hover;var content=$j.mustache(template,tweet.profile);profile.html(content);image.mouseenter(function(){$j("#twitter_search_results .tweet").css("z-index","1");element.css("z-index","2");jQuery(".profile_details").hide();profile.show()});profile.mouseleave(function(){$j("#twitter_search_results .tweet").css("z-index","");profile.hide()})}},appendMoreLink:function(){var self=this;more_link=$j("<a>"+I18n.t("txt.admin.javascript.views.twitter.twitter_search_renderer.show_more_results_label")+"</a>").click(function(event){Sammy.apps["#twitter_search"].trigger("next-page-btn-clicked",self.data.nextPage)});$j("#twitter_search #show_more").html(more_link)}};var TwitterSearchStream=function(twitterAccount){this.twitterAccount=twitterAccount;this.multiRequest=new TwitterMultiRequest(this.twitterAccount)};TwitterSearchStream.prototype={searchFor:function(query,page,successCallback){Sammy.apps["#twitter_search"].trigger("twitter-search-started");var self=this;this.streamData=null;this.multiRequest.searchFor(query,function(data){Sammy.apps["#twitter_search"].trigger("twitter-search-completed",data);if(typeof(successCallback)!="undefined"){successCallback(data.results)}})},data:function(){return this.streamData},client:function(){return new TwitterSearchActions(this.twitterAccount.id)}};var TwitterSearchSorter=function(root){this.rootElement=root.first()};TwitterSearchSorter.prototype={init:function(){var self=this;this.reorderButton=this.rootElement.parent().find("a.reorder").first();this.reorderButton.click(function(event){self.rootElement.sortable();var cancelLink=jQuery("<a class='cancel-sorting'>"+I18n.t("txt.admin.javascript.views.twitter.cancel_label")+"</a>").click(function(){self.cancelSort()});var doneButton=jQuery('<button class="button">'+I18n.t("txt.admin.javascript.views.twitter.done_label")+"</button>").click(function(){self.updatePositions()});self.rootElement.parent().find(".temp").append(doneButton).append("&nbsp;").append(cancelLink);self.rootElement.parent().find(".edit_this").hide();self.reorderButton.parent().removeClass("item");self.reorderButton.hide()})},cancelSort:function(){try{this.rootElement.sortable("cancel")}catch(e){}this.rootElement.sortable("destroy");this.reset()},updatePositions:function(){var self=this;var path="/twitter/search/update_positions";this.rootElement.sortable("disable");jQuery.ajax({url:path+"?"+self.rootElement.sortable("serialize"),type:"POST",success:function(){self.updatePositionsCallback()}})},updatePositionsCallback:function(){this.rootElement.sortable("enable").sortable("destroy");this.reset()},reset:function(){var rootElementParent=this.rootElement.parent();rootElementParent.find(".temp").empty();rootElementParent.find(".edit_this").show();this.reorderButton.parent().addClass("item");this.reorderButton.show()}};(function(){if(typeof twttr==="undefined"||twttr===null){var twttr={}}twttr.txt={};twttr.txt.regexen={};var HTML_ENTITIES={"&":"&amp;",">":"&gt;","<":"&lt;",'"':"&quot;","'":"&#39;"};twttr.txt.htmlEscape=function(text){return text&&text.replace(/[&"'><]/g,function(character){return HTML_ENTITIES[character]})};function regexSupplant(regex,flags){flags=flags||"";if(typeof regex!=="string"){if(regex.global&&flags.indexOf("g")<0){flags+="g"}if(regex.ignoreCase&&flags.indexOf("i")<0){flags+="i"}if(regex.multiline&&flags.indexOf("m")<0){flags+="m"}regex=regex.source}return new RegExp(regex.replace(/#\{(\w+)\}/g,function(match,name){var newRegex=twttr.txt.regexen[name]||"";if(typeof newRegex!=="string"){newRegex=newRegex.source}return newRegex}),flags)}twttr.txt.regexSupplant=regexSupplant;function stringSupplant(str,values){return str.replace(/#\{(\w+)\}/g,function(match,name){return values[name]||""})}twttr.txt.stringSupplant=stringSupplant;function addCharsToCharClass(charClass,start,end){var s=String.fromCharCode(start);if(end!==start){s+="-"+String.fromCharCode(end)}charClass.push(s);return charClass}twttr.txt.addCharsToCharClass=addCharsToCharClass;var fromCode=String.fromCharCode;var UNICODE_SPACES=[fromCode(32),fromCode(133),fromCode(160),fromCode(5760),fromCode(6158),fromCode(8232),fromCode(8233),fromCode(8239),fromCode(8287),fromCode(12288)];addCharsToCharClass(UNICODE_SPACES,9,13);addCharsToCharClass(UNICODE_SPACES,8192,8202);var INVALID_CHARS=[fromCode(65534),fromCode(65279),fromCode(65535)];addCharsToCharClass(INVALID_CHARS,8234,8238);twttr.txt.regexen.spaces_group=regexSupplant(UNICODE_SPACES.join(""));twttr.txt.regexen.spaces=regexSupplant("["+UNICODE_SPACES.join("")+"]");twttr.txt.regexen.invalid_chars_group=regexSupplant(INVALID_CHARS.join(""));twttr.txt.regexen.punct=/\!'#%&'\(\)*\+,\\\-\.\/:;<=>\?@\[\]\^_{|}~\$/;twttr.txt.regexen.rtl_chars=/[\u0600-\u06FF]|[\u0750-\u077F]|[\u0590-\u05FF]|[\uFE70-\uFEFF]/mg;var nonLatinHashtagChars=[];addCharsToCharClass(nonLatinHashtagChars,1024,1279);addCharsToCharClass(nonLatinHashtagChars,1280,1319);addCharsToCharClass(nonLatinHashtagChars,11744,11775);addCharsToCharClass(nonLatinHashtagChars,42560,42655);addCharsToCharClass(nonLatinHashtagChars,1425,1471);addCharsToCharClass(nonLatinHashtagChars,1473,1474);addCharsToCharClass(nonLatinHashtagChars,1476,1477);addCharsToCharClass(nonLatinHashtagChars,1479,1479);addCharsToCharClass(nonLatinHashtagChars,1488,1514);addCharsToCharClass(nonLatinHashtagChars,1520,1524);addCharsToCharClass(nonLatinHashtagChars,64274,64296);addCharsToCharClass(nonLatinHashtagChars,64298,64310);addCharsToCharClass(nonLatinHashtagChars,64312,64316);addCharsToCharClass(nonLatinHashtagChars,64318,64318);addCharsToCharClass(nonLatinHashtagChars,64320,64321);addCharsToCharClass(nonLatinHashtagChars,64323,64324);addCharsToCharClass(nonLatinHashtagChars,64326,64335);addCharsToCharClass(nonLatinHashtagChars,1552,1562);addCharsToCharClass(nonLatinHashtagChars,1568,1631);addCharsToCharClass(nonLatinHashtagChars,1646,1747);addCharsToCharClass(nonLatinHashtagChars,1749,1756);addCharsToCharClass(nonLatinHashtagChars,1758,1768);addCharsToCharClass(nonLatinHashtagChars,1770,1775);addCharsToCharClass(nonLatinHashtagChars,1786,1788);addCharsToCharClass(nonLatinHashtagChars,1791,1791);addCharsToCharClass(nonLatinHashtagChars,1872,1919);addCharsToCharClass(nonLatinHashtagChars,2208,2208);addCharsToCharClass(nonLatinHashtagChars,2210,2220);addCharsToCharClass(nonLatinHashtagChars,2276,2302);addCharsToCharClass(nonLatinHashtagChars,64336,64433);addCharsToCharClass(nonLatinHashtagChars,64467,64829);addCharsToCharClass(nonLatinHashtagChars,64848,64911);addCharsToCharClass(nonLatinHashtagChars,64914,64967);addCharsToCharClass(nonLatinHashtagChars,65008,65019);addCharsToCharClass(nonLatinHashtagChars,65136,65140);addCharsToCharClass(nonLatinHashtagChars,65142,65276);addCharsToCharClass(nonLatinHashtagChars,8204,8204);addCharsToCharClass(nonLatinHashtagChars,3585,3642);addCharsToCharClass(nonLatinHashtagChars,3648,3662);addCharsToCharClass(nonLatinHashtagChars,4352,4607);addCharsToCharClass(nonLatinHashtagChars,12592,12677);addCharsToCharClass(nonLatinHashtagChars,43360,43391);addCharsToCharClass(nonLatinHashtagChars,44032,55215);addCharsToCharClass(nonLatinHashtagChars,55216,55295);addCharsToCharClass(nonLatinHashtagChars,65441,65500);addCharsToCharClass(nonLatinHashtagChars,12449,12538);addCharsToCharClass(nonLatinHashtagChars,12540,12542);addCharsToCharClass(nonLatinHashtagChars,65382,65439);addCharsToCharClass(nonLatinHashtagChars,65392,65392);addCharsToCharClass(nonLatinHashtagChars,65296,65305);addCharsToCharClass(nonLatinHashtagChars,65313,65338);addCharsToCharClass(nonLatinHashtagChars,65345,65370);addCharsToCharClass(nonLatinHashtagChars,12353,12438);addCharsToCharClass(nonLatinHashtagChars,12441,12446);addCharsToCharClass(nonLatinHashtagChars,13312,19903);addCharsToCharClass(nonLatinHashtagChars,19968,40959);addCharsToCharClass(nonLatinHashtagChars,173824,177983);addCharsToCharClass(nonLatinHashtagChars,177984,178207);addCharsToCharClass(nonLatinHashtagChars,194560,195103);addCharsToCharClass(nonLatinHashtagChars,12291,12291);addCharsToCharClass(nonLatinHashtagChars,12293,12293);addCharsToCharClass(nonLatinHashtagChars,12347,12347);twttr.txt.regexen.nonLatinHashtagChars=regexSupplant(nonLatinHashtagChars.join(""));var latinAccentChars=[];addCharsToCharClass(latinAccentChars,192,214);addCharsToCharClass(latinAccentChars,216,246);addCharsToCharClass(latinAccentChars,248,255);addCharsToCharClass(latinAccentChars,256,591);addCharsToCharClass(latinAccentChars,595,596);addCharsToCharClass(latinAccentChars,598,599);addCharsToCharClass(latinAccentChars,601,601);addCharsToCharClass(latinAccentChars,603,603);addCharsToCharClass(latinAccentChars,611,611);addCharsToCharClass(latinAccentChars,616,616);addCharsToCharClass(latinAccentChars,623,623);addCharsToCharClass(latinAccentChars,626,626);addCharsToCharClass(latinAccentChars,649,649);addCharsToCharClass(latinAccentChars,651,651);addCharsToCharClass(latinAccentChars,699,699);addCharsToCharClass(latinAccentChars,768,879);addCharsToCharClass(latinAccentChars,7680,7935);twttr.txt.regexen.latinAccentChars=regexSupplant(latinAccentChars.join(""));twttr.txt.regexen.hashSigns=/[#＃]/;twttr.txt.regexen.hashtagAlpha=regexSupplant(/[a-z_#{latinAccentChars}#{nonLatinHashtagChars}]/i);twttr.txt.regexen.hashtagAlphaNumeric=regexSupplant(/[a-z0-9_#{latinAccentChars}#{nonLatinHashtagChars}]/i);twttr.txt.regexen.endHashtagMatch=regexSupplant(/^(?:#{hashSigns}|:\/\/)/);twttr.txt.regexen.hashtagBoundary=regexSupplant(/(?:^|$|[^&a-z0-9_#{latinAccentChars}#{nonLatinHashtagChars}])/);twttr.txt.regexen.validHashtag=regexSupplant(/(#{hashtagBoundary})(#{hashSigns})(#{hashtagAlphaNumeric}*#{hashtagAlpha}#{hashtagAlphaNumeric}*)/gi);twttr.txt.regexen.validMentionPrecedingChars=/(?:^|[^a-zA-Z0-9_!#$%&*@＠]|RT:?)/;twttr.txt.regexen.atSigns=/[@＠]/;twttr.txt.regexen.validMentionOrList=regexSupplant("(#{validMentionPrecedingChars})(#{atSigns})([a-zA-Z0-9_]{1,20})(/[a-zA-Z][a-zA-Z0-9_-]{0,24})?","g");twttr.txt.regexen.validReply=regexSupplant(/^(?:#{spaces})*#{atSigns}([a-zA-Z0-9_]{1,20})/);twttr.txt.regexen.endMentionMatch=regexSupplant(/^(?:#{atSigns}|[#{latinAccentChars}]|:\/\/)/);twttr.txt.regexen.validUrlPrecedingChars=regexSupplant(/(?:[^A-Za-z0-9@＠$#＃#{invalid_chars_group}]|^)/);twttr.txt.regexen.invalidUrlWithoutProtocolPrecedingChars=/[-_.\/]$/;twttr.txt.regexen.invalidDomainChars=stringSupplant("#{punct}#{spaces_group}#{invalid_chars_group}",twttr.txt.regexen);twttr.txt.regexen.validDomainChars=regexSupplant(/[^#{invalidDomainChars}]/);twttr.txt.regexen.validSubdomain=regexSupplant(/(?:(?:#{validDomainChars}(?:[_-]|#{validDomainChars})*)?#{validDomainChars}\.)/);twttr.txt.regexen.validDomainName=regexSupplant(/(?:(?:#{validDomainChars}(?:-|#{validDomainChars})*)?#{validDomainChars}\.)/);twttr.txt.regexen.validGTLD=regexSupplant(/(?:(?:aero|asia|biz|cat|com|coop|edu|gov|info|int|jobs|mil|mobi|museum|name|net|org|pro|tel|travel|xxx)(?=[^0-9a-zA-Z]|$))/);twttr.txt.regexen.validCCTLD=regexSupplant(/(?:(?:ac|ad|ae|af|ag|ai|al|am|an|ao|aq|ar|as|at|au|aw|ax|az|ba|bb|bd|be|bf|bg|bh|bi|bj|bm|bn|bo|br|bs|bt|bv|bw|by|bz|ca|cc|cd|cf|cg|ch|ci|ck|cl|cm|cn|co|cr|cs|cu|cv|cx|cy|cz|dd|de|dj|dk|dm|do|dz|ec|ee|eg|eh|er|es|et|eu|fi|fj|fk|fm|fo|fr|ga|gb|gd|ge|gf|gg|gh|gi|gl|gm|gn|gp|gq|gr|gs|gt|gu|gw|gy|hk|hm|hn|hr|ht|hu|id|ie|il|im|in|io|iq|ir|is|it|je|jm|jo|jp|ke|kg|kh|ki|km|kn|kp|kr|kw|ky|kz|la|lb|lc|li|lk|lr|ls|lt|lu|lv|ly|ma|mc|md|me|mg|mh|mk|ml|mm|mn|mo|mp|mq|mr|ms|mt|mu|mv|mw|mx|my|mz|na|nc|ne|nf|ng|ni|nl|no|np|nr|nu|nz|om|pa|pe|pf|pg|ph|pk|pl|pm|pn|pr|ps|pt|pw|py|qa|re|ro|rs|ru|rw|sa|sb|sc|sd|se|sg|sh|si|sj|sk|sl|sm|sn|so|sr|ss|st|su|sv|sy|sz|tc|td|tf|tg|th|tj|tk|tl|tm|tn|to|tp|tr|tt|tv|tw|tz|ua|ug|uk|us|uy|uz|va|vc|ve|vg|vi|vn|vu|wf|ws|ye|yt|za|zm|zw)(?=[^0-9a-zA-Z]|$))/);twttr.txt.regexen.validPunycode=regexSupplant(/(?:xn--[0-9a-z]+)/);twttr.txt.regexen.validDomain=regexSupplant(/(?:#{validSubdomain}*#{validDomainName}(?:#{validGTLD}|#{validCCTLD}|#{validPunycode}))/);twttr.txt.regexen.validAsciiDomain=regexSupplant(/(?:(?:[\-a-z0-9#{latinAccentChars}]+)\.)+(?:#{validGTLD}|#{validCCTLD}|#{validPunycode})/gi);twttr.txt.regexen.invalidShortDomain=regexSupplant(/^#{validDomainName}#{validCCTLD}$/);twttr.txt.regexen.validPortNumber=regexSupplant(/[0-9]+/);twttr.txt.regexen.validGeneralUrlPathChars=regexSupplant(/[a-z0-9!\*';:=\+,\.\$\/%#\[\]\-_~|&#{latinAccentChars}]/i);twttr.txt.regexen.validUrlBalancedParens=regexSupplant(/\(#{validGeneralUrlPathChars}+\)/i);twttr.txt.regexen.validUrlPathEndingChars=regexSupplant(/[\+\-a-z0-9=_#\/#{latinAccentChars}]|(?:#{validUrlBalancedParens})/i);twttr.txt.regexen.validUrlPath=regexSupplant("(?:(?:#{validGeneralUrlPathChars}*(?:#{validUrlBalancedParens}#{validGeneralUrlPathChars}*)*#{validUrlPathEndingChars})|(?:@#{validGeneralUrlPathChars}+/))","i");twttr.txt.regexen.validUrlQueryChars=/[a-z0-9!?\*'@\(\);:&=\+\$\/%#\[\]\-_\.,~|]/i;twttr.txt.regexen.validUrlQueryEndingChars=/[a-z0-9_&=#\/]/i;twttr.txt.regexen.extractUrl=regexSupplant("((#{validUrlPrecedingChars})((https?:\\/\\/)?(#{validDomain})(?::(#{validPortNumber}))?(\\/#{validUrlPath}*)?(\\?#{validUrlQueryChars}*#{validUrlQueryEndingChars})?))","gi");twttr.txt.regexen.validTcoUrl=/^https?:\/\/t\.co\/[a-z0-9]+/i;twttr.txt.regexen.cashtag=/[a-z]{1,6}(?:[._][a-z]{1,2})?/i;twttr.txt.regexen.validCashtag=regexSupplant("(^|#{spaces})(\\$)(#{cashtag})(?=$|\\s|[#{punct}])","gi");twttr.txt.regexen.validateUrlUnreserved=/[a-z0-9\-._~]/i;twttr.txt.regexen.validateUrlPctEncoded=/(?:%[0-9a-f]{2})/i;twttr.txt.regexen.validateUrlSubDelims=/[!$&'()*+,;=]/i;twttr.txt.regexen.validateUrlPchar=regexSupplant("(?:#{validateUrlUnreserved}|#{validateUrlPctEncoded}|#{validateUrlSubDelims}|[:|@])","i");twttr.txt.regexen.validateUrlScheme=/(?:[a-z][a-z0-9+\-.]*)/i;twttr.txt.regexen.validateUrlUserinfo=regexSupplant("(?:#{validateUrlUnreserved}|#{validateUrlPctEncoded}|#{validateUrlSubDelims}|:)*","i");twttr.txt.regexen.validateUrlDecOctet=/(?:[0-9]|(?:[1-9][0-9])|(?:1[0-9]{2})|(?:2[0-4][0-9])|(?:25[0-5]))/i;twttr.txt.regexen.validateUrlIpv4=regexSupplant(/(?:#{validateUrlDecOctet}(?:\.#{validateUrlDecOctet}){3})/i);twttr.txt.regexen.validateUrlIpv6=/(?:\[[a-f0-9:\.]+\])/i;twttr.txt.regexen.validateUrlIp=regexSupplant("(?:#{validateUrlIpv4}|#{validateUrlIpv6})","i");twttr.txt.regexen.validateUrlSubDomainSegment=/(?:[a-z0-9](?:[a-z0-9_\-]*[a-z0-9])?)/i;twttr.txt.regexen.validateUrlDomainSegment=/(?:[a-z0-9](?:[a-z0-9\-]*[a-z0-9])?)/i;twttr.txt.regexen.validateUrlDomainTld=/(?:[a-z](?:[a-z0-9\-]*[a-z0-9])?)/i;twttr.txt.regexen.validateUrlDomain=regexSupplant(/(?:(?:#{validateUrlSubDomainSegment]}\.)*(?:#{validateUrlDomainSegment]}\.)#{validateUrlDomainTld})/i);twttr.txt.regexen.validateUrlHost=regexSupplant("(?:#{validateUrlIp}|#{validateUrlDomain})","i");twttr.txt.regexen.validateUrlUnicodeSubDomainSegment=/(?:(?:[a-z0-9]|[^\u0000-\u007f])(?:(?:[a-z0-9_\-]|[^\u0000-\u007f])*(?:[a-z0-9]|[^\u0000-\u007f]))?)/i;twttr.txt.regexen.validateUrlUnicodeDomainSegment=/(?:(?:[a-z0-9]|[^\u0000-\u007f])(?:(?:[a-z0-9\-]|[^\u0000-\u007f])*(?:[a-z0-9]|[^\u0000-\u007f]))?)/i;twttr.txt.regexen.validateUrlUnicodeDomainTld=/(?:(?:[a-z]|[^\u0000-\u007f])(?:(?:[a-z0-9\-]|[^\u0000-\u007f])*(?:[a-z0-9]|[^\u0000-\u007f]))?)/i;twttr.txt.regexen.validateUrlUnicodeDomain=regexSupplant(/(?:(?:#{validateUrlUnicodeSubDomainSegment}\.)*(?:#{validateUrlUnicodeDomainSegment}\.)#{validateUrlUnicodeDomainTld})/i);twttr.txt.regexen.validateUrlUnicodeHost=regexSupplant("(?:#{validateUrlIp}|#{validateUrlUnicodeDomain})","i");twttr.txt.regexen.validateUrlPort=/[0-9]{1,5}/;twttr.txt.regexen.validateUrlUnicodeAuthority=regexSupplant("(?:(#{validateUrlUserinfo})@)?(#{validateUrlUnicodeHost})(?::(#{validateUrlPort}))?","i");twttr.txt.regexen.validateUrlAuthority=regexSupplant("(?:(#{validateUrlUserinfo})@)?(#{validateUrlHost})(?::(#{validateUrlPort}))?","i");twttr.txt.regexen.validateUrlPath=regexSupplant(/(\/#{validateUrlPchar}*)*/i);twttr.txt.regexen.validateUrlQuery=regexSupplant(/(#{validateUrlPchar}|\/|\?)*/i);twttr.txt.regexen.validateUrlFragment=regexSupplant(/(#{validateUrlPchar}|\/|\?)*/i);twttr.txt.regexen.validateUrlUnencoded=regexSupplant("^(?:([^:/?#]+):\\/\\/)?([^/?#]*)([^?#]*)(?:\\?([^#]*))?(?:#(.*))?$","i");var DEFAULT_LIST_CLASS="tweet-url list-slug";var DEFAULT_USERNAME_CLASS="tweet-url username";var DEFAULT_HASHTAG_CLASS="tweet-url hashtag";var DEFAULT_CASHTAG_CLASS="tweet-url cashtag";var OPTIONS_NOT_ATTRIBUTES={urlClass:true,listClass:true,usernameClass:true,hashtagClass:true,cashtagClass:true,usernameUrlBase:true,listUrlBase:true,hashtagUrlBase:true,cashtagUrlBase:true,usernameUrlBlock:true,listUrlBlock:true,hashtagUrlBlock:true,linkUrlBlock:true,usernameIncludeSymbol:true,suppressLists:true,suppressNoFollow:true,targetBlank:true,suppressDataScreenName:true,urlEntities:true,symbolTag:true,textWithSymbolTag:true,urlTarget:true,invisibleTagAttrs:true,linkAttributeBlock:true,linkTextBlock:true,htmlEscapeNonEntities:true};var BOOLEAN_ATTRIBUTES={disabled:true,readonly:true,multiple:true,checked:true};function clone(o){var r={};for(var k in o){if(o.hasOwnProperty(k)){r[k]=o[k]}}return r}twttr.txt.tagAttrs=function(attributes){var htmlAttrs="";for(var k in attributes){var v=attributes[k];if(BOOLEAN_ATTRIBUTES[k]){v=v?k:null}if(v==null){continue}htmlAttrs+=" "+twttr.txt.htmlEscape(k)+'="'+twttr.txt.htmlEscape(v.toString())+'"'}return htmlAttrs};twttr.txt.linkToText=function(entity,text,attributes,options){if(!options.suppressNoFollow){attributes.rel="nofollow"}if(options.linkAttributeBlock){options.linkAttributeBlock(entity,attributes)}if(options.linkTextBlock){text=options.linkTextBlock(entity,text)}var d={text:text,attr:twttr.txt.tagAttrs(attributes)};return stringSupplant("<a#{attr}>#{text}</a>",d)};twttr.txt.linkToTextWithSymbol=function(entity,symbol,text,attributes,options){var taggedSymbol=options.symbolTag?"<"+options.symbolTag+">"+symbol+"</"+options.symbolTag+">":symbol;text=twttr.txt.htmlEscape(text);var taggedText=options.textWithSymbolTag?"<"+options.textWithSymbolTag+">"+text+"</"+options.textWithSymbolTag+">":text;if(options.usernameIncludeSymbol||!symbol.match(twttr.txt.regexen.atSigns)){return twttr.txt.linkToText(entity,taggedSymbol+taggedText,attributes,options)}else{return taggedSymbol+twttr.txt.linkToText(entity,taggedText,attributes,options)}};twttr.txt.linkToHashtag=function(entity,text,options){var hash=text.substring(entity.indices[0],entity.indices[0]+1);var hashtag=twttr.txt.htmlEscape(entity.hashtag);var attrs=clone(options.htmlAttrs||{});attrs.href=options.hashtagUrlBase+hashtag;attrs.title="#"+hashtag;attrs["class"]=options.hashtagClass;if(hashtag[0].match(twttr.txt.regexen.rtl_chars)){attrs["class"]+=" rtl"}if(options.targetBlank){attrs.target="_blank"}return twttr.txt.linkToTextWithSymbol(entity,hash,hashtag,attrs,options)};twttr.txt.linkToCashtag=function(entity,text,options){var cashtag=twttr.txt.htmlEscape(entity.cashtag);var attrs=clone(options.htmlAttrs||{});attrs.href=options.cashtagUrlBase+cashtag;attrs.title="$"+cashtag;attrs["class"]=options.cashtagClass;if(options.targetBlank){attrs.target="_blank"}return twttr.txt.linkToTextWithSymbol(entity,"$",cashtag,attrs,options)};twttr.txt.linkToMentionAndList=function(entity,text,options){var at=text.substring(entity.indices[0],entity.indices[0]+1);var user=twttr.txt.htmlEscape(entity.screenName);var slashListname=twttr.txt.htmlEscape(entity.listSlug);var isList=entity.listSlug&&!options.suppressLists;var attrs=clone(options.htmlAttrs||{});attrs["class"]=(isList?options.listClass:options.usernameClass);attrs.href=isList?options.listUrlBase+user+slashListname:options.usernameUrlBase+user;if(!isList&&!options.suppressDataScreenName){attrs["data-screen-name"]=user}if(options.targetBlank){attrs.target="_blank"}return twttr.txt.linkToTextWithSymbol(entity,at,isList?user+slashListname:user,attrs,options)};twttr.txt.linkToUrl=function(entity,text,options){var url=entity.url;var displayUrl=url;var linkText=twttr.txt.htmlEscape(displayUrl);var urlEntity=(options.urlEntities&&options.urlEntities[url])||entity;if(urlEntity.display_url){linkText=twttr.txt.linkTextWithEntity(urlEntity,options)}var attrs=clone(options.htmlAttrs||{});attrs.href=url;if(options.targetBlank){attrs.target="_blank"}if(options.urlClass){attrs["class"]=options.urlClass}if(options.urlTarget){attrs.target=options.urlTarget}if(!options.title&&urlEntity.display_url){attrs.title=urlEntity.expanded_url}return twttr.txt.linkToText(entity,linkText,attrs,options)};twttr.txt.linkTextWithEntity=function(entity,options){var displayUrl=entity.display_url;var expandedUrl=entity.expanded_url;var displayUrlSansEllipses=displayUrl.replace(/…/g,"");if(expandedUrl.indexOf(displayUrlSansEllipses)!=-1){var displayUrlIndex=expandedUrl.indexOf(displayUrlSansEllipses);var v={displayUrlSansEllipses:displayUrlSansEllipses,beforeDisplayUrl:expandedUrl.substr(0,displayUrlIndex),afterDisplayUrl:expandedUrl.substr(displayUrlIndex+displayUrlSansEllipses.length),precedingEllipsis:displayUrl.match(/^…/)?"…":"",followingEllipsis:displayUrl.match(/…$/)?"…":""};for(var k in v){if(v.hasOwnProperty(k)){v[k]=twttr.txt.htmlEscape(v[k])}}v.invisible=options.invisibleTagAttrs;return stringSupplant("<span class='tco-ellipsis'>#{precedingEllipsis}<span #{invisible}>&nbsp;</span></span><span #{invisible}>#{beforeDisplayUrl}</span><span class='js-display-url'>#{displayUrlSansEllipses}</span><span #{invisible}>#{afterDisplayUrl}</span><span class='tco-ellipsis'><span #{invisible}>&nbsp;</span>#{followingEllipsis}</span>",v)}return displayUrl};twttr.txt.autoLinkEntities=function(text,entities,options){options=clone(options||{});options.hashtagClass=options.hashtagClass||DEFAULT_HASHTAG_CLASS;options.hashtagUrlBase=options.hashtagUrlBase||"https://twitter.com/#!/search?q=%23";options.cashtagClass=options.cashtagClass||DEFAULT_CASHTAG_CLASS;options.cashtagUrlBase=options.cashtagUrlBase||"https://twitter.com/#!/search?q=%24";options.listClass=options.listClass||DEFAULT_LIST_CLASS;options.usernameClass=options.usernameClass||DEFAULT_USERNAME_CLASS;options.usernameUrlBase=options.usernameUrlBase||"https://twitter.com/";options.listUrlBase=options.listUrlBase||"https://twitter.com/";options.htmlAttrs=twttr.txt.extractHtmlAttrsFromOptions(options);options.invisibleTagAttrs=options.invisibleTagAttrs||"style='position:absolute;left:-9999px;'";var urlEntities,i,len;if(options.urlEntities){urlEntities={};for(i=0,len=options.urlEntities.length;i<len;i++){urlEntities[options.urlEntities[i].url]=options.urlEntities[i]}options.urlEntities=urlEntities}var result="";var beginIndex=0;entities.sort(function(a,b){return a.indices[0]-b.indices[0]});var nonEntity=options.htmlEscapeNonEntities?twttr.txt.htmlEscape:function(text){return text};for(var i=0;i<entities.length;i++){var entity=entities[i];result+=nonEntity(text.substring(beginIndex,entity.indices[0]));if(entity.url){result+=twttr.txt.linkToUrl(entity,text,options)}else{if(entity.hashtag){result+=twttr.txt.linkToHashtag(entity,text,options)}else{if(entity.screenName){result+=twttr.txt.linkToMentionAndList(entity,text,options)}else{if(entity.cashtag){result+=twttr.txt.linkToCashtag(entity,text,options)}}}}beginIndex=entity.indices[1]}result+=nonEntity(text.substring(beginIndex,text.length));return result};twttr.txt.autoLinkWithJSON=function(text,json,options){var entities=[];for(var key in json){entities=entities.concat(json[key])}for(var i=0;i<entities.length;i++){entity=entities[i];if(entity.screen_name){entity.screenName=entity.screen_name}else{if(entity.text){entity.hashtag=entity.text}}}twttr.txt.modifyIndicesFromUnicodeToUTF16(text,entities);return twttr.txt.autoLinkEntities(text,entities,options)};twttr.txt.extractHtmlAttrsFromOptions=function(options){var htmlAttrs={};for(var k in options){var v=options[k];if(OPTIONS_NOT_ATTRIBUTES[k]){continue}if(BOOLEAN_ATTRIBUTES[k]){v=v?k:null}if(v==null){continue}htmlAttrs[k]=v}return htmlAttrs};twttr.txt.autoLink=function(text,options){var entities=twttr.txt.extractEntitiesWithIndices(text,{extractUrlsWithoutProtocol:false});return twttr.txt.autoLinkEntities(text,entities,options)};twttr.txt.autoLinkUsernamesOrLists=function(text,options){var entities=twttr.txt.extractMentionsOrListsWithIndices(text);return twttr.txt.autoLinkEntities(text,entities,options)};twttr.txt.autoLinkHashtags=function(text,options){var entities=twttr.txt.extractHashtagsWithIndices(text);return twttr.txt.autoLinkEntities(text,entities,options)};twttr.txt.autoLinkCashtags=function(text,options){var entities=twttr.txt.extractCashtagsWithIndices(text);return twttr.txt.autoLinkEntities(text,entities,options)};twttr.txt.autoLinkUrlsCustom=function(text,options){var entities=twttr.txt.extractUrlsWithIndices(text,{extractUrlsWithoutProtocol:false});return twttr.txt.autoLinkEntities(text,entities,options)};twttr.txt.removeOverlappingEntities=function(entities){entities.sort(function(a,b){return a.indices[0]-b.indices[0]});var prev=entities[0];for(var i=1;i<entities.length;i++){if(prev.indices[1]>entities[i].indices[0]){entities.splice(i,1);i--}else{prev=entities[i]}}};twttr.txt.extractEntitiesWithIndices=function(text,options){var entities=twttr.txt.extractUrlsWithIndices(text,options).concat(twttr.txt.extractMentionsOrListsWithIndices(text)).concat(twttr.txt.extractHashtagsWithIndices(text,{checkUrlOverlap:false})).concat(twttr.txt.extractCashtagsWithIndices(text));if(entities.length==0){return[]}twttr.txt.removeOverlappingEntities(entities);return entities};twttr.txt.extractMentions=function(text){var screenNamesOnly=[],screenNamesWithIndices=twttr.txt.extractMentionsWithIndices(text);for(var i=0;i<screenNamesWithIndices.length;i++){var screenName=screenNamesWithIndices[i].screenName;screenNamesOnly.push(screenName)}return screenNamesOnly};twttr.txt.extractMentionsWithIndices=function(text){var mentions=[],mentionOrList,mentionsOrLists=twttr.txt.extractMentionsOrListsWithIndices(text);for(var i=0;i<mentionsOrLists.length;i++){mentionOrList=mentionsOrLists[i];if(mentionOrList.listSlug==""){mentions.push({screenName:mentionOrList.screenName,indices:mentionOrList.indices})}}return mentions};twttr.txt.extractMentionsOrListsWithIndices=function(text){if(!text||!text.match(twttr.txt.regexen.atSigns)){return[]}var possibleNames=[],slashListname;text.replace(twttr.txt.regexen.validMentionOrList,function(match,before,atSign,screenName,slashListname,offset,chunk){var after=chunk.slice(offset+match.length);if(!after.match(twttr.txt.regexen.endMentionMatch)){slashListname=slashListname||"";var startPosition=offset+before.length;var endPosition=startPosition+screenName.length+slashListname.length+1;possibleNames.push({screenName:screenName,listSlug:slashListname,indices:[startPosition,endPosition]})}});return possibleNames};twttr.txt.extractReplies=function(text){if(!text){return null}var possibleScreenName=text.match(twttr.txt.regexen.validReply);if(!possibleScreenName||RegExp.rightContext.match(twttr.txt.regexen.endMentionMatch)){return null}return possibleScreenName[1]};twttr.txt.extractUrls=function(text,options){var urlsOnly=[],urlsWithIndices=twttr.txt.extractUrlsWithIndices(text,options);for(var i=0;i<urlsWithIndices.length;i++){urlsOnly.push(urlsWithIndices[i].url)}return urlsOnly};twttr.txt.extractUrlsWithIndices=function(text,options){if(!options){options={extractUrlsWithoutProtocol:true}}if(!text||(options.extractUrlsWithoutProtocol?!text.match(/\./):!text.match(/:/))){return[]}var urls=[];while(twttr.txt.regexen.extractUrl.exec(text)){var before=RegExp.$2,url=RegExp.$3,protocol=RegExp.$4,domain=RegExp.$5,path=RegExp.$7;var endPosition=twttr.txt.regexen.extractUrl.lastIndex,startPosition=endPosition-url.length;if(!protocol){if(!options.extractUrlsWithoutProtocol||before.match(twttr.txt.regexen.invalidUrlWithoutProtocolPrecedingChars)){continue}var lastUrl=null,lastUrlInvalidMatch=false,asciiEndPosition=0;domain.replace(twttr.txt.regexen.validAsciiDomain,function(asciiDomain){var asciiStartPosition=domain.indexOf(asciiDomain,asciiEndPosition);asciiEndPosition=asciiStartPosition+asciiDomain.length;lastUrl={url:asciiDomain,indices:[startPosition+asciiStartPosition,startPosition+asciiEndPosition]};lastUrlInvalidMatch=asciiDomain.match(twttr.txt.regexen.invalidShortDomain);if(!lastUrlInvalidMatch){urls.push(lastUrl)}});if(lastUrl==null){continue}if(path){if(lastUrlInvalidMatch){urls.push(lastUrl)}lastUrl.url=url.replace(domain,lastUrl.url);lastUrl.indices[1]=endPosition}}else{if(url.match(twttr.txt.regexen.validTcoUrl)){url=RegExp.lastMatch;endPosition=startPosition+url.length}urls.push({url:url,indices:[startPosition,endPosition]})}}return urls};twttr.txt.extractHashtags=function(text){var hashtagsOnly=[],hashtagsWithIndices=twttr.txt.extractHashtagsWithIndices(text);for(var i=0;i<hashtagsWithIndices.length;i++){hashtagsOnly.push(hashtagsWithIndices[i].hashtag)}return hashtagsOnly};twttr.txt.extractHashtagsWithIndices=function(text,options){if(!options){options={checkUrlOverlap:true}}if(!text||!text.match(twttr.txt.regexen.hashSigns)){return[]}var tags=[];text.replace(twttr.txt.regexen.validHashtag,function(match,before,hash,hashText,offset,chunk){var after=chunk.slice(offset+match.length);if(after.match(twttr.txt.regexen.endHashtagMatch)){return}var startPosition=offset+before.length;var endPosition=startPosition+hashText.length+1;tags.push({hashtag:hashText,indices:[startPosition,endPosition]})});if(options.checkUrlOverlap){var urls=twttr.txt.extractUrlsWithIndices(text);if(urls.length>0){var entities=tags.concat(urls);twttr.txt.removeOverlappingEntities(entities);tags=[];for(var i=0;i<entities.length;i++){if(entities[i].hashtag){tags.push(entities[i])}}}}return tags};twttr.txt.extractCashtags=function(text){var cashtagsOnly=[],cashtagsWithIndices=twttr.txt.extractCashtagsWithIndices(text);for(var i=0;i<cashtagsWithIndices.length;i++){cashtagsOnly.push(cashtagsWithIndices[i].cashtag)}return cashtagsOnly};twttr.txt.extractCashtagsWithIndices=function(text){if(!text||text.indexOf("$")==-1){return[]}var tags=[];text.replace(twttr.txt.regexen.validCashtag,function(match,before,dollar,cashtag,offset,chunk){var startPosition=offset+before.length;var endPosition=startPosition+cashtag.length+1;tags.push({cashtag:cashtag,indices:[startPosition,endPosition]})});return tags};twttr.txt.modifyIndicesFromUnicodeToUTF16=function(text,entities){twttr.txt.convertUnicodeIndices(text,entities,false)};twttr.txt.modifyIndicesFromUTF16ToUnicode=function(text,entities){twttr.txt.convertUnicodeIndices(text,entities,true)};twttr.txt.convertUnicodeIndices=function(text,entities,indicesInUTF16){if(entities.length==0){return}var charIndex=0;var codePointIndex=0;entities.sort(function(a,b){return a.indices[0]-b.indices[0]});var entityIndex=0;var entity=entities[0];while(charIndex<text.length){if(entity.indices[0]==(indicesInUTF16?charIndex:codePointIndex)){var len=entity.indices[1]-entity.indices[0];entity.indices[0]=indicesInUTF16?codePointIndex:charIndex;entity.indices[1]=entity.indices[0]+len;entityIndex++;if(entityIndex==entities.length){break}entity=entities[entityIndex]}var c=text.charCodeAt(charIndex);if(55296<=c&&c<=56319&&charIndex<text.length-1){c=text.charCodeAt(charIndex+1);if(56320<=c&&c<=57343){charIndex++}}codePointIndex++;charIndex++}};twttr.txt.splitTags=function(text){var firstSplits=text.split("<"),secondSplits,allSplits=[],split;for(var i=0;i<firstSplits.length;i+=1){split=firstSplits[i];if(!split){allSplits.push("")}else{secondSplits=split.split(">");for(var j=0;j<secondSplits.length;j+=1){allSplits.push(secondSplits[j])}}}return allSplits};twttr.txt.hitHighlight=function(text,hits,options){var defaultHighlightTag="em";hits=hits||[];options=options||{};if(hits.length===0){return text}var tagName=options.tag||defaultHighlightTag,tags=["<"+tagName+">","</"+tagName+">"],chunks=twttr.txt.splitTags(text),i,j,result="",chunkIndex=0,chunk=chunks[0],prevChunksLen=0,chunkCursor=0,startInChunk=false,chunkChars=chunk,flatHits=[],index,hit,tag,placed,hitSpot;for(i=0;i<hits.length;i+=1){for(j=0;j<hits[i].length;j+=1){flatHits.push(hits[i][j])}}for(index=0;index<flatHits.length;index+=1){hit=flatHits[index];tag=tags[index%2];placed=false;while(chunk!=null&&hit>=prevChunksLen+chunk.length){result+=chunkChars.slice(chunkCursor);if(startInChunk&&hit===prevChunksLen+chunkChars.length){result+=tag;placed=true}if(chunks[chunkIndex+1]){result+="<"+chunks[chunkIndex+1]+">"}prevChunksLen+=chunkChars.length;chunkCursor=0;chunkIndex+=2;chunk=chunks[chunkIndex];chunkChars=chunk;startInChunk=false}if(!placed&&chunk!=null){hitSpot=hit-prevChunksLen;result+=chunkChars.slice(chunkCursor,hitSpot)+tag;chunkCursor=hitSpot;if(index%2===0){startInChunk=true}else{startInChunk=false}}else{if(!placed){placed=true;result+=tag}}}if(chunk!=null){if(chunkCursor<chunkChars.length){result+=chunkChars.slice(chunkCursor)}for(index=chunkIndex+1;index<chunks.length;index+=1){result+=(index%2===0?chunks[index]:"<"+chunks[index]+">")}}return result};var MAX_LENGTH=140;var INVALID_CHARACTERS=[fromCode(65534),fromCode(65279),fromCode(65535),fromCode(8234),fromCode(8235),fromCode(8236),fromCode(8237),fromCode(8238)];twttr.txt.getTweetLength=function(text,options){if(!options){options={short_url_length:20,short_url_length_https:21}}var textLength=text.length;var urlsWithIndices=twttr.txt.extractUrlsWithIndices(text);for(var i=0;i<urlsWithIndices.length;i++){textLength+=urlsWithIndices[i].indices[0]-urlsWithIndices[i].indices[1];if(urlsWithIndices[i].url.toLowerCase().match(/^https:\/\//)){textLength+=options.short_url_length_https}else{textLength+=options.short_url_length}}return textLength};twttr.txt.isInvalidTweet=function(text){if(!text){return"empty"}if(twttr.txt.getTweetLength(text)>MAX_LENGTH){return"too_long"}for(var i=0;i<INVALID_CHARACTERS.length;i++){if(text.indexOf(INVALID_CHARACTERS[i])>=0){return"invalid_characters"}}return false};twttr.txt.isValidTweetText=function(text){return !twttr.txt.isInvalidTweet(text)};twttr.txt.isValidUsername=function(username){if(!username){return false}var extracted=twttr.txt.extractMentions(username);return extracted.length===1&&extracted[0]===username.slice(1)};var VALID_LIST_RE=regexSupplant(/^#{validMentionOrList}$/);twttr.txt.isValidList=function(usernameList){var match=usernameList.match(VALID_LIST_RE);return !!(match&&match[1]==""&&match[4])};twttr.txt.isValidHashtag=function(hashtag){if(!hashtag){return false}var extracted=twttr.txt.extractHashtags(hashtag);return extracted.length===1&&extracted[0]===hashtag.slice(1)};twttr.txt.isValidUrl=function(url,unicodeDomains,requireProtocol){if(unicodeDomains==null){unicodeDomains=true}if(requireProtocol==null){requireProtocol=true}if(!url){return false}var urlParts=url.match(twttr.txt.regexen.validateUrlUnencoded);if(!urlParts||urlParts[0]!==url){return false}var scheme=urlParts[1],authority=urlParts[2],path=urlParts[3],query=urlParts[4],fragment=urlParts[5];if(!((!requireProtocol||(isValidMatch(scheme,twttr.txt.regexen.validateUrlScheme)&&scheme.match(/^https?$/i)))&&isValidMatch(path,twttr.txt.regexen.validateUrlPath)&&isValidMatch(query,twttr.txt.regexen.validateUrlQuery,true)&&isValidMatch(fragment,twttr.txt.regexen.validateUrlFragment,true))){return false}return(unicodeDomains&&isValidMatch(authority,twttr.txt.regexen.validateUrlUnicodeAuthority))||(!unicodeDomains&&isValidMatch(authority,twttr.txt.regexen.validateUrlAuthority))};function isValidMatch(string,regex,optional){if(!optional){return((typeof string==="string")&&string.match(regex)&&RegExp["$&"]===string)}return(!string||(string.match(regex)&&RegExp["$&"]===string))}if(typeof module!="undefined"&&module.exports){module.exports=twttr.txt}if(typeof window!="undefined"){window.twitterText=twttr}})();Zendesk.NS("Twitter");Zendesk.Twitter.Menu={init:function(){this.bindDismissTwitterMenu()},bindDismissTwitterMenu:function(){var self=this;jQuery(".hide_twitter_menu").click(function(event){event.preventDefault();self.dismissTwitterMenu()})},dismissTwitterMenu:function(){var self=this;jQuery.ajax({type:"PUT",url:"/twitter/settings.json",data:{account:{settings:{twitter_search_stream:0}}},success:function(){self.hideTwitterMenu()}})},hideTwitterMenu:function(){$j("#twitter_menu").remove()}};Zendesk.NS("Twitter");Zendesk.Twitter.Settings={init:function(){this.bindSettingsToggle();Zendesk.Channels.setupBrandsDropdown("#monitored_twitter_handle_brand_id")},bindSettingsToggle:function(){var settingsLink=jQuery("#monitored_accounts_frame .twitter_profile_card .toggle");settingsLink.toggle(function(){jQuery(this).html("Close settings").parents(".twitter_profile_card").addClass("activated")},function(){jQuery(this).html("Settings").parents(".twitter_profile_card").removeClass("activated")})}};(function(Cookie,$,Zendesk){Zendesk.AlertManager=function(selector,key){this._selector=""+selector;this._key=""+key;$(selector+" a.close").click(this.hide.bind(this))};Zendesk.AlertManager.prototype={show:function(){if(Zendesk.SettingsCookie.get(this._key)==null){var element=$(this._selector);var alertId=element.data("ipm-alert-id");element.show();if(alertId){Zendesk.Instrumentation.track(alertId,"ipm-alert:load");element.find("a.link").click(function(){Zendesk.Instrumentation.track(alertId,"ipm-alert:link")})}}},hide:function(event){event&&event.preventDefault&&event.preventDefault();var alertId=$(this._selector).hide().data("ipm-alert-id");if(alertId){$.ajax({type:"delete",url:"/api/v1/ipm/alerts/"+alertId+".json"});Zendesk.Instrumentation.track(alertId,"ipm-alert:dismiss")}else{Zendesk.SettingsCookie.set(this._key,"1")}return false}}}(this.Cookie,this.jQuery,this.Zendesk));